<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Task Management Suite</title>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 24px;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stat-icon.total { background: #e0e7ff; color: var(--primary); }
        .stat-icon.done { background: #d1fae5; color: var(--success); }
        .stat-icon.progress { background: #dbeafe; color: var(--info); }
        .stat-icon.overdue { background: #fee2e2; color: var(--danger); }

        .stat-info h3 {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .stat-info p {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--shadow);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .card-header h2 {
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* Progress Ring */
        .progress-ring-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 40px;
        }

        .progress-ring {
            position: relative;
            width: 160px;
            height: 160px;
        }

        .progress-ring svg {
            transform: rotate(-90deg);
        }

        .progress-ring circle {
            fill: none;
            stroke-width: 12;
        }

        .progress-ring .bg {
            stroke: var(--border);
        }

        .progress-ring .progress {
            stroke: var(--success);
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
        }

        .progress-ring .center-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .progress-ring .percentage {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text);
        }

        .progress-ring .label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .progress-legend {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .legend-item span {
            font-size: 0.85rem;
        }

        .legend-item strong {
            margin-left: auto;
        }

        /* Priority Chart */
        .priority-bars {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .priority-bar {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .priority-label {
            width: 80px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .priority-track {
            flex: 1;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .priority-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .priority-fill.critical { background: var(--danger); }
        .priority-fill.high { background: var(--warning); }
        .priority-fill.medium { background: var(--info); }
        .priority-fill.low { background: var(--text-muted); }

        .priority-count {
            width: 30px;
            text-align: right;
            font-weight: 600;
            font-size: 0.85rem;
        }

        /* Upcoming Tasks */
        .task-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .task-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .task-item:hover {
            background: #e2e8f0;
        }

        .task-item.selected {
            outline: 2px solid var(--primary);
            background: #e0e7ff;
        }

        .task-priority {
            width: 4px;
            height: 32px;
            border-radius: 2px;
        }

        .task-priority.p1 { background: var(--danger); }
        .task-priority.p2 { background: var(--warning); }
        .task-priority.p3 { background: var(--info); }
        .task-priority.p4 { background: var(--text-muted); }

        .task-info {
            flex: 1;
        }

        .task-info h4 {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .task-info p {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .task-due {
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 4px;
            background: var(--border);
        }

        .task-due.overdue {
            background: #fee2e2;
            color: var(--danger);
        }

        .task-due.today {
            background: #dbeafe;
            color: var(--info);
        }

        /* Team Performance */
        .team-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .team-member {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .member-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .member-info {
            flex: 1;
        }

        .member-info h4 {
            font-size: 0.85rem;
            font-weight: 500;
        }

        .member-progress {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
        }

        .member-bar {
            flex: 1;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
        }

        .member-bar-fill {
            height: 100%;
            background: var(--success);
            border-radius: 3px;
        }

        .member-stats {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--card-bg);
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h2 {
            font-size: 1.25rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
        }

        .modal-body {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 0.875rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.875rem;
            outline: none;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--primary);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .btn-secondary {
            background: var(--bg);
            color: var(--text);
            border: 1px solid var(--border);
        }

        /* Toast */
        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 2000;
        }

        .toast {
            padding: 14px 20px;
            background: var(--text);
            color: white;
            border-radius: 8px;
            margin-top: 8px;
            animation: slideIn 0.3s ease;
        }

        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .demo-badge {
            position: fixed;
            top: 10px;
            right: 10px;
            background: var(--warning);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            z-index: 100;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="7" height="9"></rect>
                <rect x="14" y="3" width="7" height="5"></rect>
                <rect x="14" y="12" width="7" height="9"></rect>
                <rect x="3" y="16" width="7" height="5"></rect>
            </svg>
            Dashboard
        </h1>
        <div class="header-actions">
            <button class="btn btn-primary" onclick="openNewTaskModal()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Nouvelle tâche
            </button>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="stat-card">
            <div class="stat-icon total">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                </svg>
            </div>
            <div class="stat-info">
                <h3 id="statTotal">0</h3>
                <p>Total tâches</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon done">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
            </div>
            <div class="stat-info">
                <h3 id="statDone">0</h3>
                <p>Terminées</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon progress">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
            </div>
            <div class="stat-info">
                <h3 id="statProgress">0</h3>
                <p>En cours</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon overdue">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
            </div>
            <div class="stat-info">
                <h3 id="statOverdue">0</h3>
                <p>En retard</p>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="card">
            <div class="card-header">
                <h2>Progression globale</h2>
            </div>
            <div class="progress-ring-container">
                <div class="progress-ring">
                    <svg width="160" height="160">
                        <circle class="bg" cx="80" cy="80" r="70"></circle>
                        <circle class="progress" cx="80" cy="80" r="70" id="progressCircle"></circle>
                    </svg>
                    <div class="center-text">
                        <div class="percentage" id="progressPercentage">0%</div>
                        <div class="label">Complété</div>
                    </div>
                </div>
                <div class="progress-legend">
                    <div class="legend-item">
                        <div class="legend-dot" style="background: var(--success)"></div>
                        <span>Terminées</span>
                        <strong id="legendDone">0</strong>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: var(--info)"></div>
                        <span>En cours</span>
                        <strong id="legendProgress">0</strong>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: var(--warning)"></div>
                        <span>En review</span>
                        <strong id="legendReview">0</strong>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: var(--border)"></div>
                        <span>À faire</span>
                        <strong id="legendTodo">0</strong>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2>Répartition par priorité</h2>
            </div>
            <div class="priority-bars">
                <div class="priority-bar">
                    <span class="priority-label">Critique</span>
                    <div class="priority-track">
                        <div class="priority-fill critical" id="priorityCritical" style="width: 0%"></div>
                    </div>
                    <span class="priority-count" id="countCritical">0</span>
                </div>
                <div class="priority-bar">
                    <span class="priority-label">Haute</span>
                    <div class="priority-track">
                        <div class="priority-fill high" id="priorityHigh" style="width: 0%"></div>
                    </div>
                    <span class="priority-count" id="countHigh">0</span>
                </div>
                <div class="priority-bar">
                    <span class="priority-label">Moyenne</span>
                    <div class="priority-track">
                        <div class="priority-fill medium" id="priorityMedium" style="width: 0%"></div>
                    </div>
                    <span class="priority-count" id="countMedium">0</span>
                </div>
                <div class="priority-bar">
                    <span class="priority-label">Basse</span>
                    <div class="priority-track">
                        <div class="priority-fill low" id="priorityLow" style="width: 0%"></div>
                    </div>
                    <span class="priority-count" id="countLow">0</span>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2>Tâches à venir</h2>
            </div>
            <div class="task-list" id="upcomingTasks">
                <div class="empty-state">Aucune tâche à venir</div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2>Performance équipe</h2>
            </div>
            <div class="team-list" id="teamList">
                <div class="empty-state">Aucune donnée équipe</div>
            </div>
        </div>
    </div>

    <!-- Modal Nouvelle Tâche -->
    <div class="modal-overlay" id="taskModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Nouvelle tâche</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="taskTitre">Titre *</label>
                    <input type="text" id="taskTitre" placeholder="Titre de la tâche">
                </div>
                <div class="form-group">
                    <label for="taskDesc">Description</label>
                    <textarea id="taskDesc" placeholder="Description..."></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="taskStatut">Statut</label>
                        <select id="taskStatut">
                            <option value="A faire">À faire</option>
                            <option value="En cours">En cours</option>
                            <option value="En review">En review</option>
                            <option value="Termine">Terminé</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="taskPriorite">Priorité</label>
                        <select id="taskPriorite">
                            <option value="1">Critique</option>
                            <option value="2">Haute</option>
                            <option value="3" selected>Moyenne</option>
                            <option value="4">Basse</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="taskDateDebut">Date début</label>
                        <input type="date" id="taskDateDebut">
                    </div>
                    <div class="form-group">
                        <label for="taskDateEcheance">Date échéance</label>
                        <input type="date" id="taskDateEcheance">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                <button class="btn btn-primary" onclick="saveTask()">Créer</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <script>
        // === Configuration ===
        const TABLE_NAME = 'Tasks';
        const TEAM_TABLE = 'Team';

        // === State ===
        let gristReady = false;
        let tasks = [];
        let team = [];
        let selectedTaskId = null;

        // === Utilities ===
        function convertGristTableToRecords(tableData) {
            if (!tableData || Array.isArray(tableData)) return tableData || [];
            const columns = Object.keys(tableData);
            if (!columns.length) return [];
            const rowCount = tableData[columns[0]]?.length || 0;
            const records = [];
            for (let i = 0; i < rowCount; i++) {
                const record = {};
                columns.forEach(col => record[col] = tableData[col][i]);
                records.push(record);
            }
            return records;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ═══════════════════════════════════════════════════════════════════
        // DATES - Conformes à la documentation Grist (secondes depuis epoch)
        // ═══════════════════════════════════════════════════════════════════
        
        /**
         * Convertit une date Grist (secondes depuis epoch) en objet JavaScript Date
         */
        function gristToDate(gristTimestamp) {
            if (gristTimestamp === null || gristTimestamp === undefined || gristTimestamp === '') {
                return null;
            }
            return new Date(gristTimestamp * 1000);
        }

        /**
         * Convertit un objet JavaScript Date en timestamp Grist (secondes)
         */
        function dateToGrist(jsDate) {
            if (!jsDate || !(jsDate instanceof Date) || isNaN(jsDate.getTime())) {
                return null;
            }
            return Math.floor(jsDate.getTime() / 1000);
        }

        /**
         * Parse une chaîne YYYY-MM-DD et retourne un timestamp Grist (secondes UTC minuit)
         */
        function parseDateToGrist(dateStr) {
            if (!dateStr) return null;
            const [year, month, day] = dateStr.split('-').map(Number);
            if (isNaN(year) || isNaN(month) || isNaN(day)) return null;
            return Math.floor(Date.UTC(year, month - 1, day) / 1000);
        }

        // Alias pour compatibilité avec le code existant
        const gristDateToJS = gristToDate;
        const jsDateToGrist = dateToGrist;

        function formatDate(date) {
            if (!date) return '';
            return new Intl.DateTimeFormat('fr-FR', { day: '2-digit', month: 'short' }).format(date);
        }

        function isOverdue(task) {
            if (task.statut === 'Termine') return false;
            const dueDate = gristDateToJS(task.dateEcheance);
            if (!dueDate) return false;
            return dueDate < new Date();
        }

        function isToday(date) {
            if (!date) return false;
            const today = new Date();
            return date.toDateString() === today.toDateString();
        }

        function getAssigneesArray(task) {
            if (task.assignees) {
                if (Array.isArray(task.assignees) && task.assignees[0] === 'L') {
                    return task.assignees.slice(1).map(Number);
                }
                if (Array.isArray(task.assignees)) {
                    return task.assignees.map(Number);
                }
            }
            if (task.assignee && typeof task.assignee === 'number') {
                return [task.assignee];
            }
            return [];
        }

        function getTeamMember(id) {
            return team.find(m => m.id === id);
        }

        function getInitials(name) {
            if (!name) return '?';
            return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // === Render ===
        function updateStats() {
            const total = tasks.length;
            const done = tasks.filter(t => t.statut === 'Termine').length;
            const inProgress = tasks.filter(t => t.statut === 'En cours').length;
            const overdue = tasks.filter(t => isOverdue(t)).length;
            const inReview = tasks.filter(t => t.statut === 'En review').length;
            const todo = tasks.filter(t => t.statut === 'A faire').length;

            document.getElementById('statTotal').textContent = total;
            document.getElementById('statDone').textContent = done;
            document.getElementById('statProgress').textContent = inProgress;
            document.getElementById('statOverdue').textContent = overdue;

            // Progress ring
            const percentage = total > 0 ? Math.round((done / total) * 100) : 0;
            document.getElementById('progressPercentage').textContent = percentage + '%';
            
            const circle = document.getElementById('progressCircle');
            const circumference = 2 * Math.PI * 70;
            circle.style.strokeDasharray = circumference;
            circle.style.strokeDashoffset = circumference - (percentage / 100) * circumference;

            document.getElementById('legendDone').textContent = done;
            document.getElementById('legendProgress').textContent = inProgress;
            document.getElementById('legendReview').textContent = inReview;
            document.getElementById('legendTodo').textContent = todo;

            // Priority bars
            const p1 = tasks.filter(t => t.priorite === 1).length;
            const p2 = tasks.filter(t => t.priorite === 2).length;
            const p3 = tasks.filter(t => t.priorite === 3).length;
            const p4 = tasks.filter(t => t.priorite === 4).length;
            const maxP = Math.max(p1, p2, p3, p4, 1);

            document.getElementById('priorityCritical').style.width = (p1 / maxP * 100) + '%';
            document.getElementById('priorityHigh').style.width = (p2 / maxP * 100) + '%';
            document.getElementById('priorityMedium').style.width = (p3 / maxP * 100) + '%';
            document.getElementById('priorityLow').style.width = (p4 / maxP * 100) + '%';

            document.getElementById('countCritical').textContent = p1;
            document.getElementById('countHigh').textContent = p2;
            document.getElementById('countMedium').textContent = p3;
            document.getElementById('countLow').textContent = p4;
        }

        function renderUpcomingTasks() {
            const container = document.getElementById('upcomingTasks');
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const upcoming = tasks
                .filter(t => {
                    if (t.statut === 'Termine') return false;
                    const dueDate = gristDateToJS(t.dateEcheance);
                    return dueDate && dueDate >= today;
                })
                .sort((a, b) => {
                    const dateA = gristDateToJS(a.dateEcheance);
                    const dateB = gristDateToJS(b.dateEcheance);
                    return dateA - dateB;
                })
                .slice(0, 5);

            if (upcoming.length === 0) {
                container.innerHTML = '<div class="empty-state">Aucune tâche à venir</div>';
                return;
            }

            container.innerHTML = upcoming.map(task => {
                const dueDate = gristDateToJS(task.dateEcheance);
                const isTodayTask = isToday(dueDate);
                const isSelected = task.id === selectedTaskId;

                return `
                    <div class="task-item${isSelected ? ' selected' : ''}" data-id="${task.id}" onclick="selectTask(${task.id})">
                        <div class="task-priority p${task.priorite || 3}"></div>
                        <div class="task-info">
                            <h4>${escapeHtml(task.titre)}</h4>
                            <p>${escapeHtml(task.statut)}</p>
                        </div>
                        <span class="task-due${isTodayTask ? ' today' : ''}">${formatDate(dueDate)}</span>
                    </div>
                `;
            }).join('');
        }

        function renderTeamPerformance() {
            const container = document.getElementById('teamList');

            if (team.length === 0) {
                container.innerHTML = '<div class="empty-state">Aucune donnée équipe</div>';
                return;
            }

            const teamStats = team.map(member => {
                const memberTasks = tasks.filter(t => {
                    const assignees = getAssigneesArray(t);
                    return assignees.includes(member.id);
                });
                const completed = memberTasks.filter(t => t.statut === 'Termine').length;
                const total = memberTasks.length;
                const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;

                return { ...member, completed, total, percentage };
            }).filter(m => m.total > 0);

            if (teamStats.length === 0) {
                container.innerHTML = '<div class="empty-state">Aucune tâche assignée</div>';
                return;
            }

            container.innerHTML = teamStats.map(member => `
                <div class="team-member">
                    <div class="member-avatar" style="background: ${member.couleur || 'var(--primary)'}">
                        ${getInitials(member.nom)}
                    </div>
                    <div class="member-info">
                        <h4>${escapeHtml(member.nom)}</h4>
                        <div class="member-progress">
                            <div class="member-bar">
                                <div class="member-bar-fill" style="width: ${member.percentage}%"></div>
                            </div>
                            <span class="member-stats">${member.completed}/${member.total}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function render() {
            updateStats();
            renderUpcomingTasks();
            renderTeamPerformance();
        }

        // === Selection Sync ===
        async function selectTask(taskId) {
            if (selectedTaskId === taskId) return;
            selectedTaskId = taskId;
            renderUpcomingTasks();

            if (gristReady) {
                try {
                    await grist.setCursorPos({ rowId: taskId });
                } catch (e) {
                    console.error('Erreur setCursorPos:', e);
                }
            }
        }

        function handleRecordSelection(record) {
            if (record && record.id && record.id !== selectedTaskId) {
                selectedTaskId = record.id;
                renderUpcomingTasks();
            }
        }

        // === Modal ===
        function openNewTaskModal() {
            document.getElementById('taskTitre').value = '';
            document.getElementById('taskDesc').value = '';
            document.getElementById('taskStatut').value = 'A faire';
            document.getElementById('taskPriorite').value = '3';
            document.getElementById('taskDateDebut').value = '';
            document.getElementById('taskDateEcheance').value = '';
            document.getElementById('taskModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('taskModal').classList.remove('active');
        }

        async function saveTask() {
            const titre = document.getElementById('taskTitre').value.trim();
            if (!titre) {
                showToast('Le titre est obligatoire', 'error');
                return;
            }

            const dateDebutStr = document.getElementById('taskDateDebut').value;
            const dateEcheanceStr = document.getElementById('taskDateEcheance').value;

            const taskData = {
                titre: titre,
                description: document.getElementById('taskDesc').value.trim(),
                statut: document.getElementById('taskStatut').value,
                priorite: parseInt(document.getElementById('taskPriorite').value),
                dateDebut: parseDateToGrist(dateDebutStr),
                dateEcheance: parseDateToGrist(dateEcheanceStr),
                progression: 0
            };

            try {
                if (gristReady) {
                    taskData.dateCreation = Date.now() / 1000;
                    const result = await grist.docApi.applyUserActions([
                        ['AddRecord', TABLE_NAME, null, taskData]
                    ]);
                    taskData.id = result.retValues[0];
                    tasks.push(taskData);
                    showToast('Tâche créée', 'success');
                } else {
                    taskData.id = Date.now();
                    tasks.push(taskData);
                    showToast('Tâche créée (demo)', 'success');
                }

                closeModal();
                render();
            } catch (e) {
                console.error('Erreur création:', e);
                showToast('Erreur de création', 'error');
            }
        }

        // === Grist Integration ===
        async function loadData() {
            try {
                const [tasksData, teamData] = await Promise.all([
                    grist.docApi.fetchTable(TABLE_NAME),
                    grist.docApi.fetchTable(TEAM_TABLE).catch(() => null)
                ]);

                tasks = convertGristTableToRecords(tasksData);
                team = teamData ? convertGristTableToRecords(teamData) : [];

                render();
            } catch (e) {
                console.error('Erreur chargement:', e);
                loadDemoData();
            }
        }

        function loadDemoData() {
            const demoBadge = document.createElement('div');
            demoBadge.className = 'demo-badge';
            demoBadge.textContent = 'Mode Demo';
            document.body.appendChild(demoBadge);

            const DAY_IN_SECONDS = 86400;
            const todayGrist = Math.floor(Date.now() / 1000);

            team = [
                { id: 1, nom: 'Alice Martin', email: 'alice@example.com', role: 'Developer', couleur: '#4f46e5' },
                { id: 2, nom: 'Bob Dupont', email: 'bob@example.com', role: 'Designer', couleur: '#10b981' },
                { id: 3, nom: 'Claire Bernard', email: 'claire@example.com', role: 'PM', couleur: '#f59e0b' }
            ];

            tasks = [
                { id: 1, titre: 'Implémenter authentification', statut: 'En cours', priorite: 1, progression: 60, assignees: ['L', 1, 2], dateDebut: todayGrist - 5 * DAY_IN_SECONDS, dateEcheance: todayGrist + 3 * DAY_IN_SECONDS },
                { id: 2, titre: 'Corriger bug pagination', statut: 'A faire', priorite: 2, progression: 0, assignees: ['L', 2], dateDebut: todayGrist, dateEcheance: todayGrist + 5 * DAY_IN_SECONDS },
                { id: 3, titre: 'Design page accueil', statut: 'En review', priorite: 3, progression: 90, assignees: ['L', 2], dateDebut: todayGrist - 10 * DAY_IN_SECONDS, dateEcheance: todayGrist + 1 * DAY_IN_SECONDS },
                { id: 4, titre: 'Optimiser requêtes SQL', statut: 'A faire', priorite: 2, progression: 0, assignees: ['L', 1], dateDebut: todayGrist + 2 * DAY_IN_SECONDS, dateEcheance: todayGrist + 8 * DAY_IN_SECONDS },
                { id: 5, titre: 'Documentation API', statut: 'Termine', priorite: 4, progression: 100, assignees: ['L', 3], dateDebut: todayGrist - 15 * DAY_IN_SECONDS, dateEcheance: todayGrist - 5 * DAY_IN_SECONDS },
                { id: 6, titre: 'Tests unitaires', statut: 'En cours', priorite: 3, progression: 45, assignees: ['L', 1], dateDebut: todayGrist - 3 * DAY_IN_SECONDS, dateEcheance: todayGrist + 7 * DAY_IN_SECONDS },
                { id: 7, titre: 'Migration base de données', statut: 'A faire', priorite: 1, progression: 0, assignees: ['L', 1, 3], dateDebut: todayGrist + 10 * DAY_IN_SECONDS, dateEcheance: todayGrist + 15 * DAY_IN_SECONDS },
                { id: 8, titre: 'Refactoring module paiement', statut: 'Termine', priorite: 2, progression: 100, assignees: ['L', 1], dateDebut: todayGrist - 20 * DAY_IN_SECONDS, dateEcheance: todayGrist - 10 * DAY_IN_SECONDS }
            ];

            render();
        }

        async function init() {
            try {
                if (typeof grist !== 'undefined') {
                    await grist.ready({
                        requiredAccess: 'full',
                        columns: ['*'],
                        allowSelectBy: true
                    });
                    gristReady = true;

                    await loadData();

                    grist.onRecords((records) => {
                        if (records) {
                            tasks = Array.isArray(records) ? records : convertGristTableToRecords(records);
                            render();
                        }
                    });

                    grist.onRecord((record) => {
                        handleRecordSelection(record);
                    });
                } else {
                    loadDemoData();
                }
            } catch (e) {
                console.error('Erreur init:', e);
                loadDemoData();
            }
        }

        document.getElementById('taskModal').addEventListener('click', (e) => {
            if (e.target.id === 'taskModal') closeModal();
        });

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>