<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gantt Timeline - TaskFlow v6</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-light: #e0e7ff;
            --primary-dark: #4338ca;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.15);
            --row-height: 44px;
            --task-list-width: 260px;
            --cell-width: 34px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
        }

        /* === HEADER === */
        .header {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            padding: 10px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
            flex-shrink: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header h1 {
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-center {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            justify-content: center;
        }
        .nav-controls {
            display: flex;
            align-items: center;
            gap: 4px;
            flex-shrink: 0;
        }
        .current-period-wrap {
            flex: 1;
            text-align: center;
            min-width: 0;
            overflow: hidden;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--card-bg);
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 0.75rem;
            transition: all 0.15s;
            color: var(--text);
        }

        .btn:hover { background: var(--bg); }
        .btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .btn.primary { background: var(--primary); color: white; border-color: var(--primary); }
        .btn-nav { padding: 6px 10px; font-size: 0.9rem; }

        .view-controls {
            display: flex;
            background: var(--bg);
            padding: 3px;
            border-radius: 6px;
            gap: 2px;
        }

        .view-controls .btn {
            border: none;
            background: transparent;
            padding: 5px 10px;
            border-radius: 4px;
        }

        .view-controls .btn.active { background: var(--primary); color: white; }

        .current-period {
            font-weight: 600;
            font-size: 0.85rem;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
        }

        .sort-selector {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
        }

        .sort-selector label { color: var(--text-muted); }

        .sort-selector select {
            padding: 5px 8px;
            border: 1px solid var(--border);
            border-radius: 5px;
            font-size: 0.75rem;
            background: var(--card-bg);
        }

        /* === FILTER BAR === */
        .filter-bar {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            padding: 6px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            flex-shrink: 0;
        }

        .filter-dropdown { position: relative; }

        .filter-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.72rem;
        }

        .filter-btn:hover { background: var(--bg); }
        .filter-btn.active { background: var(--primary-light); border-color: var(--primary); color: var(--primary); }

        .filter-menu {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 4px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            min-width: 220px;
            z-index: 500;
            display: none;
            flex-direction: column;
        }

        .filter-menu.open { display: flex; }

        .filter-search {
            padding: 8px;
            border-bottom: 1px solid var(--border);
        }
        .filter-search input {
            width: 100%;
            padding: 5px 8px;
            border: 1px solid var(--border);
            border-radius: 5px;
            font-size: 0.75rem;
            background: var(--bg);
            color: var(--text);
            box-sizing: border-box;
        }
        .filter-search input:focus { outline: none; border-color: var(--primary); }

        .filter-actions {
            display: flex;
            gap: 0;
            border-bottom: 1px solid var(--border);
        }
        .filter-action-btn {
            flex: 1;
            padding: 5px 8px;
            font-size: 0.7rem;
            color: var(--primary);
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }
        .filter-action-btn:hover { background: var(--primary-light); }
        .filter-action-btn + .filter-action-btn { border-left: 1px solid var(--border); }

        .filter-list {
            max-height: 220px;
            overflow-y: auto;
            padding: 4px 0;
        }

        .filter-option {
            padding: 6px 10px;
            cursor: pointer;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 8px;
            user-select: none;
        }
        .filter-option * { pointer-events: none; }
        .filter-option.filter-inactive { color: var(--text-muted); font-style: italic; }
        .filter-option:hover { background: var(--bg); }
        .filter-checkbox {
            width: 14px;
            height: 14px;
            border: 2px solid var(--border);
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 0.6rem;
            color: white;
            background: white;
            transition: all 0.1s;
        }
        .filter-checkbox.checked { background: var(--primary); border-color: var(--primary); }
        .filter-checkbox.checked::after { content: '‚úì'; }

        .filter-footer {
            padding: 8px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
        }
        .filter-apply-btn {
            padding: 5px 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
        }
        .filter-apply-btn:hover { opacity: 0.9; }

        .filter-option .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }


        /* === GANTT CONTAINER === */
        .gantt-container {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }

        .gantt-header {
            display: flex;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .task-list-header {
            width: var(--task-list-width);
            min-width: var(--task-list-width);
            padding: 10px 12px;
            font-weight: 600;
            border-right: 1px solid var(--border);
            background: var(--bg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.8rem;
        }

        .timeline-header {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .timeline-header-months {
            display: flex;
            background: var(--bg);
            border-bottom: 1px solid var(--border);
        }

        .month-cell {
            padding: 4px 0;
            text-align: center;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            border-right: 1px solid var(--border);
        }

        .timeline-header-days {
            display: flex;
        }

        .day-cell {
            width: var(--cell-width);
            min-width: var(--cell-width);
            padding: 6px 2px;
            text-align: center;
            font-size: 0.68rem;
            color: var(--text-muted);
            border-right: 1px solid var(--border);
            background: var(--bg);
        }

        .day-cell.weekend { background: #fef2f2; color: #ef4444; }
        .day-cell.today { background: var(--primary); color: white; font-weight: 700; }
        .day-cell.month-start { border-left: 2px solid var(--border); }

        /* === GANTT BODY === */
        .gantt-body {
            display: flex;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }

        .task-list {
            width: var(--task-list-width);
            min-width: var(--task-list-width);
            overflow-y: auto;
            border-right: 1px solid var(--border);
            background: var(--card-bg);
        }

        .task-row {
            display: flex;
            align-items: center;
            padding: 0 12px;
            border-bottom: 1px solid var(--border);
            height: var(--row-height);
            gap: 8px;
            cursor: pointer;
            transition: background 0.1s;
        }

        .task-row:hover { background: var(--bg); }
        .task-row.selected { background: var(--primary-light); }

        .task-row.sortable-ghost { opacity: 0.4; }
        .task-row.sortable-chosen { background: var(--primary-light); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

        .drag-handle {
            color: var(--text-muted);
            cursor: grab;
            opacity: 0.3;
            font-size: 0.75rem;
        }

        .task-row:hover .drag-handle { opacity: 1; }

        .task-priority-bar {
            width: 3px;
            height: 22px;
            border-radius: 2px;
        }

        .task-priority-bar.p1 { background: var(--danger); }
        .task-priority-bar.p2 { background: var(--warning); }
        .task-priority-bar.p3 { background: var(--info); }
        .task-priority-bar.p4 { background: var(--text-muted); }

        .task-info {
            flex: 1;
            min-width: 0;
        }

        .task-name {
            font-size: 0.8rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .task-name .milestone-icon { color: var(--warning); }

        .task-projet {
            font-size: 0.65rem;
            color: var(--primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 500;
            opacity: 0.85;
        }

        .task-dates {
            font-size: 0.65rem;
            color: var(--text-muted);
        }

        .task-progress-badge {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 8px;
            background: var(--bg);
            color: var(--text-muted);
            min-width: 36px;
            text-align: center;
        }

        /* === TIMELINE === */
        .timeline-body {
            flex: 1;
            overflow: auto;
            position: relative;
        }

        .timeline-grid {
            position: relative;
            min-height: 100%;
        }

        .grid-row {
            height: var(--row-height);
            border-bottom: 1px solid var(--border);
            position: relative;
            display: flex;
        }

        .grid-cell {
            width: var(--cell-width);
            min-width: var(--cell-width);
            height: 100%;
            border-right: 1px solid #f1f5f9;
        }

        .grid-cell.weekend { background: #fef2f2; }
        .grid-cell.month-start { border-left: 2px solid var(--border); }
        /* Dans la vue compact, pas de border-bottom sur les cellules de fond */
        .compact-grid .grid-cell { border-bottom: none !important; }
        .group-header-cell { background: var(--bg) !important; }
        .grid-row.group-row { background: var(--bg); border-bottom: 1px solid var(--border); }

        /* === GANTT BARS === */
        .gantt-bar {
            position: absolute;
            height: 22px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            padding: 0 6px;
            font-size: 0.65rem;
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.15);
            z-index: 10;
        }

        .gantt-bar:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
            z-index: 20;
        }

        .gantt-bar.p1 { background: linear-gradient(135deg, var(--danger), #f87171); }
        .gantt-bar.p2 { background: linear-gradient(135deg, var(--warning), #fbbf24); }
        .gantt-bar.p3 { background: linear-gradient(135deg, var(--info), #60a5fa); }
        .gantt-bar.p4 { background: linear-gradient(135deg, var(--text-muted), #94a3b8); }

        .gantt-bar.selected {
            outline: 2px solid var(--text);
            outline-offset: 1px;
            z-index: 30;
        }

        .gantt-bar.dragging { opacity: 0.7; cursor: grabbing; z-index: 100; }

        .resize-handle {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 6px;
            cursor: ew-resize;
            z-index: 10;
        }

        .resize-handle:hover { background: rgba(255,255,255,0.3); }
        .resize-handle.left { left: 0; border-radius: 4px 0 0 4px; }
        .resize-handle.right { right: 0; border-radius: 0 4px 4px 0; }

        .bar-label {
            flex: 1;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .bar-date {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.62rem;
            font-weight: 600;
            color: var(--text-muted);
            white-space: nowrap;
            pointer-events: none;
        }
        .bar-date-start { right: calc(100% + 3px); }
        .bar-date-end   { left:  calc(100% + 3px); }

        .bar-label-external {
            position: absolute;
            left: calc(100% + 6px);
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.68rem;
            color: var(--text);
            white-space: nowrap;
        }
        /* Nom apr√®s la date de fin (barres courtes) */
        .bar-label-after-end {
            position: absolute;
            /* date-end fait ~28px ‚Üí d√©caler de ~34px */
            left: calc(100% + 34px);
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.68rem;
            color: var(--text);
            white-space: nowrap;
            pointer-events: none;
        }

        .gantt-bar-progress {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: rgba(255,255,255,0.25);
            border-radius: 4px 0 0 4px;
            pointer-events: none;
        }

        /* === MILESTONES === */
        .gantt-milestone {
            position: absolute;
            cursor: pointer;
            z-index: 15;
            /* left pointe sur le centre du diamant */
            transform: translateX(-50%);
        }

        .milestone-diamond {
            width: 14px;
            height: 14px;
            transform: rotate(45deg);
            border-radius: 2px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.25);
            margin: 0 auto;
        }

        .gantt-milestone.p1 .milestone-diamond { background: var(--danger); }
        .gantt-milestone.p2 .milestone-diamond { background: var(--warning); }
        .gantt-milestone.p3 .milestone-diamond { background: var(--info); }
        .gantt-milestone.p4 .milestone-diamond { background: var(--text-muted); }

        .gantt-milestone.selected .milestone-diamond {
            outline: 2px solid var(--text);
            outline-offset: 2px;
        }

        .gantt-milestone:hover .milestone-diamond { transform: rotate(45deg) scale(1.2); }

        .milestone-label {
            font-size: 0.68rem;
            color: var(--text);
            white-space: nowrap;
            font-weight: 500;
            position: absolute;
            left: calc(100% + 4px);
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }

        .milestone-date {
            font-size: 0.62rem;
            font-weight: 600;
            color: var(--text-muted);
            white-space: nowrap;
            position: absolute;
            right: calc(100% + 4px);
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }

        /* === DEPENDENCIES SVG === */
        .dependencies-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        .dependency-line {
            fill: none;
            stroke: var(--text-muted);
            stroke-width: 1.5;
            stroke-dasharray: 4 2;
        }

        .dependency-line.highlight {
            stroke: var(--primary);
            stroke-width: 2;
            stroke-dasharray: none;
        }

        .dependency-arrow {
            fill: var(--text-muted);
        }

        .dependency-arrow.highlight {
            fill: var(--primary);
        }

        /* === TODAY LINE === */
        .today-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--danger);
            z-index: 25;
        }

        .today-line::before {
            content: "‚ñº";
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.6rem;
            color: var(--danger);
        }

        /* === LEGEND === */
        .legend {
            display: flex;
            gap: 14px;
            padding: 8px 16px;
            background: var(--card-bg);
            border-top: 1px solid var(--border);
            font-size: 0.7rem;
            align-items: center;
            flex-wrap: wrap;
            flex-shrink: 0;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-color {
            width: 10px;
            height: 10px;
            border-radius: 2px;
        }

        .legend-milestone {
            width: 8px;
            height: 8px;
            background: var(--text-muted);
            transform: rotate(45deg);
        }

        .legend-separator {
            width: 1px;
            height: 16px;
            background: var(--border);
        }

        .legend-tip {
            color: var(--text-muted);
            font-style: italic;
        }

        /* === TOOLTIP === */
        .tooltip {
            position: fixed;
            background: var(--text);
            color: white;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 0.78rem;
            z-index: 1000;
            max-width: 280px;
            box-shadow: var(--shadow-lg);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s;
        }

        .tooltip.visible { opacity: 1; }
        .tooltip-title { font-weight: 600; margin-bottom: 6px; }
        .tooltip-row { display: flex; justify-content: space-between; gap: 12px; font-size: 0.72rem; opacity: 0.9; }

        /* === MODAL === */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }

        .modal-overlay.open { opacity: 1; visibility: visible; }

        .modal {
            background: var(--card-bg);
            border-radius: 14px;
            width: 90%;
            max-width: 500px;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transform: scale(0.95);
            transition: transform 0.2s;
        }

        .modal-overlay.open .modal { transform: scale(1); }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-close {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            border: none;
            background: var(--bg);
            cursor: pointer;
            font-size: 1.1rem;
            color: var(--text-muted);
        }

        .modal-close:hover { background: var(--border); }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 14px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Form elements */
        .detail-section {
            margin-bottom: 16px;
        }

        .detail-section-title {
            font-size: 0.72rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .detail-item {
            padding: 10px 12px;
            background: var(--bg);
            border-radius: 8px;
        }

        .detail-label {
            font-size: 0.68rem;
            color: var(--text-muted);
            margin-bottom: 2px;
        }

        .detail-value {
            font-size: 0.85rem;
            font-weight: 500;
        }

        .detail-value.editable {
            cursor: pointer;
            padding: 2px 4px;
            margin: -2px -4px;
            border-radius: 4px;
        }

        .detail-value.editable:hover { background: var(--card-bg); }

        .progress-display {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-bar-large {
            flex: 1;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar-large-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 4px;
            transition: width 0.3s;
        }

        .dependency-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .dependency-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: var(--bg);
            border-radius: 6px;
            font-size: 0.8rem;
        }

        .dependency-item .arrow { color: var(--text-muted); }

        .alert-box {
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 0.78rem;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .alert-box.warning { background: #fef3c7; color: #92400e; }
        .alert-box.info { background: #dbeafe; color: #1e40af; }

        /* === PANNEAU DE DETAIL TACHE === */
        .detail-panel {
            position: fixed;
            top: 0; right: 0; bottom: 0;
            width: 380px;
            background: var(--card-bg);
            border-left: 1px solid var(--border);
            box-shadow: -4px 0 24px rgba(0,0,0,0.1);
            z-index: 490;
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.22s ease;
        }
        .detail-panel.open { transform: translateX(0); }
        .detail-panel-header {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: flex-start;
            gap: 10px;
            flex-shrink: 0;
        }
        .detail-panel-header-info { flex: 1; min-width: 0; }
        .detail-panel-titre {
            font-size: 0.95rem;
            font-weight: 700;
            line-height: 1.3;
            margin-bottom: 3px;
        }
        .detail-panel-projet { font-size: 0.72rem; color: var(--primary); font-weight: 500; }
        .detail-panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 14px 16px;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }
        .detail-panel-footer {
            padding: 12px 16px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }
        .status-pills { display: flex; gap: 6px; flex-wrap: wrap; }
        .status-pill {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.72rem;
            font-weight: 600;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.15s;
            opacity: 0.45;
        }
        .status-pill.active { opacity: 1; border-color: currentColor; }
        .status-pill:hover { opacity: 0.8; }
        .status-pill.s-todo       { background: #f1f5f9; color: #64748b; }
        .status-pill.s-inprogress { background: #eff6ff; color: #3b82f6; }
        .status-pill.s-review     { background: #fefce8; color: #ca8a04; }
        .status-pill.s-done       { background: #f0fdf4; color: #16a34a; }
        .prog-slider-wrap { display: flex; align-items: center; gap: 10px; }
        .prog-slider-wrap input[type=range] { flex: 1; accent-color: var(--primary); }
        .prog-value { font-size: 0.8rem; font-weight: 700; min-width: 36px; text-align: right; }
        .date-fields { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .field-group label {
            display: block;
            font-size: 0.67rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        .field-group input[type=date],
        .field-group input[type=text],
        .field-group select,
        .field-group textarea {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.8rem;
            background: var(--bg);
            color: var(--text);
            box-sizing: border-box;
        }
        .field-group input:focus, .field-group select:focus, .field-group textarea:focus {
            outline: none; border-color: var(--primary);
        }
        .field-group textarea { resize: vertical; min-height: 60px; }
        .assignee-list { display: flex; flex-direction: column; gap: 5px; }
        /* Widget filtre panel (responsables + d√©pendances) */
        .panel-filter-widget {
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
            margin-top: 4px;
        }
        .panel-filter-search {
            width: 100%;
            box-sizing: border-box;
            padding: 5px 8px;
            border: none;
            border-bottom: 1px solid var(--border);
            background: var(--bg);
            color: var(--text);
            font-size: 0.72rem;
            outline: none;
        }
        .panel-filter-list {
            max-height: 140px;
            overflow-y: auto;
        }
        .panel-filter-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            font-size: 0.72rem;
            cursor: pointer;
            border-bottom: 1px solid var(--border-light, var(--border));
        }
        .panel-filter-item:last-child { border-bottom: none; }
        .panel-filter-item:hover { background: var(--hover); }
        .panel-filter-item input[type=checkbox] { cursor: pointer; flex-shrink: 0; }
        .panel-filter-item.inactive { color: var(--text-muted); font-style: italic; }

        .dep-pred-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .dep-remove-btn {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            font-size: 0.7rem;
            padding: 0 2px;
            line-height: 1;
            flex-shrink: 0;
        }
        .dep-remove-btn:hover { opacity: 0.7; }

        .assignee-item {
            display: flex; align-items: center; gap: 8px;
            padding: 5px 8px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;
        }
        .assignee-item:hover { background: var(--bg); }
        .assignee-item input[type=checkbox] { accent-color: var(--primary); }
        .panel-section-title {
            font-size: 0.67rem; font-weight: 700; text-transform: uppercase;
            color: var(--text-muted); letter-spacing: 0.05em;
            margin-bottom: 8px;
        }
        .info-row {
            display: flex; justify-content: space-between;
            align-items: center; font-size: 0.8rem; padding: 3px 0;
        }
        .info-row .lbl { color: var(--text-muted); font-size: 0.72rem; }
        .retard-badge {
            background: #fef2f2; color: #dc2626; border: 1px solid #fecaca;
            border-radius: 6px; padding: 6px 10px; font-size: 0.75rem; font-weight: 500;
        }

        /* === PANNEAU DE CONFIGURATION === */

        .config-panel {
            position: fixed;
            top: 0; right: 0; bottom: 0;
            width: 360px;
            background: var(--card-bg);
            border-left: 1px solid var(--border);
            box-shadow: -4px 0 20px rgba(0,0,0,0.12);
            z-index: 500;
            display: flex;
            flex-direction: column;
            transform: translateX(100%);
            transition: transform 0.25s ease;
        }

        .config-panel.open { transform: translateX(0); }

        .config-panel-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .config-panel-title {
            font-size: 0.95rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .config-panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 16px 20px;
        }

        .config-panel-footer {
            padding: 14px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            flex-shrink: 0;
        }

        .config-section {
            margin-bottom: 20px;
        }

        .config-section-title {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-muted);
            letter-spacing: 0.05em;
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--border);
        }

        .config-field {
            margin-bottom: 10px;
        }

        .config-field label {
            display: block;
            font-size: 0.72rem;
            color: var(--text-muted);
            margin-bottom: 4px;
            font-weight: 500;
        }

        .config-field input {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.8rem;
            background: var(--bg);
            color: var(--text);
            transition: border-color 0.15s;
        }

        .config-field input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .config-field input.changed {
            border-color: var(--warning);
            background: #fffbeb;
        }

        .config-info {
            font-size: 0.7rem;
            color: var(--text-muted);
            background: var(--bg);
            border-radius: 6px;
            padding: 8px 10px;
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .config-info strong { color: var(--primary); }

        .config-reset-link {
            font-size: 0.7rem;
            color: var(--text-muted);
            cursor: pointer;
            text-decoration: underline;
            text-decoration-style: dotted;
        }

        .config-reset-link:hover { color: var(--danger); }

        .config-panel-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 499;
            display: none;
        }

        .config-panel.open ~ .config-panel-overlay,
        .config-panel-overlay.visible { display: block; }

        /* === LAYOUT MODE SWITCHER === */
        .layout-controls {
            display: flex;
            gap: 2px;
            background: var(--bg);
            border-radius: 8px;
            padding: 3px;
            border: 1px solid var(--border);
        }
        .layout-btn {
            padding: 4px 10px;
            border-radius: 5px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 0.72rem;
            font-weight: 600;
            color: var(--text-muted);
            transition: all 0.15s;
            white-space: nowrap;
        }
        .layout-btn.active {
            background: var(--card-bg);
            color: var(--text);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .layout-btn:hover:not(.active) { color: var(--text); }

        /* === VUE COMPACTE === */
        .compact-row {
            display: flex;
            align-items: stretch;
            border-bottom: 1px solid var(--border);
            position: relative;
        }
        .compact-label {
            width: var(--task-list-width);
            min-width: var(--task-list-width);
            padding: 6px 12px;
            border-right: 1px solid var(--border);
            background: var(--card-bg);
            display: flex;
            flex-direction: column;
            justify-content: center;
            cursor: pointer;
            transition: background 0.12s;
            flex-shrink: 0;
            box-sizing: border-box;
        }
        .compact-label:hover { background: var(--bg); }
        .compact-label.selected { background: var(--primary-light); }
        .compact-label-nom {
            font-size: 0.78rem;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.3;
        }
        .compact-label-meta {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-top: 3px;
            line-height: 1.2;
            white-space: nowrap;
        }
        .compact-timeline {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        .compact-bar {
            position: absolute;
            height: 20px;
            top: 50%;
            transform: translateY(-50%);
            border-radius: 3px;
            opacity: 1;
            cursor: pointer;
            transition: filter 0.15s;
            display: flex;
            align-items: center;
            padding: 0 5px;
            overflow: hidden;
            filter: brightness(0.92) saturate(0.95);
        }
        .compact-bar:hover { filter: brightness(1.05) saturate(1.1); z-index: 2; }
        .compact-bar-label {
            font-size: 0.62rem;
            font-weight: 600;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        .compact-today-line {
            position: absolute;
            top: 0; bottom: 0;
            width: 2px;
            background: var(--danger);
            opacity: 0.7;
            z-index: 3;
            pointer-events: none;
        }

        /* Vue projet unique ‚Äî liste gauche cliquable */
        .project-item {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.12s;
        }
        .project-item:hover { background: var(--bg); }
        .project-item.selected { background: var(--primary-light); border-left: 3px solid var(--primary); }
        .project-item-nom { font-size: 0.8rem; font-weight: 600; }
        .project-item-meta { font-size: 0.65rem; color: var(--text-muted); margin-top: 2px; }

        /* === TOAST === */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
        }

        .toast {
            padding: 10px 16px;
            background: var(--text);
            color: white;
            border-radius: 6px;
            margin-top: 6px;
            font-size: 0.8rem;
            animation: slideIn 0.3s ease;
        }

        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* === DEMO === */
        .demo-badge {
            position: fixed;
            top: 8px;
            right: 8px;
            background: var(--warning);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 600;
            z-index: 100;
        }

        /* === RESPONSIVE === */
        @media (max-width: 900px) {
            :root { --task-list-width: 200px; --cell-width: 28px; }
            .header { flex-direction: column; align-items: stretch; }
            .header-center { justify-content: center; }
        }

        @media (max-width: 600px) {
            :root { --task-list-width: 140px; --cell-width: 24px; }
            .task-name { font-size: 0.72rem; }
            .task-dates { display: none; }
            .task-progress-badge { display: none; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <h1>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="4" y1="6" x2="20" y2="6"></line>
                    <line x1="4" y1="12" x2="14" y2="12"></line>
                    <line x1="4" y1="18" x2="18" y2="18"></line>
                </svg>
                Gantt
            </h1>
            <div class="layout-controls">
                <button class="layout-btn active" data-layout="multi" onclick="setLayoutMode('multi')" title="Vue multi-projets d√©taill√©e">Multi</button>
                <button class="layout-btn" data-layout="compact" onclick="setLayoutMode('compact')" title="Vue compacte ‚Äî 1 ligne par projet">Compact</button>
                <button class="layout-btn" data-layout="single" onclick="setLayoutMode('single')" title="Vue d√©taill√©e d'un projet">Projet</button>
            </div>
            <div class="sort-selector" id="sortSelectorWrap">
                <label>Tri:</label>
                <select id="sortSelect" onchange="changeSortMode(this.value)">
                    <option value="priority">Priorit√©</option>
                    <option value="date" selected>Date</option>
                    <option value="manual">Manuel</option>
                </select>
            </div>
        </div>
        <div class="header-center">
            <div class="nav-controls">
                <button class="btn btn-nav" onclick="navigate(-1)">‚óÄ</button>
                <button class="btn" onclick="goToToday()">Auj.</button>
                <button class="btn btn-nav" onclick="navigate(1)">‚ñ∂</button>
            </div>
            <div class="view-controls">
                <button class="btn" data-view="week" onclick="setView('week')">Sem</button>
                <button class="btn active" data-view="month" onclick="setView('month')">Mois</button>
                <button class="btn" data-view="sem6" onclick="setView('sem6')">Sem.</button>
                <button class="btn" data-view="year" onclick="setView('year')">1 An</button>
                <button class="btn" data-view="three" onclick="setView('three')">3 Ans</button>
            </div>
            <div class="current-period-wrap">
                <span class="current-period" id="currentPeriod"></span>
            </div>
        </div>
        <div class="header-right">
            <button class="btn primary" onclick="openCreateModal()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                T√¢che
            </button>
            <button class="btn" id="configBtn" onclick="openConfigPanel()" title="Configuration des tables et colonnes">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
                Tables
            </button>
        </div>
    </div>

    <!-- Panneau de configuration des tables/colonnes -->
    <aside class="config-panel" id="configPanel">
        <div class="config-panel-header">
            <div class="config-panel-title">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
                Configuration des tables
            </div>
            <button class="modal-close" onclick="closeConfigPanel()">√ó</button>
        </div>

                <div class="config-panel-body">
            <div class="config-info">
                Ces param√®tres sont <strong>persist√©s dans le document Grist</strong>.
                Les colonnes de <strong>Tasks</strong> se configurent via le panneau
                <strong>"Colonnes"</strong> du widget (ic√¥ne en haut √† droite).
            </div>

            <!-- Table Responsables -->
            <div class="config-section">
                <div class="config-section-title">üë• Table responsables</div>
                <div class="config-field">
                    <label>Table</label>
                    <select id="cfg-tableChefProjet" onchange="onTableSelect(this, 'chef')"></select>
                </div>
                <div class="config-field">
                    <label>Nom complet affich√©</label>
                    <select id="cfg-colChefNom" data-group="chef"></select>
                </div>
                <div class="config-field">
                    <label>Fonction</label>
                    <select id="cfg-colChefFonction" data-group="chef"></select>
                </div>
                <div class="config-field">
                    <label>Actif (bool√©en)</label>
                    <select id="cfg-colChefActif" data-group="chef"></select>
                </div>
            </div>

            <!-- Table Op√©rations -->
            <div class="config-section">
                <div class="config-section-title">üìÅ Table op√©rations</div>
                <div class="config-field">
                    <label>Table</label>
                    <select id="cfg-tableOperations" onchange="onTableSelect(this, 'ops')"></select>
                </div>
                <div class="config-field">
                    <label>Nom op√©ration</label>
                    <select id="cfg-colOpsNom" data-group="ops"></select>
                </div>
                <div class="config-field">
                    <label>Num√©ro op√©ration</label>
                    <select id="cfg-colOpsNumOpe" data-group="ops"></select>
                </div>
                <div class="config-field">
                    <label>Statut</label>
                    <select id="cfg-colOpsStatut" data-group="ops"></select>
                </div>
            </div>

            <!-- Table Phases / Cat√©gories -->
            <div class="config-section">
                <div class="config-section-title">üè∑Ô∏è Table cat√©gories de phases</div>
                <div class="config-field">
                    <label>Table</label>
                    <select id="cfg-tablePhases" onchange="onTableSelect(this, 'phases')"></select>
                </div>
                <div class="config-field">
                    <label>Nom avec num√©ro (affich√© sur le gantt)</label>
                    <select id="cfg-colPhasesNomOrder" data-group="phases"></select>
                </div>
                <div class="config-field">
                    <label>Nom court</label>
                    <select id="cfg-colPhasesNom" data-group="phases"></select>
                </div>
                <div class="config-field">
                    <label>Couleur (hex)</label>
                    <select id="cfg-colPhasesCouleur" data-group="phases"></select>
                </div>
                <div class="config-field">
                    <label>Num√©ro d'ordre</label>
                    <select id="cfg-colPhasesNumOrder" data-group="phases"></select>
                </div>
            </div>

            <span class="config-reset-link" onclick="resetConfigToDefaults()">
                ‚Ü∫ R√©tablir les valeurs par d√©faut
            </span>
        </div>
        <div class="config-panel-footer">
            <button class="btn" onclick="closeConfigPanel()">Annuler</button>
            <button class="btn primary" onclick="saveConfig()">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                Enregistrer
            </button>
        </div>
    </aside>
    <div class="config-panel-overlay" id="configOverlay" onclick="closeConfigPanel()"></div>

    <div class="filter-bar">
        <div class="filter-dropdown" id="filterProject">
            <button class="filter-btn" id="filterProjectBtn" data-filter-toggle="filterProject">
                <span id="filterProjectLabel">Projet ‚ñæ</span>
            </button>
            <div class="filter-menu" id="filterProjectMenu">
                <div class="filter-search"><input type="text" placeholder="Rechercher..." id="filterProjectSearch"></div>
                <div class="filter-actions">
                    <button class="filter-action-btn" data-filter-action="all" data-filter-type="projects">Tout</button>
                    <button class="filter-action-btn" data-filter-action="none" data-filter-type="projects">Aucun</button>
                </div>
                <div class="filter-list" id="filterProjectList"></div>
                <div class="filter-footer"><button class="filter-apply-btn" data-filter-apply="filterProject">OK</button></div>
            </div>
        </div>
        <div class="filter-dropdown" id="filterAssignee">
            <button class="filter-btn" id="filterAssigneeBtn" data-filter-toggle="filterAssignee">
                <span id="filterAssigneeLabel">Responsable ‚ñæ</span>
            </button>
            <div class="filter-menu" id="filterAssigneeMenu">
                <div class="filter-search"><input type="text" placeholder="Rechercher..." id="filterAssigneeSearch"></div>
                <div class="filter-actions">
                    <button class="filter-action-btn" data-filter-action="all" data-filter-type="assignees">Tout</button>
                    <button class="filter-action-btn" data-filter-action="none" data-filter-type="assignees">Aucun</button>
                </div>
                <div class="filter-list" id="filterAssigneeList"></div>
                <div class="filter-footer"><button class="filter-apply-btn" data-filter-apply="filterAssignee">OK</button></div>
            </div>
        </div>
    </div>

    <div class="gantt-container">
        <div class="gantt-header">
            <div class="task-list-header">
                <span id="listHeaderLabel">T√¢ches</span>
                <span id="sortInfo" style="font-size: 0.65rem; color: var(--text-muted); font-weight: normal;">Par date</span>
            </div>
            <div class="timeline-header" id="timelineHeaderWrapper">
                <div class="timeline-header-months" id="timelineMonths"></div>
                <div class="timeline-header-days" id="timelineHeader"></div>
            </div>
        </div>
        <div class="gantt-body" id="ganttBody">
            <div class="task-list" id="taskList"></div>
            <div class="timeline-body" id="timelineBody">
                <div class="timeline-grid" id="timelineGrid"></div>
            </div>
        </div>
        <!-- Vue compact : conteneur s√©par√©, affich√© seulement en mode compact -->
        <div id="compactView" style="display:none;flex:1;min-height:0;overflow-y:auto;overflow-x:auto;position:relative;"></div>
    </div>

    <div class="legend">
        <div class="legend-item"><div class="legend-color" style="background: var(--danger)"></div>Critique</div>
        <div class="legend-item"><div class="legend-color" style="background: var(--warning)"></div>Haute</div>
        <div class="legend-item"><div class="legend-color" style="background: var(--info)"></div>Moyenne</div>
        <div class="legend-item"><div class="legend-color" style="background: var(--text-muted)"></div>Basse</div>
        <div class="legend-separator"></div>
        <div class="legend-item"><div class="legend-milestone"></div>Jalon</div>
        <div class="legend-separator"></div>
        <span class="legend-tip">Glissez ‚Ä¢ Redimensionnez ‚Ä¢ Double-clic</span>
    </div>

    <div class="tooltip" id="tooltip">
        <div class="tooltip-title"></div>
        <div class="tooltip-row"><span>D√©but:</span><span class="tooltip-start"></span></div>
        <div class="tooltip-row"><span>√âch√©ance:</span><span class="tooltip-end"></span></div>
        <div class="tooltip-row tt-duree-row" style="display:none"><span>Dur√©e:</span><span class="tooltip-duree"></span></div>
        <div class="tooltip-row"><span>Progression:</span><span class="tooltip-progress"></span></div>
    </div>

    <!-- Task Detail Modal -->
    <!-- Panneau de detail tache (clic simple) -->
    <aside class="detail-panel" id="detailPanel" onclick="event.stopPropagation()">
        <div class="detail-panel-header">
            <div class="detail-panel-header-info">
                <div class="detail-panel-titre" id="dp-titre">‚Äî</div>
                <div class="detail-panel-projet" id="dp-projet"></div>
            </div>
            <button class="modal-close" onclick="closeDetailPanel()">√ó</button>
        </div>
        <div class="detail-panel-body" id="dp-body"></div>
        <div class="detail-panel-footer">
            <button class="btn" style="flex:1" onclick="editInGrist()">Ouvrir dans Grist</button>
            <button class="btn primary" style="flex:1" id="dp-save-btn" onclick="saveDetailPanel()">Enregistrer</button>
        </div>
    </aside>


    <!-- Modal creation tache -->
    <div class="modal-overlay" id="createModal">
        <div class="modal" style="max-width:520px">
            <div class="modal-header">
                <div class="modal-title">+ Nouvelle phase</div>
                <button class="modal-close" onclick="closeCreateModal()">√ó</button>
            </div>
            <div class="modal-body" style="max-height:75vh;overflow-y:auto;">
                <div style="display:flex;flex-direction:column;gap:14px;">
                    <div class="field-group">
                        <label>Phase *</label>
                        <select id="create-titre"></select>
                    </div>
                    <div class="field-group" id="create-projet-wrap">
                        <label>Op√©ration</label>
                        <div id="create-projet-label" style="font-size:0.8rem;padding:4px 0;color:var(--text);"></div>
                    </div>
                    <div class="date-fields">
                        <div class="field-group">
                            <label>Date d√©but</label>
                            <input type="date" id="create-dateDebut" />
                        </div>
                        <div class="field-group">
                            <label>Dur√©e</label>
                            <input type="text" id="create-duree" placeholder="ex: 3m, 45j, 1a 6m" style="width:130px;">
                        </div>
                    </div>
                    <div class="date-fields">
                        <div class="field-group">
                            <label>Type</label>
                            <select id="create-type" onchange="onCreateTypeChange(this.value)">
                                <option value="tache">T√¢che</option>
                                <option value="jalon">Jalon ‚óÜ</option>
                            </select>
                        </div>
                        <div class="field-group">
                            <label>Statut</label>
                            <select id="create-statut">
                                <option value="todo">A faire</option>
                                <option value="inprogress">En cours</option>
                                <option value="review">En revue</option>
                                <option value="done">Termin√©</option>
                            </select>
                        </div>
                    </div>
                    <div class="field-group">
                        <label>Responsables</label>
                        <div class="panel-filter-widget" id="create-chef-widget">
                            <input class="panel-filter-search" id="create-chef-search" placeholder="Rechercher‚Ä¶">
                            <div class="panel-filter-list" id="create-chef-list"></div>
                        </div>
                    </div>
                    <div class="field-group">
                        <label>Pr√©d√©cesseurs</label>
                        <div class="panel-filter-widget" id="create-pred-widget">
                            <input class="panel-filter-search" id="create-pred-search" placeholder="Rechercher‚Ä¶">
                            <div class="panel-filter-list" id="create-pred-list"></div>
                        </div>
                    </div>
                    <div class="field-group">
                        <label>Description</label>
                        <textarea id="create-description" rows="2" style="resize:vertical;"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeCreateModal()">Annuler</button>
                <button class="btn primary" onclick="submitCreateTask()">Cr√©er la phase</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CONFIGURATION GRIST
        // Noms de tables et colonnes par d√©faut.
        // ‚Ä¢ Les colonnes Tasks sont mappables via le panneau "Colonnes" de Grist
        //   (d√©clar√©es dans grist.ready({ columns })).
        // ‚Ä¢ Les noms des tables secondaires (Team, Projects) sont configurables
        //   via le panneau "Options du widget" de Grist (grist.setOptions /
        //   grist.onOptions). Les valeurs ci-dessous sont les d√©fauts utilis√©s
        //   si aucune option n'a encore √©t√© enregistr√©e.
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const GRIST_CONFIG = {
            // Noms des tables Grist ‚Äî d√©fauts modifiables via Widget Options
            tables: {
                tasks:      'Tasks',
                responsableProjet: 'DPPI_Chef_Projet',
                operations: 'DPPI_Operations',
                phases:     'PL_Liste_Phases'
            },
            // Noms des colonnes par d√©faut (√©cras√©s par le mappage Grist)
            columns: {
                tasks: {
                    // Noms LOGIQUES : correspondent exactement aux 'name' dans grist.ready columns.
                    // fetchSelectedTable() retourne les donn√©es avec ces cl√©s, quel que soit
                    // le nom physique de la colonne dans Grist.
                    titre:        'titre',
                    description:  'description',
                    dateDebut:    'dateDebut',
                    dateEcheance: 'dateEcheance',
                    priorite:     'priorite',
                    statut:       'statut',
                    progression:  'progression',
                    projet:       'projet',
                    assignees:    'assignees',
                    type:         'type',
                    dependDe:     'dependDe',
                    tags:         'tags',
                    estimationH:  'estimationH',
                    tempsPasse:   'tempsPasse',
                    couleur:      'couleur',
                    duree:        'duree',
                    dateDebutCalc:'dateDebutCalc',
                    dateFinCalc:  'dateFinCalc'
                },
                responsableProjet: {
                    nom:      'Prenom_Nom',  // Nom complet affich√©
                    prenom:   'Prenom',
                    nomFamille:'Nom',
                    fonction: 'Fonction',
                    actif:    'Actif'
                },
                operations: {
                    nom:     'Nom_Ope',     // Nom de l'op√©ration
                    numOpe:  'Num_Ope',
                    statut:  'Statut_Ope',
                    exercice:'Exercice'
                },
                phases: {
                    nom:      'Nom',        // Nom court
                    nomOrder: 'Nom_Order',  // Nom complet avec num√©ro (ex: "103 - Programme")
                    couleur:  'Couleur',    // Couleur hex de la cat√©gorie
                    numOrder: 'Num_Order'   // Num√©ro pour le tri
                }
            }
        };

        // COL ‚Äî noms physiques r√©els des colonnes Tasks.
        // Initialis√© avec les d√©fauts, mis √† jour dynamiquement par onRecords(mappings).
        // Usage dans le code : t[COL.titre], t[COL.dateDebut], etc.
        let COL = { ...GRIST_CONFIG.columns.tasks };

        // Noms des colonnes des tables secondaires.
        let COL_CHEF     = { ...GRIST_CONFIG.columns.responsableProjet };
        let COL_OPS      = { ...GRIST_CONFIG.columns.operations };
        let COL_PHASES   = { ...GRIST_CONFIG.columns.phases };

        // TABLE ‚Äî noms physiques des tables.
        // Mis √† jour via grist.onOptions() quand l'utilisateur configure le widget.
        let TABLE = { ...GRIST_CONFIG.tables };

        // Donn√©es des tables secondaires charg√©es en m√©moire
        let phases = [];  // PL_Liste_Phases

        // R√©solution des Refs Grist
        // fetchTable() retourne l'ID num√©rique pour les colonnes Ref.
        // Ces fonctions font la r√©solution ID ‚Üí valeur affichable.
        const resolvePhaseNom      = (id) => phases.find(x => x.id === id)?.[COL_PHASES.nomOrder] || String(id || '');

        // Retourne true si la t√¢che a au moins un pr√©d√©cesseur (dependDe non vide)
        function hasPredecesseurs(t) {
            const dd = t?.[COL.dependDe];
            if (!dd) return false;
            if (Array.isArray(dd)) return dd.length > 0 && !(dd.length === 1 && dd[0] === 'L');
            return true;
        }

        // Date de d√©but effective : Date_Debut_Calculee si pr√©d√©cesseurs, sinon dateDebut
        function getEffectiveStart(t) {
            if (hasPredecesseurs(t) && t[COL.dateDebutCalc]) {
                return gristToDate(t[COL.dateDebutCalc]);
            }
            return gristToDate(t[COL.dateDebut]);
        }

        // Date de fin effective : Date_Fin_Calculee si disponible, sinon dateEcheance
        function getEffectiveEnd(t) {
            if (t[COL.dateFinCalc]) return gristToDate(t[COL.dateFinCalc]);
            return gristToDate(t[COL.dateEcheance]);
        }
        const resolvePhaseNomCourt = (id) => phases.find(x => x.id === id)?.[COL_PHASES.nom]      || resolvePhaseNom(id);
        const resolvePhaseCouleur = (id) => phases.find(x => x.id === id)?.[COL_PHASES.couleur]  || null;
        const resolveOpsNom       = (id, ops) => ops.find(x => x.id === id)?.[COL_OPS.nom]       || String(id || '');
        const resolveResponsableNom      = (id, team) => team.find(x => x.id === id)?.[COL_CHEF.nom]    || String(id || '');

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CONFIGURATION VUE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // cellWidth = largeur d'une cellule en px (densit√©).
        // Le NOMBRE de cellules est calcul√© dynamiquement dans getViewCellCount()
        // pour remplir exactement la largeur disponible du conteneur timeline.
        const VIEW_CONFIG = {
            week:    { label: 'Semaine',   unit: 'day',   cellWidth: 80, navStep: 7,         minCells: 7  },
            month:   { label: 'Mois',      unit: 'day',   cellWidth: 28, navStep: 'month',   minCells: 28 },
            sem6:    { label: 'Semestre',  unit: 'sem6',  cellWidth: 90, navStep: 'sem6',    minCells: 6  },
            year:    { label: 'Annee',     unit: 'month', cellWidth: 55, navStep: 'year',    minCells: 12 },
            three:   { label: '3 ans',     unit: 'month', cellWidth: 28, navStep: 'year',    minCells: 36 }
        };

        // Retourne le nombre de cellules qui remplissent la largeur disponible,
        // en garantissant un minimum de minCells.
        function getViewCellCount() {
            const cfg = VIEW_CONFIG[currentView];
            const containerId = layoutMode === 'compact' ? 'compactView' : 'timelineBody';
            const container = document.getElementById(containerId);
            const LW = layoutMode === 'compact' ? 260 : 0;
            const availWidth = container ? (container.clientWidth || 800) - LW : 800;
            const count = Math.floor(availWidth / cfg.cellWidth);
            return Math.max(count, cfg.minCells);
        }

        const PRIORITY_LABELS = { 1: 'Critique', 2: 'Haute', 3: 'Moyenne', 4: 'Basse' };
        const PRIORITY_COLORS = { 1: '#ef4444', 2: '#f59e0b', 3: '#3b82f6', 4: '#64748b' };
        const MONTHS = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
        const MONTHS_SHORT = ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Ao√ªt', 'Sep', 'Oct', 'Nov', 'D√©c'];
        const DAYS_SHORT = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // STATE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let gristReady = false;
        let tasks = [];
        let team = [];      // DPPI_Chef_Projet
        let projects = [];  // DPPI_Operations

        // Modes de layout : 'multi' (d√©faut), 'compact', 'single'
        let layoutMode = 'compact';
        // En mode 'single' : ID de l'op√©ration s√©lectionn√©e (null = toutes)
        let selectedProjectId = null;
        let currentView = 'month';
        let viewStartDate = new Date();
        let selectedTaskId = null;
        let lastRenderedRows = null; // derni√®re allRows pass√©e √† renderTimeline
        let sortMode = 'date';
        let sortableInstance = null;
        let filters = { projects: null, assignees: null }; // null=tout, []=aucun, [ids]=filtre

        let dragState = {
            active: false, type: null, taskId: null,
            startX: 0, originalLeft: 0, originalWidth: 0,
            originalStart: null, originalEnd: null
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // UTILITIES
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const escapeHtml = (t) => { if (!t) return ''; const d = document.createElement('div'); d.textContent = t; return d.innerHTML; };
        const gristToDate = (ts) => { if (ts == null || ts === '') return null; const n = Number(ts); return isNaN(n) ? null : new Date(n * 1000); };
        const dateToGrist = (d) => d ? Math.floor(d.getTime() / 1000) : null;
        const formatDate = (d) => d ? new Intl.DateTimeFormat('fr-FR', { day: '2-digit', month: 'short', year: 'numeric' }).format(d) : '-';
        const formatDateShort = (d) => d ? new Intl.DateTimeFormat('fr-FR', { day: '2-digit', month: 'short' }).format(d) : '-';
        const formatDateBar   = (d) => d ? String(d.getDate()).padStart(2,'0') + '/' + String(d.getMonth()+1).padStart(2,'0') : '';

        // Parse une saisie libre de dur√©e ‚Üí jours
        // Ex: "3,5 ans" ‚Üí 1278, "18 mois" ‚Üí 547, "2a 3m" ‚Üí 821
        function parseDureeInput(str) {
            if (!str) return null;
            str = str.toString().trim().replace(',', '.').toLowerCase();
            // Essai direct : nombre seul ‚Üí jours
            if (/^\d+(\.\d+)?$/.test(str)) return Math.round(parseFloat(str));
            let jours = 0;
            // Patterns : (nombre)(unit√©)
            const patterns = [
                { re: /(\d+(?:\.\d+)?)\s*(?:a(?:n(?:s|n√©e?s?)?)?|y(?:ears?)?)/, mult: 365 },
                { re: /(\d+(?:\.\d+)?)\s*(?:m(?:ois|o(?:nths?)?)?)/, mult: 30 },
                { re: /(\d+(?:\.\d+)?)\s*(?:s(?:em(?:aines?)?|em)?|w(?:eeks?)?)/, mult: 7 },
                { re: /(\d+(?:\.\d+)?)\s*(?:j(?:ours?)?|d(?:ays?)?)/, mult: 1 },
            ];
            let matched = false;
            patterns.forEach(({ re, mult }) => {
                const m = str.match(re);
                if (m) { jours += Math.round(parseFloat(m[1]) * mult); matched = true; }
            });
            return matched ? Math.max(1, jours) : null;
        }

        // Formate des jours en texte lisible : "1a 6m", "3m 2s", "5j"
        function formatDureeTexte(jours) {
            if (!jours || jours <= 0) return '';
            const ans  = Math.floor(jours / 365);
            let reste  = jours - ans * 365;
            const mois = Math.floor(reste / 30);
            reste     -= mois * 30;
            const sem  = Math.floor(reste / 7);
            const j    = reste % 7;
            const parts = [];
            if (ans  > 0) parts.push(ans  + ' an'  + (ans  > 1 ? 's' : ''));
            if (mois > 0) parts.push(mois + ' mois');
            if (sem  > 0) parts.push(sem  + ' sem');
            if (j    > 0) parts.push(j    + ' j');
            return parts.slice(0, 3).join(' ');
        }

        function formatDureeBar(jours) {
            if (!jours || jours <= 0) return '';
            const ans   = Math.floor(jours / 365);
            const reste = jours % 365;
            const mois  = Math.floor(reste / 30);
            const r2    = reste % 30;
            const sem   = Math.floor(r2 / 7);
            const j     = r2 % 7;
            const parts = [];
            if (ans > 0)  parts.push(ans  + 'a');
            if (mois > 0) parts.push(mois + 'm');
            if (sem > 0)  parts.push(sem  + 's');
            if (j > 0)    parts.push(j    + 'j');
            // N'afficher que les 2 premi√®res unit√©s significatives
            return parts.slice(0, 2).join(' ');
        }
        const isWeekend = (d) => d.getDay() === 0 || d.getDay() === 6;
        const isSameDay = (a, b) => a.toDateString() === b.toDateString();
        const getDaysDiff = (a, b) => Math.round((b - a) / 86400000);
        const addDays = (d, n) => { const r = new Date(d); r.setDate(r.getDate() + n); return r; };
        const getTaskPriority = (t) => { const p = Number(t?.[COL.priorite]); return (p >= 1 && p <= 4) ? p : 3; };
        const isJalon = (t) => t?.[COL.type] === 'jalon' || t?.[COL.duree] === 0 || (getEffectiveStart(t)?.toDateString() === getEffectiveEnd(t)?.toDateString());

        function getAssigneesArray(t) {
            const val = t?.[COL.assignees];
            if (!val) return [];
            if (Array.isArray(val)) return val[0] === 'L' ? val.slice(1).map(Number) : val.map(Number);
            return [];
        }

        function getInitials(n) { return n ? n.split(' ').map(x => x[0]).join('').toUpperCase().slice(0, 2) : '?'; }

        // R√©solution du titre d'une t√¢che : la colonne titre est une Ref vers PL_Liste_Phases.
        // Nom court (Nom) ‚Äî pour les barres, tooltip, menu contextuel
        function getTaskTitre(t) {
            const val = t[COL.titre];
            if (!val) return '';
            if (typeof val === 'number' || (typeof val === 'string' && /^\d+$/.test(val))) {
                return resolvePhaseNomCourt(Number(val));
            }
            return String(val);
        }

        // Nom long avec num√©ro (Nom_Order) ‚Äî pour la liste gauche et le tri
        function getTaskTitreOrder(t) {
            const val = t[COL.titre];
            if (!val) return '';
            if (typeof val === 'number' || (typeof val === 'string' && /^\d+$/.test(val))) {
                return resolvePhaseNom(Number(val));
            }
            return String(val);
        }

        // Couleur de la barre : issue de PL_Liste_Phases via la Ref titre,
        // ou de la colonne couleur directe si pr√©sente.
        function getTaskCouleur(t) {
            // La couleur vient de PL_Liste_Phases via la Ref titre ‚Üí PL_Liste_Phases.Couleur
            const phaseId = t._phaseId ?? (() => {
                const val = t[COL.titre];
                return (typeof val === 'number') ? val :
                       (typeof val === 'string' && /^\d+$/.test(val)) ? Number(val) : null;
            })();
            return phaseId ? (resolvePhaseCouleur(phaseId) || null) : null;
        }

        // R√©solution du nom du projet (DPPI_Operations)
        function getTaskProjetNom(t) {
            const val = t[COL.projet];
            if (!val) return '';
            if (typeof val === 'number' || (typeof val === 'string' && /^\d+$/.test(val))) {
                return resolveOpsNom(Number(val), projects);
            }
            return String(val);
        }

        // R√©solution des noms des responsables (RefList ‚Üí DPPI_Chef_Projet)
        function getTaskAssigneesNoms(t) {
            return getAssigneesArray(t).map(id => resolveResponsableNom(id, team)).filter(Boolean);
        }

        function showToast(msg, type = 'info') {
            const c = document.getElementById('toastContainer');
            const t = document.createElement('div');
            t.className = `toast ${type}`;
            t.textContent = msg;
            c.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // DATE CALCULATIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function getStartOfWeek(d) {
            const r = new Date(d);
            const day = r.getDay();
            r.setDate(r.getDate() - day + (day === 0 ? -6 : 1));
            r.setHours(0, 0, 0, 0);
            return r;
        }

        function getStartOfMonth(d) { return new Date(d.getFullYear(), d.getMonth(), 1); }
        function getStartOfQuarter(d) { return new Date(d.getFullYear(), Math.floor(d.getMonth() / 3) * 3, 1); }
        function getStartOfYear(d) { return new Date(d.getFullYear(), 0, 1); }

        function getWeekNumber(d) {
            const t = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            const day = t.getUTCDay() || 7;
            t.setUTCDate(t.getUTCDate() + 4 - day);
            const year = new Date(Date.UTC(t.getUTCFullYear(), 0, 1));
            return Math.ceil((((t - year) / 86400000) + 1) / 7);
        }

        function getViewStartDate() {
            switch (currentView) {
                case 'week':  return getStartOfWeek(viewStartDate);
                case 'month': return getStartOfMonth(viewStartDate);
                case 'sem6':  return new Date(viewStartDate.getFullYear(), Math.floor(viewStartDate.getMonth()/6)*6, 1);
                case 'year':  return getStartOfYear(viewStartDate);
                case 'three': return getStartOfYear(viewStartDate);
                default:      return getStartOfMonth(viewStartDate);
            }
        }

        function getTotalDays() {
            const cfg = VIEW_CONFIG[currentView];
            const n = getViewCellCount();
            if (cfg.unit === 'day')   return n;
            if (cfg.unit === 'sem6')  return n * 30; // n = nb mois
            if (cfg.unit === 'month') return n * 30;
            return n;
        }

        function getPixelsPerDay() {
            const cfg = VIEW_CONFIG[currentView];
            if (cfg.unit === 'day')   return cfg.cellWidth;
            if (cfg.unit === 'sem6')  return cfg.cellWidth / 30;
            if (cfg.unit === 'month') return cfg.cellWidth / 30;
            return cfg.cellWidth;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // VIEW & NAVIGATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function setView(view) {
            if (view === currentView) return;

            // 1. Calculer la date centrale de la vue ACTUELLE avant tout changement
            const prevCfg   = VIEW_CONFIG[currentView];
            const prevStart = getViewStartDate();
            // Nombre de jours que repr√©sente la vue actuelle
            const prevDays  = prevCfg.unit === 'day'   ? getViewCellCount() :
                               prevCfg.unit === 'sem6'  ? getViewCellCount() * 30 :
                               prevCfg.unit === 'month' ? getViewCellCount() * 30 : 365;
            const centerDate = addDays(prevStart, Math.floor(prevDays / 2));

            // 2. Changer la vue
            currentView = view;
            document.querySelectorAll('.view-controls .btn').forEach(b => b.classList.toggle('active', b.dataset.view === view));
            document.documentElement.style.setProperty('--cell-width', VIEW_CONFIG[view].cellWidth + 'px');
            localStorage.setItem('taskflow_gantt_view', view);

            // 3. Calculer viewStartDate pour centrer sur centerDate dans la NOUVELLE vue
            const newCfg   = VIEW_CONFIG[view];
            const newCount = getViewCellCount(); // maintenant bas√© sur currentView = view
            // Nombre de jours de la nouvelle vue
            const newDays  = newCfg.unit === 'day'   ? newCount :
                              newCfg.unit === 'sem6'  ? newCount * 30 :
                              newCfg.unit === 'month' ? newCount * 30 : 365;
            const halfDays = Math.floor(newDays / 2);

            if (newCfg.unit === 'day') {
                viewStartDate = addDays(centerDate, -halfDays);
            } else if (newCfg.unit === 'sem6') {
                const d = addDays(centerDate, -halfDays);
                viewStartDate = new Date(d.getFullYear(), Math.floor(d.getMonth()/6)*6, 1);
            } else if (newCfg.unit === 'month') {
                // Reculer halfDays jours depuis centerDate, puis aller au 1er du mois
                const d = addDays(centerDate, -halfDays);
                viewStartDate = new Date(d.getFullYear(), d.getMonth(), 1);
            }

            render();
        }

        function navigate(dir) {
            const cfg = VIEW_CONFIG[currentView];
            if (typeof cfg.navStep === 'number') {
                viewStartDate = addDays(viewStartDate, dir * cfg.navStep);
            } else if (cfg.navStep === 'month') {
                viewStartDate = new Date(viewStartDate.getFullYear(), viewStartDate.getMonth() + dir, 1);
            } else if (cfg.navStep === 'sem6') {
                viewStartDate = new Date(viewStartDate.getFullYear(), viewStartDate.getMonth() + dir * 6, 1);
            } else if (cfg.navStep === 'year') {
                viewStartDate = new Date(viewStartDate.getFullYear() + dir, 0, 1);
            }
            render();
        }

        function goToToday() {
            const today = new Date();
            if (currentView === 'week') {
                viewStartDate = getStartOfWeek(today);
            } else if (currentView === 'sem6') {
                viewStartDate = new Date(today.getFullYear(), Math.floor(today.getMonth()/6)*6, 1);
            } else if (currentView === 'month') {
                viewStartDate = new Date(today.getFullYear(), today.getMonth(), 1);
            } else {
                // year, three
                viewStartDate = new Date(today.getFullYear(), 0, 1);
            }
            render();
        }

        function updatePeriodLabel() {
            const start = getViewStartDate();
            const n = getViewCellCount();
            let text = '';
            switch (currentView) {
                case 'week': {
                    const end = addDays(start, n - 1);
                    text = `${MONTHS_SHORT[start.getMonth()]} ${start.getFullYear()}`;
                    break;
                }
                case 'sem6': {
                    const sem = Math.floor(start.getMonth() / 6) + 1;
                    text = `S${sem} ${start.getFullYear()}`;
                    break;
                }
                case 'month':
                    text = `${MONTHS[start.getMonth()]} ${start.getFullYear()}`;
                    break;
                case 'quarter':
                    text = `T${Math.floor(start.getMonth() / 3) + 1} ${start.getFullYear()}`;
                    break;
                case 'year':
                    text = `${start.getFullYear()}`;
                    break;
                case 'three': {
                    const endYear = new Date(start.getFullYear(), start.getMonth() + n - 1, 1).getFullYear();
                    text = `${start.getFullYear()} ‚Äì ${endYear}`;
                    break;
                }
            }
            // En mode single avec filtre projet unique, afficher le nom
            if (layoutMode === 'single' && filters.projects !== null && filters.projects.length === 1) {
                const proj = projects.find(p => String(p.id) === String(filters.projects[0]));
                if (proj) text = (proj[COL_OPS.nom] || '') + (text ? ' ¬∑ ' + text : '');
            } else if (layoutMode === 'single' && filters.projects !== null && filters.projects.length > 1) {
                text = filters.projects.length + ' op√©rations ¬∑ ' + text;
            }
            document.getElementById('currentPeriod').textContent = text;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SORTING
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function changeSortMode(mode) {
            sortMode = mode;
            document.getElementById('sortInfo').textContent = mode === 'priority' ? 'Par priorit√©' : mode === 'date' ? 'Par date' : 'Manuel';
            sortTasks();
            render();
        }

        function sortTasks() {
            if (sortMode === 'priority') {
                tasks.sort((a, b) => {
                    const pa = getTaskPriority(a), pb = getTaskPriority(b);
                    return pa !== pb ? pa - pb : (getEffectiveStart(a)?.getTime()||0) - (getEffectiveStart(b)?.getTime()||0);
                });
            } else if (sortMode === 'date') {
                tasks.sort((a, b) => { const sa = getEffectiveStart(a); const sb = getEffectiveStart(b); return (sa?.getTime()||0) - (sb?.getTime()||0); });
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // FILTERS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function loadFilters() {
            try {
                const s = localStorage.getItem('taskflow_gantt_filters');
                try { const saved = JSON.parse(s); if (saved && typeof saved === 'object') {
                    filters.projects = Array.isArray(saved.projects) ? saved.projects : null;
                    filters.assignees = Array.isArray(saved.assignees) ? saved.assignees : null;
                }} catch(e) {}
                const v = localStorage.getItem('taskflow_gantt_view');
                if (v && VIEW_CONFIG[v]) currentView = v;
            } catch (e) {}
        }

        function closeAllFilterMenus() {
            document.querySelectorAll('.filter-menu.open').forEach(m => {
                m.classList.remove('open');
                const inp = m.querySelector('input');
                if (inp) inp.value = '';
                const type = m.id === 'filterProjectMenu' ? 'projects' : 'assignees';
                filterSearch[type] = '';
                renderFilterList(type, '');
            });
        }

        function toggleFilterMenu(id) {
            const menu = document.getElementById(id + 'Menu');
            const isOpen = menu.classList.contains('open');
            closeAllFilterMenus();
            if (!isOpen) {
                menu.classList.add('open');
                const inp = menu.querySelector('input');
                if (inp) inp.focus();
            }
        }

        function applyFilterMenu(id) {
            const type = id === 'filterProject' ? 'projects' : 'assignees';
            const menu = document.getElementById(id + 'Menu');
            menu.classList.remove('open');
            const inp = menu.querySelector('input');
            if (inp) inp.value = '';
            filterSearch[type] = '';
            renderFilterList(type, '');
            updateFilterUI();
            render();
        }



        // Donn√©es des filtres (ind√©pendantes de la recherche en cours)
        let filterData = { projects: [], assignees: [] };
        // Terme de recherche courant par filtre
        let filterSearch = { projects: '', assignees: '' };

        function buildFilterData() {
            const projRaw = [...new Set(tasks.map(t => t[COL.projet]).filter(Boolean))];
            filterData.projects = projRaw.map(raw => ({
                id: String(raw),
                nom: getTaskProjetNom({ [COL.projet]: raw })
            })).sort((a, b) => a.nom.localeCompare(b.nom));
            filterData.assignees = team.map(m => ({
                id: m.id,
                nom: m[COL_CHEF.nom],
                actif: m[COL_CHEF.actif] !== false
            })).sort((a, b) => {
                if (a.actif !== b.actif) return a.actif ? -1 : 1;
                return a.nom.localeCompare(b.nom);
            });
        }

        function renderFilterList(type, search) {
            const listId = type === 'projects' ? 'filterProjectList' : 'filterAssigneeList';
            const listEl = document.getElementById(listId);
            if (!listEl) return;
            const items = filterData[type] || [];
            const q = (search || '').toLowerCase();
            const visible = items.filter(it => !q || it.nom.toLowerCase().includes(q));
            const noFilter = filters[type] === null;

            // Stocker les items visibles sur le conteneur pour la d√©l√©gation
            listEl._visibleItems = visible;
            listEl._filterType = type;

            listEl.innerHTML = visible.length ? visible.map((it, idx) => {
                const sel = noFilter || (filters[type] !== null && filters[type].map(String).includes(String(it.id)));
                return `<div class="filter-option" data-filter-idx="${idx}">
                    <div class="filter-checkbox${sel ? ' checked' : ''}"></div>
                    <span>${escapeHtml(it.nom)}</span>
                </div>`;
            }).join('') : '<div style="padding:8px 10px;font-size:0.75rem;color:var(--text-muted);">Aucun r√©sultat</div>';
        }

        function filterMenuSearch(menuId, q) {
            const type = menuId === 'filterProject' ? 'projects' : 'assignees';
            filterSearch[type] = q || '';
            renderFilterList(type, filterSearch[type]);
        }

        function updateFilterMenus() {
            buildFilterData();
            renderFilterList('projects');
            renderFilterList('assignees');
            updateFilterUI();
        }

        function updateFilterUI() {
            const hasProj = filters.projects !== null;
            const hasAss  = filters.assignees !== null;
            document.getElementById('filterProjectBtn').className  = 'filter-btn' + (hasProj ? ' active' : '');
            document.getElementById('filterAssigneeBtn').className = 'filter-btn' + (hasAss  ? ' active' : '');

            if (!hasProj) {
                document.getElementById('filterProjectLabel').textContent = 'Projet ‚ñæ';
            } else if (filters.projects !== null && filters.projects.length === 1) {
                const p = filterData.projects.find(p => p.id === filters.projects[0]);
                document.getElementById('filterProjectLabel').textContent = (p ? p.nom : '?') + ' ‚ñæ';
            } else {
                document.getElementById('filterProjectLabel').textContent = (filters.projects.length === 0 ? 'Aucun' : filters.projects.length + ' projets') + ' ‚ñæ';
            }
            if (!hasAss) {
                document.getElementById('filterAssigneeLabel').textContent = 'Responsable ‚ñæ';
            } else if (filters.assignees !== null && filters.assignees.length === 1) {
                const m = filterData.assignees.find(m => String(m.id) === String(filters.assignees[0]));
                document.getElementById('filterAssigneeLabel').textContent = (m ? m.nom : '?') + ' ‚ñæ';
            } else {
                document.getElementById('filterAssigneeLabel').textContent = (filters.assignees.length === 0 ? 'Aucun' : filters.assignees.length + ' responsables') + ' ‚ñæ';
            }
        }

        function selectAllFilter(type) {
            filters[type] = null; // null = pas de filtre = tout visible
            renderFilterList(type, filterSearch[type]);
            updateFilterUI();
            render();
        }

        function toggleFilter(type, val) {
            if (type === 'assignees') val = Number(val);
            else val = String(val);
            // Si pas de filtre actif ([] = tout coch√©), initialiser avec tous sauf le cliqu√©
            if (filters[type] === null) {
                buildFilterData();
                filters[type] = filterData[type]
                    .map(it => type === 'assignees' ? Number(it.id) : String(it.id))
                    .filter(v => String(v) !== String(val));
            } else {
                const idx = filters[type].findIndex(v => String(v) === String(val));
                if (idx >= 0) {
                    filters[type].splice(idx, 1);
                    buildFilterData();
                    if (filters[type].length === filterData[type].length) filters[type] = null;
                } else {
                    filters[type].push(val);
                    buildFilterData();
                    if (filters[type].length === filterData[type].length) filters[type] = null;
                }
            }
            renderFilterList(type, filterSearch[type]);
            updateFilterUI();
            render();
        }

        function clearFilter(type) {
            filters[type] = []; // [] = aucun s√©lectionn√©
            renderFilterList(type, filterSearch[type]);
            updateFilterUI();
            render();
        }

        function taskMatchesFilters(t) {
            // null = pas de filtre (tout passe), [] = aucun (tout bloqu√©)
            if (filters.projects !== null) {
                if (filters.projects.length === 0) return false;
                if (!filters.projects.map(String).includes(String(t[COL.projet]))) return false;
            }
            if (filters.assignees !== null) {
                if (filters.assignees.length === 0) return false;
                if (!filters.assignees.some(id => getAssigneesArray(t).includes(Number(id)))) return false;
            }
            return true;
        }

        function getFilteredTasks() {
            return tasks.filter(taskMatchesFilters);
        }

        // Retourne la liste ordonn√©e de "lignes" pour la vue single (et multi).
        // Chaque √©l√©ment est { type:'task'|'header', task?, projNom?, projId? }
        // Les deux fonctions renderTaskList et renderTimeline doivent l'utiliser
        // pour que les positions soient parfaitement align√©es.
        function getOrderedRows() {
            const filtered = getFilteredTasks();
            if (layoutMode !== 'single') {
                return filtered.map(t => ({ type: 'task', task: t }));
            }
            // Mode single : grouper par projet (ordre dans projects[])
            const byProj = {};
            filtered.forEach(t => {
                const pid = String(t[COL.projet] || '__none__');
                if (!byProj[pid]) byProj[pid] = [];
                byProj[pid].push(t);
            });
            // Ordre : projets dans l'ordre de la liste projects, puis orphelins
            const rows = [];
            const seen = new Set();
            projects.forEach(proj => {
                const pid = String(proj.id);
                if (byProj[pid] && byProj[pid].length) {
                    rows.push({ type: 'header', projNom: proj[COL_OPS.nom], projId: proj.id });
                    byProj[pid].forEach(t => rows.push({ type: 'task', task: t }));
                    seen.add(pid);
                }
            });
            if (byProj['__none__']) {
                rows.push({ type: 'header', projNom: 'Sans op√©ration', projId: null });
                byProj['__none__'].forEach(t => rows.push({ type: 'task', task: t }));
            }
            return rows;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // RENDER
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function render() {
            updatePeriodLabel();
            if (layoutMode === 'compact') {
                renderCompact();
            } else {
                renderTimelineHeader();
                renderTaskList();
                renderTimeline();
                syncScroll();
            }
        }

        // ‚îÄ‚îÄ‚îÄ Changement de layout mode ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function setLayoutMode(mode, pid) {
            layoutMode = mode;
            document.querySelectorAll('.layout-btn').forEach(b =>
                b.classList.toggle('active', b.dataset.layout === mode)
            );

            const isCompact = mode === 'compact';

            // Switcher les deux conteneurs principaux
            document.getElementById('ganttBody').style.display    = isCompact ? 'none' : '';
            document.getElementById('compactView').style.display  = isCompact ? 'flex' : 'none';

            // L'en-t√™te timeline : en compact, on la masque (le compact g√®re le sien)
            document.getElementById('timelineHeaderWrapper').style.display = isCompact ? 'none' : '';
            document.querySelector('.task-list-header').style.display       = isCompact ? 'none' : '';
            // R√©initialiser le padding de l'header si on sort du compact
            if (!isCompact) {
                document.getElementById('timelineHeader').style.paddingLeft = '';
                document.getElementById('timelineMonths').style.paddingLeft = '';
            }
            // Reset filtres quand on revient en compact
            if (isCompact) {
                filters.projects = null;
                filters.assignees = null;
            }

            // Tri visible seulement en mode multi/single
            const sortWrap = document.getElementById('sortSelectorWrap');
            if (sortWrap) sortWrap.style.display = isCompact ? 'none' : '';

            // Label liste gauche
            const lbl = document.getElementById('listHeaderLabel');
            if (lbl) lbl.textContent = mode === 'single' ? 'Phases' : 'T√¢ches';

            // Arriv√©e dans 'single'
            if (mode === 'single' && pid !== undefined) {
                // Depuis compact : filtre projet = ce projet uniquement
                filters.projects = [String(pid)];
                // Filtre responsables = les responsables qui ont des t√¢ches dans ce projet
                buildFilterData();
                const projTasks = tasks.filter(t => String(t[COL.projet]) === String(pid));
                const responsableIds = new Set();
                projTasks.forEach(t => getAssigneesArray(t).forEach(id => responsableIds.add(Number(id))));
                // N'inclure que les responsables qui existent dans filterData
                filters.assignees = filterData.assignees
                    .map(m => Number(m.id))
                    .filter(id => responsableIds.has(id));
            } else if (mode === 'single' && pid === undefined) {
                // Bouton direct : tout afficher (pas de filtre)
                filters.projects  = null;
                filters.assignees = null;
            }

            // Mettre √† jour les menus de filtre pour refl√©ter la s√©lection courante
            updateFilterMenus();
            closeDetailPanel();
            render();
        }

        function renderTimelineHeader() {
            const cfg = VIEW_CONFIG[currentView];
            const start = getViewStartDate();
            const today = new Date(); today.setHours(0, 0, 0, 0);
            const n = getViewCellCount();
            let topHtml = '', botHtml = '';

            if (cfg.unit === 'day') {
                // ‚îÄ‚îÄ Semaine & Mois ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                // Haut : "Mois Ann√©e" ex: "F√©v 2025"
                // Bas  : num√©ro du jour ; vue Semaine ajoute le nom du jour abr√©g√©
                const isWeekView = currentView === 'week';
                let curLabel = '', curWidth = 0;
                for (let i = 0; i < n; i++) {
                    const d = addDays(start, i);
                    const label = `${MONTHS_SHORT[d.getMonth()]} ${d.getFullYear()}`;
                    if (label !== curLabel) {
                        if (curLabel) topHtml += `<div class="month-cell" style="width:${curWidth * cfg.cellWidth}px">${curLabel}</div>`;
                        curLabel = label; curWidth = 1;
                    } else { curWidth++; }

                    const isToday = isSameDay(d, today);
                    const weekend = isWeekend(d);
                    let cls = 'day-cell';
                    if (weekend) cls += ' weekend';
                    if (isToday) cls += ' today';
                    if (d.getDate() === 1) cls += ' month-start';
                    // Vue Semaine : nom du jour au-dessus du num√©ro
                    const cellText = isWeekView
                        ? `<span style="font-size:0.6rem;opacity:0.7;display:block">${DAYS_SHORT[d.getDay()]}</span>${d.getDate()}`
                        : String(d.getDate());
                    botHtml += `<div class="${cls}" style="width:${cfg.cellWidth}px;min-width:${cfg.cellWidth}px;line-height:1.3">${cellText}</div>`;
                }
                topHtml += `<div class="month-cell" style="width:${curWidth * cfg.cellWidth}px">${curLabel}</div>`;

            } else if (cfg.unit === 'sem6') {
                // ‚îÄ‚îÄ Semestre ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                // Haut : Ann√©e + num√©ro semestre  ex: "2025 ‚Äî S1"
                // Bas  : mois abr√©g√©s (Jan F√©v ‚Ä¶ Juin | Juil ‚Ä¶ D√©c)
                let md = new Date(start.getFullYear(), start.getMonth(), 1);
                let curSem = '', semWidth = 0;
                for (let i = 0; i < n; i++) {
                    const y  = md.getFullYear();
                    const s  = Math.floor(md.getMonth() / 6) + 1;
                    const semLabel = `${y} ‚Äî S${s}`;
                    if (semLabel !== curSem) {
                        if (curSem) topHtml += `<div class="month-cell" style="width:${semWidth * cfg.cellWidth}px">${curSem}</div>`;
                        curSem = semLabel; semWidth = 1;
                    } else { semWidth++; }
                    const curr = md.getMonth() === today.getMonth() && md.getFullYear() === today.getFullYear();
                    // D√©but de semestre : s√©parateur visuel
                    const isSemStart = md.getMonth() === 0 || md.getMonth() === 6;
                    botHtml += `<div class="day-cell${curr ? ' today' : ''}${isSemStart ? ' month-start' : ''}" style="width:${cfg.cellWidth}px;min-width:${cfg.cellWidth}px">${MONTHS_SHORT[md.getMonth()]}</div>`;
                    md = new Date(md.getFullYear(), md.getMonth() + 1, 1);
                }
                topHtml += `<div class="month-cell" style="width:${semWidth * cfg.cellWidth}px">${curSem}</div>`;

            } else if (cfg.unit === 'month') {
                // ‚îÄ‚îÄ 1 An & 3 Ans ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                // Haut : Ann√©e
                // Bas  : mois abr√©g√©
                let md = new Date(start.getFullYear(), start.getMonth(), 1);
                let curYear = -1, yearCells = 0;
                for (let i = 0; i < n; i++) {
                    const y = md.getFullYear();
                    if (y !== curYear) {
                        if (curYear !== -1) topHtml += `<div class="month-cell" style="width:${yearCells * cfg.cellWidth}px">${curYear}</div>`;
                        curYear = y; yearCells = 1;
                    } else { yearCells++; }
                    const curr = md.getMonth() === today.getMonth() && md.getFullYear() === today.getFullYear();
                    botHtml += `<div class="day-cell${curr ? ' today' : ''}" style="width:${cfg.cellWidth}px;min-width:${cfg.cellWidth}px">${MONTHS_SHORT[md.getMonth()]}</div>`;
                    md = new Date(md.getFullYear(), md.getMonth() + 1, 1);
                }
                topHtml += `<div class="month-cell" style="width:${yearCells * cfg.cellWidth}px">${curYear}</div>`;
            }

            document.getElementById('timelineMonths').innerHTML = topHtml;
            document.getElementById('timelineMonths').style.display = 'flex';
            document.getElementById('timelineHeader').innerHTML = botHtml;
        }

        function renderTaskList() {
            const list = document.getElementById('taskList');






            const rows = getOrderedRows();
            if (!rows.some(r => r.type === 'task')) {
                list.innerHTML = '<div style="padding:40px;text-align:center;color:var(--text-muted);">Aucune t√¢che</div>';
                return;
            }

            let html = '';
            const ROW_H = 44; // doit correspondre √† --row-height CSS
            rows.forEach(row => {
                if (row.type === 'header') {
                    html += `<div class="group-header" style="height:${ROW_H}px;box-sizing:border-box;
                        padding:0 12px;display:flex;align-items:center;
                        font-size:0.68rem;font-weight:700;text-transform:uppercase;
                        color:var(--primary);background:var(--bg);
                        border-bottom:1px solid var(--border);letter-spacing:0.04em;">
                        ${escapeHtml(row.projNom)}</div>`;
                } else {
                    const t = row.task;
                    const p = getTaskPriority(t);
                    const sel = t.id === selectedTaskId ? ' selected' : '';
                    const tStart = getEffectiveStart(t);
                    const tEnd = getEffectiveEnd(t);
                    const jalon = isJalon(t);
                    const titre      = getTaskTitre(t);       // Nom court (barres)
                    const titreOrder = getTaskTitreOrder(t); // Nom_Order (liste)
                    const projetNom = layoutMode !== 'single' ? getTaskProjetNom(t) : '';
                    const drag = layoutMode !== 'single' ? '<span class="drag-handle">‚ãÆ‚ãÆ</span>' : '';
                    html += `<div class="task-row${sel}" data-id="${t.id}" style="height:${ROW_H}px;box-sizing:border-box;">
                        ${drag}
                        <div class="task-priority-bar p${p}"></div>
                        <div class="task-info">
                            <div class="task-name">${jalon ? '<span class="milestone-icon">‚óÜ</span> ' : ''}${escapeHtml(titreOrder)}</div>
                            ${projetNom ? `<div class="task-projet">${escapeHtml(projetNom)}</div>` : ''}
                            <div class="task-dates">${formatDateShort(tStart)} ‚Üí ${formatDateShort(tEnd)}</div>
                        </div>
                        <span class="task-progress-badge">${t[COL.progression] || 0}%</span>
                    </div>`;
                }
            });

            list.innerHTML = html;

            // Click handlers
            list.querySelectorAll('.task-row').forEach(row => {
                row.addEventListener('click', () => {
                    selectTask(parseInt(row.dataset.id));
                    showDetailPanel(parseInt(row.dataset.id));
                });
            });

            initTaskListSortable();
        }

        function initTaskListSortable() {
            if (sortableInstance) sortableInstance.destroy();
            sortableInstance = Sortable.create(document.getElementById('taskList'), {
                animation: 150,
                handle: '.drag-handle',
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                onStart: () => {
                    if (sortMode !== 'manual') {
                        sortMode = 'manual';
                        document.getElementById('sortSelect').value = 'manual';
                        document.getElementById('sortInfo').textContent = 'Manuel';
                    }
                },
                onEnd: (evt) => {
                    if (evt.oldIndex === evt.newIndex) return;
                    const id = parseInt(evt.item.dataset.id);
                    const task = tasks.find(t => t.id === id);
                    if (task) {
                        const idx = tasks.indexOf(task);
                        tasks.splice(idx, 1);
                        tasks.splice(evt.newIndex, 0, task);
                    }
                    render();
                    showToast('Ordre mis √† jour', 'success');
                }
            });
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // VUE COMPACTE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function renderCompact() {
            const cfg = VIEW_CONFIG[currentView];
            const start = getViewStartDate();
            const today = new Date(); today.setHours(0,0,0,0);
            const n = getViewCellCount();
            const pxPerDay = getPixelsPerDay();
            const totalDays = getTotalDays();
            const totalWidth = n * cfg.cellWidth;
            const LW = 260; // largeur colonne label
            const ROW_H = 52;

            // Grouper les t√¢ches par projet (en respectant les filtres actifs)
            const filteredTasks = getFilteredTasks();
            const tasksByProject = {};
            const projectsWithTasks = [];
            projects.forEach(p => {
                const pts = filteredTasks.filter(t => t[COL.projet] == p.id);
                if (pts.length) { tasksByProject[p.id] = pts; projectsWithTasks.push(p); }
            });
            const orphans = filteredTasks.filter(t => !t[COL.projet]);

            // Helper cellules de fond
            function makeCells() {
                let c = '';
                if (cfg.unit === 'day') {
                    for (let j = 0; j < n; j++) {
                        const d = addDays(start, j);
                        let cls = 'grid-cell';
                        if (isWeekend(d)) cls += ' weekend';
                        if (d.getDate() === 1) cls += ' month-start';
                        c += `<div class="${cls}" style="width:${cfg.cellWidth}px;height:100%;flex-shrink:0;"></div>`;
                    }
                } else {
                    for (let j = 0; j < n; j++)
                        c += `<div class="grid-cell" style="width:${cfg.cellWidth}px;height:100%;flex-shrink:0;"></div>`;
                }
                return c;
            }

            // Helper barres
            function makeBars(pts) {
                let bars = '';
                pts.forEach(t => {
                    const tStart = getEffectiveStart(t);
                    const tEnd   = getEffectiveEnd(t);
                    if (!tStart || !tEnd) return;
                    const s0 = getDaysDiff(start, tStart);
                    const e0 = getDaysDiff(start, tEnd);
                    if (e0 < 0 || s0 > totalDays) return;
                    const left  = Math.max(0, s0) * pxPerDay;
                    const right = Math.min(e0 + 1, totalDays) * pxPerDay;
                    const width = Math.max(right - left, 4);
                    const colour = getTaskCouleur(t) || 'var(--primary)';
                    const titre  = escapeHtml(getTaskTitre(t));
                    const prog   = t[COL.progression] || 0;
                    if (isJalon(t)) {
                        // colour est d√©j√† calcul√© correctement via getTaskCouleur(t) juste au-dessus
                        bars += `<div title="${titre}" onclick="showDetailPanel(${t.id})"
                            onmouseenter="showTooltip(event)" onmouseleave="hideTooltip()" onmousemove="moveTooltip(event)"
                            data-title="${titre}" data-start="${formatDateShort(tStart)}" data-end="${formatDateShort(tStart)}" data-progress="${t[COL.progression]||0}" data-duree="${t[COL.duree]||0}"
                            style="position:absolute;left:${left}px;top:50%;transform:translateY(-50%) rotate(45deg);
                            width:12px;height:12px;background:${colour};cursor:pointer;z-index:2;box-shadow:0 1px 3px rgba(0,0,0,0.3);"></div>`;
                    } else {
                        const dureeStrC = formatDureeBar(t[COL.duree]);
                        // Compact : nom+dur√©e si ‚â•100px, nom seul si ‚â•30px, rien si < 30px
                        const cLabel = width < 30 ? '' :
                                       (dureeStrC && width >= 100) ? titre + ' - ' + dureeStrC : titre;
                        bars += `<div class="compact-bar" onclick="showDetailPanel(${t.id})"
                            onmouseenter="showTooltip(event)" onmouseleave="hideTooltip()" onmousemove="moveTooltip(event)"
                            data-title="${titre}" data-start="${formatDateShort(tStart)}" data-end="${formatDateShort(tEnd)}" data-progress="${t[COL.progression] || 0}" data-duree="${t[COL.duree]||0}"
                            style="left:${left}px;width:${width}px;background:${colour};">
                            <div class="compact-bar-label">${escapeHtml(cLabel)}</div>
                        </div>`;
                    }
                });
                return bars;
            }

            const todayOff = getDaysDiff(start, today);
            const todayLine = todayOff >= 0 && todayOff < totalDays
                ? `<div class="compact-today-line" style="left:${todayOff * pxPerDay}px"></div>` : '';

            // ‚îÄ‚îÄ Construire l'en-t√™te compact ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // Mois + jours align√©s sur la zone timeline (apr√®s le label)
            let hMonths = '', hDays = '';
            if (cfg.unit === 'day') {
                let curMonth = -1, mDays = 0;
                for (let i = 0; i < n; i++) {
                    const d = addDays(start, i);
                    const m = d.getMonth();
                    if (m !== curMonth) {
                        if (curMonth !== -1) hMonths += `<div class="month-cell" style="width:${mDays * cfg.cellWidth}px">${MONTHS_SHORT[curMonth]}</div>`;
                        curMonth = m; mDays = 1;
                    } else mDays++;
                    const isToday = isSameDay(d, today);
                    let cls = 'day-cell' + (isWeekend(d) ? ' weekend' : '') + (isToday ? ' today' : '') + (d.getDate() === 1 ? ' month-start' : '');
                    hDays += `<div class="${cls}" style="width:${cfg.cellWidth}px;min-width:${cfg.cellWidth}px">${cfg.cellWidth >= 22 ? d.getDate() : ''}</div>`;
                }
                hMonths += `<div class="month-cell" style="width:${mDays * cfg.cellWidth}px">${MONTHS_SHORT[curMonth]}</div>`;
            } else if (cfg.unit === 'week') {
                let ws = getStartOfWeek(start), curY = -1, yCells = 0;
                for (let i = 0; i < n; i++) {
                    const y = ws.getFullYear();
                    if (y !== curY) { if (curY !== -1) hMonths += `<div class="month-cell" style="width:${yCells * cfg.cellWidth}px">${curY}</div>`; curY = y; yCells = 1; } else yCells++;
                    const wn = getWeekNumber(ws);
                    const curr = getWeekNumber(today) === wn && ws.getFullYear() === today.getFullYear();
                    hDays += `<div class="day-cell${curr ? ' today' : ''}" style="width:${cfg.cellWidth}px;min-width:${cfg.cellWidth}px">${ws.getDate() <= 7 ? MONTHS_SHORT[ws.getMonth()] : 'S'+wn}</div>`;
                    ws = addDays(ws, 7);
                }
                hMonths += `<div class="month-cell" style="width:${yCells * cfg.cellWidth}px">${curY}</div>`;
            } else {
                let md = new Date(start.getFullYear(), start.getMonth(), 1), curY = -1, yCells = 0;
                for (let i = 0; i < n; i++) {
                    const y = md.getFullYear();
                    if (y !== curY) { if (curY !== -1) hMonths += `<div class="month-cell" style="width:${yCells * cfg.cellWidth}px">${curY}</div>`; curY = y; yCells = 1; } else yCells++;
                    const curr = md.getMonth() === today.getMonth() && md.getFullYear() === today.getFullYear();
                    hDays += `<div class="day-cell${curr ? ' today' : ''}" style="width:${cfg.cellWidth}px;min-width:${cfg.cellWidth}px">${MONTHS_SHORT[md.getMonth()]}</div>`;
                    md = new Date(md.getFullYear(), md.getMonth() + 1, 1);
                }
                hMonths += `<div class="month-cell" style="width:${yCells * cfg.cellWidth}px">${curY}</div>`;
            }

            // ‚îÄ‚îÄ Construire les lignes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            let rowsHtml = '';
            projectsWithTasks.forEach(proj => {
                const pts = tasksByProject[proj.id];
                rowsHtml += `
                <div style="display:flex;height:${ROW_H}px;border-bottom:1px solid var(--border);">
                    <div class="compact-label" style="width:${LW}px;min-width:${LW}px;position:sticky;left:0;z-index:3;background:var(--card-bg);border-right:1px solid var(--border);"
                         onclick="selectCompactProject(${proj.id})">
                        <div class="compact-label-nom">${escapeHtml(proj[COL_OPS.nom])}</div>
                        <div class="compact-label-meta">${proj[COL_OPS.numOpe] || ''} ¬∑ ${pts.length} phase${pts.length > 1 ? 's' : ''}</div>
                    </div>
                    <div class="compact-grid" style="position:relative;width:${totalWidth}px;min-width:${totalWidth}px;height:${ROW_H}px;overflow:hidden;display:flex;">
                        ${makeCells()}
                        ${makeBars(pts)}
                        ${todayLine}
                    </div>
                </div>`;
            });

            if (orphans.length) {
                rowsHtml += `
                <div style="display:flex;height:${ROW_H}px;border-bottom:1px solid var(--border);">
                    <div class="compact-label" style="width:${LW}px;min-width:${LW}px;position:sticky;left:0;z-index:3;background:var(--card-bg);border-right:1px solid var(--border);">
                        <div class="compact-label-nom" style="color:var(--text-muted)">Sans op√©ration</div>
                        <div class="compact-label-meta">${orphans.length} phase${orphans.length > 1 ? 's' : ''}</div>
                    </div>
                    <div class="compact-grid" style="position:relative;width:${totalWidth}px;min-width:${totalWidth}px;height:${ROW_H}px;overflow:hidden;display:flex;">
                        ${makeCells()}
                        ${makeBars(orphans)}
                        ${todayLine}
                    </div>
                </div>`;
            }

            // ‚îÄ‚îÄ Injecter dans compactView ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const cv = document.getElementById('compactView');
            cv.style.flexDirection = 'column';
            cv.innerHTML = `
                <div style="flex-shrink:0;background:var(--card-bg);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10;">
                    <div style="display:flex;">
                        <div style="width:${LW}px;min-width:${LW}px;padding:4px 12px;font-weight:600;font-size:0.8rem;border-right:1px solid var(--border);background:var(--bg);">Op√©rations</div>
                        <div style="display:flex;overflow:hidden;flex:1;background:var(--bg);">
                            <div style="display:flex;">${hMonths}</div>
                        </div>
                    </div>
                    <div style="display:flex;">
                        <div style="width:${LW}px;min-width:${LW}px;border-right:1px solid var(--border);background:var(--bg);"></div>
                        <div style="display:flex;overflow:hidden;">${hDays}</div>
                    </div>
                </div>
                <div style="flex:1;">${rowsHtml}</div>
            `;
        }

        function selectCompactProject(pid) {
            // Clic sur un projet en vue compact ‚Üí ouvrir la vue projet (single)
            setLayoutMode('single', pid);
        }

        function renderTimeline() {
            const grid = document.getElementById('timelineGrid');
            const cfg = VIEW_CONFIG[currentView];
            const start = getViewStartDate();
            const today = new Date(); today.setHours(0, 0, 0, 0);
            const filtered = getFilteredTasks();
            const n = getViewCellCount();
            const totalDays = getTotalDays();
            const pxPerDay = getPixelsPerDay();
            const totalWidth = n * cfg.cellWidth;

            grid.style.width = totalWidth + 'px';

            const ROW_H = 44;
            const rows = getOrderedRows();
            const taskRows = rows.filter(r => r.type === 'task');
            let html = '';

            // Grid rows (une par ligne, header ou t√¢che)
            rows.forEach((row, i) => {
                let cells = '';
                const isHeader = row.type === 'header';
                if (cfg.unit === 'day') {
                    for (let j = 0; j < n; j++) {
                        const d = addDays(start, j);
                        let cls = 'grid-cell' + (isHeader ? ' group-header-cell' : '');
                        if (!isHeader && isWeekend(d)) cls += ' weekend';
                        if (d.getDate() === 1) cls += ' month-start';
                        cells += `<div class="${cls}" style="width:${cfg.cellWidth}px"></div>`;
                    }
                } else {
                    for (let j = 0; j < n; j++) {
                        const cls = 'grid-cell' + (isHeader ? ' group-header-cell' : '');
                        cells += `<div class="${cls}" style="width:${cfg.cellWidth}px"></div>`;
                    }
                }
                html += `<div class="grid-row${isHeader ? ' group-row' : ''}" data-row="${i}">${cells}</div>`;
            });

            // Dependencies layer
            html += '<svg class="dependencies-layer" id="dependenciesLayer"></svg>';

            // Bars & Milestones ‚Äî positionner sur l'index de ligne r√©el dans rows
            rows.forEach((row, i) => {
                if (row.type !== 'task') return;
                const t = row.task;
                const taskStart = getEffectiveStart(t);
                const taskEnd = getEffectiveEnd(t);
                if (!taskStart || !taskEnd) return;

                const startOff = getDaysDiff(start, taskStart);
                const endOff = getDaysDiff(start, taskEnd);

                if (endOff < 0 || startOff > totalDays) return;

                const visStart = Math.max(startOff, 0);
                const visEnd = Math.min(endOff, totalDays - 1);
                const p = getTaskPriority(t);
                const sel = t.id === selectedTaskId ? ' selected' : '';
                const top = i * ROW_H + 11;
                const titre = escapeHtml(getTaskTitre(t));
                const barColor = getTaskCouleur(t);
                const barStyle = barColor ? `background:${barColor};` : '';

                if (isJalon(t)) {
                    const left = startOff * pxPerDay;
                    if (startOff >= 0 && startOff < totalDays) {
                        const diamondStyle = barColor ? `background:${barColor};` : '';
                        html += `
                            <div class="gantt-milestone p${p}${sel}" style="left: ${left}px; top: ${top}px;" data-id="${t.id}">
                                <span class="milestone-date">${formatDateBar(taskStart)}</span>
                                <div class="milestone-diamond" style="${diamondStyle}"></div>
                                <span class="milestone-label">${titre}</span>
                            </div>
                        `;
                    }
                } else {
                    let left = visStart * pxPerDay;
                    let width = (visEnd - visStart + 1) * pxPerDay;
                    if (width < 4) width = 4;

                    const prog = t[COL.progression] || 0;
                    const dStart = formatDateBar(taskStart);
                    const dEnd   = formatDateBar(taskEnd);
                    const dureeStr = formatDureeBar(t[COL.duree]);
                    // D√©cision d'affichage selon largeur
                    let barInner;
                    if (width >= 120 && dureeStr) {
                        // Barre large : nom + dur√©e √† l'int√©rieur
                        barInner = `<span class="bar-date bar-date-start">${dStart}</span>
                            <span class="bar-label">${escapeHtml(titre + ' - ' + dureeStr)}</span>
                            <span class="bar-date bar-date-end">${dEnd}</span>`;
                    } else if (width >= 60) {
                        // Barre moyenne : nom seul √† l'int√©rieur
                        barInner = `<span class="bar-date bar-date-start">${dStart}</span>
                            <span class="bar-label">${escapeHtml(titre)}</span>
                            <span class="bar-date bar-date-end">${dEnd}</span>`;
                    } else {
                        // Barre courte : date fin puis nom √† l'ext√©rieur (apr√®s la date)
                        barInner = `<span class="bar-date bar-date-start">${dStart}</span>
                            <span class="bar-label"></span>
                            <span class="bar-date bar-date-end">${dEnd}</span>
                            <span class="bar-label-after-end">${escapeHtml(titre)}</span>`;
                    }
                    html += `
                        <div class="gantt-bar p${p}${sel}" style="left: ${left}px; width: ${width}px; top: ${top}px; ${barStyle}" 
                             data-id="${t.id}" data-title="${titre}" data-start="${formatDate(taskStart)}" data-end="${formatDate(taskEnd)}" data-progress="${prog}" data-duree="${t[COL.duree]||0}">
                            <div class="resize-handle left" data-resize="left"></div>
                            <div class="gantt-bar-progress" style="width: ${prog}%"></div>
                            ${barInner}
                            <div class="resize-handle right" data-resize="right"></div>
                        </div>
                    `;
                }
            });

            // Today line
            const todayOff = getDaysDiff(start, today);
            if (todayOff >= 0 && todayOff < totalDays) {
                html += `<div class="today-line" style="left: ${todayOff * pxPerDay}px;"></div>`;
            }

            grid.innerHTML = html;
            lastRenderedRows = rows;
            renderDependencies(taskRows.map(r => r.task), start, rows);

            // Event handlers
            grid.querySelectorAll('.gantt-bar').forEach(bar => {
                bar.addEventListener('mouseenter', showTooltip);
                bar.addEventListener('mouseleave', hideTooltip);
                bar.addEventListener('mousemove', moveTooltip);
                bar.addEventListener('click', () => selectTask(parseInt(bar.dataset.id)));
                bar.addEventListener('click', (e) => { if (!e.target.classList.contains('resize-handle')) showDetailPanel(parseInt(bar.dataset.id)); });
                bar.addEventListener('mousedown', (e) => {
                    if (e.target.classList.contains('resize-handle')) return;
                    startDrag(e, bar, 'move');
                });
                bar.querySelectorAll('.resize-handle').forEach(h => {
                    h.addEventListener('mousedown', (e) => {
                        e.stopPropagation();
                        startDrag(e, bar, h.dataset.resize === 'left' ? 'resize-left' : 'resize-right');
                    });
                });
            });

            grid.querySelectorAll('.gantt-milestone').forEach(m => {
                m.addEventListener('click', () => selectTask(parseInt(m.dataset.id)));
                m.addEventListener('click', () => showDetailPanel(parseInt(m.dataset.id)));
            });
        }

        function renderDependencies(taskList, start, allRows) {
            const svg = document.getElementById('dependenciesLayer');
            if (!svg) return;

            const ROW_H = 44;
            const pxPerDay = getPixelsPerDay();
            let paths = '';

            // Construire un map taskId ‚Üí index de ligne r√©el (dans allRows)
            const rowIndexOf = {};
            if (allRows) {
                allRows.forEach((row, i) => {
                    if (row.type === 'task') rowIndexOf[row.task.id] = i;
                });
            } else {
                taskList.forEach((t, i) => rowIndexOf[t.id] = i);
            }

            taskList.forEach((t, i) => {
                const dependDe = t[COL.dependDe];
                if (!dependDe) return;

                let depIds = [];
                if (Array.isArray(dependDe)) {
                    depIds = dependDe[0] === 'L' ? dependDe.slice(1) : dependDe;
                } else if (typeof dependDe === 'number') {
                    depIds = [dependDe];
                }

                depIds.forEach(depId => {
                    const depTask = taskList.find(x => x.id === depId);
                    if (!depTask) return;

                    const depIdx = rowIndexOf[depTask.id] ?? -1;
                    if (depIdx < 0) return;
                    const depEnd   = getEffectiveEnd(depTask);
                    const taskStart = getEffectiveStart(t);
                    if (!depEnd || !taskStart) return;

                    const x1 = (getDaysDiff(start, depEnd) + 1) * pxPerDay;
                    const y1 = depIdx * ROW_H + 22;
                    const x2 = getDaysDiff(start, taskStart) * pxPerDay;
                    const y2 = (rowIndexOf[t.id] ?? i) * ROW_H + 22;

                    const midX = (x1 + x2) / 2;
                    const highlight = t.id === selectedTaskId || depTask.id === selectedTaskId;
                    const cls = highlight ? ' highlight' : '';

                    paths += `<path class="dependency-line${cls}" d="M${x1},${y1} C${midX},${y1} ${midX},${y2} ${x2},${y2}"/>`;
                    paths += `<polygon class="dependency-arrow${cls}" points="${x2},${y2} ${x2-5},${y2-3} ${x2-5},${y2+3}"/>`;
                });
            });

            svg.innerHTML = paths;
        }

        function syncScroll() {
            const header = document.getElementById('timelineHeader');
            const months = document.getElementById('timelineMonths');
            const body = document.getElementById('timelineBody');
            const taskList = document.getElementById('taskList');

            body.onscroll = () => {
                header.scrollLeft = body.scrollLeft;
                months.scrollLeft = body.scrollLeft;
                taskList.scrollTop = body.scrollTop;
            };

            // Clic sur zone vide du Gantt ‚Üí fermer le panneau de d√©tail
            body.addEventListener('click', (e) => {
                if (e.target.classList.contains('grid-cell') || e.target.classList.contains('grid-row')) {
                    closeDetailPanel();
                }
            });
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // TOOLTIP
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function showTooltip(e) {
            const tt = document.getElementById('tooltip');
            const bar = e.currentTarget;
            tt.querySelector('.tooltip-title').textContent = bar.dataset.title;
            tt.querySelector('.tooltip-start').textContent = bar.dataset.start;
            tt.querySelector('.tooltip-end').textContent = bar.dataset.end;
            tt.querySelector('.tooltip-progress').textContent = bar.dataset.progress + '%';
            const dureeRow = tt.querySelector('.tt-duree-row');
            const dureeVal = bar.dataset.duree;
            if (dureeVal && dureeVal !== '0') {
                tt.querySelector('.tooltip-duree').textContent = formatDureeTexte(parseInt(dureeVal));
                dureeRow.style.display = '';
            } else {
                dureeRow.style.display = 'none';
            }
            tt.classList.add('visible');
            moveTooltip(e);
        }

        function moveTooltip(e) {
            const tt = document.getElementById('tooltip');
            tt.style.left = (e.clientX + 12) + 'px';
            tt.style.top = (e.clientY + 12) + 'px';
        }

        function hideTooltip() {
            document.getElementById('tooltip').classList.remove('visible');
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // TASK MODAL
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ‚îÄ‚îÄ‚îÄ Panneau de d√©tail / √©dition ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let detailPanelTaskId = null;

        function showDetailPanel(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            detailPanelTaskId = taskId;

            const start = gristToDate(task[COL.dateDebut]);
            const end   = gristToDate(task[COL.dateEcheance]);
            const progress = task[COL.progression] || 0;
            const statut   = task[COL.statut] || 'todo';
            const taskDependDe = task[COL.dependDe];
            const today = new Date();

            document.getElementById('dp-titre').textContent = getTaskTitre(task);
            document.getElementById('dp-projet').textContent = getTaskProjetNom(task);

            // Alerte retard
            let retardHtml = '';
            if (end && end < today && progress < 100) {
                const d = getDaysDiff(end, today);
                retardHtml = `<div class="retard-badge">‚ö†Ô∏è En retard de ${d} jour${d > 1 ? 's' : ''}</div>`;
            }

            // D√©pendances
            const depIds = !taskDependDe ? [] :
                Array.isArray(taskDependDe) ? (taskDependDe[0] === 'L' ? taskDependDe.slice(1) : taskDependDe) : [taskDependDe];
            const dependents = tasks.filter(t => {
                const dd = t[COL.dependDe];
                if (!dd) return false;
                const ids = Array.isArray(dd) ? (dd[0] === 'L' ? dd.slice(1) : dd) : [dd];
                return ids.includes(task.id);
            });

            // Liste des t√¢ches pouvant √™tre pr√©d√©cesseurs (toutes sauf cette t√¢che et ses successeurs)
            const successorIds = new Set();
            const collectSuccessors = (id) => {
                tasks.forEach(t => {
                    const dd = t[COL.dependDe];
                    if (!dd) return;
                    const ids = Array.isArray(dd) ? (dd[0] === 'L' ? dd.slice(1) : dd) : [dd];
                    if (ids.includes(id) && !successorIds.has(t.id)) {
                        successorIds.add(t.id);
                        collectSuccessors(t.id);
                    }
                });
            };
            collectSuccessors(task.id);

            const candidats = tasks.filter(t =>
                t.id !== task.id &&                          // pas elle-m√™me
                String(t[COL.projet]) === String(task[COL.projet]) && // m√™me projet
                !successorIds.has(t.id) &&                  // pas un successeur
                !depIds.includes(t.id)                      // pas d√©j√† pr√©d√©cesseur
            );

            // Pr√©d√©cesseurs ‚Äî widget filtre avec recherche + cases coch√©es
            // candidats d√©j√† tri√©s par projet, on les affiche tous cochables
            const allPredCandidats = [...candidats];
            // Ajouter les d√©j√†-pr√©d√©cesseurs en t√™te (coch√©s)
            const allPredItems = [
                ...depIds.map(id => tasks.find(t => t.id === id)).filter(Boolean),
                ...allPredCandidats
            ];

            const predsWidgetHtml = `<div class="panel-filter-widget" id="dp-pred-widget">
                <input class="panel-filter-search" id="dp-pred-search" placeholder="Rechercher un pr√©d√©cesseur‚Ä¶" autocomplete="off">
                <div class="panel-filter-list" id="dp-pred-list">
                    ${allPredItems.map(t => {
                        const checked = depIds.includes(t.id);
                        return `<label class="panel-filter-item" data-pred-id="${t.id}" data-pred-nom="${escapeHtml(getTaskTitreOrder(t)).toLowerCase()}">
                            <input type="checkbox" value="${t.id}" ${checked ? 'checked' : ''}>
                            ${escapeHtml(getTaskTitreOrder(t))}
                        </label>`;
                    }).join('')}
                </div>
            </div>`;

            // Successeurs (lecture seule)
            const succsHtml = dependents.map(dep =>
                `<div class="assignee-item" style="color:var(--text-muted);font-size:0.72rem;">‚Üí ${escapeHtml(getTaskTitre(dep))}</div>`
            ).join('');

            let depsHtml = `<div class="panel-section-title">Pr√©d√©cesseurs</div>
                ${allPredItems.length ? predsWidgetHtml : '<div style="font-size:0.7rem;color:var(--text-muted);padding:2px 0;">Aucune t√¢che disponible dans ce projet</div>'}
                ${succsHtml ? '<div class="panel-section-title" style="margin-top:8px;">Successeurs</div><div class="assignee-list">'+succsHtml+'</div>' : ''}`;

            // Statut labels
            const statuts = [
                { v: 'todo',       l: 'A faire',  cls: 's-todo' },
                { v: 'inprogress', l: 'En cours', cls: 's-inprogress' },
                { v: 'review',     l: 'En revue', cls: 's-review' },
                { v: 'done',       l: 'Termine',  cls: 's-done' }
            ];

            // Assign√©s ‚Äî widget filtre avec recherche, actifs d'abord
            const assigneeIds = getAssigneesArray(task);
            const teamSorted = [...team].sort((a, b) => {
                const aActif = a[COL_CHEF.actif] !== false;
                const bActif = b[COL_CHEF.actif] !== false;
                if (aActif !== bActif) return aActif ? -1 : 1;
                return String(a[COL_CHEF.nom]).localeCompare(String(b[COL_CHEF.nom]));
            });
            const assigneesHtml = `<div class="panel-filter-widget" id="dp-chef-widget">
                <input class="panel-filter-search" id="dp-chef-search" placeholder="Rechercher‚Ä¶" autocomplete="off">
                <div class="panel-filter-list" id="dp-chef-list">
                    ${teamSorted.map(m => {
                        const actif = m[COL_CHEF.actif] !== false;
                        const checked = assigneeIds.includes(m.id);
                        return `<label class="panel-filter-item${actif ? '' : ' inactive'}" data-responsable-id="${m.id}" data-responsable-nom="${escapeHtml(m[COL_CHEF.nom]).toLowerCase()}">
                            <input type="checkbox" value="${m.id}" ${checked ? 'checked' : ''}>
                            ${escapeHtml(m[COL_CHEF.nom])}${actif ? '' : ' (inactif)'}
                        </label>`;
                    }).join('')}
                </div>
            </div>`;

            const toDateInput = (d) => d ? d.toISOString().slice(0, 10) : '';
            const hasPreds = hasPredecesseurs(task);

            document.getElementById('dp-body').innerHTML = `
                ${retardHtml}

                <div>
                    <div class="panel-section-title">Statut</div>
                    <div class="status-pills">
                        ${statuts.map(s => `<div class="status-pill ${s.cls} ${statut === s.v ? 'active' : ''}"
                            onclick="setTaskStatut(${task.id}, '${s.v}', this)">${s.l}</div>`).join('')}
                    </div>
                </div>

                <div>
                    <div class="panel-section-title">Progression</div>
                    <div class="prog-slider-wrap">
                        <input type="range" min="0" max="100" step="5" value="${progress}"
                            id="dp-prog-slider"
                            oninput="document.getElementById('dp-prog-val').textContent=this.value+'%'">
                        <span class="prog-value" id="dp-prog-val">${progress}%</span>
                    </div>
                </div>

                <div class="date-fields">
                    <div class="field-group">
                        <label>Date d√©but saisie ${hasPreds ? '<span style="color:var(--text-muted);font-size:0.65rem">(ignor√©e)</span>' : ''}</label>
                        <input type="date" id="dp-dateDebut" value="${toDateInput(gristToDate(task[COL.dateDebut]))}"
                            ${hasPreds ? 'disabled title="Cette t√¢che a des pr√©d√©cesseurs ‚Äî modifiez la date de fin du pr√©d√©cesseur"' : ''}>
                        ${hasPreds ? '<div style="font-size:0.65rem;color:var(--warning);margin-top:2px;">‚ö† Pour modifier la date de d√©but, modifiez la date de fin du pr√©d√©cesseur.</div>' : ''}
                    </div>
                    <div class="field-group">
                        <label>Date d√©but calcul√©e</label>
                        <input type="date" id="dp-dateDebutCalc" value="${toDateInput(getEffectiveStart(task))}" disabled>
                    </div>
                    <div class="field-group">
                        <label>Dur√©e</label>
                        <input type="text" id="dp-duree" placeholder="ex: 3m, 1a 6m, 45j"
                            value="${formatDureeTexte(task[COL.duree])}"
                            title="Saisir: 3,5 ans | 18 mois | 2 semaines | 45j | combinaisons: 1a 3m"
                            style="width:140px;">
                        <div style="font-size:0.62rem;color:var(--text-muted);margin-top:2px;">${task[COL.duree] ? task[COL.duree] + ' jours' : ''}</div>
                    </div>
                    <div class="field-group">
                        <label>Date fin calcul√©e</label>
                        <input type="date" id="dp-dateFinCalc" value="${toDateInput(getEffectiveEnd(task))}" disabled>
                    </div>
                </div>

                ${team.length ? `<div>
                    <div class="panel-section-title">Responsables</div>
                    ${assigneesHtml}
                </div>` : ''}

                ${depsHtml}

                <div>
                    <div class="panel-section-title">Informations</div>
                    <div class="info-row"><span class="lbl">Type</span><span>${isJalon(task) ? 'Jalon' : 'Tache'}</span></div>
                    <div class="info-row"><span class="lbl">Estimation</span><span>${task[COL.estimationH] || 0} h</span></div>
                    <div class="info-row"><span class="lbl">Temps passe</span><span>${task[COL.tempsPasse] || 0} h</span></div>
                </div>
            `;

            // Attacher √©v√©nements ‚Äî widget responsables
            const responsableSearchEl = document.getElementById('dp-chef-search');
            if (responsableSearchEl) {
                responsableSearchEl.addEventListener('input', () => {
                    const q = responsableSearchEl.value.toLowerCase();
                    document.querySelectorAll('#dp-chef-list .panel-filter-item').forEach(el => {
                        el.style.display = !q || el.dataset.responsableNom.includes(q) ? '' : 'none';
                    });
                });
            }
            document.querySelectorAll('#dp-chef-list input[type=checkbox]').forEach(cb => {
                cb.addEventListener('change', () => updateAssignee(task.id, cb));
            });

            // Widget pr√©d√©cesseurs
            const predSearchEl = document.getElementById('dp-pred-search');
            if (predSearchEl) {
                predSearchEl.addEventListener('input', () => {
                    const q = predSearchEl.value.toLowerCase();
                    document.querySelectorAll('#dp-pred-list .panel-filter-item').forEach(el => {
                        el.style.display = !q || el.dataset.predNom.includes(q) ? '' : 'none';
                    });
                });
            }
            document.querySelectorAll('#dp-pred-list input[type=checkbox]').forEach(cb => {
                cb.addEventListener('change', async () => {
                    const predId = parseInt(cb.value);
                    if (cb.checked) {
                        await addPredecesseur(task.id, predId);
                    } else {
                        await removePredecesseur(task.id, predId);
                    }
                });
            });

            document.getElementById('detailPanel').classList.add('open');

            // S√©lectionner la ligne dans Grist
            if (gristReady) grist.setSelectedRows([taskId]);
        }

        function closeDetailPanel() {
            document.getElementById('detailPanel').classList.remove('open');
            detailPanelTaskId = null;
        }

        // Changement de statut imm√©diat (sans "Enregistrer")
        // ‚îÄ‚îÄ‚îÄ Gestion des d√©pendances depuis le panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function getDepIds(task) {
            const dd = task[COL.dependDe];
            if (!dd) return [];
            return Array.isArray(dd) ? (dd[0] === 'L' ? dd.slice(1) : dd) : [dd];
        }

        function buildDepGristValue(ids) {
            // Grist RefList = ['L', id1, id2, ...]
            return ids.length ? ['L', ...ids] : null;
        }

        async function addPredecesseur(taskId, predId) {
            predId = parseInt(predId);
            if (!predId) return;
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            const ids = getDepIds(task);
            if (ids.includes(predId)) return;
            ids.push(predId);
            const newVal = buildDepGristValue(ids);
            task[COL.dependDe] = newVal;
            if (gristReady) {
                try {
                    await grist.docApi.applyUserActions([
                        ['UpdateRecord', TABLE.tasks, taskId, { [COL.dependDe]: newVal }]
                    ]);
                    showToast('Pr√©d√©cesseur ajout√©', 'success');
                    await loadAllData();
                    showDetailPanel(taskId);
                } catch(e) { showToast('Erreur', 'error'); }
            } else {
                render();
                showDetailPanel(taskId);
            }
        }

        async function removePredecesseur(taskId, predId) {
            predId = parseInt(predId);
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            const ids = getDepIds(task).filter(id => id !== predId);
            const newVal = buildDepGristValue(ids);
            task[COL.dependDe] = newVal;
            if (gristReady) {
                try {
                    await grist.docApi.applyUserActions([
                        ['UpdateRecord', TABLE.tasks, taskId, { [COL.dependDe]: newVal }]
                    ]);
                    showToast('Pr√©d√©cesseur supprim√©', 'success');
                    await loadAllData();
                    showDetailPanel(taskId);
                } catch(e) { showToast('Erreur', 'error'); }
            } else {
                render();
                showDetailPanel(taskId);
            }
        }

        async function setTaskStatut(taskId, newStatut, el) {
            // Mettre √† jour l'UI
            el.closest('.status-pills').querySelectorAll('.status-pill').forEach(p => p.classList.remove('active'));
            el.classList.add('active');
            // Mettre √† jour en m√©moire
            const task = tasks.find(t => t.id === taskId);
            if (task) task[COL.statut] = newStatut;
            // Persister dans Grist
            if (gristReady) {
                try {
                    await grist.docApi.applyUserActions([
                        ['UpdateRecord', TABLE.tasks, taskId, { [COL.statut]: newStatut }]
                    ]);
                    render();
                } catch(e) { showToast('Erreur statut', 'error'); }
            }
        }

        // Mise √† jour d'un responsable (checkbox)
        async function updateAssignee(taskId, checkbox) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            const id = parseInt(checkbox.value);
            let ids = getAssigneesArray(task);
            if (checkbox.checked) { if (!ids.includes(id)) ids.push(id); }
            else { ids = ids.filter(x => x !== id); }
            const newVal = ids.length ? ['L', ...ids] : null;
            task[COL.assignees] = newVal;
            if (gristReady) {
                try {
                    await grist.docApi.applyUserActions([
                        ['UpdateRecord', TABLE.tasks, taskId, { [COL.assignees]: newVal }]
                    ]);
                    render();
                } catch(e) { showToast('Erreur assignation', 'error'); }
            }
        }

        // Enregistrer dates + progression
        async function saveDetailPanel() {
            if (!detailPanelTaskId) return;
            const task = tasks.find(t => t.id === detailPanelTaskId);
            if (!task) return;

            const toGrist = (s) => s ? Math.floor(new Date(s + 'T00:00:00').getTime() / 1000) : null;
            const hasPreds = hasPredecesseurs(task);

            const prog  = parseInt(document.getElementById('dp-prog-slider')?.value || 0);
            const dureeRaw = document.getElementById('dp-duree')?.value || '';
            const duree = parseDureeInput(dureeRaw);

            // Colonnes √† mettre √† jour dans Grist
            const updates = { [COL.progression]: prog };

            if (!hasPreds) {
                // Pas de pr√©d√©cesseur : dateDebut saisie manuellement
                const dDebut = document.getElementById('dp-dateDebut')?.value;
                if (dDebut) updates[COL.dateDebut] = toGrist(dDebut);
            }
            if (duree) updates[COL.duree] = duree;

            // Mise √† jour en m√©moire (les dates calcul√©es seront rafra√Æchies depuis Grist)
            Object.assign(task, updates);

            if (gristReady) {
                try {
                    await grist.docApi.applyUserActions([
                        ['UpdateRecord', TABLE.tasks, detailPanelTaskId, updates]
                    ]);
                    showToast('Sauvegarde OK', 'success');
                    // Recharger les donn√©es pour r√©cup√©rer les dates calcul√©es
                    await loadAllData();
                    // Rouvrir le panel pour afficher les dates mises √† jour
                    if (detailPanelTaskId) showDetailPanel(detailPanelTaskId);
                } catch(e) { showToast('Erreur sauvegarde', 'error'); }
            } else {
                showToast('Sauvegarde (demo)', 'info');
                render();
                if (detailPanelTaskId) showDetailPanel(detailPanelTaskId);
            }
        }

        // ‚îÄ‚îÄ‚îÄ Modal cr√©ation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function openCreateModal() {
            // V√©rification : uniquement en vue Projet avec 1 projet s√©lectionn√©
            if (layoutMode !== 'single') {
                showToast('La cr√©ation de t√¢che est disponible uniquement en vue Projet.', 'warning', 4000);
                return;
            }
            if (!filters.projects || filters.projects.length !== 1) {
                showToast('S√©lectionnez un seul projet en vue Projet pour cr√©er une t√¢che.', 'warning', 4000);
                return;
            }

            const projetId = parseInt(filters.projects[0]);
            const projet = projects.find(p => p.id === projetId);

            // Phases
            const phasesSorted = [...phases].sort((a, b) => (a[COL_PHASES.numOrder] || 0) - (b[COL_PHASES.numOrder] || 0));
            document.getElementById('create-titre').innerHTML =
                '<option value="">‚Äî Choisir une phase ‚Äî</option>' +
                phasesSorted.map(p => `<option value="${p.id}">${escapeHtml(p[COL_PHASES.nomOrder] || p[COL_PHASES.nom])}</option>`).join('');

            // Op√©ration pr√©-s√©lectionn√©e (lecture seule)
            document.getElementById('create-projet-label').textContent = projet ? (projet[COL_OPS.nom] || '') : '';

            // Responsables (actifs d'abord)
            const teamSorted = [...team].sort((a, b) => {
                const aA = a[COL_CHEF.actif] !== false, bA = b[COL_CHEF.actif] !== false;
                if (aA !== bA) return aA ? -1 : 1;
                return String(a[COL_CHEF.nom]).localeCompare(String(b[COL_CHEF.nom]));
            });
            document.getElementById('create-chef-list').innerHTML = teamSorted.map(m => {
                const actif = m[COL_CHEF.actif] !== false;
                return `<label class="panel-filter-item${actif ? '' : ' inactive'}" data-chef-nom="${String(m[COL_CHEF.nom]).toLowerCase()}">
                    <input type="checkbox" value="${m.id}">
                    ${escapeHtml(m[COL_CHEF.nom])}${actif ? '' : ' (inactif)'}
                </label>`;
            }).join('');

            // Pr√©d√©cesseurs ‚Äî t√¢ches du m√™me projet
            const projTasks = tasks.filter(t => String(t[COL.projet]) === String(projetId));
            document.getElementById('create-pred-list').innerHTML = projTasks.length
                ? projTasks.map(t => `<label class="panel-filter-item" data-pred-nom="${escapeHtml(getTaskTitreOrder(t)).toLowerCase()}">
                    <input type="checkbox" value="${t.id}">
                    ${escapeHtml(getTaskTitreOrder(t))}
                </label>`).join('')
                : '<div style="padding:6px 8px;font-size:0.7rem;color:var(--text-muted);">Aucune t√¢che dans ce projet</div>';

            // Recherche responsables
            document.getElementById('create-chef-search').addEventListener('input', function() {
                const q = this.value.toLowerCase();
                document.querySelectorAll('#create-chef-list .panel-filter-item').forEach(el => {
                    el.style.display = !q || el.dataset.chefNom.includes(q) ? '' : 'none';
                });
            });
            document.getElementById('create-pred-search').addEventListener('input', function() {
                const q = this.value.toLowerCase();
                document.querySelectorAll('#create-pred-list .panel-filter-item').forEach(el => {
                    el.style.display = !q || el.dataset.predNom.includes(q) ? '' : 'none';
                });
            });

            // Valeurs par d√©faut
            const today = new Date().toISOString().slice(0, 10);
            document.getElementById('create-dateDebut').value = today;
            document.getElementById('create-duree').value = '';
            document.getElementById('create-description').value = '';
            document.getElementById('create-statut').value = 'todo';
            document.getElementById('create-type').value = 'tache';
            onCreateTypeChange('tache');

            document.getElementById('createModal').classList.add('open');
        }

        function closeCreateModal() {
            document.getElementById('createModal').classList.remove('open');
        }

        function onCreateTypeChange(type) {
            const dureeWrap = document.getElementById('create-duree').closest('.field-group');
            if (type === 'jalon') {
                dureeWrap.style.opacity = '0.4';
                dureeWrap.style.pointerEvents = 'none';
                document.getElementById('create-duree').value = '0';
            } else {
                dureeWrap.style.opacity = '';
                dureeWrap.style.pointerEvents = '';
                if (document.getElementById('create-duree').value === '0') {
                    document.getElementById('create-duree').value = '';
                }
            }
        }

        async function submitCreateTask() {
            const titreId  = parseInt(document.getElementById('create-titre').value);
            const dDebut   = document.getElementById('create-dateDebut').value;
            const dureeRaw = document.getElementById('create-duree').value;
            const duree    = parseDureeInput(dureeRaw);
            const statut   = document.getElementById('create-statut').value;
            const desc     = document.getElementById('create-description').value.trim();

            const typeVal  = document.getElementById('create-type').value;
            const isJalonCreate = typeVal === 'jalon';

            if (!titreId) { showToast('Choisissez une phase', 'error'); return; }
            if (!dDebut)  { showToast('Date de d√©but obligatoire', 'error'); return; }
            if (!isJalonCreate && duree === null) { showToast('Dur√©e obligatoire (ex: 3m, 45j)', 'error'); return; }

            const projetId = filters.projects?.length === 1 ? parseInt(filters.projects[0]) : null;
            const toGrist  = (s) => s ? Math.floor(new Date(s + 'T00:00:00').getTime() / 1000) : null;

            const assigneeIds = [...document.querySelectorAll('#create-chef-list input:checked')].map(c => parseInt(c.value));
            const assigneesVal = assigneeIds.length ? ['L', ...assigneeIds] : null;

            const predIds = [...document.querySelectorAll('#create-pred-list input:checked')].map(c => parseInt(c.value));
            const dependDeVal = predIds.length ? ['L', ...predIds] : null;

            const record = {
                [COL.titre]:       titreId,
                [COL.dateDebut]:   toGrist(dDebut),
                [COL.duree]:       isJalonCreate ? 0 : duree,
                [COL.statut]:      statut,
                [COL.progression]: 0,
                [COL.type]:        typeVal,
            };
            if (projetId)     record[COL.projet]      = projetId;
            if (assigneesVal) record[COL.assignees]   = assigneesVal;
            if (dependDeVal)  record[COL.dependDe]    = dependDeVal;
            if (desc)         record[COL.description] = desc;

            if (gristReady) {
                try {
                    const result = await grist.docApi.applyUserActions([
                        ['AddRecord', TABLE.tasks, null, record]
                    ]);
                    showToast('Phase cr√©√©e', 'success');
                    closeCreateModal();
                    await loadAllData();
                    // Ouvrir le panel de d√©tail sur la nouvelle t√¢che
                    const newId = result?.retValues?.[0];
                    if (newId) showDetailPanel(newId);
                } catch(e) {
                    showToast('Erreur cr√©ation: ' + (e.message || e), 'error');
                }
            } else {
                const newId = Math.max(0, ...tasks.map(t => t.id)) + 1;
                record.id = newId;
                record._phaseId = titreId || null;
                tasks.push(record);
                showToast('Phase cr√©√©e (demo)', 'info');
                closeCreateModal();
                sortTasks(); updateFilterMenus(); render();
                showDetailPanel(newId);
            }
        }

        function editInGrist() {
            if (gristReady && detailPanelTaskId) {
                grist.setSelectedRows([detailPanelTaskId]);
            }
            closeDetailPanel();
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SELECTION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function selectTask(id) {
            selectedTaskId = id;
            document.querySelectorAll('.task-row, .gantt-bar, .gantt-milestone').forEach(el => {
                el.classList.toggle('selected', parseInt(el.dataset.id) === id);
            });
            renderDependencies(getFilteredTasks(), getViewStartDate(), lastRenderedRows);
            if (gristReady && id) grist.setSelectedRows([id]);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // DRAG & DROP BARS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function startDrag(e, bar, type) {
            const id = parseInt(bar.dataset.id);
            const task = tasks.find(t => t.id === id);
            if (!task) return;

            dragState = {
                active: true,
                type,
                taskId: id,
                startX: e.clientX,
                originalLeft: parseFloat(bar.style.left),
                originalWidth: parseFloat(bar.style.width),
                originalStart: getEffectiveStart(task),
                originalEnd:   getEffectiveEnd(task)
            };

            bar.classList.add('dragging');
            document.addEventListener('mousemove', onDrag);
            document.addEventListener('mouseup', endDrag);
        }

        function onDrag(e) {
            if (!dragState.active) return;

            const dx = e.clientX - dragState.startX;
            const pxPerDay = getPixelsPerDay();
            const daysDelta = Math.round(dx / pxPerDay);

            const bar = document.querySelector(`.gantt-bar[data-id="${dragState.taskId}"]`);
            if (!bar) return;

            if (dragState.type === 'move') {
                bar.style.left = (dragState.originalLeft + daysDelta * pxPerDay) + 'px';
            } else if (dragState.type === 'resize-right') {
                const newWidth = dragState.originalWidth + daysDelta * pxPerDay;
                if (newWidth >= 10) bar.style.width = newWidth + 'px';
            } else if (dragState.type === 'resize-left') {
                const newLeft = dragState.originalLeft + daysDelta * pxPerDay;
                const newWidth = dragState.originalWidth - daysDelta * pxPerDay;
                if (newWidth >= 10) {
                    bar.style.left = newLeft + 'px';
                    bar.style.width = newWidth + 'px';
                }
            }
        }

        async function endDrag(e) {
            if (!dragState.active) return;

            const dx = e.clientX - dragState.startX;
            const pxPerDay = getPixelsPerDay();
            const daysDelta = Math.round(dx / pxPerDay);

            document.removeEventListener('mousemove', onDrag);
            document.removeEventListener('mouseup', endDrag);

            const bar = document.querySelector(`.gantt-bar[data-id="${dragState.taskId}"]`);
            if (bar) bar.classList.remove('dragging');

            if (daysDelta === 0) {
                dragState.active = false;
                return;
            }

            const task = tasks.find(t => t.id === dragState.taskId);
            if (!task) { dragState.active = false; return; }

            const hasPreds = hasPredecesseurs(task);

            // Si la t√¢che a des pr√©d√©cesseurs et qu'on tente de d√©placer sa date de d√©but
            if (hasPreds && (dragState.type === 'move' || dragState.type === 'resize-left')) {
                dragState.active = false;
                showToast('Pour modifier la date de d√©but de cette t√¢che, vous devez modifier la date de fin du pr√©d√©cesseur.', 'warning', 5000);
                render();
                return;
            }

            let newStart = dragState.originalStart;
            let newEnd   = dragState.originalEnd;

            if (dragState.type === 'move') {
                newStart = addDays(dragState.originalStart, daysDelta);
                newEnd   = addDays(dragState.originalEnd,   daysDelta);
            } else if (dragState.type === 'resize-right') {
                newEnd = addDays(dragState.originalEnd, daysDelta);
            } else if (dragState.type === 'resize-left') {
                newStart = addDays(dragState.originalStart, daysDelta);
            }

            // Calcul de la dur√©e en jours
            const newDuree = Math.max(1, Math.round((newEnd - newStart) / 86400000) + 1);

            // Colonnes √† mettre √† jour
            const dragUpdates = { [COL.duree]: newDuree };
            if (!hasPreds) dragUpdates[COL.dateDebut] = dateToGrist(newStart);

            // Mise √† jour optimiste en m√©moire (dates calcul√©es incluses)
            Object.assign(task, dragUpdates);
            // Mise √† jour optimiste des dates calcul√©es pour √©viter le flash
            if (!hasPreds && dragUpdates[COL.dateDebut]) {
                task[COL.dateDebutCalc] = dragUpdates[COL.dateDebut];
            }
            task[COL.dateFinCalc] = dateToGrist(newEnd);

            dragState.active = false;
            render();
            if (detailPanelTaskId === dragState.taskId) showDetailPanel(detailPanelTaskId);

            if (gristReady) {
                try {
                    await grist.docApi.applyUserActions([
                        ['UpdateRecord', TABLE.tasks, task.id, dragUpdates]
                    ]);
                    showToast('T√¢che mise √† jour', 'success');
                    // Recharger pour r√©cup√©rer les vraies dates calcul√©es par Grist
                    await loadAllData();
                } catch (err) {
                    showToast('Erreur de mise √† jour', 'error');
                }
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // GRIST INTEGRATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function convert(data) {
            if (!data || Array.isArray(data)) return data || [];
            const cols = Object.keys(data);
            if (!cols.length) return [];
            const n = data[cols[0]]?.length || 0;
            const r = [];
            for (let i = 0; i < n; i++) {
                const rec = {};
                cols.forEach(c => rec[c] = data[c][i]);
                r.push(rec);
            }
            return r;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SCHEMA AUTO-INITIALISATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // getTaskflowSchema() ‚Äî construit le sch√©ma en utilisant les noms dynamiques
        // de TABLE et COL/COL_CHEF/COL_PROJECTS au moment de l'appel.
        function getTaskflowSchema() {
            return {
                [TABLE.responsableProjet]: [
                    { id: COL_CHEF.nom,      type: 'Text' },
                    { id: COL_CHEF.prenom,   type: 'Text' },
                    { id: COL_CHEF.fonction, type: 'Text' },
                    { id: COL_CHEF.actif,    type: 'Bool' }
                ],
                [TABLE.operations]: [
                    { id: COL_OPS.nom,     type: 'Text' },
                    { id: COL_OPS.numOpe,  type: 'Text' },
                    { id: COL_OPS.statut,  type: 'Choice' },
                    { id: COL_OPS.exercice,type: 'Text' }
                ],
                [TABLE.phases]: [
                    { id: COL_PHASES.nom,      type: 'Text' },
                    { id: COL_PHASES.nomOrder, type: 'Text' },
                    { id: COL_PHASES.couleur,  type: 'Text' },
                    { id: COL_PHASES.numOrder, type: 'Numeric' }
                ],
                // TABLE.tasks n'est PAS dans le sch√©ma ensureSchema :
                // ses colonnes sont mappables via le panneau widget Grist.
                // ensureSchema ne doit jamais recr√©er une colonne que l'utilisateur
                // a renomm√©e ‚Äî c'est √† lui de mapper la bonne colonne.
            };
        }

        async function ensureSchema() {
            const log = (msg) => {}; // logging disabled
            let created = 0, added = 0;
            const tablesCreated = [];

            for (const [tableName, columns] of Object.entries(getTaskflowSchema())) {
                let existingCols = [];
                let tableExists = false;

                try {
                    const data = await grist.docApi.fetchTable(tableName);
                    existingCols = Object.keys(data).filter(c => c !== 'id' && c !== 'manualSort');
                    tableExists = true;
                    log(`‚úì Table ${tableName} existe (${existingCols.length} colonnes)`);
                } catch (e) {
                    try {
                        await grist.docApi.applyUserActions([
                            ['AddTable', tableName, columns.map(c => ({ id: c.id, type: c.type }))]
                        ]);
                        log(`‚úÖ Table ${tableName} cr√©√©e avec ${columns.length} colonnes`);
                        tablesCreated.push(tableName);
                        created++;
                        continue;
                    } catch (e2) {
                        log(`‚ö†Ô∏è Impossible de cr√©er ${tableName}: ${e2.message || e2}`);
                        continue;
                    }
                }

                // Ne pas cr√©er de colonnes ‚Äî l'utilisateur configure les noms via le panneau.
                // On cr√©e uniquement les tables absentes (ci-dessus).
                _ = tableExists; // tableExists utilis√© pour √©viter warning
            }

            if (tablesCreated.includes(TABLE.tasks)) {
                await seedData();
            }

            if (created > 0 || added > 0) {
                log(`Schema OK ‚Äî ${created} table(s) cr√©√©e(s), ${added} colonne(s) ajout√©e(s)`);
                showToast(`Schema initialis√© (${created} tables, ${added} colonnes)`, 'success');
            } else {
                log('Schema complet ‚Äî rien √† modifier');
            }
        }

        async function seedData() {
            const log = (msg) => {};
            const today = new Date();
            const day = (d) => {
                const dt = new Date(today.getFullYear(), today.getMonth(), today.getDate() + d);
                return dt.getTime() / 1000;
            };

            // Helper : construit un enregistrement Task avec les noms de colonnes dynamiques
            const mkTask = (d) => ({
                [COL.titre]:        d.titre,
                [COL.description]:  d.description || '',
                [COL.dateDebut]:    d.dateDebut,
                [COL.dateEcheance]: d.dateEcheance,
                [COL.priorite]:     d.priorite,
                [COL.statut]:       d.statut,
                [COL.progression]:  d.progression,
                [COL.type]:         d.type,
                ...(d.projet      !== undefined ? { [COL.projet]:      d.projet      } : {}),
                ...(d.assignees   !== undefined ? { [COL.assignees]:   d.assignees   } : {}),
                ...(d.dependDe    !== undefined ? { [COL.dependDe]:    d.dependDe    } : {}),
                ...(d.estimationH !== undefined ? { [COL.estimationH]: d.estimationH } : {}),
                ...(d.tempsPasse  !== undefined ? { [COL.tempsPasse]:  d.tempsPasse  } : {})
            });

            try {
                await grist.docApi.applyUserActions([
                    ['AddRecord', TABLE.responsableProjet, null, { [COL_CHEF.nom]: 'Cynthia Chaudron',  [COL_CHEF.prenom]: 'Cynthia',  [COL_CHEF.nomFamille]: 'Chaudron',  [COL_CHEF.fonction]: "Charg√©e d'op√©ration", [COL_CHEF.actif]: true }],
                    ['AddRecord', TABLE.responsableProjet, null, { [COL_CHEF.nom]: 'Nathalie Gaillard', [COL_CHEF.prenom]: 'Nathalie', [COL_CHEF.nomFamille]: 'Gaillard',  [COL_CHEF.fonction]: "Charg√©e d'op√©ration", [COL_CHEF.actif]: true }],
                    ['AddRecord', TABLE.responsableProjet, null, { [COL_CHEF.nom]: 'Anne Blanchon',     [COL_CHEF.prenom]: 'Anne',     [COL_CHEF.nomFamille]: 'Blanchon',  [COL_CHEF.fonction]: "Charg√©e d'op√©ration", [COL_CHEF.actif]: true }]
                ]);
                log(`‚úÖ 3 responsables ajout√©s √† ${TABLE.responsableProjet}`);

                await grist.docApi.applyUserActions([
                    ['AddRecord', TABLE.phases, null, { [COL_PHASES.nom]: 'Faisabilit√©',      [COL_PHASES.nomOrder]: '101 - Faisabilit√©',      [COL_PHASES.couleur]: '#BC77FC', [COL_PHASES.numOrder]: 101 }],
                    ['AddRecord', TABLE.phases, null, { [COL_PHASES.nom]: 'Pr√©-programme',    [COL_PHASES.nomOrder]: '102 - Pr√©-programme',    [COL_PHASES.couleur]: '#BC77FC', [COL_PHASES.numOrder]: 102 }],
                    ['AddRecord', TABLE.phases, null, { [COL_PHASES.nom]: 'Programme',        [COL_PHASES.nomOrder]: '103 - Programme',        [COL_PHASES.couleur]: '#7C9EFC', [COL_PHASES.numOrder]: 103 }],
                    ['AddRecord', TABLE.phases, null, { [COL_PHASES.nom]: 'Consultation MOE', [COL_PHASES.nomOrder]: '203 - Consultation MOE', [COL_PHASES.couleur]: '#7CD4FC', [COL_PHASES.numOrder]: 203 }],
                    ['AddRecord', TABLE.phases, null, { [COL_PHASES.nom]: '√âtudes',           [COL_PHASES.nomOrder]: '301 - √âtudes',           [COL_PHASES.couleur]: '#7CFCB8', [COL_PHASES.numOrder]: 301 }],
                    ['AddRecord', TABLE.phases, null, { [COL_PHASES.nom]: 'Travaux',          [COL_PHASES.nomOrder]: '401 - Travaux',          [COL_PHASES.couleur]: '#FCB87C', [COL_PHASES.numOrder]: 401 }],
                    ['AddRecord', TABLE.phases, null, { [COL_PHASES.nom]: 'Livraison',        [COL_PHASES.nomOrder]: '501 - Livraison',        [COL_PHASES.couleur]: '#FC7C7C', [COL_PHASES.numOrder]: 501 }]
                ]);
                log(`‚úÖ 7 phases ajout√©es √† ${TABLE.phases}`);

                await grist.docApi.applyUserActions([
                    ['AddRecord', TABLE.operations, null, { [COL_OPS.nom]: 'IUT1 Halles GCCD & GMP',    [COL_OPS.numOpe]: '2024_001', [COL_OPS.statut]: 'En cours' }],
                    ['AddRecord', TABLE.operations, null, { [COL_OPS.nom]: 'Biblioth√®que Briffaut',      [COL_OPS.numOpe]: '2023_011', [COL_OPS.statut]: 'En cours' }],
                    ['AddRecord', TABLE.operations, null, { [COL_OPS.nom]: 'Marguerite Soubeyran - ACC', [COL_OPS.numOpe]: '2024_005', [COL_OPS.statut]: 'Transf√©r√©e' }]
                ]);
                log(`‚úÖ 3 op√©rations ajout√©es √† ${TABLE.operations}`);

                await grist.docApi.applyUserActions([
                    ['AddRecord', TABLE.tasks, null, mkTask({ titre: 'Cahier des charges',          description: 'R√©diger le CDC complet',                dateDebut: day(-15), dateEcheance: day(-8),  priorite: '1', statut: 'done',       progression: 100, projet: 1, type: 'tache',  assignees: ['L', 1],       estimationH: 16 })],
                    ['AddRecord', TABLE.tasks, null, mkTask({ titre: 'Maquettes UI/UX',             description: 'Wireframes et prototypes Figma',         dateDebut: day(-10), dateEcheance: day(-2),  priorite: '2', statut: 'done',       progression: 100, projet: 1, type: 'tache',  assignees: ['L', 3],       estimationH: 24 })],
                    ['AddRecord', TABLE.tasks, null, mkTask({ titre: 'D√©veloppement frontend',      description: 'Int√©gration HTML/CSS/JS du portail',     dateDebut: day(-3),  dateEcheance: day(12),  priorite: '1', statut: 'inprogress', progression: 35,  projet: 1, type: 'tache',  assignees: ['L', 2, 3],    dependDe: ['L', 2],     estimationH: 40 })],
                    ['AddRecord', TABLE.tasks, null, mkTask({ titre: 'Validation design',           description: 'Point de validation des maquettes',      dateDebut: day(-2),  dateEcheance: day(-2),  priorite: '2', statut: 'done',       progression: 100, projet: 1, type: 'jalon' })],
                    ['AddRecord', TABLE.tasks, null, mkTask({ titre: 'API backend',                 description: 'D√©veloppement des endpoints REST',       dateDebut: day(-5),  dateEcheance: day(10),  priorite: '1', statut: 'inprogress', progression: 55,  projet: 1, type: 'tache',  assignees: ['L', 2],       estimationH: 32, tempsPasse: 18 })],
                    ['AddRecord', TABLE.tasks, null, mkTask({ titre: '√âtude terrain',              description: 'Analyse des besoins agents terrain',     dateDebut: day(-5),  dateEcheance: day(0),   priorite: '2', statut: 'review',     progression: 90,  projet: 2, type: 'tache',  assignees: ['L', 1, 4],    estimationH: 12 })],
                    ['AddRecord', TABLE.tasks, null, mkTask({ titre: 'Proto mobile v1',            description: 'Premier prototype React Native',         dateDebut: day(1),   dateEcheance: day(20),  priorite: '2', statut: 'todo',       progression: 0,   projet: 2, type: 'tache',  assignees: ['L', 2],       dependDe: ['L', 6],     estimationH: 48 })],
                    ['AddRecord', TABLE.tasks, null, mkTask({ titre: 'R√©union lancement mobile',  description: 'Kick-off parties prenantes',             dateDebut: day(2),   dateEcheance: day(2),   priorite: '3', statut: 'todo',       progression: 0,   projet: 2, type: 'reunion', assignees: ['L', 1, 2, 3, 4] })],
                    ['AddRecord', TABLE.tasks, null, mkTask({ titre: 'Collecte des sources',       description: 'Identifier et connecter les donn√©es',    dateDebut: day(0),   dateEcheance: day(7),   priorite: '2', statut: 'inprogress', progression: 20,  projet: 3, type: 'tache',  assignees: ['L', 4],       estimationH: 16 })],
                    ['AddRecord', TABLE.tasks, null, mkTask({ titre: 'Mod√®le de scoring IA',      description: 'Entra√Æner le mod√®le Albert API',         dateDebut: day(5),   dateEcheance: day(18),  priorite: '1', statut: 'todo',       progression: 0,   projet: 3, type: 'tache',  assignees: ['L', 4],       dependDe: ['L', 9],     estimationH: 30 })],
                    ['AddRecord', TABLE.tasks, null, mkTask({ titre: 'Widget dashboard Grist',     description: 'Interface de visualisation indicateurs', dateDebut: day(10),  dateEcheance: day(25),  priorite: '3', statut: 'todo',       progression: 0,   projet: 3, type: 'tache',  assignees: ['L', 2, 3],    estimationH: 24 })],
                    ['AddRecord', TABLE.tasks, null, mkTask({ titre: 'Livraison MVP Dashboard',    description: 'Version minimale fonctionnelle',         dateDebut: day(28),  dateEcheance: day(28),  priorite: '1', statut: 'todo',       progression: 0,   projet: 3, type: 'jalon',  dependDe: ['L', 10, 11] })]
                ]);
                log(`‚úÖ 12 t√¢ches ajout√©es √† ${TABLE.tasks}`);

            } catch (e) {
                log(`‚ö†Ô∏è Erreur seed: ${e.message || e}`);
            }
        }

        // Charge les tables secondaires (phases, responsables, op√©rations) via fetchTable.
        // Appel√© une fois au d√©marrage, et √† chaque changement d'options.
        // V√©rifie que les colonnes configur√©es existent dans les donn√©es fetchTable.
        // Retourne la liste des colonnes manquantes (nom logique + valeur configur√©e).
        function checkMissingCols(data, colObj, tableName) {
            const available = Object.keys(data).filter(c => c !== 'manualSort' && c !== 'id');
            const missing = [];
            Object.entries(colObj).forEach(([logicalName, configured]) => {
                if (!available.includes(configured)) {
                    missing.push({ table: tableName, col: logicalName, configured });
                }
            });
            return missing;
        }

        async function loadSecondaryData() {
            const allMissing = [];

            try {
                const cd = await grist.docApi.fetchTable(TABLE.responsableProjet);
                allMissing.push(...checkMissingCols(cd, COL_CHEF, TABLE.responsableProjet));
                team = convert(cd);
            } catch (e) { team = []; }

            try {
                const od = await grist.docApi.fetchTable(TABLE.operations);
                allMissing.push(...checkMissingCols(od, COL_OPS, TABLE.operations));
                projects = convert(od);
            } catch (e) { projects = []; }

            try {
                const phd = await grist.docApi.fetchTable(TABLE.phases);
                allMissing.push(...checkMissingCols(phd, COL_PHASES, TABLE.phases));
                phases = convert(phd);
            } catch (e) { phases = []; }

            // Si des colonnes configur√©es sont introuvables, avertir et ouvrir le panel
            if (allMissing.length > 0 && gristReady) {
                const msg = allMissing.map(m => `${m.table}.${m.configured}`).join(', ');
                showToast(`‚ö† Colonnes introuvables : ${msg} ‚Äî v√©rifiez la configuration`, 'error', 8000);
                // Ouvrir automatiquement le panneau config pour correction
                setTimeout(() => openConfigPanel(), 500);
            }
        }

        // Met √† jour COL[] avec les mappings re√ßus de onRecords.
        // mappings = { logicalName: physicalColId }
        // Ex: { titre: 'Categorie', dateDebut: 'Date_Debut', ... }
        function applyMappings(mappings) {
            if (!mappings) return;
            Object.keys(GRIST_CONFIG.columns.tasks).forEach(logicalName => {
                if (mappings[logicalName]) COL[logicalName] = mappings[logicalName];
            });
        }

        async function loadAllData() {
            try {
                const taskData = await grist.docApi.fetchTable(TABLE.tasks);
                tasks = convert(taskData);
                tasks.forEach(t => {
                    const v = t[COL.titre];
                    t._phaseId = (typeof v === 'number') ? v :
                                 (typeof v === 'string' && /^\d+$/.test(v)) ? Number(v) : null;
                });
            } catch(e) { tasks = []; }

            await loadSecondaryData();
            gristReady = true;
            sortTasks();
            updateFilterMenus();
            render();
        }

        async function initGrist() {
            try {
                // ‚îÄ‚îÄ D√©claration des colonnes mappables (panneau "Colonnes" de Grist) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                // L'utilisateur peut associer chaque champ logique √† n'importe quelle
                // colonne de sa table. Les 3 premiers champs sont obligatoires.
                grist.ready({
                    requiredAccess: 'full',
                    columns: [
                        { name: 'titre',         title: 'Cat√©gorie (Ref phases)',  type: 'Ref',        optional: false },
                        { name: 'dateDebut',     title: 'Date de d√©but',           type: 'Date',       optional: true  },
                        { name: 'duree',         title: 'Dur√©e (jours)',           type: 'Numeric',    optional: true  },
                        { name: 'dateDebutCalc', title: 'Date d√©but calcul√©e',     type: 'Date',       optional: true  },
                        { name: 'dateFinCalc',   title: 'Date fin calcul√©e',       type: 'Date',       optional: true  },
                        { name: 'projet',        title: 'Op√©ration (Ref)',         type: 'Ref',        optional: true  },
                        { name: 'assignees',     title: 'Responsables',            type: 'RefList',    optional: true  },
                        { name: 'dependDe',      title: 'D√©pend de',               type: 'RefList',    optional: true  },
                        { name: 'statut',        title: 'Statut',                  type: 'Choice',     optional: true  },
                        { name: 'type',          title: 'Type (tache/jalon)',       type: 'Choice',     optional: true  },
                        { name: 'progression',   title: 'Progression (%)',         type: 'Numeric',    optional: true  },
                        { name: 'priorite',      title: 'Priorit√©',                type: 'Choice',     optional: true  },
                        { name: 'couleur',       title: 'Couleur',                 type: 'Text',       optional: true  },
                        { name: 'description',   title: 'Description',             type: 'Text',       optional: true  },
                        { name: 'tags',          title: 'Tags',                    type: 'ChoiceList', optional: true  },
                        { name: 'estimationH',   title: 'Estimation (h)',          type: 'Numeric',    optional: true  },
                        { name: 'tempsPasse',    title: 'Temps pass√© (h)',         type: 'Numeric',    optional: true  }
                    ]
                });

                // ‚îÄ‚îÄ IMPORTANT : enregistrer onRecords IMM√âDIATEMENT apr√®s grist.ready() ‚îÄ‚îÄ
                // Grist envoie onRecords juste apr√®s ready(). Si on met un await avant,
                // l'√©v√©nement est manqu√© et les donn√©es n'arrivent jamais.
                grist.onRecords(async (records, mappings) => {
                    applyMappings(mappings);
                    await loadAllData();
                });

                // ‚îÄ‚îÄ Sync de s√©lection inter-widgets ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                grist.onRecord((rec) => {
                    if (rec?.id && rec.id !== selectedTaskId) {
                        selectedTaskId = rec.id;
                        document.querySelectorAll('.task-row, .gantt-bar, .gantt-milestone').forEach(el => {
                            el.classList.toggle('selected', parseInt(el.dataset.id) === selectedTaskId);
                        });
                    }
                });

                // ‚îÄ‚îÄ Options du widget (panneau "Options" de Grist) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                grist.onOptions((options) => {
                    if (!options) return;
                    // Noms des tables secondaires
                    if (options.tableChefProjet) TABLE.responsableProjet = options.tableChefProjet;
                    if (options.tableOperations) TABLE.operations = options.tableOperations;
                    if (options.tablePhases)     TABLE.phases     = options.tablePhases;
                    // Colonnes de DPPI_Chef_Projet
                    if (options.colChefNom)      COL_CHEF.nom      = options.colChefNom;
                    if (options.colChefPrenom)   COL_CHEF.prenom   = options.colChefPrenom;
                    if (options.colChefFonction) COL_CHEF.fonction = options.colChefFonction;
                    if (options.colChefActif)    COL_CHEF.actif    = options.colChefActif;
                    // Colonnes de DPPI_Operations
                    if (options.colOpsNom)       COL_OPS.nom      = options.colOpsNom;
                    if (options.colOpsNumOpe)    COL_OPS.numOpe   = options.colOpsNumOpe;
                    if (options.colOpsStatut)    COL_OPS.statut   = options.colOpsStatut;
                    // Colonnes de PL_Liste_Phases
                    if (options.colPhasesNom)      COL_PHASES.nom      = options.colPhasesNom;
                    if (options.colPhasesNomOrder) COL_PHASES.nomOrder = options.colPhasesNomOrder;
                    if (options.colPhasesCouleur)  COL_PHASES.couleur  = options.colPhasesCouleur;
                    if (options.colPhasesNumOrder) COL_PHASES.numOrder = options.colPhasesNumOrder;
                    // Recharger apr√®s changement d'options
                    loadAllData(); // recharge tables secondaires + re-render
                });

                // Auto-init du sch√©ma des tables secondaires uniquement
                await ensureSchema();

            } catch (e) {
                useDemoMode();
            }
        }

        function useDemoMode() {
            document.body.insertAdjacentHTML('beforeend', '<div class="demo-badge">D√©mo</div>');

            const today = new Date();
            const day = (d) => dateToGrist(new Date(today.getFullYear(), today.getMonth(), today.getDate() + d));

            // En mode d√©mo, les titres sont des IDs qui pointent vers phases[]
            // On cr√©e des phases d√©mo pour que resolvePhaseNom fonctionne
            phases = [
                { id: 1, [COL_PHASES.nomOrder]: '101 - Faisabilit√©',     [COL_PHASES.nom]: 'Faisabilit√©',     [COL_PHASES.couleur]: '#BC77FC', [COL_PHASES.numOrder]: 101 },
                { id: 2, [COL_PHASES.nomOrder]: '102 - Pr√©-programme',   [COL_PHASES.nom]: 'Pr√©-programme',   [COL_PHASES.couleur]: '#BC77FC', [COL_PHASES.numOrder]: 102 },
                { id: 3, [COL_PHASES.nomOrder]: '103 - Programme',       [COL_PHASES.nom]: 'Programme',       [COL_PHASES.couleur]: '#7C9EFC', [COL_PHASES.numOrder]: 103 },
                { id: 4, [COL_PHASES.nomOrder]: '203 - Consultation MOE',[COL_PHASES.nom]: 'Consultation MOE',[COL_PHASES.couleur]: '#7CD4FC', [COL_PHASES.numOrder]: 203 },
                { id: 5, [COL_PHASES.nomOrder]: '301 - √âtudes',          [COL_PHASES.nom]: '√âtudes',          [COL_PHASES.couleur]: '#7CFCB8', [COL_PHASES.numOrder]: 301 },
                { id: 6, [COL_PHASES.nomOrder]: '401 - Travaux',         [COL_PHASES.nom]: 'Travaux',         [COL_PHASES.couleur]: '#FCB87C', [COL_PHASES.numOrder]: 401 },
                { id: 7, [COL_PHASES.nomOrder]: '501 - Livraison',       [COL_PHASES.nom]: 'Livraison',       [COL_PHASES.couleur]: '#FC7C7C', [COL_PHASES.numOrder]: 501 },
            ];

            // Projets (op√©rations)
            projects = [
                { id: 1, [COL_OPS.nom]: 'IUT1 Halles GCCD & GMP',    [COL_OPS.numOpe]: '2024_001', [COL_OPS.statut]: 'En cours' },
                { id: 2, [COL_OPS.nom]: 'Biblioth√®que Briffaut',      [COL_OPS.numOpe]: '2023_011', [COL_OPS.statut]: 'En cours' },
                { id: 3, [COL_OPS.nom]: 'Marguerite Soubeyran - ACC', [COL_OPS.numOpe]: '2024_005', [COL_OPS.statut]: 'Transf√©r√©e' },
            ];

            // Responsables
            team = [
                { id: 1, [COL_CHEF.nom]: 'Cynthia Chaudron',  [COL_CHEF.fonction]: "Charg√©e d'op√©ration" },
                { id: 2, [COL_CHEF.nom]: 'Nathalie Gaillard', [COL_CHEF.fonction]: "Charg√©e d'op√©ration" },
                { id: 3, [COL_CHEF.nom]: 'Anne Blanchon',     [COL_CHEF.fonction]: "Charg√©e d'op√©ration" },
            ];

            // Helper : construit un enregistrement task avec les noms de colonnes dynamiques
            // titre = ID pointant vers phases
            const mk = (d) => {
                const rec = { id: d.id };
                rec[COL.titre]        = d.titreId;   // ID Ref vers phases
                rec[COL.priorite]     = d.priorite;
                rec[COL.projet]       = d.projetId;  // ID Ref vers projects
                rec[COL.dateDebut]    = d.dateDebut;
                rec[COL.dateEcheance] = d.dateEcheance;
                rec[COL.progression]  = d.progression || 0;
                rec[COL.statut]       = d.statut || 'todo';
                rec[COL.type]         = d.type || 'tache';
                if (d.assignees) rec[COL.assignees] = d.assignees;
                if (d.dependDe)  rec[COL.dependDe]  = d.dependDe;
                return rec;
            };

            tasks = [
                mk({ id: 1,  titreId: 1, projetId: 1, priorite: 3, statut: 'done',       progression: 100, dateDebut: day(-90), dateEcheance: day(-60), assignees: ['L', 1, 2] }),
                mk({ id: 2,  titreId: 2, projetId: 1, priorite: 3, statut: 'done',       progression: 100, dateDebut: day(-60), dateEcheance: day(-30), assignees: ['L', 1], dependDe: ['L', 1] }),
                mk({ id: 3,  titreId: 3, projetId: 1, priorite: 2, statut: 'done',       progression: 100, dateDebut: day(-30), dateEcheance: day(0),   assignees: ['L', 1, 2], dependDe: ['L', 2] }),
                mk({ id: 4,  titreId: 4, projetId: 1, priorite: 2, statut: 'inprogress', progression: 60,  dateDebut: day(0),   dateEcheance: day(30),  assignees: ['L', 1], dependDe: ['L', 3] }),
                mk({ id: 5,  titreId: 5, projetId: 1, priorite: 2, statut: 'todo',       progression: 0,   dateDebut: day(25),  dateEcheance: day(60),  assignees: ['L', 2], dependDe: ['L', 4] }),
                mk({ id: 6,  titreId: 3, projetId: 2, priorite: 3, statut: 'inprogress', progression: 40,  dateDebut: day(-20), dateEcheance: day(10),  assignees: ['L', 2, 3] }),
                mk({ id: 7,  titreId: 4, projetId: 2, priorite: 2, statut: 'todo',       progression: 0,   dateDebut: day(10),  dateEcheance: day(40),  assignees: ['L', 3], dependDe: ['L', 6] }),
                mk({ id: 8,  titreId: 5, projetId: 2, priorite: 1, statut: 'todo',       progression: 0,   dateDebut: day(35),  dateEcheance: day(70),  assignees: ['L', 2], dependDe: ['L', 7] }),
                mk({ id: 9,  titreId: 6, projetId: 2, priorite: 1, statut: 'todo',       progression: 0,   dateDebut: day(65),  dateEcheance: day(110), assignees: ['L', 2, 3], dependDe: ['L', 8] }),
                mk({ id: 10, titreId: 7, projetId: 2, priorite: 1, statut: 'todo',       progression: 0,   dateDebut: day(105), dateEcheance: day(105), assignees: ['L', 3], type: 'jalon', dependDe: ['L', 9] }),
            ];

            sortTasks();
            updateFilterMenus();
            render();
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PANNEAU DE CONFIGURATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // Mapping champs config ‚Üí cl√©s options Grist
        const CONFIG_FIELDS = [
            { id: 'cfg-tableChefProjet',   optionKey: 'tableChefProjet',   default: () => GRIST_CONFIG.tables.responsableProjet },
            { id: 'cfg-tableOperations',   optionKey: 'tableOperations',   default: () => GRIST_CONFIG.tables.operations },
            { id: 'cfg-tablePhases',       optionKey: 'tablePhases',       default: () => GRIST_CONFIG.tables.phases },
            { id: 'cfg-colChefNom',        optionKey: 'colChefNom',        default: () => GRIST_CONFIG.columns.responsableProjet.nom },
            { id: 'cfg-colChefFonction',   optionKey: 'colChefFonction',   default: () => GRIST_CONFIG.columns.responsableProjet.fonction },
            { id: 'cfg-colChefActif',      optionKey: 'colChefActif',      default: () => GRIST_CONFIG.columns.responsableProjet.actif },
            { id: 'cfg-colOpsNom',         optionKey: 'colOpsNom',         default: () => GRIST_CONFIG.columns.operations.nom },
            { id: 'cfg-colOpsNumOpe',      optionKey: 'colOpsNumOpe',      default: () => GRIST_CONFIG.columns.operations.numOpe },
            { id: 'cfg-colOpsStatut',      optionKey: 'colOpsStatut',      default: () => GRIST_CONFIG.columns.operations.statut },
            { id: 'cfg-colPhasesNom',      optionKey: 'colPhasesNom',      default: () => GRIST_CONFIG.columns.phases.nom },
            { id: 'cfg-colPhasesNomOrder', optionKey: 'colPhasesNomOrder', default: () => GRIST_CONFIG.columns.phases.nomOrder },
            { id: 'cfg-colPhasesCouleur',  optionKey: 'colPhasesCouleur',  default: () => GRIST_CONFIG.columns.phases.couleur },
            { id: 'cfg-colPhasesNumOrder', optionKey: 'colPhasesNumOrder', default: () => GRIST_CONFIG.columns.phases.numOrder },
        ];

        // Groupes : associe chaque groupe √† son select de table et ses selects de colonnes
        const CONFIG_GROUPS = {
            chef:   { tableId: 'cfg-tableChefProjet',  curTable: () => TABLE.responsableProjet },
            ops:    { tableId: 'cfg-tableOperations',  curTable: () => TABLE.operations },
            phases: { tableId: 'cfg-tablePhases',      curTable: () => TABLE.phases },
        };

        function closeConfigPanel() {
            document.getElementById('configPanel').classList.remove('open');
            document.getElementById('configOverlay').classList.remove('visible');
            document.getElementById('configBtn').classList.remove('active');
        }

        async function openConfigPanel() {
            document.getElementById('configPanel').classList.add('open');
            document.getElementById('configOverlay').classList.add('visible');
            document.getElementById('configBtn').classList.add('active');
            await populateConfigSelects();
        }

        async function populateConfigSelects() {
            // R√©cup√©rer toutes les tables du document
            let allTables = [];
            try { allTables = await grist.docApi.listTables(); } catch(e) {}

            // Valeurs courantes sauvegard√©es
            const current = {};
            CONFIG_FIELDS.forEach(f => {
                const el = document.getElementById(f.id);
                current[f.optionKey] = el?.value || f.default();
            });

            // Peupler les selects de tables et d√©clencher le chargement des colonnes
            for (const [group, cfg] of Object.entries(CONFIG_GROUPS)) {
                const tableSel = document.getElementById(cfg.tableId);
                if (!tableSel) continue;
                const curTable = cfg.curTable();
                tableSel.innerHTML = allTables.map(t =>
                    `<option value="${t}"${t === curTable ? ' selected' : ''}>${t}</option>`
                ).join('');
                await loadColumnsForGroup(group, curTable, current);
            }
        }

        async function loadColumnsForGroup(group, tableName, current) {
            if (!tableName) return;
            let cols = [];
            try {
                const data = await grist.docApi.fetchTable(tableName);
                cols = Object.keys(data).filter(c => c !== 'manualSort' && c !== 'id');
            } catch(e) { return; }

            document.querySelectorAll(`[data-group="${group}"]`).forEach(sel => {
                const field = CONFIG_FIELDS.find(f => f.id === sel.id);
                const curVal = current ? (current[field?.optionKey] || field?.default()) : sel.value;
                // Si la colonne configur√©e n'existe plus dans la table, ajouter une option
                // marqu√©e pour alerter l'utilisateur
                const colExists = cols.includes(curVal);
                sel.innerHTML = cols.map(c =>
                    `<option value="${c}"${c === curVal ? ' selected' : ''}>${c}</option>`
                ).join('');
                if (!colExists && curVal) {
                    sel.insertAdjacentHTML('afterbegin',
                        `<option value="${curVal}" selected style="color:var(--danger)">‚ö† ${curVal} (introuvable)</option>`);
                }
            });
        }

        async function onTableSelect(tableSelectEl, group) {
            await loadColumnsForGroup(group, tableSelectEl.value, null);
        }

        async function resetConfigToDefaults() {
            // R√©initialiser TABLE/COL aux d√©fauts GRIST_CONFIG
            TABLE.responsableProjet = GRIST_CONFIG.tables.responsableProjet;
            TABLE.operations        = GRIST_CONFIG.tables.operations;
            TABLE.phases            = GRIST_CONFIG.tables.phases;
            COL_CHEF   = { ...GRIST_CONFIG.columns.responsableProjet };
            COL_OPS    = { ...GRIST_CONFIG.columns.operations };
            COL_PHASES = { ...GRIST_CONFIG.columns.phases };
            await populateConfigSelects();
        }

                async function saveConfig() {
            const options = {};
            CONFIG_FIELDS.forEach(f => {
                const el = document.getElementById(f.id);
                if (!el) return;
                options[f.optionKey] = el.value || f.default();
            });

            // Appliquer imm√©diatement les nouvelles valeurs aux variables actives
            TABLE.responsableProjet = options.tableChefProjet;
            TABLE.operations = options.tableOperations;
            TABLE.phases     = options.tablePhases;

            COL_CHEF.nom      = options.colChefNom;
            COL_CHEF.fonction = options.colChefFonction;
            COL_CHEF.actif    = options.colChefActif;

            COL_OPS.nom    = options.colOpsNom;
            COL_OPS.numOpe = options.colOpsNumOpe;
            COL_OPS.statut = options.colOpsStatut;

            COL_PHASES.nom      = options.colPhasesNom;
            COL_PHASES.nomOrder = options.colPhasesNomOrder;
            COL_PHASES.couleur  = options.colPhasesCouleur;
            COL_PHASES.numOrder = options.colPhasesNumOrder;



            // Persister dans Grist si disponible
            if (gristReady) {
                try {
                    await grist.setOptions(options);
                    showToast('Configuration enregistr√©e', 'success');
                } catch (e) {
                    console.error('setOptions error:', e);
                    showToast("Erreur lors de l'enregistrement", 'error');
                }
            } else {
                // Mode d√©mo : appliquer sans persister
                showToast('Configuration appliqu√©e (mode d√©mo)', 'info');
            }

            closeConfigPanel();

            // Recharger les donn√©es avec les nouveaux noms
            if (gristReady) {
                await loadAllData();
            } else {
                // En mode d√©mo, recharger les donn√©es d√©mo avec les nouveaux noms COL
                sortTasks();
                updateFilterMenus();
                render();
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // INIT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // Re-render si la fenetre change de taille (pour recalculer getViewCellCount)
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => render(), 100);
        });



        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });

        loadFilters();
        document.documentElement.style.setProperty('--cell-width', VIEW_CONFIG[currentView].cellWidth + 'px');
        // Initialiser les donn√©es de filtre
        buildFilterData();

        // D√©l√©gation en capture (true) pour passer avant tout autre handler Grist
        document.addEventListener('click', function(e) {
            const inFilter = e.target.closest('.filter-dropdown');
            if (!inFilter) { closeAllFilterMenus(); return; }

            const toggleBtn = e.target.closest('[data-filter-toggle]');
            if (toggleBtn) { e.stopPropagation(); toggleFilterMenu(toggleBtn.dataset.filterToggle); return; }

            const applyBtn = e.target.closest('[data-filter-apply]');
            if (applyBtn) { e.stopPropagation(); applyFilterMenu(applyBtn.dataset.filterApply); return; }

            const actionBtn = e.target.closest('[data-filter-action]');
            if (actionBtn) {
                e.stopPropagation();
                const t = actionBtn.dataset.filterType;
                if (actionBtn.dataset.filterAction === 'all') selectAllFilter(t);
                else clearFilter(t);
                return;
            }

            const opt = e.target.closest('.filter-option[data-filter-idx]');
            if (opt) {
                e.stopPropagation();
                const listEl = opt.closest('#filterProjectList, #filterAssigneeList');
                if (listEl) {
                    const idx = parseInt(opt.dataset.filterIdx);
                    const items = listEl._visibleItems;
                    const type = listEl._filterType;
                    if (items && type && items[idx]) toggleFilter(type, items[idx].id);
                }
            }
        }, true);



        document.addEventListener('input', function(e) {
            if (e.target.id === 'filterProjectSearch') {
                const q = e.target.value || '';
                filterSearch.projects = q;
                if (q) {
                    // S√©lectionner automatiquement les items qui matchent
                    buildFilterData();
                    const matched = filterData.projects
                        .filter(it => it.nom.toLowerCase().includes(q.toLowerCase()))
                        .map(it => it.id);
                    filters.projects = matched;
                } else {
                    filters.projects = null;
                }
                renderFilterList('projects', q);
                updateFilterUI();
            } else if (e.target.id === 'filterAssigneeSearch') {
                const q = e.target.value || '';
                filterSearch.assignees = q;
                if (q) {
                    buildFilterData();
                    const matched = filterData.assignees
                        .filter(it => it.nom.toLowerCase().includes(q.toLowerCase()))
                        .map(it => it.id);
                    filters.assignees = matched;
                } else {
                    filters.assignees = null;
                }
                renderFilterList('assignees', q);
                updateFilterUI();
            }
        }, true);

        // Initialiser le layout compact (mode par d√©faut)
        setLayoutMode('compact');
        document.querySelectorAll('.view-controls .btn').forEach(b => b.classList.toggle('active', b.dataset.view === currentView));
        initGrist();
    </script>
</body>
</html>