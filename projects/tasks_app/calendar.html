<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar - TaskFlow v6</title>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-light: #e0e7ff;
            --primary-dark: #4338ca;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
        }

        /* === HEADER === */
        .header {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
            flex-shrink: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header h1 {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-center {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn {
            padding: 7px 14px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--card-bg);
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 0.78rem;
            transition: all 0.15s;
            color: var(--text);
        }

        .btn:hover { background: var(--bg); }
        .btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .btn.primary { background: var(--primary); color: white; border-color: var(--primary); }
        .btn.primary:hover { background: var(--primary-dark); }
        .btn-nav { padding: 7px 10px; }

        .view-controls {
            display: flex;
            background: var(--bg);
            padding: 3px;
            border-radius: 6px;
            gap: 2px;
        }

        .view-controls .btn {
            border: none;
            background: transparent;
            padding: 5px 12px;
            border-radius: 4px;
        }

        .view-controls .btn.active { background: var(--primary); color: white; }

        .current-period {
            font-weight: 600;
            font-size: 0.9rem;
            min-width: 130px;
            text-align: center;
        }

        /* === FILTER BAR === */
        .filter-bar {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            padding: 8px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            flex-shrink: 0;
        }

        .filter-dropdown { position: relative; }

        .filter-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 5px 10px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.75rem;
        }

        .filter-btn:hover { background: var(--bg); }
        .filter-btn.active { background: var(--primary-light); border-color: var(--primary); color: var(--primary); }

        .filter-menu {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 4px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            box-shadow: var(--shadow-lg);
            min-width: 150px;
            z-index: 200;
            display: none;
            max-height: 250px;
            overflow-y: auto;
        }

        .filter-menu.open { display: block; }

        .filter-option {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-option:hover { background: var(--bg); }
        .filter-option.active { background: var(--primary-light); color: var(--primary); }

        .filter-option .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .active-filters {
            display: flex;
            gap: 6px;
        }

        .filter-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            background: var(--primary-light);
            color: var(--primary);
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .filter-chip button {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 0.8rem;
            padding: 0;
            margin-left: 2px;
        }

        /* === CALENDAR CONTAINER === */
        .calendar-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* === MONTH VIEW === */
        .month-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .month-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: var(--bg);
            border-bottom: 1px solid var(--border);
        }

        .month-header-cell {
            padding: 10px;
            text-align: center;
            font-weight: 600;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .month-header-cell.weekend { color: var(--danger); }

        .month-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: repeat(6, 1fr);
            background: var(--card-bg);
            overflow: hidden;
        }

        .day-cell {
            border-right: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            padding: 4px;
            display: flex;
            flex-direction: column;
            min-height: 90px;
            cursor: pointer;
            transition: background 0.1s;
        }

        .day-cell:hover { background: var(--bg); }
        .day-cell:nth-child(7n) { border-right: none; }
        .day-cell.other-month { background: #fafbfc; }
        .day-cell.other-month .day-number { color: var(--text-muted); opacity: 0.5; }
        .day-cell.weekend { background: #fef8f8; }
        .day-cell.today { background: var(--primary-light); }

        .day-number {
            font-size: 0.85rem;
            font-weight: 500;
            padding: 2px 6px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            width: 26px;
            height: 26px;
            margin-bottom: 4px;
        }

        .day-cell.today .day-number {
            background: var(--primary);
            color: white;
        }

        .day-events {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .event-item {
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 0.68rem;
            color: white;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: transform 0.1s;
        }

        .event-item:hover { transform: scale(1.02); }
        .event-item.selected { outline: 2px solid var(--text); outline-offset: 1px; }

        .event-item.p1 { background: var(--danger); }
        .event-item.p2 { background: var(--warning); }
        .event-item.p3 { background: var(--info); }
        .event-item.p4 { background: var(--text-muted); }

        .event-item.milestone {
            background: transparent;
            border: 2px solid currentColor;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .event-item.milestone.p1 { border-color: var(--danger); color: var(--danger); }
        .event-item.milestone.p2 { border-color: var(--warning); color: #a16207; }
        .event-item.milestone.p3 { border-color: var(--info); color: var(--info); }
        .event-item.milestone.p4 { border-color: var(--text-muted); color: var(--text-muted); }

        .event-item.milestone::before {
            content: "â—†";
            font-size: 0.6rem;
        }

        .more-events {
            font-size: 0.65rem;
            color: var(--text-muted);
            padding: 2px 6px;
            cursor: pointer;
            text-align: center;
        }

        .more-events:hover { color: var(--primary); }

        /* === WEEK VIEW === */
        .week-view {
            flex: 1;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .week-view.active { display: flex; }
        .month-view.active { display: flex; }

        .week-header {
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr);
            background: var(--bg);
            border-bottom: 1px solid var(--border);
        }

        .week-header-cell {
            padding: 10px 8px;
            text-align: center;
            border-right: 1px solid var(--border);
        }

        .week-header-cell:last-child { border-right: none; }

        .week-header-cell .day-name {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .week-header-cell .day-num {
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 2px;
        }

        .week-header-cell.today { background: var(--primary-light); }
        .week-header-cell.today .day-num {
            background: var(--primary);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .week-body {
            flex: 1;
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr);
            overflow-y: auto;
        }

        .time-column {
            display: flex;
            flex-direction: column;
        }

        .time-slot {
            height: 50px;
            border-bottom: 1px solid var(--border);
            font-size: 0.65rem;
            color: var(--text-muted);
            padding: 4px;
            text-align: right;
        }

        .week-day-column {
            position: relative;
            border-right: 1px solid var(--border);
        }

        .week-day-column:last-child { border-right: none; }

        .hour-slot {
            height: 50px;
            border-bottom: 1px solid var(--border);
            position: relative;
        }

        .hour-slot:hover { background: var(--bg); }

        .week-event {
            position: absolute;
            left: 2px;
            right: 2px;
            padding: 3px 5px;
            border-radius: 4px;
            font-size: 0.65rem;
            color: white;
            overflow: hidden;
            cursor: pointer;
            z-index: 10;
        }

        .week-event.p1 { background: var(--danger); }
        .week-event.p2 { background: var(--warning); }
        .week-event.p3 { background: var(--info); }
        .week-event.p4 { background: var(--text-muted); }

        .all-day-row {
            display: grid;
            grid-template-columns: 60px repeat(7, 1fr);
            min-height: 30px;
            background: var(--bg);
            border-bottom: 1px solid var(--border);
        }

        .all-day-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            padding: 6px 4px;
            text-align: right;
        }

        .all-day-cell {
            border-right: 1px solid var(--border);
            padding: 3px;
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
        }

        .all-day-cell:last-child { border-right: none; }

        /* === MODAL === */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }

        .modal-overlay.open { opacity: 1; visibility: visible; }

        .modal {
            background: var(--card-bg);
            border-radius: 14px;
            width: 90%;
            max-width: 480px;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transform: scale(0.95);
            transition: transform 0.2s;
        }

        .modal-overlay.open .modal { transform: scale(1); }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-close {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            border: none;
            background: var(--bg);
            cursor: pointer;
            font-size: 1.1rem;
            color: var(--text-muted);
        }

        .modal-close:hover { background: var(--border); }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 14px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Form elements */
        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 0.78rem;
            font-weight: 500;
            margin-bottom: 5px;
            color: var(--text);
        }

        .form-group label .required { color: var(--danger); }

        .form-control {
            width: 100%;
            padding: 9px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.85rem;
            transition: all 0.15s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 70px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .type-tabs {
            display: flex;
            background: var(--bg);
            padding: 3px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .type-tab {
            flex: 1;
            padding: 8px 12px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 0.8rem;
            border-radius: 6px;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .type-tab:hover { background: var(--card-bg); }
        .type-tab.active { background: var(--primary); color: white; }

        .priority-selector {
            display: flex;
            gap: 6px;
        }

        .priority-option {
            flex: 1;
            padding: 8px;
            border: 2px solid var(--border);
            border-radius: 6px;
            background: var(--card-bg);
            cursor: pointer;
            text-align: center;
            font-size: 0.7rem;
            font-weight: 500;
            transition: all 0.15s;
        }

        .priority-option:hover { border-color: var(--text-muted); }
        .priority-option.active.p1 { border-color: var(--danger); background: #fef2f2; color: var(--danger); }
        .priority-option.active.p2 { border-color: var(--warning); background: #fefce8; color: #a16207; }
        .priority-option.active.p3 { border-color: var(--info); background: #eff6ff; color: var(--info); }
        .priority-option.active.p4 { border-color: var(--text-muted); background: var(--bg); }

        .priority-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 4px;
        }

        .priority-dot.p1 { background: var(--danger); }
        .priority-dot.p2 { background: var(--warning); }
        .priority-dot.p3 { background: var(--info); }
        .priority-dot.p4 { background: var(--text-muted); }

        .time-inputs {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .time-inputs input {
            width: 100px;
        }

        .time-inputs span {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
        }

        .checkbox-group input {
            width: 16px;
            height: 16px;
        }

        /* === DETAIL MODAL === */
        .detail-section {
            margin-bottom: 16px;
        }

        .detail-section-title {
            font-size: 0.72rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .detail-item {
            padding: 10px;
            background: var(--bg);
            border-radius: 6px;
        }

        .detail-label {
            font-size: 0.68rem;
            color: var(--text-muted);
            margin-bottom: 2px;
        }

        .detail-value {
            font-size: 0.85rem;
            font-weight: 500;
        }

        .progress-display {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-bar-large {
            flex: 1;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar-large-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 4px;
        }

        /* === QUICK ADD === */
        .quick-add {
            position: absolute;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            padding: 12px;
            width: 280px;
            z-index: 500;
            display: none;
        }

        .quick-add.open { display: block; }

        .quick-add-input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.85rem;
            margin-bottom: 8px;
        }

        .quick-add-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .quick-add-actions {
            display: flex;
            justify-content: flex-end;
            gap: 6px;
        }

        /* === LEGEND === */
        .legend {
            display: flex;
            gap: 14px;
            padding: 8px 20px;
            background: var(--card-bg);
            border-top: 1px solid var(--border);
            font-size: 0.7rem;
            align-items: center;
            flex-wrap: wrap;
            flex-shrink: 0;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-color {
            width: 10px;
            height: 10px;
            border-radius: 2px;
        }

        .legend-milestone {
            width: 8px;
            height: 8px;
            background: var(--text-muted);
            transform: rotate(45deg);
        }

        .legend-separator {
            width: 1px;
            height: 16px;
            background: var(--border);
        }

        /* === TOAST === */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
        }

        .toast {
            padding: 10px 16px;
            background: var(--text);
            color: white;
            border-radius: 6px;
            margin-top: 6px;
            font-size: 0.8rem;
            animation: slideIn 0.3s ease;
        }

        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .demo-badge {
            position: fixed;
            top: 8px;
            right: 8px;
            background: var(--warning);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 600;
            z-index: 100;
        }

        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .header { flex-direction: column; align-items: stretch; }
            .header-center { justify-content: center; }
            .month-header-cell { font-size: 0.7rem; padding: 8px 4px; }
            .day-cell { min-height: 70px; }
            .event-item { font-size: 0.6rem; padding: 2px 4px; }
            .form-row { grid-template-columns: 1fr; }
        }

        @media (max-width: 480px) {
            .month-header-cell { font-size: 0.6rem; }
            .day-number { font-size: 0.75rem; width: 22px; height: 22px; }
            .view-controls .btn { padding: 4px 8px; font-size: 0.7rem; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <h1>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                Calendar
            </h1>
        </div>
        <div class="header-center">
            <button class="btn btn-nav" onclick="navigate(-1)">â—€</button>
            <button class="btn" onclick="goToToday()">Aujourd'hui</button>
            <button class="btn btn-nav" onclick="navigate(1)">â–¶</button>
            <span class="current-period" id="currentPeriod"></span>
            <div class="view-controls">
                <button class="btn" data-view="week" onclick="setView('week')">Sem</button>
                <button class="btn active" data-view="month" onclick="setView('month')">Mois</button>
            </div>
        </div>
        <div class="header-right">
            <button class="btn primary" onclick="openCreateModal()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Nouveau
            </button>
        </div>
    </div>

    <div class="filter-bar">
        <div class="filter-dropdown" id="filterProject">
            <button class="filter-btn" onclick="toggleFilterMenu('filterProject')">
                <span id="filterProjectLabel">Projet â–¾</span>
            </button>
            <div class="filter-menu" id="filterProjectMenu"></div>
        </div>
        <div class="filter-dropdown" id="filterPriority">
            <button class="filter-btn" onclick="toggleFilterMenu('filterPriority')">
                <span id="filterPriorityLabel">PrioritÃ© â–¾</span>
            </button>
            <div class="filter-menu" id="filterPriorityMenu"></div>
        </div>
        <div class="filter-dropdown" id="filterType">
            <button class="filter-btn" onclick="toggleFilterMenu('filterType')">
                <span id="filterTypeLabel">Type â–¾</span>
            </button>
            <div class="filter-menu" id="filterTypeMenu"></div>
        </div>
        <div class="active-filters" id="activeFilters"></div>
    </div>

    <div class="calendar-wrapper">
        <div class="month-view active" id="monthView">
            <div class="month-header" id="monthHeader"></div>
            <div class="month-grid" id="monthGrid"></div>
        </div>

        <div class="week-view" id="weekView">
            <div class="week-header" id="weekHeader"></div>
            <div class="all-day-row" id="allDayRow"></div>
            <div class="week-body" id="weekBody"></div>
        </div>
    </div>

    <div class="legend">
        <div class="legend-item"><div class="legend-color" style="background: var(--danger)"></div>Critique</div>
        <div class="legend-item"><div class="legend-color" style="background: var(--warning)"></div>Haute</div>
        <div class="legend-item"><div class="legend-color" style="background: var(--info)"></div>Moyenne</div>
        <div class="legend-item"><div class="legend-color" style="background: var(--text-muted)"></div>Basse</div>
        <div class="legend-separator"></div>
        <div class="legend-item"><div class="legend-milestone"></div>Jalon</div>
    </div>

    <!-- Create/Edit Modal -->
    <div class="modal-overlay" id="eventModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">ðŸ“… Nouvel Ã©vÃ©nement</div>
                <button class="modal-close" onclick="closeModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="eventId">

                <div class="type-tabs">
                    <button class="type-tab active" data-type="tache" onclick="selectEventType('tache')">ðŸ“‹ TÃ¢che</button>
                    <button class="type-tab" data-type="jalon" onclick="selectEventType('jalon')">â—† Jalon</button>
                    <button class="type-tab" data-type="reunion" onclick="selectEventType('reunion')">ðŸ‘¥ RÃ©union</button>
                </div>

                <div class="form-group">
                    <label>Titre <span class="required">*</span></label>
                    <input type="text" class="form-control" id="eventTitle" placeholder="Nom de l'Ã©vÃ©nement">
                </div>

                <div class="form-group">
                    <label>Description</label>
                    <textarea class="form-control" id="eventDescription" placeholder="Description..."></textarea>
                </div>

                <div class="form-row" id="dateFields">
                    <div class="form-group">
                        <label>Date de dÃ©but</label>
                        <input type="date" class="form-control" id="eventStartDate">
                    </div>
                    <div class="form-group">
                        <label>Date de fin</label>
                        <input type="date" class="form-control" id="eventEndDate">
                    </div>
                </div>

                <div class="form-row" id="timeFields" style="display: none;">
                    <div class="form-group">
                        <label>Heure de dÃ©but</label>
                        <input type="time" class="form-control" id="eventStartTime" value="09:00">
                    </div>
                    <div class="form-group">
                        <label>Heure de fin</label>
                        <input type="time" class="form-control" id="eventEndTime" value="10:00">
                    </div>
                </div>

                <div class="form-group" id="allDayField">
                    <label class="checkbox-group">
                        <input type="checkbox" id="eventAllDay" checked onchange="toggleTimeFields()">
                        JournÃ©e entiÃ¨re
                    </label>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Projet</label>
                        <select class="form-control" id="eventProject">
                            <option value="">Aucun</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Statut</label>
                        <select class="form-control" id="eventStatus">
                            <option value="todo">Ã€ faire</option>
                            <option value="inprogress">En cours</option>
                            <option value="review">En revue</option>
                            <option value="done">TerminÃ©</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>PrioritÃ©</label>
                    <div class="priority-selector" id="prioritySelector">
                        <div class="priority-option p1" data-priority="1" onclick="selectPriority(1)">
                            <span class="priority-dot p1"></span>Critique
                        </div>
                        <div class="priority-option p2" data-priority="2" onclick="selectPriority(2)">
                            <span class="priority-dot p2"></span>Haute
                        </div>
                        <div class="priority-option p3 active" data-priority="3" onclick="selectPriority(3)">
                            <span class="priority-dot p3"></span>Moyenne
                        </div>
                        <div class="priority-option p4" data-priority="4" onclick="selectPriority(4)">
                            <span class="priority-dot p4"></span>Basse
                        </div>
                    </div>
                </div>

                <div class="form-group" id="progressField">
                    <label>Progression: <span id="progressValue">0%</span></label>
                    <input type="range" class="form-control" id="eventProgress" min="0" max="100" value="0" 
                           style="padding: 0;" oninput="updateProgressValue()">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal()">Annuler</button>
                <button class="btn primary" onclick="saveEvent()">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div class="modal-overlay" id="detailModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="detailTitle">ðŸ“‹ DÃ©tails</div>
                <button class="modal-close" onclick="closeDetailModal()">Ã—</button>
            </div>
            <div class="modal-body" id="detailBody"></div>
            <div class="modal-footer">
                <button class="btn" onclick="editEvent()">Modifier</button>
                <button class="btn" onclick="closeDetailModal()">Fermer</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CONFIGURATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const PRIORITY_LABELS = { 1: 'Critique', 2: 'Haute', 3: 'Moyenne', 4: 'Basse' };
        const PRIORITY_COLORS = { 1: '#ef4444', 2: '#f59e0b', 3: '#3b82f6', 4: '#64748b' };
        const STATUS_LABELS = { 'todo': 'Ã€ faire', 'inprogress': 'En cours', 'review': 'En revue', 'done': 'TerminÃ©' };
        const DAYS_SHORT = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
        const DAYS_FULL = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
        const MONTHS = ['Janvier', 'FÃ©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'AoÃ»t', 'Septembre', 'Octobre', 'Novembre', 'DÃ©cembre'];
        const MONTHS_SHORT = ['Jan', 'FÃ©v', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'AoÃ»t', 'Sep', 'Oct', 'Nov', 'DÃ©c'];

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // STATE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let gristReady = false;
        let tasks = [];
        let team = [];
        let projects = [];
        let currentView = 'month';
        let currentDate = new Date();
        let selectedTaskId = null;
        let selectedPriority = 3;
        let selectedType = 'tache';
        let filters = { project: null, priority: null, type: null };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // UTILITIES
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const escapeHtml = (t) => { if (!t) return ''; const d = document.createElement('div'); d.textContent = t; return d.innerHTML; };
        const gristToDate = (ts) => { if (ts == null || ts === '') return null; const n = Number(ts); return isNaN(n) ? null : new Date(n * 1000); };
        const dateToGrist = (d) => d ? Math.floor(d.getTime() / 1000) : null;
        const formatDate = (d) => d ? new Intl.DateTimeFormat('fr-FR', { day: '2-digit', month: 'short', year: 'numeric' }).format(d) : '-';
        const formatDateShort = (d) => d ? new Intl.DateTimeFormat('fr-FR', { day: '2-digit', month: 'short' }).format(d) : '-';
        const formatDateInput = (d) => d ? d.toISOString().split('T')[0] : '';
        const isSameDay = (a, b) => a && b && a.toDateString() === b.toDateString();
        const isWeekend = (d) => d.getDay() === 0 || d.getDay() === 6;
        const addDays = (d, n) => { const r = new Date(d); r.setDate(r.getDate() + n); return r; };
        const getTaskPriority = (t) => (t?.priorite >= 1 && t?.priorite <= 4) ? t.priorite : 3;
        const isJalon = (t) => t?.type === 'jalon' || (gristToDate(t?.dateDebut)?.toDateString() === gristToDate(t?.dateEcheance)?.toDateString());
        const isReunion = (t) => t?.type === 'reunion';

        function getAssigneesArray(t) {
            if (!t?.assignees) return [];
            if (Array.isArray(t.assignees)) return t.assignees[0] === 'L' ? t.assignees.slice(1).map(Number) : t.assignees.map(Number);
            return [];
        }

        function showToast(msg, type = 'info') {
            const c = document.getElementById('toastContainer');
            const t = document.createElement('div');
            t.className = `toast ${type}`;
            t.textContent = msg;
            c.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DATE CALCULATIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function getStartOfWeek(d) {
            const r = new Date(d);
            const day = r.getDay();
            r.setDate(r.getDate() - day + (day === 0 ? -6 : 1));
            r.setHours(0, 0, 0, 0);
            return r;
        }

        function getStartOfMonth(d) { return new Date(d.getFullYear(), d.getMonth(), 1); }

        function getMonthDays(year, month) {
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const days = [];

            // Previous month days
            const startDay = firstDay.getDay() || 7;
            for (let i = startDay - 1; i > 0; i--) {
                const d = new Date(year, month, 1 - i);
                days.push({ date: d, otherMonth: true });
            }

            // Current month days
            for (let i = 1; i <= lastDay.getDate(); i++) {
                days.push({ date: new Date(year, month, i), otherMonth: false });
            }

            // Next month days
            const remaining = 42 - days.length;
            for (let i = 1; i <= remaining; i++) {
                days.push({ date: new Date(year, month + 1, i), otherMonth: true });
            }

            return days;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // VIEW & NAVIGATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function setView(view) {
            currentView = view;
            document.querySelectorAll('.view-controls .btn').forEach(b => b.classList.toggle('active', b.dataset.view === view));
            document.getElementById('monthView').classList.toggle('active', view === 'month');
            document.getElementById('weekView').classList.toggle('active', view === 'week');
            localStorage.setItem('taskflow_calendar_view', view);
            render();
        }

        function navigate(dir) {
            if (currentView === 'month') {
                currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + dir, 1);
            } else {
                currentDate = addDays(currentDate, dir * 7);
            }
            render();
        }

        function goToToday() {
            currentDate = new Date();
            render();
        }

        function updatePeriodLabel() {
            let text = '';
            if (currentView === 'month') {
                text = `${MONTHS[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
            } else {
                const start = getStartOfWeek(currentDate);
                const end = addDays(start, 6);
                text = `${formatDateShort(start)} - ${formatDateShort(end)}`;
            }
            document.getElementById('currentPeriod').textContent = text;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FILTERS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function loadPrefs() {
            try {
                const s = localStorage.getItem('taskflow_calendar_filters');
                if (s) filters = { ...filters, ...JSON.parse(s) };
                const v = localStorage.getItem('taskflow_calendar_view');
                if (v) currentView = v;
            } catch (e) {}
        }

        function toggleFilterMenu(id) {
            const m = document.querySelector(`#${id} .filter-menu`);
            const open = m.classList.contains('open');
            document.querySelectorAll('.filter-menu').forEach(x => x.classList.remove('open'));
            if (!open) m.classList.add('open');
        }

        function setFilter(key, val) {
            filters[key] = val || null;
            localStorage.setItem('taskflow_calendar_filters', JSON.stringify(filters));
            updateFilterUI();
            render();
        }

        function updateFilterMenus() {
            const projs = [...new Set(tasks.map(t => t.projet).filter(Boolean))].sort();
            document.getElementById('filterProjectMenu').innerHTML = `
                <div class="filter-option ${!filters.project ? 'active' : ''}" onclick="setFilter('project', null)">Tous</div>
                ${projs.map(p => `<div class="filter-option ${filters.project === p ? 'active' : ''}" onclick="setFilter('project', '${escapeHtml(p)}')">${escapeHtml(p)}</div>`).join('')}
            `;

            document.getElementById('filterPriorityMenu').innerHTML = `
                <div class="filter-option ${!filters.priority ? 'active' : ''}" onclick="setFilter('priority', null)">Toutes</div>
                ${[1,2,3,4].map(p => `<div class="filter-option ${filters.priority === p ? 'active' : ''}" onclick="setFilter('priority', ${p})">
                    <span class="dot" style="background:${PRIORITY_COLORS[p]}"></span>${PRIORITY_LABELS[p]}
                </div>`).join('')}
            `;

            document.getElementById('filterTypeMenu').innerHTML = `
                <div class="filter-option ${!filters.type ? 'active' : ''}" onclick="setFilter('type', null)">Tous</div>
                <div class="filter-option ${filters.type === 'tache' ? 'active' : ''}" onclick="setFilter('type', 'tache')">ðŸ“‹ TÃ¢ches</div>
                <div class="filter-option ${filters.type === 'jalon' ? 'active' : ''}" onclick="setFilter('type', 'jalon')">â—† Jalons</div>
                <div class="filter-option ${filters.type === 'reunion' ? 'active' : ''}" onclick="setFilter('type', 'reunion')">ðŸ‘¥ RÃ©unions</div>
            `;

            // Update project select in modal
            document.getElementById('eventProject').innerHTML = `
                <option value="">Aucun</option>
                ${projs.map(p => `<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join('')}
            `;

            updateFilterUI();
        }

        function updateFilterUI() {
            const projBtn = document.querySelector('#filterProject .filter-btn');
            const prioBtn = document.querySelector('#filterPriority .filter-btn');
            const typeBtn = document.querySelector('#filterType .filter-btn');

            projBtn.className = 'filter-btn' + (filters.project ? ' active' : '');
            prioBtn.className = 'filter-btn' + (filters.priority ? ' active' : '');
            typeBtn.className = 'filter-btn' + (filters.type ? ' active' : '');

            document.getElementById('filterProjectLabel').textContent = filters.project || 'Projet â–¾';
            document.getElementById('filterPriorityLabel').textContent = filters.priority ? PRIORITY_LABELS[filters.priority] : 'PrioritÃ© â–¾';
            document.getElementById('filterTypeLabel').textContent = filters.type ? 
                (filters.type === 'tache' ? 'TÃ¢ches' : filters.type === 'jalon' ? 'Jalons' : 'RÃ©unions') : 'Type â–¾';

            const chips = [];
            if (filters.project) chips.push(`<span class="filter-chip">${escapeHtml(filters.project)}<button onclick="setFilter('project',null)">Ã—</button></span>`);
            if (filters.priority) chips.push(`<span class="filter-chip">${PRIORITY_LABELS[filters.priority]}<button onclick="setFilter('priority',null)">Ã—</button></span>`);
            if (filters.type) chips.push(`<span class="filter-chip">${filters.type}<button onclick="setFilter('type',null)">Ã—</button></span>`);
            document.getElementById('activeFilters').innerHTML = chips.join('');
        }

        function getFilteredTasks() {
            return tasks.filter(t => {
                if (filters.project && t.projet !== filters.project) return false;
                if (filters.priority && getTaskPriority(t) !== filters.priority) return false;
                if (filters.type) {
                    if (filters.type === 'jalon' && !isJalon(t)) return false;
                    if (filters.type === 'reunion' && !isReunion(t)) return false;
                    if (filters.type === 'tache' && (isJalon(t) || isReunion(t))) return false;
                }
                return true;
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // RENDER
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function render() {
            updatePeriodLabel();
            if (currentView === 'month') {
                renderMonthView();
            } else {
                renderWeekView();
            }
        }

        function renderMonthView() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const days = getMonthDays(year, month);
            const today = new Date();
            const filtered = getFilteredTasks();

            // Header
            document.getElementById('monthHeader').innerHTML = DAYS_SHORT.slice(1).concat(DAYS_SHORT[0])
                .map((d, i) => `<div class="month-header-cell${i >= 5 ? ' weekend' : ''}">${d}</div>`).join('');

            // Grid
            let html = '';
            days.forEach((dayInfo, idx) => {
                const d = dayInfo.date;
                const isToday = isSameDay(d, today);
                const weekend = isWeekend(d);
                let cls = 'day-cell';
                if (dayInfo.otherMonth) cls += ' other-month';
                if (weekend) cls += ' weekend';
                if (isToday) cls += ' today';

                // Get events for this day
                const dayEvents = filtered.filter(t => {
                    const start = gristToDate(t.dateDebut);
                    const end = gristToDate(t.dateEcheance);
                    if (!start || !end) return false;
                    return d >= new Date(start.toDateString()) && d <= new Date(end.toDateString());
                });

                const maxEvents = 3;
                const visibleEvents = dayEvents.slice(0, maxEvents);
                const moreCount = dayEvents.length - maxEvents;

                html += `
                    <div class="${cls}" data-date="${formatDateInput(d)}" onclick="onDayClick(event, '${formatDateInput(d)}')">
                        <div class="day-number">${d.getDate()}</div>
                        <div class="day-events">
                            ${visibleEvents.map(t => renderEventItem(t, d)).join('')}
                            ${moreCount > 0 ? `<div class="more-events" onclick="event.stopPropagation(); showMoreEvents('${formatDateInput(d)}')">+${moreCount} autres</div>` : ''}
                        </div>
                    </div>
                `;
            });

            document.getElementById('monthGrid').innerHTML = html;

            // Event click handlers
            document.querySelectorAll('.event-item').forEach(el => {
                el.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const id = parseInt(el.dataset.id);
                    selectTask(id);
                    showDetailModal(id);
                });
            });
        }

        function renderEventItem(task, date) {
            const p = getTaskPriority(task);
            const jalon = isJalon(task);
            const sel = task.id === selectedTaskId ? ' selected' : '';
            const cls = jalon ? `event-item milestone p${p}${sel}` : `event-item p${p}${sel}`;
            return `<div class="${cls}" data-id="${task.id}">${escapeHtml(task.titre)}</div>`;
        }

        function renderWeekView() {
            const start = getStartOfWeek(currentDate);
            const today = new Date();
            const filtered = getFilteredTasks();

            // Header
            let headerHtml = '<div class="week-header-cell"></div>';
            for (let i = 0; i < 7; i++) {
                const d = addDays(start, i);
                const isToday = isSameDay(d, today);
                headerHtml += `
                    <div class="week-header-cell${isToday ? ' today' : ''}">
                        <div class="day-name">${DAYS_SHORT[(i + 1) % 7]}</div>
                        <div class="day-num">${d.getDate()}</div>
                    </div>
                `;
            }
            document.getElementById('weekHeader').innerHTML = headerHtml;

            // All-day row
            let allDayHtml = '<div class="all-day-label">JournÃ©e</div>';
            for (let i = 0; i < 7; i++) {
                const d = addDays(start, i);
                const dayTasks = filtered.filter(t => {
                    const s = gristToDate(t.dateDebut);
                    const e = gristToDate(t.dateEcheance);
                    if (!s || !e) return false;
                    return d >= new Date(s.toDateString()) && d <= new Date(e.toDateString());
                });

                allDayHtml += `<div class="all-day-cell">${dayTasks.slice(0, 2).map(t => {
                    const p = getTaskPriority(t);
                    const jalon = isJalon(t);
                    return `<div class="event-item${jalon ? ' milestone' : ''} p${p}" data-id="${t.id}" onclick="showDetailModal(${t.id})">${escapeHtml(t.titre)}</div>`;
                }).join('')}${dayTasks.length > 2 ? `<div class="more-events">+${dayTasks.length - 2}</div>` : ''}</div>`;
            }
            document.getElementById('allDayRow').innerHTML = allDayHtml;

            // Time grid
            let bodyHtml = '<div class="time-column">';
            for (let h = 0; h < 24; h++) {
                bodyHtml += `<div class="time-slot">${h.toString().padStart(2, '0')}:00</div>`;
            }
            bodyHtml += '</div>';

            for (let i = 0; i < 7; i++) {
                const d = addDays(start, i);
                bodyHtml += '<div class="week-day-column">';
                for (let h = 0; h < 24; h++) {
                    bodyHtml += `<div class="hour-slot" data-date="${formatDateInput(d)}" data-hour="${h}" onclick="onHourClick(event, '${formatDateInput(d)}', ${h})"></div>`;
                }
                bodyHtml += '</div>';
            }

            document.getElementById('weekBody').innerHTML = bodyHtml;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // INTERACTIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function onDayClick(e, dateStr) {
            if (e.target.classList.contains('event-item') || e.target.classList.contains('more-events')) return;
            openCreateModal(dateStr);
        }

        function onHourClick(e, dateStr, hour) {
            openCreateModal(dateStr, hour);
        }

        function showMoreEvents(dateStr) {
            // For simplicity, open the first event of that day
            const date = new Date(dateStr);
            const dayTasks = getFilteredTasks().filter(t => {
                const s = gristToDate(t.dateDebut);
                const e = gristToDate(t.dateEcheance);
                return s && e && date >= new Date(s.toDateString()) && date <= new Date(e.toDateString());
            });
            if (dayTasks.length > 0) {
                showDetailModal(dayTasks[0].id);
            }
        }

        function selectTask(id) {
            selectedTaskId = id;
            document.querySelectorAll('.event-item').forEach(el => {
                el.classList.toggle('selected', parseInt(el.dataset.id) === id);
            });
            if (gristReady && id) grist.setSelectedRows([id]);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // MODALS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function openCreateModal(dateStr = null, hour = null) {
            document.getElementById('eventId').value = '';
            document.getElementById('modalTitle').innerHTML = 'ðŸ“… Nouvel Ã©vÃ©nement';
            document.getElementById('eventTitle').value = '';
            document.getElementById('eventDescription').value = '';
            document.getElementById('eventProject').value = '';
            document.getElementById('eventStatus').value = 'todo';
            document.getElementById('eventProgress').value = 0;
            document.getElementById('progressValue').textContent = '0%';

            const date = dateStr ? new Date(dateStr) : new Date();
            document.getElementById('eventStartDate').value = formatDateInput(date);
            document.getElementById('eventEndDate').value = formatDateInput(date);

            if (hour !== null) {
                document.getElementById('eventAllDay').checked = false;
                document.getElementById('eventStartTime').value = `${hour.toString().padStart(2, '0')}:00`;
                document.getElementById('eventEndTime').value = `${(hour + 1).toString().padStart(2, '0')}:00`;
                toggleTimeFields();
            } else {
                document.getElementById('eventAllDay').checked = true;
                toggleTimeFields();
            }

            selectEventType('tache');
            selectPriority(3);

            document.getElementById('eventModal').classList.add('open');
            document.getElementById('eventTitle').focus();
        }

        function openEditModal(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            document.getElementById('eventId').value = task.id;
            document.getElementById('modalTitle').innerHTML = 'ðŸ“ Modifier';
            document.getElementById('eventTitle').value = task.titre || '';
            document.getElementById('eventDescription').value = task.description || '';
            document.getElementById('eventProject').value = task.projet || '';
            document.getElementById('eventStatus').value = task.statut || 'todo';
            document.getElementById('eventProgress').value = task.progression || 0;
            document.getElementById('progressValue').textContent = (task.progression || 0) + '%';

            const start = gristToDate(task.dateDebut);
            const end = gristToDate(task.dateEcheance);
            document.getElementById('eventStartDate').value = start ? formatDateInput(start) : '';
            document.getElementById('eventEndDate').value = end ? formatDateInput(end) : '';

            document.getElementById('eventAllDay').checked = true;
            toggleTimeFields();

            selectEventType(task.type || 'tache');
            selectPriority(getTaskPriority(task));

            document.getElementById('eventModal').classList.add('open');
        }

        function closeModal() {
            document.getElementById('eventModal').classList.remove('open');
        }

        function selectEventType(type) {
            selectedType = type;
            document.querySelectorAll('.type-tab').forEach(t => t.classList.toggle('active', t.dataset.type === type));

            // Adjust fields based on type
            document.getElementById('progressField').style.display = type === 'tache' ? 'block' : 'none';
            document.getElementById('allDayField').style.display = type === 'reunion' ? 'block' : 'none';

            if (type === 'jalon') {
                document.getElementById('eventEndDate').value = document.getElementById('eventStartDate').value;
            }
        }

        function selectPriority(p) {
            selectedPriority = p;
            document.querySelectorAll('.priority-option').forEach(opt => {
                opt.classList.toggle('active', parseInt(opt.dataset.priority) === p);
            });
        }

        function toggleTimeFields() {
            const allDay = document.getElementById('eventAllDay').checked;
            document.getElementById('timeFields').style.display = allDay ? 'none' : 'grid';
        }

        function updateProgressValue() {
            document.getElementById('progressValue').textContent = document.getElementById('eventProgress').value + '%';
        }

        async function saveEvent() {
            const title = document.getElementById('eventTitle').value.trim();
            if (!title) {
                showToast('âš ï¸ Titre requis', 'warning');
                document.getElementById('eventTitle').focus();
                return;
            }

            const eventId = document.getElementById('eventId').value;
            const startDate = document.getElementById('eventStartDate').value;
            const endDate = selectedType === 'jalon' ? startDate : document.getElementById('eventEndDate').value;

            const eventData = {
                titre: title,
                description: document.getElementById('eventDescription').value,
                projet: document.getElementById('eventProject').value || null,
                statut: document.getElementById('eventStatus').value,
                priorite: selectedPriority,
                type: selectedType,
                progression: selectedType === 'tache' ? parseInt(document.getElementById('eventProgress').value) : 0,
                dateDebut: startDate ? dateToGrist(new Date(startDate)) : null,
                dateEcheance: endDate ? dateToGrist(new Date(endDate)) : null
            };

            if (gristReady) {
                try {
                    if (eventId) {
                        await grist.docApi.applyUserActions([
                            ['UpdateRecord', 'Tasks', parseInt(eventId), eventData]
                        ]);
                        showToast('âœ“ Ã‰vÃ©nement modifiÃ©', 'success');
                    } else {
                        await grist.docApi.applyUserActions([
                            ['AddRecord', 'Tasks', null, eventData]
                        ]);
                        showToast('âœ“ Ã‰vÃ©nement crÃ©Ã©', 'success');
                    }
                    closeModal();
                } catch (e) {
                    console.error(e);
                    showToast('Erreur', 'error');
                }
            } else {
                // Demo mode
                if (eventId) {
                    const task = tasks.find(t => t.id === parseInt(eventId));
                    if (task) Object.assign(task, eventData);
                } else {
                    eventData.id = Date.now();
                    tasks.push(eventData);
                }
                render();
                closeModal();
                showToast('âœ“ Ã‰vÃ©nement enregistrÃ© (dÃ©mo)', 'success');
            }
        }

        // Detail Modal
        function showDetailModal(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            selectedTaskId = taskId;
            document.getElementById('detailModal').dataset.taskId = taskId;

            const start = gristToDate(task.dateDebut);
            const end = gristToDate(task.dateEcheance);
            const p = getTaskPriority(task);
            const jalon = isJalon(task);
            const progress = task.progression || 0;

            const typeIcon = jalon ? 'â—† Jalon' : isReunion(task) ? 'ðŸ‘¥ RÃ©union' : 'ðŸ“‹ TÃ¢che';
            document.getElementById('detailTitle').innerHTML = typeIcon + ' - ' + escapeHtml(task.titre);

            const html = `
                <div class="detail-section">
                    <div class="detail-section-title">ðŸ“‹ Informations</div>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">PrioritÃ©</div>
                            <div class="detail-value"><span class="priority-dot p${p}"></span>${PRIORITY_LABELS[p]}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Statut</div>
                            <div class="detail-value">${STATUS_LABELS[task.statut] || task.statut || '-'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">DÃ©but</div>
                            <div class="detail-value">${formatDate(start)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Fin</div>
                            <div class="detail-value">${formatDate(end)}</div>
                        </div>
                        ${task.projet ? `<div class="detail-item" style="grid-column: span 2;"><div class="detail-label">Projet</div><div class="detail-value">${escapeHtml(task.projet)}</div></div>` : ''}
                    </div>
                </div>

                ${!jalon ? `
                <div class="detail-section">
                    <div class="detail-section-title">ðŸ“Š Progression</div>
                    <div class="detail-item">
                        <div class="progress-display">
                            <div class="progress-bar-large">
                                <div class="progress-bar-large-fill" style="width: ${progress}%"></div>
                            </div>
                            <strong>${progress}%</strong>
                        </div>
                    </div>
                </div>
                ` : ''}

                ${task.description ? `
                <div class="detail-section">
                    <div class="detail-section-title">ðŸ“ Description</div>
                    <div class="detail-item">
                        <div class="detail-value">${escapeHtml(task.description)}</div>
                    </div>
                </div>
                ` : ''}
            `;

            document.getElementById('detailBody').innerHTML = html;
            document.getElementById('detailModal').classList.add('open');
        }

        function closeDetailModal() {
            document.getElementById('detailModal').classList.remove('open');
        }

        function editEvent() {
            const id = parseInt(document.getElementById('detailModal').dataset.taskId);
            closeDetailModal();
            openEditModal(id);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // GRIST INTEGRATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function convert(data) {
            if (!data || Array.isArray(data)) return data || [];
            const cols = Object.keys(data);
            if (!cols.length) return [];
            const n = data[cols[0]]?.length || 0;
            const r = [];
            for (let i = 0; i < n; i++) {
                const rec = {};
                cols.forEach(c => rec[c] = data[c][i]);
                r.push(rec);
            }
            return r;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SCHEMA AUTO-INITIALISATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        const TASKFLOW_SCHEMA = {
            Team: [
                { id: 'nom', type: 'Text' },
                { id: 'email', type: 'Text' },
                { id: 'avatar', type: 'Text' },
                { id: 'role', type: 'Choice' },
                { id: 'actif', type: 'Bool' }
            ],
            Projects: [
                { id: 'nom', type: 'Text' },
                { id: 'couleur', type: 'Text' },
                { id: 'dateDebut', type: 'Date' },
                { id: 'dateFin', type: 'Date' },
                { id: 'responsable', type: 'Ref:Team' },
                { id: 'actif', type: 'Bool' }
            ],
            Tasks: [
                { id: 'titre', type: 'Text' },
                { id: 'description', type: 'Text' },
                { id: 'dateDebut', type: 'Date' },
                { id: 'dateEcheance', type: 'Date' },
                { id: 'priorite', type: 'Choice' },
                { id: 'statut', type: 'Choice' },
                { id: 'progression', type: 'Numeric' },
                { id: 'projet', type: 'Ref:Projects' },
                { id: 'assignees', type: 'RefList:Team' },
                { id: 'type', type: 'Choice' },
                { id: 'dependDe', type: 'RefList:Tasks' },
                { id: 'tags', type: 'ChoiceList' },
                { id: 'estimationH', type: 'Numeric' },
                { id: 'tempsPasse', type: 'Numeric' },
                { id: 'couleur', type: 'Text' }
            ]
        };

        async function ensureSchema() {
            const log = (msg) => console.log(`[TaskFlow Schema] ${msg}`);
            let created = 0, added = 0;
            const tablesCreated = [];

            for (const [tableName, columns] of Object.entries(TASKFLOW_SCHEMA)) {
                let existingCols = [];
                let tableExists = false;

                try {
                    const data = await grist.docApi.fetchTable(tableName);
                    existingCols = Object.keys(data).filter(c => c !== 'id' && c !== 'manualSort');
                    tableExists = true;
                    log(`âœ“ Table ${tableName} existe (${existingCols.length} colonnes)`);
                } catch (e) {
                    try {
                        await grist.docApi.applyUserActions([
                            ['AddTable', tableName, columns.map(c => ({ id: c.id, type: c.type }))]
                        ]);
                        log(`âœ… Table ${tableName} crÃ©Ã©e avec ${columns.length} colonnes`);
                        tablesCreated.push(tableName);
                        created++;
                        continue;
                    } catch (e2) {
                        log(`âš ï¸ Impossible de crÃ©er ${tableName}: ${e2.message || e2}`);
                        continue;
                    }
                }

                if (tableExists) {
                    const missing = columns.filter(c => !existingCols.includes(c.id));
                    for (const col of missing) {
                        try {
                            await grist.docApi.applyUserActions([
                                ['AddColumn', tableName, col.id, { type: col.type }]
                            ]);
                            log(`  + Colonne ${tableName}.${col.id} (${col.type}) ajoutÃ©e`);
                            added++;
                        } catch (e) {
                            log(`  ~ Colonne ${tableName}.${col.id} ignorÃ©e: ${e.message || e}`);
                        }
                    }
                }
            }

            if (tablesCreated.includes('Tasks')) {
                await seedData();
            }

            if (created > 0 || added > 0) {
                log(`Schema OK â€” ${created} table(s) crÃ©Ã©e(s), ${added} colonne(s) ajoutÃ©e(s)`);
                showToast(`Schema initialisÃ© (${created} tables, ${added} colonnes)`, 'success');
            } else {
                log('Schema complet â€” rien Ã  modifier');
            }
        }

        async function seedData() {
            const log = (msg) => console.log(`[TaskFlow Seed] ${msg}`);
            const today = new Date();
            const day = (d) => {
                const dt = new Date(today.getFullYear(), today.getMonth(), today.getDate() + d);
                return dt.getTime() / 1000;
            };

            try {
                await grist.docApi.applyUserActions([
                    ['AddRecord', 'Team', null, { nom: 'Alice Martin', email: 'alice.martin@cerema.fr', role: 'Chef de projet', actif: true }],
                    ['AddRecord', 'Team', null, { nom: 'Bob Durant', email: 'bob.durant@cerema.fr', role: 'DÃ©veloppeur', actif: true }],
                    ['AddRecord', 'Team', null, { nom: 'Claire Bernard', email: 'claire.bernard@cerema.fr', role: 'Designer', actif: true }],
                    ['AddRecord', 'Team', null, { nom: 'David Petit', email: 'david.petit@cerema.fr', role: 'Data analyst', actif: true }]
                ]);
                log('âœ… 4 membres ajoutÃ©s Ã  Team');

                await grist.docApi.applyUserActions([
                    ['AddRecord', 'Projects', null, { nom: 'Refonte Portail', couleur: '#4f46e5', dateDebut: day(-15), dateFin: day(45), responsable: 1, actif: true }],
                    ['AddRecord', 'Projects', null, { nom: 'App Mobile Terrain', couleur: '#10b981', dateDebut: day(-5), dateFin: day(60), responsable: 2, actif: true }],
                    ['AddRecord', 'Projects', null, { nom: 'Dashboard IA', couleur: '#f59e0b', dateDebut: day(0), dateFin: day(30), responsable: 4, actif: true }]
                ]);
                log('âœ… 3 projets ajoutÃ©s Ã  Projects');

                await grist.docApi.applyUserActions([
                    ['AddRecord', 'Tasks', null, { titre: 'Cahier des charges', description: 'RÃ©diger le CDC complet avec specs fonctionnelles', dateDebut: day(-15), dateEcheance: day(-8), priorite: '1', statut: 'done', progression: 100, projet: 1, type: 'tache', assignees: ['L', 1], estimationH: 16 }],
                    ['AddRecord', 'Tasks', null, { titre: 'Maquettes UI/UX', description: 'Wireframes et prototypes Figma', dateDebut: day(-10), dateEcheance: day(-2), priorite: '2', statut: 'done', progression: 100, projet: 1, type: 'tache', assignees: ['L', 3], estimationH: 24 }],
                    ['AddRecord', 'Tasks', null, { titre: 'DÃ©veloppement frontend', description: 'IntÃ©gration HTML/CSS/JS du nouveau portail', dateDebut: day(-3), dateEcheance: day(12), priorite: '1', statut: 'inprogress', progression: 35, projet: 1, type: 'tache', assignees: ['L', 2, 3], dependDe: ['L', 2], estimationH: 40 }],
                    ['AddRecord', 'Tasks', null, { titre: 'Validation design', description: 'Point de validation des maquettes', dateDebut: day(-2), dateEcheance: day(-2), priorite: '2', statut: 'done', progression: 100, projet: 1, type: 'jalon' }],
                    ['AddRecord', 'Tasks', null, { titre: 'API backend', description: 'DÃ©veloppement des endpoints REST', dateDebut: day(-5), dateEcheance: day(10), priorite: '1', statut: 'inprogress', progression: 55, projet: 1, type: 'tache', assignees: ['L', 2], estimationH: 32, tempsPasse: 18 }],
                    ['AddRecord', 'Tasks', null, { titre: 'Ã‰tude terrain', description: 'Analyse des besoins agents terrain', dateDebut: day(-5), dateEcheance: day(0), priorite: '2', statut: 'review', progression: 90, projet: 2, type: 'tache', assignees: ['L', 1, 4], estimationH: 12 }],
                    ['AddRecord', 'Tasks', null, { titre: 'Proto mobile v1', description: 'Premier prototype fonctionnel React Native', dateDebut: day(1), dateEcheance: day(20), priorite: '2', statut: 'todo', progression: 0, projet: 2, type: 'tache', assignees: ['L', 2], dependDe: ['L', 6], estimationH: 48 }],
                    ['AddRecord', 'Tasks', null, { titre: 'RÃ©union lancement mobile', description: 'Kick-off avec les parties prenantes', dateDebut: day(2), dateEcheance: day(2), priorite: '3', statut: 'todo', progression: 0, projet: 2, type: 'reunion', assignees: ['L', 1, 2, 3, 4] }],
                    ['AddRecord', 'Tasks', null, { titre: 'Collecte des sources de donnÃ©es', description: 'Identifier et connecter les flux de donnÃ©es', dateDebut: day(0), dateEcheance: day(7), priorite: '2', statut: 'inprogress', progression: 20, projet: 3, type: 'tache', assignees: ['L', 4], estimationH: 16 }],
                    ['AddRecord', 'Tasks', null, { titre: 'ModÃ¨le de scoring IA', description: 'EntraÃ®ner le modÃ¨le de classification Albert API', dateDebut: day(5), dateEcheance: day(18), priorite: '1', statut: 'todo', progression: 0, projet: 3, type: 'tache', assignees: ['L', 4], dependDe: ['L', 9], estimationH: 30 }],
                    ['AddRecord', 'Tasks', null, { titre: 'Widget dashboard Grist', description: 'Interface de visualisation des indicateurs', dateDebut: day(10), dateEcheance: day(25), priorite: '3', statut: 'todo', progression: 0, projet: 3, type: 'tache', assignees: ['L', 2, 3], estimationH: 24 }],
                    ['AddRecord', 'Tasks', null, { titre: 'Livraison MVP Dashboard', description: 'Version minimale fonctionnelle', dateDebut: day(28), dateEcheance: day(28), priorite: '1', statut: 'todo', progression: 0, projet: 3, type: 'jalon', dependDe: ['L', 10, 11] }]
                ]);
                log('âœ… 12 tÃ¢ches ajoutÃ©es Ã  Tasks');

            } catch (e) {
                log(`âš ï¸ Erreur seed: ${e.message || e}`);
            }
        }

        async function loadAllData() {
            try {
                const taskData = await grist.docApi.fetchTable('Tasks');
                tasks = convert(taskData);
            } catch (e) {
                console.log('Tasks table not available:', e);
                tasks = [];
            }

            try {
                const td = await grist.docApi.fetchTable('Team');
                team = convert(td);
            } catch (e) {}

            try {
                const pd = await grist.docApi.fetchTable('Projects');
                projects = convert(pd);
            } catch (e) {}

            gristReady = true;
            updateFilterMenus();
            render();
        }

        async function initGrist() {
            try {
                grist.ready({ requiredAccess: 'full' });

                // Auto-init du schÃ©ma complet
                await ensureSchema();

                // Chargement initial direct
                await loadAllData();

                // Live updates
                grist.onRecords(async () => {
                    await loadAllData();
                });

                grist.onRecord((rec) => {
                    if (rec?.id && rec.id !== selectedTaskId) {
                        selectedTaskId = rec.id;
                        document.querySelectorAll('.event-item').forEach(el => {
                            el.classList.toggle('selected', parseInt(el.dataset.id) === selectedTaskId);
                        });
                    }
                });

            } catch (e) {
                console.log('Grist unavailable, using demo');
                useDemoMode();
            }
        }

        function useDemoMode() {
            document.body.insertAdjacentHTML('beforeend', '<div class="demo-badge">DÃ©mo</div>');

            team = [
                { id: 1, nom: 'Alice Martin' },
                { id: 2, nom: 'Bob Durant' },
                { id: 3, nom: 'Claire Bernard' }
            ];

            const today = new Date();
            const day = (d) => dateToGrist(new Date(today.getFullYear(), today.getMonth(), today.getDate() + d));

            tasks = [
                { id: 1, titre: 'Sprint Planning', type: 'jalon', priorite: 2, projet: 'Agile', dateDebut: day(-2), dateEcheance: day(-2), progression: 0 },
                { id: 2, titre: 'Dev feature A', priorite: 1, projet: 'Frontend', dateDebut: day(-4), dateEcheance: day(5), progression: 60, statut: 'inprogress' },
                { id: 3, titre: 'RÃ©union Ã©quipe', type: 'reunion', priorite: 3, projet: 'Team', dateDebut: day(0), dateEcheance: day(0), progression: 0 },
                { id: 4, titre: 'Review code', type: 'jalon', priorite: 2, projet: 'QA', dateDebut: day(1), dateEcheance: day(1), progression: 0 },
                { id: 5, titre: 'Tests intÃ©gration', priorite: 3, projet: 'QA', dateDebut: day(2), dateEcheance: day(7), progression: 0, statut: 'todo' },
                { id: 6, titre: 'Livraison v2.0', type: 'jalon', priorite: 1, projet: 'Release', dateDebut: day(3), dateEcheance: day(3), progression: 0 },
                { id: 7, titre: 'Documentation', priorite: 4, projet: 'Docs', dateDebut: day(5), dateEcheance: day(10), progression: 0 },
                { id: 8, titre: 'Formation', priorite: 4, projet: 'Team', dateDebut: day(8), dateEcheance: day(12), progression: 0 }
            ];

            updateFilterMenus();
            render();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // INIT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.filter-dropdown')) {
                document.querySelectorAll('.filter-menu').forEach(m => m.classList.remove('open'));
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
                closeDetailModal();
            }
        });

        loadPrefs();
        document.querySelectorAll('.view-controls .btn').forEach(b => b.classList.toggle('active', b.dataset.view === currentView));
        document.getElementById('monthView').classList.toggle('active', currentView === 'month');
        document.getElementById('weekView').classList.toggle('active', currentView === 'week');
        initGrist();
    </script>
</body>
</html>