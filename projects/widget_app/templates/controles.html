<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patrimoine - Contr√¥les</title>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { box-sizing: border-box; }
        html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: system-ui, -apple-system, sans-serif; }
        .fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50 h-full flex flex-col">
    <div id="app" class="h-full flex flex-col"></div>
    
    <script>
    // ============ CONFIGURATION ============
    const CONTROLE_STATUTS = {
        'Conforme': { color: '#10b981', icon: '‚úÖ' },
        'Non conforme': { color: '#ef4444', icon: '‚ùå' },
        '√Ä planifier': { color: '#f59e0b', icon: 'üìÖ' },
        'En attente': { color: '#6b7280', icon: '‚è≥' }
    };
    
    // ============ APP CONTEXT ============
    const appContext = {
        isArtefactory: typeof window.app !== 'undefined' && window.app.navigate,
        app: window.app || { navigate: () => {}, emit: () => {}, on: () => {}, state: {} }
    };
    
    // ============ ROUTER ============
    const router = {
        currentRoute: '/planning',
        
        navigate(path) {
            if (path === '/liste' || path === '/controles/liste') {
                this.currentRoute = '/liste';
            } else {
                this.currentRoute = '/planning';
            }
            render();
        }
    };
    
    // ============ STATE ============
    let state = {
        loading: true,
        error: null,
        batiments: [],
        types: [],
        controles: [],
        filterType: '',
        filterStatut: ''
    };
    
    // ============ DATA ============
    async function safeLoad(tableName) {
        try {
            const data = await grist.docApi.fetchTable(tableName);
            const n = data.id?.length || 0;
            const records = [];
            for (let i = 0; i < n; i++) {
                const record = { id: data.id[i] };
                Object.keys(data).forEach(key => {
                    if (key !== 'id') record[key] = data[key][i];
                });
                records.push(record);
            }
            return records;
        } catch (e) {
            console.warn(`Table ${tableName} non trouv√©e`);
            return [];
        }
    }
    
    async function loadAllData() {
        state.loading = true;
        render();
        
        try {
            const [batiments, types, controles] = await Promise.all([
                safeLoad('Batiments'),
                safeLoad('CTR_Types'),
                safeLoad('CTR_Controles')
            ]);
            
            state.batiments = batiments;
            state.types = types;
            state.controles = controles;
            state.loading = false;
        } catch (e) {
            state.error = e.message;
            state.loading = false;
        }
        
        render();
    }
    
    // ============ COMPUTED ============
    function getStats() {
        const now = Date.now() / 1000;
        const in30Days = now + (30 * 24 * 60 * 60);
        const in90Days = now + (90 * 24 * 60 * 60);
        
        const aVenir30 = state.controles.filter(c => 
            c.Date_prochain && c.Date_prochain >= now && c.Date_prochain <= in30Days
        ).length;
        
        const aVenir90 = state.controles.filter(c => 
            c.Date_prochain && c.Date_prochain >= now && c.Date_prochain <= in90Days
        ).length;
        
        const enRetard = state.controles.filter(c => 
            c.Date_prochain && c.Date_prochain < now
        ).length;
        
        const conformes = state.controles.filter(c => c.Statut === 'Conforme').length;
        const nonConformes = state.controles.filter(c => c.Statut === 'Non conforme').length;
        
        return { aVenir30, aVenir90, enRetard, conformes, nonConformes, total: state.controles.length };
    }
    
    function getBatimentName(id) {
        const b = state.batiments.find(x => x.id === id);
        return b?.Nom || b?.Code || '-';
    }
    
    function getTypeName(id) {
        const t = state.types.find(x => x.id === id);
        return t?.Nom || '-';
    }
    
    function getTypeInfo(id) {
        const t = state.types.find(x => x.id === id);
        return t || { Nom: '-', Icone: '‚úÖ', Periodicite_mois: null };
    }
    
    function getUpcomingControles() {
        const now = Date.now() / 1000;
        return state.controles
            .filter(c => c.Date_prochain && c.Date_prochain >= now)
            .sort((a, b) => a.Date_prochain - b.Date_prochain)
            .slice(0, 10);
    }
    
    function getOverdueControles() {
        const now = Date.now() / 1000;
        return state.controles
            .filter(c => c.Date_prochain && c.Date_prochain < now)
            .sort((a, b) => a.Date_prochain - b.Date_prochain);
    }
    
    // ============ RENDER ============
    function render() {
        const app = document.getElementById('app');
        
        if (state.loading) {
            app.innerHTML = `
                <div class="flex-1 flex items-center justify-center">
                    <div class="text-center">
                        <div class="animate-spin text-4xl mb-4">‚úÖ</div>
                        <p class="text-gray-500">Chargement des contr√¥les...</p>
                    </div>
                </div>
            `;
            return;
        }
        
        switch (router.currentRoute) {
            case '/planning':
                app.innerHTML = renderPlanning();
                break;
            case '/liste':
                app.innerHTML = renderListe();
                break;
            default:
                app.innerHTML = renderPlanning();
        }
    }
    
    function renderHeader(title) {
        return `
            <header class="flex-none bg-white border-b px-4 py-3 flex items-center gap-3">
                <h1 class="text-lg font-semibold text-gray-800 flex-1">${title}</h1>
                <nav class="flex gap-1">
                    <button onclick="router.navigate('/planning')" 
                            class="px-3 py-1.5 text-sm rounded-lg ${router.currentRoute === '/planning' ? 'bg-purple-100 text-purple-700' : 'hover:bg-gray-100 text-gray-600'}">
                        üìÖ Planning
                    </button>
                    <button onclick="router.navigate('/liste')" 
                            class="px-3 py-1.5 text-sm rounded-lg ${router.currentRoute === '/liste' ? 'bg-purple-100 text-purple-700' : 'hover:bg-gray-100 text-gray-600'}">
                        üìã Liste
                    </button>
                </nav>
            </header>
        `;
    }
    
    // ============ PLANNING ============
    function renderPlanning() {
        const stats = getStats();
        const upcoming = getUpcomingControles();
        const overdue = getOverdueControles();
        
        return `
            ${renderHeader('‚úÖ Contr√¥les r√©glementaires')}
            
            <div class="flex-1 overflow-y-auto p-4 space-y-4 fade-in">
                <!-- KPIs -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="bg-white rounded-xl shadow-sm p-4 ${stats.enRetard > 0 ? 'ring-2 ring-red-200' : ''}">
                        <div class="text-2xl mb-1">üö®</div>
                        <div class="text-3xl font-bold ${stats.enRetard > 0 ? 'text-red-600' : 'text-gray-800'}">${stats.enRetard}</div>
                        <div class="text-sm text-gray-500">En retard</div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-4">
                        <div class="text-2xl mb-1">üìÖ</div>
                        <div class="text-3xl font-bold text-orange-600">${stats.aVenir30}</div>
                        <div class="text-sm text-gray-500">Dans 30 jours</div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-4">
                        <div class="text-2xl mb-1">‚úÖ</div>
                        <div class="text-3xl font-bold text-emerald-600">${stats.conformes}</div>
                        <div class="text-sm text-gray-500">Conformes</div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-4">
                        <div class="text-2xl mb-1">‚ùå</div>
                        <div class="text-3xl font-bold text-red-600">${stats.nonConformes}</div>
                        <div class="text-sm text-gray-500">Non conformes</div>
                    </div>
                </div>
                
                <!-- En retard -->
                ${overdue.length > 0 ? `
                    <div class="bg-red-50 rounded-xl p-4 border border-red-200">
                        <h3 class="font-semibold text-red-800 mb-3">üö® Contr√¥les en retard</h3>
                        <div class="space-y-2">
                            ${overdue.map(c => renderControleRow(c, true)).join('')}
                        </div>
                    </div>
                ` : ''}
                
                <!-- √Ä venir -->
                <div class="bg-white rounded-xl shadow-sm p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-semibold text-gray-800">üìÖ Contr√¥les √† venir</h3>
                        <button onclick="router.navigate('/liste')" class="text-sm text-purple-600">Voir tout ‚Üí</button>
                    </div>
                    ${upcoming.length === 0 ? `
                        <p class="text-gray-400 text-sm py-4 text-center">Aucun contr√¥le planifi√©</p>
                    ` : `
                        <div class="space-y-2">
                            ${upcoming.map(c => renderControleRow(c, false)).join('')}
                        </div>
                    `}
                </div>
                
                <!-- Types de contr√¥les -->
                <div class="bg-white rounded-xl shadow-sm p-4">
                    <h3 class="font-semibold text-gray-800 mb-3">üìã Types de contr√¥les</h3>
                    <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3">
                        ${state.types.map(t => `
                            <div class="flex items-center gap-3 p-3 rounded-lg bg-gray-50">
                                <span class="text-xl">${t.Icone || '‚úÖ'}</span>
                                <div class="flex-1">
                                    <div class="font-medium text-gray-800 text-sm">${t.Nom}</div>
                                    <div class="text-xs text-gray-500">
                                        ${t.Periodicite_mois ? `Tous les ${t.Periodicite_mois} mois` : '-'}
                                        ${t.Obligatoire ? ' ‚Ä¢ Obligatoire' : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
    }
    
    function renderControleRow(c, isOverdue) {
        const type = getTypeInfo(c.Type_controle);
        const statut = CONTROLE_STATUTS[c.Statut] || { color: '#6b7280', icon: '‚è≥' };
        const dateStr = c.Date_prochain ? new Date(c.Date_prochain * 1000).toLocaleDateString() : '-';
        
        const daysUntil = c.Date_prochain ? Math.floor((c.Date_prochain - Date.now() / 1000) / 86400) : null;
        let daysLabel = '';
        if (daysUntil !== null) {
            if (daysUntil < 0) daysLabel = `${Math.abs(daysUntil)}j de retard`;
            else if (daysUntil === 0) daysLabel = "Aujourd'hui";
            else if (daysUntil === 1) daysLabel = "Demain";
            else daysLabel = `Dans ${daysUntil}j`;
        }
        
        return `
            <div class="flex items-center gap-3 p-3 rounded-lg ${isOverdue ? 'bg-red-100' : 'bg-gray-50'}">
                <span class="text-lg">${type.Icone || '‚úÖ'}</span>
                <div class="flex-1">
                    <div class="font-medium text-gray-800">${type.Nom}</div>
                    <div class="text-sm text-gray-500">${getBatimentName(c.Batiment)}</div>
                </div>
                <div class="text-right">
                    <div class="text-sm font-medium ${isOverdue ? 'text-red-600' : 'text-gray-800'}">${dateStr}</div>
                    <div class="text-xs ${isOverdue ? 'text-red-500' : 'text-gray-400'}">${daysLabel}</div>
                </div>
            </div>
        `;
    }
    
    // ============ LISTE ============
    function renderListe() {
        let filtered = [...state.controles];
        
        if (state.filterType) {
            filtered = filtered.filter(c => c.Type_controle == state.filterType);
        }
        if (state.filterStatut) {
            filtered = filtered.filter(c => c.Statut === state.filterStatut);
        }
        
        filtered.sort((a, b) => (a.Date_prochain || 0) - (b.Date_prochain || 0));
        
        return `
            ${renderHeader('‚úÖ Liste des contr√¥les')}
            
            <!-- Filtres -->
            <div class="flex-none bg-white border-b px-4 py-3">
                <div class="flex gap-3">
                    <select onchange="state.filterType = this.value; render()" class="px-3 py-2 border rounded-lg text-sm">
                        <option value="">Tous types</option>
                        ${state.types.map(t => `<option value="${t.id}" ${state.filterType == t.id ? 'selected' : ''}>${t.Nom}</option>`).join('')}
                    </select>
                    <select onchange="state.filterStatut = this.value; render()" class="px-3 py-2 border rounded-lg text-sm">
                        <option value="">Tous statuts</option>
                        ${Object.keys(CONTROLE_STATUTS).map(s => `<option value="${s}" ${state.filterStatut === s ? 'selected' : ''}>${s}</option>`).join('')}
                    </select>
                    <button onclick="showCreateModal()" class="ml-auto px-4 py-2 bg-purple-600 text-white rounded-lg text-sm font-medium">
                        ‚ûï Nouveau
                    </button>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4 fade-in">
                <div class="grid gap-3">
                    ${filtered.length === 0 ? `
                        <div class="text-center py-12 text-gray-500">
                            <div class="text-4xl mb-2">‚úÖ</div>
                            <p>Aucun contr√¥le trouv√©</p>
                        </div>
                    ` : filtered.map(c => renderControleCard(c)).join('')}
                </div>
            </div>
            
            ${renderCreateModal()}
        `;
    }
    
    function renderControleCard(c) {
        const type = getTypeInfo(c.Type_controle);
        const statut = CONTROLE_STATUTS[c.Statut] || { color: '#6b7280', icon: '‚è≥' };
        const now = Date.now() / 1000;
        const isOverdue = c.Date_prochain && c.Date_prochain < now;
        
        return `
            <div class="bg-white rounded-xl shadow-sm p-4 border-l-4" style="border-left-color: ${statut.color}">
                <div class="flex items-start gap-4">
                    <div class="w-12 h-12 rounded-lg bg-purple-50 flex items-center justify-center text-2xl">
                        ${type.Icone || '‚úÖ'}
                    </div>
                    <div class="flex-1">
                        <div class="flex items-start justify-between">
                            <div>
                                <div class="font-semibold text-gray-800">${type.Nom}</div>
                                <div class="text-sm text-gray-500">${getBatimentName(c.Batiment)}</div>
                            </div>
                            <span class="px-2 py-1 text-xs rounded-full" style="background: ${statut.color}20; color: ${statut.color}">
                                ${statut.icon} ${c.Statut || '-'}
                            </span>
                        </div>
                        <div class="flex gap-4 mt-2 text-sm">
                            <span class="${isOverdue ? 'text-red-600 font-medium' : 'text-gray-600'}">
                                üìÖ Prochain : ${c.Date_prochain ? new Date(c.Date_prochain * 1000).toLocaleDateString() : '-'}
                            </span>
                            <span class="text-gray-500">
                                Dernier : ${c.Date_dernier ? new Date(c.Date_dernier * 1000).toLocaleDateString() : '-'}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // ============ CREATE MODAL ============
    function renderCreateModal() {
        return `
            <div id="createModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 p-6">
                    <h2 class="text-lg font-semibold mb-4">‚úÖ Nouveau contr√¥le</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">B√¢timent *</label>
                            <select id="newBatiment" class="w-full px-3 py-2 border rounded-lg">
                                <option value="">-- S√©lectionner --</option>
                                ${state.batiments.map(b => `<option value="${b.id}">${b.Nom || b.Code}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Type de contr√¥le *</label>
                            <select id="newType" class="w-full px-3 py-2 border rounded-lg">
                                <option value="">-- S√©lectionner --</option>
                                ${state.types.map(t => `<option value="${t.id}">${t.Icone || '‚úÖ'} ${t.Nom}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Prochaine √©ch√©ance</label>
                            <input type="date" id="newDate" class="w-full px-3 py-2 border rounded-lg">
                        </div>
                        <div class="flex gap-2 pt-2">
                            <button onclick="closeCreateModal()" class="flex-1 px-4 py-2 border rounded-lg">Annuler</button>
                            <button onclick="createControle()" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg">Cr√©er</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    function showCreateModal() {
        document.getElementById('createModal').classList.remove('hidden');
        document.getElementById('createModal').classList.add('flex');
    }
    
    function closeCreateModal() {
        document.getElementById('createModal').classList.add('hidden');
        document.getElementById('createModal').classList.remove('flex');
    }
    
    async function createControle() {
        const batiment = document.getElementById('newBatiment').value;
        const type = document.getElementById('newType').value;
        const date = document.getElementById('newDate').value;
        
        if (!batiment || !type) {
            showToast('Veuillez remplir les champs obligatoires', 'error');
            return;
        }
        
        const data = {
            Batiment: parseInt(batiment),
            Type_controle: parseInt(type),
            Statut: '√Ä planifier',
            Date_prochain: date ? new Date(date).getTime() / 1000 : null
        };
        
        try {
            await grist.docApi.applyUserActions([['AddRecord', 'CTR_Controles', null, data]]);
            closeCreateModal();
            showToast('Contr√¥le cr√©√© !', 'success');
            await loadAllData();
        } catch (err) {
            showToast('Erreur: ' + err.message, 'error');
        }
    }
    
    // ============ TOAST ============
    function showToast(msg, type = 'info') {
        const colors = { info: 'bg-blue-500', success: 'bg-emerald-500', error: 'bg-red-500' };
        const toast = document.createElement('div');
        toast.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg text-white ${colors[type]} shadow-lg z-50 fade-in`;
        toast.textContent = msg;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }
    
    // ============ INIT ============
    grist.ready({ requiredAccess: 'full' });
    loadAllData();
    </script>
</body>
</html>