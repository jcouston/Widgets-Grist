<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patrimoine - Interventions</title>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { box-sizing: border-box; }
        html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: system-ui, -apple-system, sans-serif; }
        .fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .kanban-column { min-width: 280px; }
        .kanban-card { cursor: grab; }
        .kanban-card:active { cursor: grabbing; }
        .kanban-card.dragging { opacity: 0.5; }
    </style>
</head>
<body class="bg-gray-50 h-full flex flex-col">
    <div id="app" class="h-full flex flex-col"></div>
    
    <script>
    // ============ CONFIGURATION ============
    const STATUTS = [
        { id: 'Demand√©e', label: 'Demand√©es', color: '#6b7280', icon: 'üì•' },
        { id: 'Planifi√©e', label: 'Planifi√©es', color: '#3b82f6', icon: 'üìÖ' },
        { id: 'En cours', label: 'En cours', color: '#f59e0b', icon: 'üîß' },
        { id: 'Termin√©e', label: 'Termin√©es', color: '#10b981', icon: '‚úÖ' },
        { id: 'Annul√©e', label: 'Annul√©es', color: '#ef4444', icon: '‚ùå' }
    ];
    
    const URGENCES = {
        'Critique': { color: '#ef4444', icon: 'üî¥', priority: 1 },
        'Haute': { color: '#f59e0b', icon: 'üü†', priority: 2 },
        'Normale': { color: '#3b82f6', icon: 'üü°', priority: 3 },
        'Basse': { color: '#10b981', icon: 'üü¢', priority: 4 }
    };
    
    // ============ APP CONTEXT ============
    const appContext = {
        isArtefactory: typeof window.app !== 'undefined' && window.app.navigate,
        app: window.app || {
            navigate: (path) => router.navigate(path),
            emit: (event, data) => eventBus.emit(event, data),
            on: (event, cb) => eventBus.on(event, cb),
            state: {}
        }
    };
    
    const eventBus = {
        handlers: new Map(),
        emit(event, data) {
            (this.handlers.get(event) || []).forEach(cb => cb(data));
        },
        on(event, cb) {
            if (!this.handlers.has(event)) this.handlers.set(event, []);
            this.handlers.get(event).push(cb);
        }
    };
    
    // ============ ROUTER ============
    const router = {
        currentRoute: '/dashboard',
        currentParams: {},
        
        navigate(path, params = {}) {
            // Parser le path
            if (path.match(/^\/intervention\/(\d+)$/)) {
                const id = parseInt(path.match(/^\/intervention\/(\d+)$/)[1]);
                this.currentRoute = '/detail';
                this.currentParams = { id };
            } else if (path === '/kanban' || path === '/interventions/kanban') {
                this.currentRoute = '/kanban';
            } else if (path === '/nouveau' || path === '/interventions/nouveau') {
                this.currentRoute = '/nouveau';
            } else if (path === '/dashboard' || path === '/interventions' || path === '/') {
                this.currentRoute = '/dashboard';
            } else {
                this.currentRoute = path;
                this.currentParams = params;
            }
            render();
        },
        
        goToIntervention(id) {
            this.currentParams = { id };
            this.currentRoute = '/detail';
            render();
        }
    };
    
    // ============ STATE ============
    let state = {
        loading: true,
        error: null,
        // Donn√©es
        interventions: [],
        batiments: [],
        categories: [],
        // Filtres
        filterStatut: '',
        filterUrgence: '',
        filterBatiment: '',
        searchQuery: '',
        // Formulaire
        form: {
            Batiment: '',
            Local: '',
            Categorie: '',
            Objet: '',
            Description: '',
            Urgence: 'Normale',
            Localisation_precise: '',
            Date_souhaitee: ''
        }
    };
    
    // ============ DATA ============
    async function safeLoad(tableName) {
        try {
            const data = await grist.docApi.fetchTable(tableName);
            const n = data.id?.length || 0;
            const records = [];
            for (let i = 0; i < n; i++) {
                const record = { id: data.id[i] };
                Object.keys(data).forEach(key => {
                    if (key !== 'id') record[key] = data[key][i];
                });
                records.push(record);
            }
            return records;
        } catch (e) {
            console.warn(`Table ${tableName} non trouv√©e:`, e.message);
            return [];
        }
    }
    
    async function loadAllData() {
        state.loading = true;
        render();
        
        try {
            const [interventions, batiments, categories] = await Promise.all([
                safeLoad('Interventions'),
                safeLoad('Batiments'),
                safeLoad('INT_Categories')
            ]);
            
            state.interventions = interventions;
            state.batiments = batiments;
            state.categories = categories;
            state.loading = false;
        } catch (e) {
            state.error = e.message;
            state.loading = false;
        }
        
        render();
    }
    
    // ============ COMPUTED ============
    function getFilteredInterventions() {
        let list = [...state.interventions];
        
        if (state.searchQuery) {
            const q = state.searchQuery.toLowerCase();
            list = list.filter(i => 
                (i.Objet || '').toLowerCase().includes(q) ||
                (i.Code || '').toLowerCase().includes(q)
            );
        }
        
        if (state.filterStatut) {
            list = list.filter(i => i.Statut === state.filterStatut);
        }
        
        if (state.filterUrgence) {
            list = list.filter(i => i.Urgence === state.filterUrgence);
        }
        
        if (state.filterBatiment) {
            list = list.filter(i => i.Batiment == state.filterBatiment);
        }
        
        // Trier par urgence puis date
        list.sort((a, b) => {
            const pa = URGENCES[a.Urgence]?.priority || 99;
            const pb = URGENCES[b.Urgence]?.priority || 99;
            if (pa !== pb) return pa - pb;
            return (b.Date_demande || 0) - (a.Date_demande || 0);
        });
        
        return list;
    }
    
    function getStats() {
        const total = state.interventions.length;
        const enCours = state.interventions.filter(i => i.Statut === 'En cours').length;
        const urgentes = state.interventions.filter(i => i.Urgence === 'Critique' || i.Urgence === 'Haute').length;
        const terminees = state.interventions.filter(i => i.Statut === 'Termin√©e').length;
        
        return { total, enCours, urgentes, terminees };
    }
    
    function getBatimentName(id) {
        const b = state.batiments.find(x => x.id === id);
        return b?.Nom || b?.Code || '-';
    }
    
    function getCategoryInfo(id) {
        const c = state.categories.find(x => x.id === id);
        return c ? { nom: c.Nom, icone: c.Icone || 'üîß' } : { nom: '-', icone: 'üîß' };
    }
    
    // ============ RENDER ============
    function render() {
        const app = document.getElementById('app');
        
        if (state.loading) {
            app.innerHTML = `
                <div class="flex-1 flex items-center justify-center">
                    <div class="text-center">
                        <div class="animate-spin text-4xl mb-4">‚è≥</div>
                        <p class="text-gray-500">Chargement...</p>
                    </div>
                </div>
            `;
            return;
        }
        
        switch (router.currentRoute) {
            case '/dashboard':
                app.innerHTML = renderDashboard();
                initCharts();
                break;
            case '/kanban':
                app.innerHTML = renderKanban();
                initDragDrop();
                break;
            case '/nouveau':
                app.innerHTML = renderFormulaire();
                break;
            case '/detail':
                app.innerHTML = renderDetail();
                break;
            default:
                app.innerHTML = renderDashboard();
                initCharts();
        }
    }
    
    function renderHeader(title) {
        return `
            <header class="flex-none bg-white border-b px-4 py-3 flex items-center gap-3">
                <h1 class="text-lg font-semibold text-gray-800 flex-1">${title}</h1>
                <nav class="flex gap-1">
                    <button onclick="router.navigate('/dashboard')" 
                            class="px-3 py-1.5 text-sm rounded-lg ${router.currentRoute === '/dashboard' ? 'bg-orange-100 text-orange-700' : 'hover:bg-gray-100 text-gray-600'}">
                        üìä Dashboard
                    </button>
                    <button onclick="router.navigate('/kanban')" 
                            class="px-3 py-1.5 text-sm rounded-lg ${router.currentRoute === '/kanban' ? 'bg-orange-100 text-orange-700' : 'hover:bg-gray-100 text-gray-600'}">
                        üìã Kanban
                    </button>
                    <button onclick="router.navigate('/nouveau')" 
                            class="px-3 py-1.5 text-sm rounded-lg ${router.currentRoute === '/nouveau' ? 'bg-orange-100 text-orange-700' : 'hover:bg-gray-100 text-gray-600'}">
                        ‚ûï Nouvelle
                    </button>
                </nav>
            </header>
        `;
    }
    
    // ============ DASHBOARD ============
    function renderDashboard() {
        const stats = getStats();
        const recent = state.interventions
            .sort((a, b) => (b.Date_demande || 0) - (a.Date_demande || 0))
            .slice(0, 5);
        
        return `
            ${renderHeader('üîß Interventions')}
            
            <div class="flex-1 overflow-y-auto p-4 space-y-4 fade-in">
                <!-- KPIs -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="bg-white rounded-xl shadow-sm p-4 cursor-pointer hover:shadow-md" onclick="router.navigate('/kanban')">
                        <div class="text-2xl mb-1">üìã</div>
                        <div class="text-3xl font-bold text-gray-800">${stats.total}</div>
                        <div class="text-sm text-gray-500">Total</div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-4">
                        <div class="text-2xl mb-1">üîß</div>
                        <div class="text-3xl font-bold text-orange-600">${stats.enCours}</div>
                        <div class="text-sm text-gray-500">En cours</div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-4">
                        <div class="text-2xl mb-1">üö®</div>
                        <div class="text-3xl font-bold text-red-600">${stats.urgentes}</div>
                        <div class="text-sm text-gray-500">Urgentes</div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-4">
                        <div class="text-2xl mb-1">‚úÖ</div>
                        <div class="text-3xl font-bold text-emerald-600">${stats.terminees}</div>
                        <div class="text-sm text-gray-500">Termin√©es</div>
                    </div>
                </div>
                
                <!-- Graphiques -->
                <div class="grid lg:grid-cols-2 gap-4">
                    <div class="bg-white rounded-xl shadow-sm p-4">
                        <h3 class="font-semibold text-gray-800 mb-3">üìä Par statut</h3>
                        <div class="h-48"><canvas id="chartStatuts"></canvas></div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-4">
                        <h3 class="font-semibold text-gray-800 mb-3">üéØ Par urgence</h3>
                        <div class="h-48"><canvas id="chartUrgences"></canvas></div>
                    </div>
                </div>
                
                <!-- R√©centes -->
                <div class="bg-white rounded-xl shadow-sm p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-semibold text-gray-800">üïê Interventions r√©centes</h3>
                        <button onclick="router.navigate('/kanban')" class="text-sm text-orange-600">Voir tout ‚Üí</button>
                    </div>
                    <div class="space-y-2">
                        ${recent.map(i => renderInterventionRow(i)).join('')}
                    </div>
                </div>
            </div>
        `;
    }
    
    let chartStatuts = null;
    let chartUrgences = null;
    
    function initCharts() {
        if (chartStatuts) { chartStatuts.destroy(); chartStatuts = null; }
        if (chartUrgences) { chartUrgences.destroy(); chartUrgences = null; }
        
        // Par statut
        const byStatut = {};
        STATUTS.forEach(s => byStatut[s.id] = 0);
        state.interventions.forEach(i => {
            if (byStatut.hasOwnProperty(i.Statut)) byStatut[i.Statut]++;
        });
        
        const ctx1 = document.getElementById('chartStatuts')?.getContext('2d');
        if (ctx1) {
            chartStatuts = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: STATUTS.map(s => s.label),
                    datasets: [{
                        data: STATUTS.map(s => byStatut[s.id] || 0),
                        backgroundColor: STATUTS.map(s => s.color)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { position: 'right', labels: { boxWidth: 12, font: { size: 11 } } } }
                }
            });
        }
        
        // Par urgence
        const byUrgence = {};
        Object.keys(URGENCES).forEach(u => byUrgence[u] = 0);
        state.interventions.forEach(i => {
            if (byUrgence.hasOwnProperty(i.Urgence)) byUrgence[i.Urgence]++;
        });
        
        const ctx2 = document.getElementById('chartUrgences')?.getContext('2d');
        if (ctx2) {
            chartUrgences = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: Object.keys(URGENCES),
                    datasets: [{
                        label: 'Interventions',
                        data: Object.keys(URGENCES).map(u => byUrgence[u] || 0),
                        backgroundColor: Object.values(URGENCES).map(u => u.color)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                }
            });
        }
    }
    
    function renderInterventionRow(i) {
        const cat = getCategoryInfo(i.Categorie);
        const urgence = URGENCES[i.Urgence] || { icon: '‚ö™', color: '#6b7280' };
        
        return `
            <div class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 cursor-pointer"
                 onclick="router.goToIntervention(${i.id})">
                <span class="text-lg">${urgence.icon}</span>
                <div class="flex-1 min-w-0">
                    <div class="font-medium text-gray-800 truncate">${i.Objet || i.Code}</div>
                    <div class="text-sm text-gray-500">${getBatimentName(i.Batiment)} ‚Ä¢ ${cat.nom}</div>
                </div>
                <span class="px-2 py-1 text-xs rounded-full"
                      style="background: ${STATUTS.find(s => s.id === i.Statut)?.color || '#6b7280'}20; color: ${STATUTS.find(s => s.id === i.Statut)?.color || '#6b7280'}">
                    ${i.Statut || '-'}
                </span>
            </div>
        `;
    }
    
    // ============ KANBAN ============
    function renderKanban() {
        return `
            ${renderHeader('üîß Interventions - Kanban')}
            
            <div class="flex-1 overflow-x-auto p-4">
                <div class="flex gap-4 h-full min-w-max">
                    ${STATUTS.filter(s => s.id !== 'Annul√©e').map(statut => renderKanbanColumn(statut)).join('')}
                </div>
            </div>
            
            ${renderCreateModal()}
        `;
    }
    
    function renderKanbanColumn(statut) {
        const cards = state.interventions.filter(i => i.Statut === statut.id);
        
        return `
            <div class="kanban-column flex flex-col h-full" data-status="${statut.id}">
                <div class="flex-none bg-white rounded-t-xl px-4 py-3 border-b shadow-sm" 
                     style="border-top: 3px solid ${statut.color}">
                    <div class="flex items-center justify-between">
                        <span class="font-semibold text-gray-800">${statut.icon} ${statut.label}</span>
                        <span class="px-2 py-0.5 bg-gray-100 rounded-full text-sm">${cards.length}</span>
                    </div>
                </div>
                <div class="flex-1 bg-gray-100/50 rounded-b-xl p-2 space-y-2 overflow-y-auto kanban-dropzone"
                     data-status="${statut.id}">
                    ${cards.length === 0 ? `
                        <div class="text-center py-8 text-gray-400 text-sm">Aucune intervention</div>
                    ` : cards.map(i => renderKanbanCard(i)).join('')}
                </div>
            </div>
        `;
    }
    
    function renderKanbanCard(i) {
        const urgence = URGENCES[i.Urgence] || { icon: '‚ö™', color: '#6b7280' };
        const cat = getCategoryInfo(i.Categorie);
        
        return `
            <div class="kanban-card bg-white rounded-lg shadow-sm p-3 cursor-pointer hover:shadow-md transition-shadow"
                 draggable="true"
                 data-id="${i.id}"
                 onclick="router.goToIntervention(${i.id})">
                <div class="flex items-start gap-2 mb-2">
                    <span class="text-lg">${urgence.icon}</span>
                    <div class="flex-1 min-w-0">
                        <div class="font-medium text-gray-800 text-sm truncate">${i.Objet || i.Code}</div>
                        <div class="text-xs text-gray-500">${i.Code}</div>
                    </div>
                </div>
                <div class="flex items-center gap-2 text-xs text-gray-500">
                    <span>üè¢ ${getBatimentName(i.Batiment)}</span>
                </div>
                <div class="flex items-center gap-2 mt-2">
                    <span class="px-2 py-0.5 rounded text-xs" style="background: ${urgence.color}20; color: ${urgence.color}">
                        ${i.Urgence}
                    </span>
                    <span class="text-xs text-gray-400">${cat.icone} ${cat.nom}</span>
                </div>
            </div>
        `;
    }
    
    function initDragDrop() {
        document.querySelectorAll('.kanban-card').forEach(card => {
            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragend', handleDragEnd);
        });
        
        document.querySelectorAll('.kanban-dropzone').forEach(zone => {
            zone.addEventListener('dragover', handleDragOver);
            zone.addEventListener('drop', handleDrop);
            zone.addEventListener('dragleave', handleDragLeave);
        });
    }
    
    let draggedCard = null;
    
    function handleDragStart(e) {
        draggedCard = e.target;
        e.target.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
    }
    
    function handleDragEnd(e) {
        e.target.classList.remove('dragging');
        document.querySelectorAll('.kanban-dropzone').forEach(z => z.classList.remove('bg-blue-50'));
    }
    
    function handleDragOver(e) {
        e.preventDefault();
        e.currentTarget.classList.add('bg-blue-50');
    }
    
    function handleDragLeave(e) {
        e.currentTarget.classList.remove('bg-blue-50');
    }
    
    async function handleDrop(e) {
        e.preventDefault();
        e.currentTarget.classList.remove('bg-blue-50');
        
        if (!draggedCard) return;
        
        const newStatus = e.currentTarget.dataset.status;
        const id = parseInt(draggedCard.dataset.id);
        
        try {
            await grist.docApi.applyUserActions([['UpdateRecord', 'Interventions', id, { Statut: newStatus }]]);
            await loadAllData();
            showToast(`Intervention pass√©e en "${newStatus}"`, 'success');
        } catch (err) {
            showToast('Erreur: ' + err.message, 'error');
        }
        
        draggedCard = null;
    }
    
    // ============ FORMULAIRE ============
    function renderFormulaire() {
        return `
            <header class="flex-none bg-white border-b px-4 py-3 flex items-center gap-3">
                <button onclick="router.navigate('/kanban')" 
                        class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100">‚Üê</button>
                <h1 class="text-lg font-semibold text-gray-800">‚ûï Nouvelle intervention</h1>
            </header>
            
            <div class="flex-1 overflow-y-auto p-4 fade-in">
                <div class="max-w-2xl mx-auto space-y-6">
                    <!-- Localisation -->
                    <div class="bg-white rounded-xl shadow-sm p-4">
                        <h2 class="font-semibold text-gray-800 mb-4">üìç Localisation</h2>
                        <div class="grid gap-4 sm:grid-cols-2">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">B√¢timent *</label>
                                <select id="formBatiment" onchange="state.form.Batiment = this.value"
                                        class="w-full px-3 py-2 border rounded-lg">
                                    <option value="">-- S√©lectionner --</option>
                                    ${state.batiments.map(b => `<option value="${b.id}">${b.Nom || b.Code}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Localisation pr√©cise</label>
                                <input type="text" id="formLocalisation" 
                                       onchange="state.form.Localisation_precise = this.value"
                                       placeholder="Ex: Bureau 203, Couloir 2√®me √©tage..."
                                       class="w-full px-3 py-2 border rounded-lg">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Description -->
                    <div class="bg-white rounded-xl shadow-sm p-4">
                        <h2 class="font-semibold text-gray-800 mb-4">üìù Description</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Objet *</label>
                                <input type="text" id="formObjet"
                                       onchange="state.form.Objet = this.value"
                                       placeholder="D√©crivez bri√®vement le probl√®me..."
                                       class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Description d√©taill√©e</label>
                                <textarea id="formDescription" rows="3"
                                          onchange="state.form.Description = this.value"
                                          placeholder="D√©tails suppl√©mentaires..."
                                          class="w-full px-3 py-2 border rounded-lg"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Classification -->
                    <div class="bg-white rounded-xl shadow-sm p-4">
                        <h2 class="font-semibold text-gray-800 mb-4">üè∑Ô∏è Classification</h2>
                        <div class="grid gap-4 sm:grid-cols-2">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Cat√©gorie *</label>
                                <select id="formCategorie" onchange="state.form.Categorie = this.value"
                                        class="w-full px-3 py-2 border rounded-lg">
                                    <option value="">-- S√©lectionner --</option>
                                    ${state.categories.map(c => `<option value="${c.id}">${c.Icone || 'üîß'} ${c.Nom}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Urgence</label>
                                <select id="formUrgence" onchange="state.form.Urgence = this.value"
                                        class="w-full px-3 py-2 border rounded-lg">
                                    ${Object.keys(URGENCES).map(u => `
                                        <option value="${u}" ${u === 'Normale' ? 'selected' : ''}>
                                            ${URGENCES[u].icon} ${u}
                                        </option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Planification -->
                    <div class="bg-white rounded-xl shadow-sm p-4">
                        <h2 class="font-semibold text-gray-800 mb-4">üìÖ Planification</h2>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Date souhait√©e</label>
                            <input type="date" id="formDate"
                                   onchange="state.form.Date_souhaitee = this.value"
                                   class="w-full px-3 py-2 border rounded-lg">
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    <div class="flex gap-3">
                        <button onclick="resetForm()" 
                                class="flex-1 px-4 py-3 border rounded-xl font-medium hover:bg-gray-50">
                            R√©initialiser
                        </button>
                        <button onclick="submitForm()" 
                                class="flex-1 px-4 py-3 bg-orange-600 text-white rounded-xl font-medium hover:bg-orange-700">
                            Cr√©er l'intervention
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
    
    function resetForm() {
        state.form = {
            Batiment: '', Local: '', Categorie: '', Objet: '', 
            Description: '', Urgence: 'Normale', Localisation_precise: '', Date_souhaitee: ''
        };
        render();
    }
    
    async function submitForm() {
        if (!state.form.Batiment) {
            showToast('Veuillez s√©lectionner un b√¢timent', 'error');
            return;
        }
        if (!state.form.Objet?.trim()) {
            showToast('Veuillez saisir un objet', 'error');
            return;
        }
        if (!state.form.Categorie) {
            showToast('Veuillez s√©lectionner une cat√©gorie', 'error');
            return;
        }
        
        const year = new Date().getFullYear();
        const count = state.interventions.length + 1;
        const code = `INT-${year}-${String(count).padStart(4, '0')}`;
        
        const data = {
            Code: code,
            Objet: state.form.Objet,
            Description: state.form.Description || null,
            Batiment: parseInt(state.form.Batiment) || null,
            Localisation_precise: state.form.Localisation_precise || null,
            Categorie: parseInt(state.form.Categorie) || null,
            Urgence: state.form.Urgence,
            Statut: 'Demand√©e',
            Date_demande: Date.now() / 1000,
            Date_souhaitee: state.form.Date_souhaitee ? new Date(state.form.Date_souhaitee).getTime() / 1000 : null
        };
        
        try {
            await grist.docApi.applyUserActions([['AddRecord', 'Interventions', null, data]]);
            showToast(`${code} cr√©√©e avec succ√®s !`, 'success');
            resetForm();
            await loadAllData();
            router.navigate('/kanban');
        } catch (err) {
            showToast('Erreur: ' + err.message, 'error');
        }
    }
    
    // ============ DETAIL ============
    function renderDetail() {
        const id = router.currentParams.id;
        const i = state.interventions.find(x => x.id === id);
        
        if (!i) {
            return `
                <header class="flex-none bg-white border-b px-4 py-3 flex items-center gap-3">
                    <button onclick="router.navigate('/kanban')" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100">‚Üê</button>
                    <h1 class="text-lg font-semibold text-gray-800">Intervention non trouv√©e</h1>
                </header>
                <div class="flex-1 flex items-center justify-center text-gray-500">
                    Cette intervention n'existe pas
                </div>
            `;
        }
        
        const cat = getCategoryInfo(i.Categorie);
        const urgence = URGENCES[i.Urgence] || { icon: '‚ö™', color: '#6b7280' };
        const statut = STATUTS.find(s => s.id === i.Statut) || { color: '#6b7280' };
        
        return `
            <header class="flex-none bg-white border-b px-4 py-3 flex items-center gap-3">
                <button onclick="router.navigate('/kanban')" 
                        class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100">‚Üê</button>
                <div class="flex-1">
                    <h1 class="text-lg font-semibold text-gray-800">${i.Code}</h1>
                    <div class="text-sm text-gray-500">${i.Objet}</div>
                </div>
                <span class="px-3 py-1 text-sm rounded-full" 
                      style="background: ${statut.color}20; color: ${statut.color}">
                    ${i.Statut}
                </span>
            </header>
            
            <div class="flex-1 overflow-y-auto p-4 space-y-4 fade-in">
                <!-- En-t√™te -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex items-start gap-4">
                        <div class="w-16 h-16 rounded-xl flex items-center justify-center text-3xl"
                             style="background: ${urgence.color}20">
                            ${urgence.icon}
                        </div>
                        <div class="flex-1">
                            <h2 class="text-xl font-bold text-gray-800 mb-2">${i.Objet || 'Sans objet'}</h2>
                            <div class="flex flex-wrap gap-2">
                                <span class="px-2 py-1 rounded text-sm" style="background: ${urgence.color}20; color: ${urgence.color}">
                                    ${i.Urgence || '-'}
                                </span>
                                <span class="px-2 py-1 bg-gray-100 rounded text-sm">${cat.icone} ${cat.nom}</span>
                            </div>
                        </div>
                    </div>
                    ${i.Description ? `
                        <div class="mt-4 pt-4 border-t">
                            <h3 class="text-sm font-medium text-gray-700 mb-1">Description</h3>
                            <p class="text-gray-600">${i.Description}</p>
                        </div>
                    ` : ''}
                </div>
                
                <!-- Infos -->
                <div class="grid lg:grid-cols-2 gap-4">
                    <div class="bg-white rounded-xl shadow-sm p-4">
                        <h3 class="font-semibold text-gray-800 mb-3">üìç Localisation</h3>
                        <dl class="space-y-2 text-sm">
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <dt class="text-gray-500">B√¢timent</dt>
                                <dd class="font-medium">${getBatimentName(i.Batiment)}</dd>
                            </div>
                            ${i.Localisation_precise ? `
                                <div class="flex justify-between py-2">
                                    <dt class="text-gray-500">Pr√©cision</dt>
                                    <dd class="font-medium">${i.Localisation_precise}</dd>
                                </div>
                            ` : ''}
                        </dl>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm p-4">
                        <h3 class="font-semibold text-gray-800 mb-3">üìÖ Dates</h3>
                        <dl class="space-y-2 text-sm">
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <dt class="text-gray-500">Demand√©e le</dt>
                                <dd class="font-medium">${i.Date_demande ? new Date(i.Date_demande * 1000).toLocaleDateString() : '-'}</dd>
                            </div>
                            <div class="flex justify-between py-2">
                                <dt class="text-gray-500">Souhait√©e pour</dt>
                                <dd class="font-medium">${i.Date_souhaitee ? new Date(i.Date_souhaitee * 1000).toLocaleDateString() : '-'}</dd>
                            </div>
                        </dl>
                    </div>
                </div>
                
                <!-- Actions -->
                <div class="bg-white rounded-xl shadow-sm p-4">
                    <h3 class="font-semibold text-gray-800 mb-3">üîÑ Changer le statut</h3>
                    <div class="flex flex-wrap gap-2">
                        ${STATUTS.map(s => `
                            <button onclick="updateStatus(${i.id}, '${s.id}')"
                                    class="px-4 py-2 rounded-lg text-sm font-medium transition-colors ${i.Statut === s.id ? 'ring-2 ring-offset-2' : 'hover:opacity-80'}"
                                    style="background: ${s.color}20; color: ${s.color}; ${i.Statut === s.id ? `ring-color: ${s.color}` : ''}">
                                ${s.icon} ${s.label}
                            </button>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
    }
    
    async function updateStatus(id, newStatus) {
        try {
            await grist.docApi.applyUserActions([['UpdateRecord', 'Interventions', id, { Statut: newStatus }]]);
            showToast(`Statut mis √† jour : ${newStatus}`, 'success');
            await loadAllData();
        } catch (err) {
            showToast('Erreur: ' + err.message, 'error');
        }
    }
    
    // ============ CREATE MODAL (Kanban) ============
    function renderCreateModal() {
        return `
            <div id="createModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 p-6">
                    <h2 class="text-lg font-semibold mb-4">üîß Nouvelle intervention rapide</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Objet *</label>
                            <input type="text" id="quickObjet" class="w-full px-3 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">B√¢timent</label>
                            <select id="quickBatiment" class="w-full px-3 py-2 border rounded-lg">
                                <option value="">-- S√©lectionner --</option>
                                ${state.batiments.map(b => `<option value="${b.id}">${b.Nom || b.Code}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Urgence</label>
                            <select id="quickUrgence" class="w-full px-3 py-2 border rounded-lg">
                                ${Object.keys(URGENCES).map(u => `
                                    <option value="${u}" ${u === 'Normale' ? 'selected' : ''}>${URGENCES[u].icon} ${u}</option>
                                `).join('')}
                            </select>
                        </div>
                        <div class="flex gap-2 pt-2">
                            <button onclick="closeCreateModal()" class="flex-1 px-4 py-2 border rounded-lg">Annuler</button>
                            <button onclick="quickCreate()" class="flex-1 px-4 py-2 bg-orange-600 text-white rounded-lg">Cr√©er</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    function showCreateModal() {
        document.getElementById('createModal').classList.remove('hidden');
        document.getElementById('createModal').classList.add('flex');
    }
    
    function closeCreateModal() {
        document.getElementById('createModal').classList.add('hidden');
        document.getElementById('createModal').classList.remove('flex');
    }
    
    async function quickCreate() {
        const objet = document.getElementById('quickObjet').value.trim();
        if (!objet) {
            showToast('Veuillez saisir un objet', 'error');
            return;
        }
        
        const year = new Date().getFullYear();
        const count = state.interventions.length + 1;
        const code = `INT-${year}-${String(count).padStart(4, '0')}`;
        
        const data = {
            Code: code,
            Objet: objet,
            Batiment: parseInt(document.getElementById('quickBatiment').value) || null,
            Urgence: document.getElementById('quickUrgence').value,
            Statut: 'Demand√©e',
            Date_demande: Date.now() / 1000
        };
        
        try {
            await grist.docApi.applyUserActions([['AddRecord', 'Interventions', null, data]]);
            closeCreateModal();
            document.getElementById('quickObjet').value = '';
            showToast(`${code} cr√©√©e !`, 'success');
            await loadAllData();
        } catch (err) {
            showToast('Erreur: ' + err.message, 'error');
        }
    }
    
    // ============ TOAST ============
    function showToast(msg, type = 'info') {
        const colors = { info: 'bg-blue-500', success: 'bg-emerald-500', error: 'bg-red-500' };
        const toast = document.createElement('div');
        toast.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg text-white ${colors[type]} shadow-lg z-50 fade-in`;
        toast.textContent = msg;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }
    
    // ============ INIT ============
    grist.ready({ requiredAccess: 'full' });
    
    // √âcouter les √©v√©nements (mode Artefactory)
    if (appContext.isArtefactory) {
        appContext.app.on('createIntervention', (data) => {
            if (data?.batimentId) {
                state.form.Batiment = data.batimentId;
            }
            router.navigate('/nouveau');
        });
    }
    
    loadAllData();
    </script>
</body>
</html>