<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patrimoine - √ânergie</title>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { box-sizing: border-box; }
        html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: system-ui, -apple-system, sans-serif; }
        .fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50 h-full flex flex-col">
    <div id="app" class="h-full flex flex-col"></div>
    
    <script>
    // ============ CONFIGURATION ============
    const DPE_COLORS = {
        'A': '#319834', 'B': '#33cc31', 'C': '#cbfc34',
        'D': '#fbfe06', 'E': '#fbcc05', 'F': '#fc9935', 'G': '#fc0205'
    };
    
    const ENERGIE_ICONS = {
        '√âlectricit√©': '‚ö°', 'Gaz': 'üî•', 'Eau': 'üíß', 'Chaleur': 'üå°Ô∏è', 'Fioul': 'üõ¢Ô∏è'
    };
    
    // ============ APP CONTEXT ============
    const appContext = {
        isArtefactory: typeof window.app !== 'undefined' && window.app.navigate,
        app: window.app || { navigate: () => {}, emit: () => {}, on: () => {}, state: {} }
    };
    
    // ============ ROUTER ============
    const router = {
        currentRoute: '/dashboard',
        
        navigate(path) {
            if (path === '/pdl' || path === '/energie/pdl') {
                this.currentRoute = '/pdl';
            } else if (path === '/import' || path === '/energie/import') {
                this.currentRoute = '/import';
            } else {
                this.currentRoute = '/dashboard';
            }
            render();
        }
    };
    
    // ============ STATE ============
    let state = {
        loading: true,
        error: null,
        batiments: [],
        pdl: [],
        consommations: [],
        dpe: [],
        fournisseurs: [],
        selectedYear: new Date().getFullYear()
    };
    
    // ============ DATA ============
    async function safeLoad(tableName) {
        try {
            const data = await grist.docApi.fetchTable(tableName);
            const n = data.id?.length || 0;
            const records = [];
            for (let i = 0; i < n; i++) {
                const record = { id: data.id[i] };
                Object.keys(data).forEach(key => {
                    if (key !== 'id') record[key] = data[key][i];
                });
                records.push(record);
            }
            return records;
        } catch (e) {
            console.warn(`Table ${tableName} non trouv√©e`);
            return [];
        }
    }
    
    async function loadAllData() {
        state.loading = true;
        render();
        
        try {
            const [batiments, pdl, consommations, dpe, fournisseurs] = await Promise.all([
                safeLoad('Batiments'),
                safeLoad('ENE_PDL'),
                safeLoad('ENE_Consommations'),
                safeLoad('ENE_DPE'),
                safeLoad('ENE_Fournisseurs')
            ]);
            
            state.batiments = batiments;
            state.pdl = pdl;
            state.consommations = consommations;
            state.dpe = dpe;
            state.fournisseurs = fournisseurs;
            state.loading = false;
        } catch (e) {
            state.error = e.message;
            state.loading = false;
        }
        
        render();
    }
    
    // ============ COMPUTED ============
    function getStats() {
        const totalConso = state.consommations.reduce((sum, c) => sum + (c.Montant_EUR || 0), 0);
        const totalKwh = state.consommations.reduce((sum, c) => sum + (c.Quantite || 0), 0);
        
        // DPE distribution
        const dpeDistribution = {};
        state.dpe.forEach(d => {
            const classe = d.Classe_energie || 'NC';
            dpeDistribution[classe] = (dpeDistribution[classe] || 0) + 1;
        });
        
        return {
            nbPDL: state.pdl.length,
            totalConso,
            totalKwh,
            nbDPE: state.dpe.length,
            dpeDistribution
        };
    }
    
    function getBatimentName(id) {
        const b = state.batiments.find(x => x.id === id);
        return b?.Nom || b?.Code || '-';
    }
    
    function getFournisseurName(id) {
        const f = state.fournisseurs.find(x => x.id === id);
        return f?.Nom || '-';
    }
    
    // ============ RENDER ============
    function render() {
        const app = document.getElementById('app');
        
        if (state.loading) {
            app.innerHTML = `
                <div class="flex-1 flex items-center justify-center">
                    <div class="text-center">
                        <div class="animate-spin text-4xl mb-4">‚ö°</div>
                        <p class="text-gray-500">Chargement des donn√©es √©nerg√©tiques...</p>
                    </div>
                </div>
            `;
            return;
        }
        
        switch (router.currentRoute) {
            case '/dashboard':
                app.innerHTML = renderDashboard();
                initCharts();
                break;
            case '/pdl':
                app.innerHTML = renderPDL();
                break;
            case '/import':
                app.innerHTML = renderImport();
                break;
            default:
                app.innerHTML = renderDashboard();
                initCharts();
        }
    }
    
    function renderHeader(title) {
        return `
            <header class="flex-none bg-white border-b px-4 py-3 flex items-center gap-3">
                <h1 class="text-lg font-semibold text-gray-800 flex-1">${title}</h1>
                <nav class="flex gap-1">
                    <button onclick="router.navigate('/dashboard')" 
                            class="px-3 py-1.5 text-sm rounded-lg ${router.currentRoute === '/dashboard' ? 'bg-blue-100 text-blue-700' : 'hover:bg-gray-100 text-gray-600'}">
                        üìä Dashboard
                    </button>
                    <button onclick="router.navigate('/pdl')" 
                            class="px-3 py-1.5 text-sm rounded-lg ${router.currentRoute === '/pdl' ? 'bg-blue-100 text-blue-700' : 'hover:bg-gray-100 text-gray-600'}">
                        üìç PDL
                    </button>
                    <button onclick="router.navigate('/import')" 
                            class="px-3 py-1.5 text-sm rounded-lg ${router.currentRoute === '/import' ? 'bg-blue-100 text-blue-700' : 'hover:bg-gray-100 text-gray-600'}">
                        üì• Import
                    </button>
                </nav>
            </header>
        `;
    }
    
    // ============ DASHBOARD ============
    function renderDashboard() {
        const stats = getStats();
        
        return `
            ${renderHeader('‚ö° √ânergie')}
            
            <div class="flex-1 overflow-y-auto p-4 space-y-4 fade-in">
                <!-- KPIs -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="bg-white rounded-xl shadow-sm p-4">
                        <div class="text-2xl mb-1">üìç</div>
                        <div class="text-3xl font-bold text-gray-800">${stats.nbPDL}</div>
                        <div class="text-sm text-gray-500">Points de livraison</div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-4">
                        <div class="text-2xl mb-1">‚ö°</div>
                        <div class="text-3xl font-bold text-blue-600">${(stats.totalKwh / 1000).toFixed(0)}k</div>
                        <div class="text-sm text-gray-500">kWh consomm√©s</div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-4">
                        <div class="text-2xl mb-1">üí∞</div>
                        <div class="text-3xl font-bold text-emerald-600">${(stats.totalConso / 1000).toFixed(1)}k‚Ç¨</div>
                        <div class="text-sm text-gray-500">Budget √©nergie</div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-4">
                        <div class="text-2xl mb-1">üìã</div>
                        <div class="text-3xl font-bold text-purple-600">${stats.nbDPE}</div>
                        <div class="text-sm text-gray-500">Diagnostics DPE</div>
                    </div>
                </div>
                
                <!-- Graphiques -->
                <div class="grid lg:grid-cols-2 gap-4">
                    <div class="bg-white rounded-xl shadow-sm p-4">
                        <h3 class="font-semibold text-gray-800 mb-3">üìà √âvolution mensuelle</h3>
                        <div class="h-48"><canvas id="chartMensuel"></canvas></div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-4">
                        <h3 class="font-semibold text-gray-800 mb-3">üè∑Ô∏è R√©partition DPE</h3>
                        <div class="h-48 flex items-center justify-center">
                            <div class="w-40 h-40"><canvas id="chartDPE"></canvas></div>
                        </div>
                    </div>
                </div>
                
                <!-- PDL r√©cents -->
                <div class="bg-white rounded-xl shadow-sm p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-semibold text-gray-800">üìç Points de livraison</h3>
                        <button onclick="router.navigate('/pdl')" class="text-sm text-blue-600">Voir tout ‚Üí</button>
                    </div>
                    <div class="space-y-2">
                        ${state.pdl.slice(0, 5).map(p => `
                            <div class="flex items-center gap-3 p-3 rounded-lg bg-gray-50">
                                <span class="text-lg">${ENERGIE_ICONS[p.Type_energie] || '‚ö°'}</span>
                                <div class="flex-1">
                                    <div class="font-medium text-gray-800">${p.Numero_PDL || p.id}</div>
                                    <div class="text-sm text-gray-500">${getBatimentName(p.Batiment)} ‚Ä¢ ${p.Type_energie || '-'}</div>
                                </div>
                                <span class="px-2 py-1 bg-blue-50 text-blue-600 rounded text-xs">${p.Actif ? 'Actif' : 'Inactif'}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
    }
    
    let chartMensuel = null;
    let chartDPE = null;
    
    function initCharts() {
        if (chartMensuel) { chartMensuel.destroy(); chartMensuel = null; }
        if (chartDPE) { chartDPE.destroy(); chartDPE = null; }
        
        // Chart mensuel (simulation)
        const months = ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Ao√ªt', 'Sep', 'Oct', 'Nov', 'D√©c'];
        const values = months.map(() => Math.floor(Math.random() * 5000) + 2000);
        
        const ctx1 = document.getElementById('chartMensuel')?.getContext('2d');
        if (ctx1) {
            chartMensuel = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'kWh',
                        data: values,
                        backgroundColor: '#3b82f6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }
        
        // Chart DPE
        const stats = getStats();
        const dpeLabels = Object.keys(stats.dpeDistribution);
        const dpeValues = Object.values(stats.dpeDistribution);
        
        const ctx2 = document.getElementById('chartDPE')?.getContext('2d');
        if (ctx2 && dpeLabels.length > 0) {
            chartDPE = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: dpeLabels,
                    datasets: [{
                        data: dpeValues,
                        backgroundColor: dpeLabels.map(l => DPE_COLORS[l] || '#6b7280')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { position: 'right', labels: { boxWidth: 12, font: { size: 11 } } } }
                }
            });
        }
    }
    
    // ============ PDL ============
    function renderPDL() {
        return `
            ${renderHeader('‚ö° Points de livraison')}
            
            <div class="flex-1 overflow-y-auto p-4 fade-in">
                <div class="grid gap-3">
                    ${state.pdl.length === 0 ? `
                        <div class="text-center py-12 text-gray-500">
                            <div class="text-4xl mb-2">üìç</div>
                            <p>Aucun point de livraison</p>
                        </div>
                    ` : state.pdl.map(p => `
                        <div class="bg-white rounded-xl shadow-sm p-4 border-l-4" style="border-left-color: ${p.Actif ? '#10b981' : '#6b7280'}">
                            <div class="flex items-start gap-4">
                                <div class="w-12 h-12 rounded-lg bg-blue-50 flex items-center justify-center text-2xl">
                                    ${ENERGIE_ICONS[p.Type_energie] || '‚ö°'}
                                </div>
                                <div class="flex-1">
                                    <div class="font-semibold text-gray-800">${p.Numero_PDL || 'PDL ' + p.id}</div>
                                    <div class="text-sm text-gray-500">${getBatimentName(p.Batiment)}</div>
                                    <div class="flex gap-4 mt-2 text-sm text-gray-600">
                                        <span>${p.Type_energie || '-'}</span>
                                        <span>${getFournisseurName(p.Fournisseur)}</span>
                                        <span>${p.Puissance_souscrite ? p.Puissance_souscrite + ' kVA' : '-'}</span>
                                    </div>
                                </div>
                                <span class="px-2 py-1 rounded text-xs ${p.Actif ? 'bg-emerald-50 text-emerald-600' : 'bg-gray-100 text-gray-500'}">
                                    ${p.Actif ? 'Actif' : 'Inactif'}
                                </span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    // ============ IMPORT ============
    function renderImport() {
        return `
            ${renderHeader('‚ö° Import des consommations')}
            
            <div class="flex-1 overflow-y-auto p-4 fade-in">
                <div class="max-w-2xl mx-auto">
                    <div class="bg-white rounded-xl shadow-sm p-6 text-center">
                        <div class="text-6xl mb-4">üì•</div>
                        <h2 class="text-xl font-bold text-gray-800 mb-2">Import des donn√©es</h2>
                        <p class="text-gray-500 mb-6">Importez vos relev√©s de consommation au format CSV ou Excel</p>
                        
                        <div class="border-2 border-dashed border-gray-300 rounded-xl p-8 mb-6 hover:border-blue-400 transition-colors cursor-pointer"
                             onclick="document.getElementById('fileInput').click()">
                            <div class="text-4xl mb-2">üìÑ</div>
                            <p class="text-gray-600">Glissez un fichier ici ou cliquez pour s√©lectionner</p>
                            <p class="text-sm text-gray-400 mt-2">Formats accept√©s : CSV, XLSX</p>
                        </div>
                        <input type="file" id="fileInput" accept=".csv,.xlsx" class="hidden" onchange="handleFileUpload(this)">
                        
                        <div class="text-left bg-blue-50 rounded-lg p-4">
                            <h3 class="font-semibold text-blue-800 mb-2">üìã Format attendu</h3>
                            <ul class="text-sm text-blue-700 space-y-1">
                                <li>‚Ä¢ Colonne PDL : num√©ro du point de livraison</li>
                                <li>‚Ä¢ Colonne Date : date du relev√©</li>
                                <li>‚Ä¢ Colonne Quantit√© : consommation en kWh</li>
                                <li>‚Ä¢ Colonne Montant : montant en euros (optionnel)</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    function handleFileUpload(input) {
        if (input.files && input.files[0]) {
            showToast('Fichier s√©lectionn√© : ' + input.files[0].name, 'info');
            // TODO: Traitement du fichier
        }
    }
    
    // ============ TOAST ============
    function showToast(msg, type = 'info') {
        const colors = { info: 'bg-blue-500', success: 'bg-emerald-500', error: 'bg-red-500' };
        const toast = document.createElement('div');
        toast.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg text-white ${colors[type]} shadow-lg z-50 fade-in`;
        toast.textContent = msg;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }
    
    // ============ INIT ============
    grist.ready({ requiredAccess: 'full' });
    loadAllData();
    </script>
</body>
</html>