<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patrimoine - Administration</title>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { box-sizing: border-box; }
        html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: system-ui, -apple-system, sans-serif; }
        .fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50 h-full flex flex-col">
    <div id="app" class="h-full flex flex-col"></div>
    
    <script>
    // ============ CONFIGURATION ============
    const REFERENTIELS = [
        { id: 'Services', label: 'Services', icon: 'üèõÔ∏è', columns: ['Nom', 'Code', 'Responsable'] },
        { id: 'Agents', label: 'Agents', icon: 'üë§', columns: ['Nom', 'Prenom', 'Email', 'Service'] },
        { id: 'INT_Categories', label: 'Cat√©gories interventions', icon: 'üè∑Ô∏è', columns: ['Nom', 'Icone', 'Description'] },
        { id: 'CTR_Types', label: 'Types de contr√¥les', icon: '‚úÖ', columns: ['Nom', 'Icone', 'Periodicite_mois', 'Obligatoire'] },
        { id: 'ENE_Fournisseurs', label: 'Fournisseurs √©nergie', icon: '‚ö°', columns: ['Nom', 'Type', 'Contact'] }
    ];
    
    // ============ STATE ============
    let state = {
        loading: true,
        currentTab: 'Services',
        data: {},
        editingItem: null,
        searchQuery: ''
    };
    
    // ============ DATA ============
    async function safeLoad(tableName) {
        try {
            const data = await grist.docApi.fetchTable(tableName);
            const n = data.id?.length || 0;
            const records = [];
            for (let i = 0; i < n; i++) {
                const record = { id: data.id[i] };
                Object.keys(data).forEach(key => {
                    if (key !== 'id') record[key] = data[key][i];
                });
                records.push(record);
            }
            return records;
        } catch (e) {
            console.warn(`Table ${tableName} non trouv√©e`);
            return [];
        }
    }
    
    async function loadAllData() {
        state.loading = true;
        render();
        
        try {
            for (const ref of REFERENTIELS) {
                state.data[ref.id] = await safeLoad(ref.id);
            }
            state.loading = false;
        } catch (e) {
            state.loading = false;
        }
        
        render();
    }
    
    // ============ RENDER ============
    function render() {
        const app = document.getElementById('app');
        
        if (state.loading) {
            app.innerHTML = `
                <div class="flex-1 flex items-center justify-center">
                    <div class="text-center">
                        <div class="animate-spin text-4xl mb-4">‚öôÔ∏è</div>
                        <p class="text-gray-500">Chargement...</p>
                    </div>
                </div>
            `;
            return;
        }
        
        const currentRef = REFERENTIELS.find(r => r.id === state.currentTab);
        const items = state.data[state.currentTab] || [];
        
        // Filtrer
        let filtered = items;
        if (state.searchQuery) {
            const q = state.searchQuery.toLowerCase();
            filtered = items.filter(item => 
                Object.values(item).some(v => 
                    String(v || '').toLowerCase().includes(q)
                )
            );
        }
        
        app.innerHTML = `
            <header class="flex-none bg-white border-b px-4 py-3">
                <div class="flex items-center gap-3">
                    <h1 class="text-lg font-semibold text-gray-800">‚öôÔ∏è Administration</h1>
                    <span class="text-sm text-gray-500">Gestion des r√©f√©rentiels</span>
                </div>
            </header>
            
            <!-- Tabs -->
            <div class="flex-none bg-white border-b px-4 overflow-x-auto">
                <div class="flex gap-1 py-2">
                    ${REFERENTIELS.map(ref => `
                        <button onclick="setTab('${ref.id}')"
                                class="px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-colors ${state.currentTab === ref.id ? 'bg-gray-800 text-white' : 'hover:bg-gray-100 text-gray-600'}">
                            ${ref.icon} ${ref.label}
                            <span class="ml-1 px-1.5 py-0.5 rounded-full text-xs ${state.currentTab === ref.id ? 'bg-white/20' : 'bg-gray-200'}">${(state.data[ref.id] || []).length}</span>
                        </button>
                    `).join('')}
                </div>
            </div>
            
            <!-- Toolbar -->
            <div class="flex-none bg-white border-b px-4 py-3">
                <div class="flex gap-3 items-center">
                    <div class="flex-1 max-w-md">
                        <input type="text" placeholder="üîç Rechercher..." 
                               value="${state.searchQuery}"
                               oninput="state.searchQuery = this.value; render()"
                               class="w-full px-3 py-2 border rounded-lg text-sm">
                    </div>
                    <button onclick="showCreateModal()"
                            class="px-4 py-2 bg-gray-800 text-white rounded-lg text-sm font-medium hover:bg-gray-700">
                        ‚ûï Nouveau
                    </button>
                </div>
            </div>
            
            <!-- Table -->
            <div class="flex-1 overflow-auto p-4 fade-in">
                ${filtered.length === 0 ? `
                    <div class="text-center py-12 text-gray-500">
                        <div class="text-4xl mb-2">${currentRef?.icon || 'üìã'}</div>
                        <p>Aucun √©l√©ment</p>
                    </div>
                ` : `
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">ID</th>
                                    ${currentRef.columns.map(col => `
                                        <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">${col}</th>
                                    `).join('')}
                                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                ${filtered.map(item => `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-4 py-3 text-sm text-gray-400">#${item.id}</td>
                                        ${currentRef.columns.map(col => `
                                            <td class="px-4 py-3 text-sm text-gray-800">${formatValue(item[col])}</td>
                                        `).join('')}
                                        <td class="px-4 py-3 text-right">
                                            <button onclick="editItem(${item.id})" class="text-blue-600 hover:text-blue-800 text-sm mr-2">‚úèÔ∏è</button>
                                            <button onclick="deleteItem(${item.id})" class="text-red-600 hover:text-red-800 text-sm">üóëÔ∏è</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `}
            </div>
            
            ${renderModal()}
        `;
    }
    
    function formatValue(val) {
        if (val === null || val === undefined) return '-';
        if (val === true) return '‚úÖ';
        if (val === false) return '‚ùå';
        return String(val);
    }
    
    function setTab(tabId) {
        state.currentTab = tabId;
        state.searchQuery = '';
        render();
    }
    
    // ============ MODAL ============
    function renderModal() {
        const currentRef = REFERENTIELS.find(r => r.id === state.currentTab);
        const isEditing = state.editingItem !== null;
        const item = isEditing ? (state.data[state.currentTab] || []).find(i => i.id === state.editingItem) : {};
        
        return `
            <div id="modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="p-4 border-b flex items-center justify-between sticky top-0 bg-white">
                        <h2 class="text-lg font-semibold">${currentRef?.icon} ${isEditing ? 'Modifier' : 'Nouveau'} ${currentRef?.label}</h2>
                        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">‚úï</button>
                    </div>
                    <div id="modalForm" class="p-4 space-y-4">
                        ${currentRef?.columns.map(col => {
                            const value = item?.[col] ?? '';
                            const inputType = col.toLowerCase().includes('email') ? 'email' : 
                                             col.toLowerCase().includes('date') ? 'date' :
                                             typeof value === 'number' ? 'number' : 'text';
                            const isBoolean = typeof value === 'boolean' || col.toLowerCase().includes('obligatoire') || col.toLowerCase().includes('actif');
                            
                            if (isBoolean) {
                                return `
                                    <div>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" name="${col}" ${value ? 'checked' : ''} class="w-4 h-4 rounded">
                                            <span class="text-sm font-medium">${col}</span>
                                        </label>
                                    </div>
                                `;
                            }
                            
                            return `
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">${col}</label>
                                    <input type="${inputType}" name="${col}" value="${value}" 
                                           class="w-full px-3 py-2 border rounded-lg text-sm">
                                </div>
                            `;
                        }).join('') || ''}
                    </div>
                    <div class="p-4 border-t flex gap-2">
                        <button type="button" onclick="closeModal()" class="flex-1 px-4 py-2 border rounded-lg hover:bg-gray-50">
                            Annuler
                        </button>
                        <button type="button" onclick="saveItem()" class="flex-1 px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-700">
                            ${isEditing ? 'Modifier' : 'Cr√©er'}
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
    
    function showCreateModal() {
        state.editingItem = null;
        render();
        document.getElementById('modal').classList.remove('hidden');
        document.getElementById('modal').classList.add('flex');
    }
    
    function editItem(id) {
        state.editingItem = id;
        render();
        document.getElementById('modal').classList.remove('hidden');
        document.getElementById('modal').classList.add('flex');
    }
    
    function closeModal() {
        state.editingItem = null;
        document.getElementById('modal').classList.add('hidden');
        document.getElementById('modal').classList.remove('flex');
    }
    
    async function saveItem() {
        const currentRef = REFERENTIELS.find(r => r.id === state.currentTab);
        const form = document.getElementById('modalForm');
        const inputs = form.querySelectorAll('input, select');
        
        const record = {};
        inputs.forEach(input => {
            const name = input.name;
            if (!name) return;
            
            if (input.type === 'checkbox') {
                record[name] = input.checked;
            } else if (input.type === 'number') {
                record[name] = input.value ? parseInt(input.value) : null;
            } else {
                record[name] = input.value || null;
            }
        });
        
        try {
            if (state.editingItem) {
                await grist.docApi.applyUserActions([
                    ['UpdateRecord', state.currentTab, state.editingItem, record]
                ]);
                showToast('√âl√©ment modifi√©', 'success');
            } else {
                await grist.docApi.applyUserActions([
                    ['AddRecord', state.currentTab, null, record]
                ]);
                showToast('√âl√©ment cr√©√©', 'success');
            }
            
            closeModal();
            await loadAllData();
        } catch (err) {
            showToast('Erreur: ' + err.message, 'error');
        }
    }
    
    async function deleteItem(id) {
        if (!confirm('Supprimer cet √©l√©ment ?')) return;
        
        try {
            await grist.docApi.applyUserActions([
                ['RemoveRecord', state.currentTab, id]
            ]);
            showToast('√âl√©ment supprim√©', 'success');
            await loadAllData();
        } catch (err) {
            showToast('Erreur: ' + err.message, 'error');
        }
    }
    
    // ============ TOAST ============
    function showToast(msg, type = 'info') {
        const colors = { info: 'bg-blue-500', success: 'bg-emerald-500', error: 'bg-red-500' };
        const toast = document.createElement('div');
        toast.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg text-white ${colors[type]} shadow-lg z-50 fade-in`;
        toast.textContent = msg;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }
    
    // ============ INIT ============
    grist.ready({ requiredAccess: 'full' });
    loadAllData();
    </script>
</body>
</html>