<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patrimoine - B√¢timents</title>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { box-sizing: border-box; }
        html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: system-ui, -apple-system, sans-serif; }
        .fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .slide-in { animation: slideIn 0.25s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
    </style>
</head>
<body class="bg-gray-50 h-full flex flex-col">
    <div id="app" class="h-full flex flex-col"></div>
    
    <script>
    // ============ CONFIGURATION ============
    const ICONS = {
        'Administratif': 'üèõÔ∏è', 'Technique': 'üîß', 'Culturel': 'üé≠', 'Sportif': '‚öΩ',
        'Scolaire': 'üéì', 'Social': 'ü§ù', 'Logement': 'üè†', 'Autre': 'üè¢'
    };
    
    const COLORS = {
        statut: { 'Actif': '#10b981', 'Projet': '#3b82f6', 'Travaux': '#f59e0b', 'Inactif': '#6b7280' },
        type: { 'Administratif': '#3b82f6', 'Technique': '#8b5cf6', 'Culturel': '#ec4899', 'Sportif': '#10b981', 'Scolaire': '#f59e0b', 'Social': '#06b6d4', 'Logement': '#f97316' }
    };
    
    // ============ APP CONTEXT ============
    // D√©tection du contexte : Artefactory ou Grist autonome
    const appContext = {
        isArtefactory: typeof window.app !== 'undefined' && window.app.navigate,
        app: window.app || {
            navigate: (path) => router.navigate(path),
            emit: (event, data) => eventBus.emit(event, data),
            on: (event, cb) => eventBus.on(event, cb),
            state: {}
        }
    };
    
    // ============ EVENT BUS (pour mode Grist autonome) ============
    const eventBus = {
        handlers: new Map(),
        emit(event, data) {
            (this.handlers.get(event) || []).forEach(cb => cb(data));
            // Aussi notifier Grist si pertinent
            if (event === 'batimentSelected' && data?.id) {
                grist.setSelectedRows([data.id]);
            }
        },
        on(event, cb) {
            if (!this.handlers.has(event)) this.handlers.set(event, []);
            this.handlers.get(event).push(cb);
        }
    };
    
    // ============ ROUTER INTERNE ============
    const router = {
        currentRoute: '/',
        currentParams: {},
        routes: {
            '/': 'renderDashboard',
            '/liste': 'renderListe',
            '/fiche': 'renderFiche',
            '/locaux': 'renderLocaux'
        },
        
        navigate(path, params = {}) {
            // Parser le path pour extraire l'ID si pr√©sent
            if (path.match(/^\/batiment\/(\d+)$/)) {
                const id = parseInt(path.match(/^\/batiment\/(\d+)$/)[1]);
                this.currentRoute = '/fiche';
                this.currentParams = { id };
            } else if (path.match(/^\/batiment\/(\d+)\/locaux$/)) {
                const id = parseInt(path.match(/^\/batiment\/(\d+)\/locaux$/)[1]);
                this.currentRoute = '/locaux';
                this.currentParams = { id };
            } else if (path === '/liste' || path === '/batiments/liste') {
                this.currentRoute = '/liste';
                this.currentParams = {};
            } else if (path === '/' || path === '/batiments') {
                this.currentRoute = '/';
                this.currentParams = {};
            } else {
                this.currentRoute = path;
                this.currentParams = params;
            }
            
            render();
        },
        
        goToBatiment(id) {
            this.currentParams = { id };
            this.currentRoute = '/fiche';
            render();
        },
        
        goToLocaux(id) {
            this.currentParams = { id };
            this.currentRoute = '/locaux';
            render();
        }
    };
    
    // ============ STATE ============
    let state = {
        loading: true,
        error: null,
        // Donn√©es
        batiments: [],
        locaux: [],
        services: [],
        interventions: [],
        // UI
        searchQuery: '',
        filterType: '',
        filterStatut: '',
        sortBy: 'Nom',
        // S√©lection
        selectedBatiment: null
    };
    
    // ============ DATA LOADING ============
    async function safeLoad(tableName) {
        try {
            const data = await grist.docApi.fetchTable(tableName);
            const n = data.id?.length || 0;
            const records = [];
            for (let i = 0; i < n; i++) {
                const record = { id: data.id[i] };
                Object.keys(data).forEach(key => {
                    if (key !== 'id') record[key] = data[key][i];
                });
                records.push(record);
            }
            return records;
        } catch (e) {
            console.warn(`Table ${tableName} non trouv√©e:`, e.message);
            return [];
        }
    }
    
    async function loadAllData() {
        state.loading = true;
        render();
        
        try {
            const [batiments, locaux, services, interventions] = await Promise.all([
                safeLoad('Batiments'),
                safeLoad('Locaux'),
                safeLoad('Services'),
                safeLoad('Interventions')
            ]);
            
            state.batiments = batiments;
            state.locaux = locaux;
            state.services = services;
            state.interventions = interventions;
            state.loading = false;
            state.error = null;
        } catch (e) {
            state.error = e.message;
            state.loading = false;
        }
        
        render();
    }
    
    // ============ COMPUTED ============
    function getFilteredBatiments() {
        let list = [...state.batiments];
        
        if (state.searchQuery) {
            const q = state.searchQuery.toLowerCase();
            list = list.filter(b => 
                (b.Nom || '').toLowerCase().includes(q) ||
                (b.Code || '').toLowerCase().includes(q)
            );
        }
        
        if (state.filterType) {
            list = list.filter(b => b.Type === state.filterType);
        }
        
        if (state.filterStatut) {
            list = list.filter(b => b.Statut === state.filterStatut);
        }
        
        list.sort((a, b) => {
            const va = a[state.sortBy] || '';
            const vb = b[state.sortBy] || '';
            return String(va).localeCompare(String(vb));
        });
        
        return list;
    }
    
    function getBatimentById(id) {
        return state.batiments.find(b => b.id === id);
    }
    
    function getLocauxForBatiment(batimentId) {
        return state.locaux.filter(l => l.Batiment === batimentId);
    }
    
    function getInterventionsForBatiment(batimentId) {
        return state.interventions.filter(i => i.Batiment === batimentId);
    }
    
    function getServiceName(serviceId) {
        const s = state.services.find(x => x.id === serviceId);
        return s?.Nom || '-';
    }
    
    function getStats() {
        const total = state.batiments.length;
        const actifs = state.batiments.filter(b => b.Statut === 'Actif').length;
        const surface = state.batiments.reduce((sum, b) => sum + (b.Surface_m2 || 0), 0);
        const interventionsEnCours = state.interventions.filter(i => 
            i.Statut && !['Termin√©e', 'Annul√©e'].includes(i.Statut)
        ).length;
        
        return { total, actifs, surface, interventionsEnCours };
    }
    
    // ============ RENDER FUNCTIONS ============
    function render() {
        const app = document.getElementById('app');
        
        if (state.loading) {
            app.innerHTML = renderLoading();
            return;
        }
        
        if (state.error) {
            app.innerHTML = renderError(state.error);
            return;
        }
        
        // Router vers la bonne vue
        switch (router.currentRoute) {
            case '/':
                app.innerHTML = renderDashboard();
                initDashboardCharts();
                break;
            case '/liste':
                app.innerHTML = renderListe();
                break;
            case '/fiche':
                app.innerHTML = renderFiche();
                break;
            case '/locaux':
                app.innerHTML = renderLocaux();
                break;
            default:
                app.innerHTML = renderDashboard();
                initDashboardCharts();
        }
    }
    
    function renderLoading() {
        return `
            <div class="flex-1 flex items-center justify-center">
                <div class="text-center">
                    <div class="animate-spin text-4xl mb-4">‚è≥</div>
                    <p class="text-gray-500">Chargement des donn√©es...</p>
                </div>
            </div>
        `;
    }
    
    function renderError(msg) {
        return `
            <div class="flex-1 flex items-center justify-center">
                <div class="text-center p-8 bg-red-50 rounded-xl max-w-md">
                    <div class="text-4xl mb-4">‚ö†Ô∏è</div>
                    <h2 class="text-lg font-semibold text-red-800 mb-2">Erreur</h2>
                    <p class="text-red-600">${msg}</p>
                    <button onclick="loadAllData()" class="mt-4 px-4 py-2 bg-red-600 text-white rounded-lg">
                        R√©essayer
                    </button>
                </div>
            </div>
        `;
    }
    
    // ============ HEADER NAVIGATION ============
    function renderHeader(title, showBack = false, backRoute = '/') {
        return `
            <header class="flex-none bg-white border-b px-4 py-3 flex items-center gap-3">
                ${showBack ? `
                    <button onclick="router.navigate('${backRoute}')" 
                            class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100 text-gray-600">
                        ‚Üê
                    </button>
                ` : ''}
                <h1 class="text-lg font-semibold text-gray-800 flex-1">${title}</h1>
                <nav class="flex gap-1">
                    <button onclick="router.navigate('/')" 
                            class="px-3 py-1.5 text-sm rounded-lg ${router.currentRoute === '/' ? 'bg-emerald-100 text-emerald-700' : 'hover:bg-gray-100 text-gray-600'}">
                        üìä Dashboard
                    </button>
                    <button onclick="router.navigate('/liste')" 
                            class="px-3 py-1.5 text-sm rounded-lg ${router.currentRoute === '/liste' ? 'bg-emerald-100 text-emerald-700' : 'hover:bg-gray-100 text-gray-600'}">
                        üìã Liste
                    </button>
                </nav>
            </header>
        `;
    }
    
    // ============ DASHBOARD VIEW ============
    function renderDashboard() {
        const stats = getStats();
        const recentBatiments = state.batiments.slice(0, 5);
        
        // Stats par type
        const byType = {};
        state.batiments.forEach(b => {
            const t = b.Type || 'Autre';
            byType[t] = (byType[t] || 0) + 1;
        });
        
        return `
            ${renderHeader('üè¢ Patrimoine B√¢timents')}
            
            <div class="flex-1 overflow-y-auto p-4 space-y-4 fade-in">
                <!-- KPIs -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="bg-white rounded-xl shadow-sm p-4 cursor-pointer hover:shadow-md transition-shadow"
                         onclick="router.navigate('/liste')">
                        <div class="text-2xl mb-1">üè¢</div>
                        <div class="text-3xl font-bold text-gray-800">${stats.total}</div>
                        <div class="text-sm text-gray-500">B√¢timents</div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-4">
                        <div class="text-2xl mb-1">‚úÖ</div>
                        <div class="text-3xl font-bold text-emerald-600">${stats.actifs}</div>
                        <div class="text-sm text-gray-500">Actifs</div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-4">
                        <div class="text-2xl mb-1">üìê</div>
                        <div class="text-3xl font-bold text-blue-600">${(stats.surface / 1000).toFixed(1)}k</div>
                        <div class="text-sm text-gray-500">m¬≤ totaux</div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-4">
                        <div class="text-2xl mb-1">üîß</div>
                        <div class="text-3xl font-bold text-orange-600">${stats.interventionsEnCours}</div>
                        <div class="text-sm text-gray-500">Interventions</div>
                    </div>
                </div>
                
                <!-- Graphiques -->
                <div class="grid lg:grid-cols-2 gap-4">
                    <div class="bg-white rounded-xl shadow-sm p-4">
                        <h3 class="font-semibold text-gray-800 mb-3">üìä R√©partition par type</h3>
                        <div class="h-48"><canvas id="chartTypes"></canvas></div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm p-4">
                        <h3 class="font-semibold text-gray-800 mb-3">üìà Par statut</h3>
                        <div class="h-48"><canvas id="chartStatuts"></canvas></div>
                    </div>
                </div>
                
                <!-- Liste r√©cente -->
                <div class="bg-white rounded-xl shadow-sm p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-semibold text-gray-800">üè¢ B√¢timents r√©cents</h3>
                        <button onclick="router.navigate('/liste')" 
                                class="text-sm text-emerald-600 hover:text-emerald-700">
                            Voir tout ‚Üí
                        </button>
                    </div>
                    <div class="space-y-2">
                        ${recentBatiments.map(b => `
                            <div class="flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors"
                                 onclick="router.goToBatiment(${b.id})">
                                <div class="w-10 h-10 rounded-lg bg-gray-100 flex items-center justify-center text-xl">
                                    ${ICONS[b.Type] || 'üè¢'}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="font-medium text-gray-800 truncate">${b.Nom || b.Code}</div>
                                    <div class="text-sm text-gray-500">${b.Type || '-'}</div>
                                </div>
                                <span class="px-2 py-1 text-xs rounded-full" 
                                      style="background: ${COLORS.statut[b.Statut] || '#6b7280'}20; color: ${COLORS.statut[b.Statut] || '#6b7280'}">
                                    ${b.Statut || '-'}
                                </span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
    }
    
    let chartTypes = null;
    let chartStatuts = null;
    
    function initDashboardCharts() {
        // Destroy existing charts
        if (chartTypes) { chartTypes.destroy(); chartTypes = null; }
        if (chartStatuts) { chartStatuts.destroy(); chartStatuts = null; }
        
        // Chart par type
        const byType = {};
        state.batiments.forEach(b => {
            const t = b.Type || 'Autre';
            byType[t] = (byType[t] || 0) + 1;
        });
        
        const ctx1 = document.getElementById('chartTypes')?.getContext('2d');
        if (ctx1) {
            chartTypes = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(byType),
                    datasets: [{
                        data: Object.values(byType),
                        backgroundColor: Object.keys(byType).map(t => COLORS.type[t] || '#6b7280')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { position: 'right', labels: { boxWidth: 12, font: { size: 11 } } } }
                }
            });
        }
        
        // Chart par statut
        const byStatut = {};
        state.batiments.forEach(b => {
            const s = b.Statut || 'Inconnu';
            byStatut[s] = (byStatut[s] || 0) + 1;
        });
        
        const ctx2 = document.getElementById('chartStatuts')?.getContext('2d');
        if (ctx2) {
            chartStatuts = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: Object.keys(byStatut),
                    datasets: [{
                        label: 'B√¢timents',
                        data: Object.values(byStatut),
                        backgroundColor: Object.keys(byStatut).map(s => COLORS.statut[s] || '#6b7280')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                }
            });
        }
    }
    
    // ============ LISTE VIEW ============
    function renderListe() {
        const filtered = getFilteredBatiments();
        const types = [...new Set(state.batiments.map(b => b.Type).filter(Boolean))];
        const statuts = [...new Set(state.batiments.map(b => b.Statut).filter(Boolean))];
        
        return `
            ${renderHeader('üè¢ Liste des B√¢timents')}
            
            <!-- Filtres -->
            <div class="flex-none bg-white border-b px-4 py-3">
                <div class="flex flex-wrap gap-3 items-center">
                    <div class="flex-1 min-w-[200px] max-w-md">
                        <input type="text" placeholder="üîç Rechercher..." 
                               value="${state.searchQuery}"
                               oninput="state.searchQuery = this.value; render()"
                               class="w-full px-3 py-2 border rounded-lg text-sm">
                    </div>
                    <select onchange="state.filterType = this.value; render()"
                            class="px-3 py-2 border rounded-lg text-sm">
                        <option value="">Tous types</option>
                        ${types.map(t => `<option value="${t}" ${state.filterType === t ? 'selected' : ''}>${ICONS[t] || ''} ${t}</option>`).join('')}
                    </select>
                    <select onchange="state.filterStatut = this.value; render()"
                            class="px-3 py-2 border rounded-lg text-sm">
                        <option value="">Tous statuts</option>
                        ${statuts.map(s => `<option value="${s}" ${state.filterStatut === s ? 'selected' : ''}>${s}</option>`).join('')}
                    </select>
                    <button onclick="showCreateModal()" 
                            class="px-4 py-2 bg-emerald-600 text-white rounded-lg text-sm font-medium hover:bg-emerald-700">
                        ‚ûï Nouveau
                    </button>
                </div>
            </div>
            
            <!-- Liste -->
            <div class="flex-1 overflow-y-auto p-4">
                <div class="grid gap-3 fade-in">
                    ${filtered.length === 0 ? `
                        <div class="text-center py-12 text-gray-500">
                            <div class="text-4xl mb-2">üîç</div>
                            <p>Aucun b√¢timent trouv√©</p>
                        </div>
                    ` : filtered.map(b => renderBatimentCard(b)).join('')}
                </div>
            </div>
            
            <!-- Modal cr√©ation -->
            ${renderCreateModal()}
        `;
    }
    
    function renderBatimentCard(b) {
        const icon = ICONS[b.Type] || 'üè¢';
        const locaux = getLocauxForBatiment(b.id);
        const interventions = getInterventionsForBatiment(b.id);
        
        return `
            <div class="bg-white rounded-xl shadow-sm p-4 hover:shadow-md transition-all cursor-pointer border-l-4"
                 style="border-left-color: ${COLORS.type[b.Type] || '#6b7280'}"
                 onclick="router.goToBatiment(${b.id})">
                <div class="flex items-start gap-4">
                    <div class="w-12 h-12 rounded-lg bg-gray-100 flex items-center justify-center text-2xl flex-shrink-0">
                        ${icon}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-start justify-between gap-2">
                            <div>
                                <div class="font-semibold text-gray-800">${b.Nom || b.Code}</div>
                                <div class="text-sm text-gray-500">${b.Code}</div>
                            </div>
                            <span class="px-2 py-1 text-xs rounded-full flex-shrink-0"
                                  style="background: ${COLORS.statut[b.Statut] || '#6b7280'}20; color: ${COLORS.statut[b.Statut] || '#6b7280'}">
                                ${b.Statut || '-'}
                            </span>
                        </div>
                        <div class="flex flex-wrap gap-4 mt-2 text-sm text-gray-600">
                            <span>üìê ${b.Surface_m2 ? b.Surface_m2.toLocaleString() + ' m¬≤' : '-'}</span>
                            <span>üö™ ${locaux.length} locaux</span>
                            <span>üîß ${interventions.length} interventions</span>
                        </div>
                    </div>
                    <div class="text-gray-400">‚Üí</div>
                </div>
            </div>
        `;
    }
    
    // ============ FICHE VIEW ============
    function renderFiche() {
        const id = router.currentParams.id;
        const b = getBatimentById(id);
        
        if (!b) {
            return `
                ${renderHeader('B√¢timent non trouv√©', true, '/liste')}
                <div class="flex-1 flex items-center justify-center">
                    <div class="text-center">
                        <div class="text-4xl mb-2">‚ùì</div>
                        <p class="text-gray-500">Ce b√¢timent n'existe pas</p>
                        <button onclick="router.navigate('/liste')" class="mt-4 px-4 py-2 bg-emerald-600 text-white rounded-lg">
                            Retour √† la liste
                        </button>
                    </div>
                </div>
            `;
        }
        
        const locaux = getLocauxForBatiment(id);
        const interventions = getInterventionsForBatiment(id);
        const icon = ICONS[b.Type] || 'üè¢';
        
        return `
            ${renderHeader(b.Nom || b.Code, true, '/liste')}
            
            <div class="flex-1 overflow-y-auto p-4 space-y-4 slide-in">
                <!-- En-t√™te -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex items-start gap-4">
                        <div class="w-16 h-16 rounded-xl flex items-center justify-center text-3xl"
                             style="background: ${COLORS.type[b.Type] || '#6b7280'}20">
                            ${icon}
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <h2 class="text-2xl font-bold text-gray-800">${b.Nom || 'Sans nom'}</h2>
                                <span class="px-3 py-1 text-sm rounded-full"
                                      style="background: ${COLORS.statut[b.Statut] || '#6b7280'}20; color: ${COLORS.statut[b.Statut] || '#6b7280'}">
                                    ${b.Statut || '-'}
                                </span>
                            </div>
                            <div class="text-gray-500">${b.Code} ‚Ä¢ ${b.Type || '-'}</div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="router.goToLocaux(${b.id})" 
                                    class="px-4 py-2 bg-blue-50 text-blue-600 rounded-lg text-sm font-medium hover:bg-blue-100">
                                üö™ Locaux (${locaux.length})
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Infos -->
                <div class="grid lg:grid-cols-2 gap-4">
                    <div class="bg-white rounded-xl shadow-sm p-4">
                        <h3 class="font-semibold text-gray-800 mb-3">üìã Informations</h3>
                        <dl class="space-y-2 text-sm">
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <dt class="text-gray-500">Surface</dt>
                                <dd class="font-medium">${b.Surface_m2 ? b.Surface_m2.toLocaleString() + ' m¬≤' : '-'}</dd>
                            </div>
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <dt class="text-gray-500">Ann√©e construction</dt>
                                <dd class="font-medium">${b.Annee_construction || '-'}</dd>
                            </div>
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <dt class="text-gray-500">Service gestionnaire</dt>
                                <dd class="font-medium">${getServiceName(b.Service_gestionnaire)}</dd>
                            </div>
                            <div class="flex justify-between py-2">
                                <dt class="text-gray-500">√âtages</dt>
                                <dd class="font-medium">${b.Nb_etages || '-'}</dd>
                            </div>
                        </dl>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm p-4">
                        <h3 class="font-semibold text-gray-800 mb-3">üìä Statistiques</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="text-center p-4 bg-blue-50 rounded-lg">
                                <div class="text-2xl font-bold text-blue-600">${locaux.length}</div>
                                <div class="text-sm text-gray-600">Locaux</div>
                            </div>
                            <div class="text-center p-4 bg-orange-50 rounded-lg">
                                <div class="text-2xl font-bold text-orange-600">${interventions.length}</div>
                                <div class="text-sm text-gray-600">Interventions</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Interventions r√©centes -->
                <div class="bg-white rounded-xl shadow-sm p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-semibold text-gray-800">üîß Interventions</h3>
                        <button onclick="appContext.app.emit('createIntervention', {batimentId: ${b.id}})"
                                class="text-sm text-emerald-600 hover:text-emerald-700">
                            ‚ûï Nouvelle
                        </button>
                    </div>
                    ${interventions.length === 0 ? `
                        <p class="text-gray-400 text-sm py-4 text-center">Aucune intervention</p>
                    ` : `
                        <div class="space-y-2">
                            ${interventions.slice(0, 5).map(i => `
                                <div class="flex items-center gap-3 p-3 rounded-lg bg-gray-50">
                                    <span class="text-lg">${getUrgenceIcon(i.Urgence)}</span>
                                    <div class="flex-1 min-w-0">
                                        <div class="font-medium text-gray-800 truncate">${i.Objet || i.Code}</div>
                                        <div class="text-sm text-gray-500">${i.Statut || '-'}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>
            </div>
        `;
    }
    
    function getUrgenceIcon(urgence) {
        const icons = { 'Critique': 'üî¥', 'Haute': 'üü†', 'Normale': 'üü°', 'Basse': 'üü¢' };
        return icons[urgence] || '‚ö™';
    }
    
    // ============ LOCAUX VIEW ============
    function renderLocaux() {
        const id = router.currentParams.id;
        const b = getBatimentById(id);
        const locaux = getLocauxForBatiment(id);
        
        if (!b) {
            return `
                ${renderHeader('B√¢timent non trouv√©', true, '/liste')}
                <div class="flex-1 flex items-center justify-center text-gray-500">
                    Ce b√¢timent n'existe pas
                </div>
            `;
        }
        
        // Grouper par √©tage
        const byEtage = {};
        locaux.forEach(l => {
            const etage = l.Etage || 'Non d√©fini';
            if (!byEtage[etage]) byEtage[etage] = [];
            byEtage[etage].push(l);
        });
        
        const etages = Object.keys(byEtage).sort((a, b) => {
            if (a === 'Non d√©fini') return 1;
            if (b === 'Non d√©fini') return -1;
            return a.localeCompare(b, undefined, { numeric: true });
        });
        
        return `
            <header class="flex-none bg-white border-b px-4 py-3 flex items-center gap-3">
                <button onclick="router.goToBatiment(${id})" 
                        class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100 text-gray-600">
                    ‚Üê
                </button>
                <div class="flex-1">
                    <h1 class="text-lg font-semibold text-gray-800">üö™ Locaux</h1>
                    <div class="text-sm text-gray-500">${b.Nom || b.Code}</div>
                </div>
                <button onclick="showLocalModal(${id})" 
                        class="px-4 py-2 bg-emerald-600 text-white rounded-lg text-sm font-medium hover:bg-emerald-700">
                    ‚ûï Nouveau local
                </button>
            </header>
            
            <div class="flex-1 overflow-y-auto p-4 space-y-4 slide-in">
                ${locaux.length === 0 ? `
                    <div class="text-center py-12">
                        <div class="text-4xl mb-2">üö™</div>
                        <p class="text-gray-500 mb-4">Aucun local enregistr√©</p>
                        <button onclick="showLocalModal(${id})" 
                                class="px-4 py-2 bg-emerald-600 text-white rounded-lg">
                            Ajouter un local
                        </button>
                    </div>
                ` : etages.map(etage => `
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <div class="px-4 py-3 bg-gray-50 border-b font-semibold text-gray-700">
                            üìç ${etage}
                            <span class="text-sm font-normal text-gray-500 ml-2">(${byEtage[etage].length} locaux)</span>
                        </div>
                        <div class="divide-y">
                            ${byEtage[etage].map(l => `
                                <div class="p-4 hover:bg-gray-50 transition-colors">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-lg bg-blue-50 flex items-center justify-center text-xl">
                                            ${getLocalIcon(l.Type_local)}
                                        </div>
                                        <div class="flex-1">
                                            <div class="font-medium text-gray-800">${l.Nom || l.Code || 'Sans nom'}</div>
                                            <div class="text-sm text-gray-500">
                                                ${l.Type_local || '-'} 
                                                ${l.Surface_m2 ? `‚Ä¢ ${l.Surface_m2} m¬≤` : ''}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
            </div>
            
            ${renderLocalModal()}
        `;
    }
    
    function getLocalIcon(type) {
        const icons = {
            'Bureau': 'üíº', 'Salle de r√©union': 'üë•', 'Stockage': 'üì¶',
            'Technique': '‚öôÔ∏è', 'Sanitaires': 'üöª', 'Circulation': 'üö∂',
            'Accueil': 'üè¢', 'Archives': 'üìö'
        };
        return icons[type] || 'üö™';
    }
    
    // ============ MODALS ============
    function renderCreateModal() {
        return `
            <div id="createModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="p-4 border-b sticky top-0 bg-white flex items-center justify-between">
                        <h2 class="text-lg font-semibold">üè¢ Nouveau b√¢timent</h2>
                        <button onclick="closeCreateModal()" class="text-gray-400 hover:text-gray-600">‚úï</button>
                    </div>
                    <div class="p-4 space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Code *</label>
                                <input type="text" id="newCode" class="w-full px-3 py-2 border rounded-lg" placeholder="PAT-XXX">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Nom *</label>
                                <input type="text" id="newNom" class="w-full px-3 py-2 border rounded-lg">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Type</label>
                                <select id="newType" class="w-full px-3 py-2 border rounded-lg">
                                    ${Object.keys(ICONS).map(t => `<option value="${t}">${ICONS[t]} ${t}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Statut</label>
                                <select id="newStatut" class="w-full px-3 py-2 border rounded-lg">
                                    <option value="Actif">Actif</option>
                                    <option value="Projet">Projet</option>
                                    <option value="Travaux">Travaux</option>
                                    <option value="Inactif">Inactif</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Surface (m¬≤)</label>
                                <input type="number" id="newSurface" class="w-full px-3 py-2 border rounded-lg" min="0">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Ann√©e construction</label>
                                <input type="number" id="newAnnee" class="w-full px-3 py-2 border rounded-lg" min="1800" max="2030">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Service gestionnaire</label>
                            <select id="newService" class="w-full px-3 py-2 border rounded-lg">
                                <option value="">-- Aucun --</option>
                                ${state.services.map(s => `<option value="${s.id}">${s.Nom}</option>`).join('')}
                            </select>
                        </div>
                        <div class="flex gap-2 pt-4 border-t">
                            <button type="button" onclick="closeCreateModal()" class="flex-1 px-4 py-2 border rounded-lg hover:bg-gray-50">
                                Annuler
                            </button>
                            <button type="button" onclick="createBatiment()" class="flex-1 px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">
                                Cr√©er
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    function renderLocalModal() {
        return `
            <div id="localModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4">
                    <div class="p-4 border-b flex items-center justify-between">
                        <h2 class="text-lg font-semibold">üö™ Nouveau local</h2>
                        <button onclick="closeLocalModal()" class="text-gray-400 hover:text-gray-600">‚úï</button>
                    </div>
                    <div class="p-4 space-y-4">
                        <input type="hidden" id="localBatimentId">
                        <div>
                            <label class="block text-sm font-medium mb-1">Nom / Num√©ro *</label>
                            <input type="text" id="localNom" class="w-full px-3 py-2 border rounded-lg" placeholder="Bureau 101">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">√âtage</label>
                                <input type="text" id="localEtage" class="w-full px-3 py-2 border rounded-lg" placeholder="RDC, 1er, SS1...">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Surface (m¬≤)</label>
                                <input type="number" id="localSurface" class="w-full px-3 py-2 border rounded-lg" min="0">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Type</label>
                            <select id="localType" class="w-full px-3 py-2 border rounded-lg">
                                <option value="">-- S√©lectionner --</option>
                                <option value="Bureau">üíº Bureau</option>
                                <option value="Salle de r√©union">üë• Salle de r√©union</option>
                                <option value="Stockage">üì¶ Stockage</option>
                                <option value="Technique">‚öôÔ∏è Technique</option>
                                <option value="Sanitaires">üöª Sanitaires</option>
                                <option value="Circulation">üö∂ Circulation</option>
                                <option value="Accueil">üè¢ Accueil</option>
                                <option value="Archives">üìö Archives</option>
                            </select>
                        </div>
                        <div class="flex gap-2 pt-4 border-t">
                            <button type="button" onclick="closeLocalModal()" class="flex-1 px-4 py-2 border rounded-lg hover:bg-gray-50">
                                Annuler
                            </button>
                            <button type="button" onclick="createLocal()" class="flex-1 px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">
                                Cr√©er
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // ============ MODAL ACTIONS ============
    function showCreateModal() {
        document.getElementById('createModal').classList.remove('hidden');
        document.getElementById('createModal').classList.add('flex');
    }
    
    function closeCreateModal() {
        document.getElementById('createModal').classList.add('hidden');
        document.getElementById('createModal').classList.remove('flex');
    }
    
    function showLocalModal(batimentId) {
        document.getElementById('localBatimentId').value = batimentId;
        document.getElementById('localModal').classList.remove('hidden');
        document.getElementById('localModal').classList.add('flex');
    }
    
    function closeLocalModal() {
        document.getElementById('localModal').classList.add('hidden');
        document.getElementById('localModal').classList.remove('flex');
    }
    
    async function createBatiment() {
        const code = document.getElementById('newCode').value.trim();
        const nom = document.getElementById('newNom').value.trim();
        
        if (!code || !nom) {
            showToast('Veuillez remplir le code et le nom', 'error');
            return;
        }
        
        const data = {
            Code: code,
            Nom: nom,
            Type: document.getElementById('newType').value,
            Statut: document.getElementById('newStatut').value,
            Surface_m2: parseFloat(document.getElementById('newSurface').value) || null,
            Annee_construction: parseInt(document.getElementById('newAnnee').value) || null,
            Service_gestionnaire: parseInt(document.getElementById('newService').value) || null
        };
        
        try {
            await grist.docApi.applyUserActions([['AddRecord', 'Batiments', null, data]]);
            closeCreateModal();
            showToast(`${code} cr√©√© avec succ√®s !`, 'success');
            await loadAllData();
        } catch (err) {
            showToast('Erreur: ' + err.message, 'error');
        }
    }
    
    async function createLocal() {
        const batimentId = parseInt(document.getElementById('localBatimentId').value);
        const nom = document.getElementById('localNom').value.trim();
        
        if (!nom) {
            showToast('Veuillez saisir un nom', 'error');
            return;
        }
        
        const data = {
            Nom: nom,
            Batiment: batimentId,
            Etage: document.getElementById('localEtage').value.trim() || null,
            Surface_m2: parseFloat(document.getElementById('localSurface').value) || null,
            Type_local: document.getElementById('localType').value || null
        };
        
        try {
            await grist.docApi.applyUserActions([['AddRecord', 'Locaux', null, data]]);
            closeLocalModal();
            showToast('Local cr√©√© avec succ√®s !', 'success');
            await loadAllData();
        } catch (err) {
            showToast('Erreur: ' + err.message, 'error');
        }
    }
    
    // ============ TOAST ============
    function showToast(msg, type = 'info') {
        const colors = { info: 'bg-blue-500', success: 'bg-emerald-500', error: 'bg-red-500' };
        const toast = document.createElement('div');
        toast.className = `fixed bottom-4 right-4 px-4 py-3 rounded-lg text-white ${colors[type]} shadow-lg z-50 fade-in`;
        toast.textContent = msg;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }
    
    // ============ INIT ============
    grist.ready({ requiredAccess: 'full' });
    
    // √âcouter les s√©lections Grist (pour le mode widget li√©)
    grist.onRecord((record) => {
        if (record && record.id) {
            router.goToBatiment(record.id);
        }
    });
    
    // √âcouter les √©v√©nements de l'app (mode Artefactory)
    if (appContext.isArtefactory) {
        appContext.app.on('navigateToBatiment', (data) => {
            if (data?.id) router.goToBatiment(data.id);
        });
    }
    
    // Charger les donn√©es
    loadAllData();
    </script>
</body>
</html>