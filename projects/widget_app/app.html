<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Artefactory AI v12 - Apps Composables</title>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.6/ace.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.6/mode-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.6/mode-jsx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.6/mode-html.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.6/mode-json.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.6/mode-svg.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.6/mode-markdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.6/theme-one_dark.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.6/ext-language_tools.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --bg: #ffffff;
            --bg2: #f8fafc;
            --bg3: #f1f5f9;
            --border: #e2e8f0;
            --text: #0f172a;
            --text2: #64748b;
            --accent: #3b82f6;
            --accent2: #2563eb;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --code-bg: #282c34;
            --ai-gradient: linear-gradient(135deg, #3e5de7 0%, #6366f1 100%);
            --ai-bg: #f5f3ff;
            --ai-border: #c4b5fd;
            --doc-bg: #fef3c7;
            --doc-border: #fbbf24;
            --doc-text: #92400e;
            --app-gradient: linear-gradient(135deg, #059669 0%, #10b981 100%);
            --app-bg: #ecfdf5;
            --app-border: #6ee7b7;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg2); min-height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* ============ MODE SWITCH ============ */
        .mode-bar { background: var(--bg); border-bottom: 1px solid var(--border); padding: 6px 12px; display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
        .mode-bar.hidden { display: none; }
        .mode-switch { display: flex; border: 2px solid var(--border); border-radius: 8px; overflow: hidden; }
        .mode-btn { padding: 8px 16px; border: none; background: var(--bg); cursor: pointer; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 6px; transition: all 0.2s; }
        .mode-btn:hover { background: var(--bg2); }
        .mode-btn.active { background: var(--accent); color: #fff; }
        .mode-btn.edit-mode.active { background: var(--warning); }
        .mode-btn.run-mode.active { background: var(--success); }
        .mode-btn + .mode-btn { border-left: 2px solid var(--border); }
        
        .app-selector { display: flex; align-items: center; gap: 8px; margin-left: 12px; padding-left: 12px; border-left: 1px solid var(--border); }
        .app-selector label { font-size: 11px; color: var(--text2); }
        .app-select { padding: 6px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 12px; min-width: 200px; }
        .app-badge { padding: 4px 10px; background: var(--app-gradient); color: #fff; border-radius: 12px; font-size: 10px; font-weight: 600; }
        
        .mode-info { margin-left: auto; font-size: 11px; color: var(--text2); display: flex; align-items: center; gap: 8px; }
        .mode-indicator { width: 8px; height: 8px; border-radius: 50%; }
        .mode-indicator.edit { background: var(--warning); }
        .mode-indicator.run { background: var(--success); }
        
        /* ============ FACTORY MODE (Edit) ============ */
        .factory-container { flex: 1; display: none; flex-direction: column; overflow: hidden; }
        .factory-container.active { display: flex; }
        
        /* Header */
        .header { background: var(--bg); border-bottom: 1px solid var(--border); padding: 8px 12px; display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
        .header-icon { width: 32px; height: 32px; border-radius: 8px; background: var(--ai-gradient); display: flex; align-items: center; justify-content: center; color: #fff; font-size: 16px; }
        .header-info { flex: 1; min-width: 0; }
        .header-title { font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .header-sub { font-size: 10px; color: var(--text2); }
        .art-select { padding: 6px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 12px; min-width: 180px; max-width: 280px; }
        .art-count { padding: 3px 8px; background: var(--bg2); border-radius: 12px; font-size: 11px; color: var(--text2); }
        
        .type-badge { padding: 3px 8px; border-radius: 12px; font-size: 10px; font-weight: 600; text-transform: uppercase; }
        .type-react { background: #dbeafe; color: #1e40af; }
        .type-html { background: #fef3c7; color: #92400e; }
        .type-svg { background: #d1fae5; color: #065f46; }
        .type-mermaid { background: #ede9fe; color: #5b21b6; }
        .type-markdown { background: #fce7f3; color: #9d174d; }
        .type-grist { background: #e0f2f1; color: #00695c; }
        .type-app { background: var(--app-bg); color: #065f46; border: 1px solid var(--app-border); }
        .type-component { background: #fef3c7; color: #92400e; }
        
        /* Toolbar */
        .toolbar { background: var(--bg); border-bottom: 1px solid var(--border); padding: 6px 12px; display: flex; gap: 4px; flex-wrap: wrap; align-items: center; flex-shrink: 0; }
        .btn { padding: 5px 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); font-size: 11px; cursor: pointer; display: inline-flex; align-items: center; gap: 4px; transition: all .15s; white-space: nowrap; }
        .btn:hover { background: var(--bg2); border-color: #cbd5e1; }
        .btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
        .btn.primary { background: var(--accent); color: #fff; border-color: var(--accent); }
        .btn.success { background: var(--success); color: #fff; border-color: var(--success); }
        .btn.ai-btn { background: var(--ai-gradient); color: #fff; border: none; font-weight: 600; }
        .btn.app-btn { background: var(--app-gradient); color: #fff; border: none; font-weight: 600; }
        .btn-add { background: var(--ai-gradient); color: #fff; border: none; font-weight: 600; }
        .toolbar-sep { width: 1px; height: 20px; background: var(--border); margin: 0 4px; }
        .toolbar-spacer { flex: 1; }
        
        .device-group { display: flex; border: 1px solid var(--border); border-radius: 6px; overflow: hidden; }
        .device-btn { padding: 5px 8px; border: none; background: var(--bg); cursor: pointer; font-size: 11px; }
        .device-btn:hover { background: var(--bg2); }
        .device-btn.active { background: var(--accent); color: #fff; }
        .device-btn + .device-btn { border-left: 1px solid var(--border); }
        
        /* Main layout */
        .main { flex: 1; display: flex; overflow: hidden; min-height: 0; }
        .main-left { flex: 1; display: flex; flex-direction: column; overflow: hidden; padding: 8px; gap: 8px; min-width: 0; }
        .main-right { width: 0; overflow: hidden; transition: width 0.3s ease; background: var(--bg2); min-height: 0; position: relative; }
        .main-right.visible { width: 420px; min-width: 360px; }
        
        /* Panels */
        .panels { flex: 1; display: flex; flex-direction: column; gap: 8px; min-height: 0; }
        .panels.split-h { flex-direction: row; }
        
        /* Render zone */
        .render-zone { flex: 1; background: var(--bg); border-radius: 8px; border: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; min-height: 0; }
        .render-bar { padding: 5px 10px; background: var(--bg2); border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--text2); flex-shrink: 0; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--success); }
        .status-dot.error { background: var(--error); }
        .status-dot.loading { background: var(--warning); animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .render-content { flex: 1; position: relative; background: repeating-conic-gradient(var(--bg3) 0% 25%, transparent 0% 50%) 50% / 16px 16px; overflow: hidden; }
        .render-content.no-pattern { background: var(--bg); }
        
        .device-frame { background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,.1); position: absolute; top: 0; left: 0; right: 0; bottom: 0; overflow: hidden; }
        .device-frame.desktop { border-radius: 0; box-shadow: none; }
        .render-iframe { width: 100%; height: 100%; border: none; display: block; }
        
        /* Code zone */
        .code-zone { display: none; flex-direction: column; background: var(--code-bg); border-radius: 8px; overflow: hidden; min-height: 0; }
        .code-zone.visible { display: flex; flex: 1; }
        .code-bar { padding: 6px 12px; background: #21252b; display: flex; align-items: center; gap: 10px; font-size: 11px; color: #636d83; flex-shrink: 0; }
        .code-bar-left { display: flex; align-items: center; gap: 10px; }
        .code-bar-right { margin-left: auto; display: flex; align-items: center; gap: 8px; }
        .code-content { flex: 1; overflow: hidden; position: relative; display: flex; flex-direction: column; }
        #aceEditor { flex: 1; width: 100%; min-height: 0; }
        
        .splitter { flex-shrink: 0; background: var(--border); transition: background .15s; }
        .splitter:hover { background: var(--accent); }
        .splitter-h { width: 6px; cursor: col-resize; margin: 0 -2px; position: relative; z-index: 10; }
        
        /* Console */
        .console-zone { display: none; background: #1a1a2e; border-radius: 8px; overflow: hidden; flex-shrink: 0; }
        .console-zone.visible { display: flex; flex-direction: column; height: 140px; }
        .console-bar { padding: 5px 10px; background: #16213e; display: flex; justify-content: space-between; font-size: 11px; color: #a0aec0; }
        .console-content { flex: 1; overflow-y: auto; padding: 6px 10px; font-family: monospace; font-size: 11px; }
        .console-line { padding: 2px 0; border-bottom: 1px solid #2d3748; }
        .console-line.log { color: #e2e8f0; }
        .console-line.warn { color: #f6e05e; }
        .console-line.error { color: #fc8181; }
        
        /* ============ APP RUNTIME MODE ============ */
        .runtime-container { flex: 1; display: none; flex-direction: column; overflow: hidden; }
        .runtime-container.active { display: flex; }
        
        .runtime-main { flex: 1; display: flex; overflow: hidden; }
        
        /* Sidebar navigation */
        .runtime-sidebar { width: 220px; background: var(--bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; }
        .runtime-sidebar.collapsed { width: 56px; }
        .sidebar-header { padding: 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; }
        .sidebar-logo { width: 32px; height: 32px; border-radius: 8px; background: var(--app-gradient); display: flex; align-items: center; justify-content: center; color: #fff; font-size: 16px; flex-shrink: 0; }
        .sidebar-title { font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; }
        .runtime-sidebar.collapsed .sidebar-title { display: none; }
        
        .sidebar-nav { flex: 1; overflow-y: auto; padding: 8px; }
        .nav-item { padding: 10px 12px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 13px; color: var(--text); transition: all 0.15s; margin-bottom: 4px; }
        .nav-item:hover { background: var(--bg2); }
        .nav-item.active { background: var(--accent); color: #fff; }
        .nav-item-icon { font-size: 18px; flex-shrink: 0; }
        .nav-item-label { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .runtime-sidebar.collapsed .nav-item-label { display: none; }
        
        .sidebar-footer { padding: 12px; border-top: 1px solid var(--border); }
        .sidebar-toggle { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); cursor: pointer; font-size: 11px; }
        
        /* Content area */
        .runtime-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: var(--bg2); }
        .runtime-toolbar { padding: 8px 16px; background: var(--bg); border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
        .runtime-breadcrumb { font-size: 12px; color: var(--text2); display: flex; align-items: center; gap: 6px; }
        .runtime-breadcrumb span { color: var(--text); font-weight: 500; }
        
        .runtime-frame { flex: 1; overflow: hidden; position: relative; }
        .runtime-iframe { width: 100%; height: 100%; border: none; background: #fff; }
        
        /* Embedded artefacts */
        .embedded-container { display: flex; flex-wrap: wrap; gap: 16px; padding: 16px; overflow: auto; }
        .embedded-card { background: #fff; border-radius: 12px; border: 1px solid var(--border); overflow: hidden; flex: 1; min-width: 300px; max-width: 600px; }
        .embedded-header { padding: 12px 16px; background: var(--bg2); border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 8px; }
        .embedded-title { font-size: 13px; font-weight: 600; }
        .embedded-frame { height: 300px; }
        .embedded-iframe { width: 100%; height: 100%; border: none; }
        
        /* ============ AI PANEL ============ */
        .ai-panel { position: absolute; top: 8px; right: 8px; bottom: 8px; left: 8px; display: flex; flex-direction: column; overflow: hidden; background: var(--bg); border-radius: 8px; border: 1px solid var(--border); }
        .ai-header { padding: 12px 16px; background: var(--ai-gradient); color: #fff; display: flex; align-items: center; gap: 10px; flex-shrink: 0; border-radius: 7px 7px 0 0; }
        .ai-header h3 { font-size: 14px; font-weight: 600; flex: 1; }
        .ai-close { background: rgba(255,255,255,0.2); border: none; color: #fff; width: 28px; height: 28px; border-radius: 6px; cursor: pointer; font-size: 14px; }
        
        .ai-config { padding: 12px 16px; background: var(--ai-bg); border-bottom: 1px solid var(--ai-border); flex-shrink: 0; }
        .ai-config-row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
        .ai-config-row:last-child { margin-bottom: 0; }
        .ai-config label { font-size: 11px; color: var(--text2); min-width: 80px; }
        .ai-config input, .ai-config select { flex: 1; padding: 6px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 11px; }
        
        /* Dependencies section */
        .ai-deps { padding: 12px 16px; background: var(--app-bg); border-bottom: 1px solid var(--app-border); flex-shrink: 0; }
        .ai-deps-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        .ai-deps-title { font-size: 12px; font-weight: 600; color: #065f46; display: flex; align-items: center; gap: 6px; }
        .ai-deps-list { display: flex; flex-wrap: wrap; gap: 6px; }
        .dep-chip { padding: 4px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 16px; font-size: 10px; cursor: pointer; display: flex; align-items: center; gap: 4px; }
        .dep-chip:hover { border-color: var(--accent); }
        .dep-chip.selected { background: var(--accent); color: #fff; border-color: var(--accent); }
        .dep-chip .dep-type { opacity: 0.7; }
        
        /* Documentation section */
        .ai-docs { padding: 12px 16px; background: var(--doc-bg); border-bottom: 1px solid var(--doc-border); flex-shrink: 0; }
        .ai-docs-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; cursor: pointer; }
        .ai-docs-title { font-size: 12px; font-weight: 600; color: var(--doc-text); display: flex; align-items: center; gap: 6px; }
        .ai-docs-count { padding: 2px 8px; background: var(--doc-text); color: #fff; border-radius: 10px; font-size: 10px; }
        .ai-docs-toggle { font-size: 10px; color: var(--doc-text); }
        .ai-docs-content { display: flex; flex-direction: column; gap: 8px; }
        .ai-docs-content.collapsed { display: none; }
        .ai-docs-suggested { margin-bottom: 4px; }
        .ai-docs-suggested-label { font-size: 10px; color: var(--doc-text); opacity: 0.8; margin-bottom: 4px; }
        .ai-docs-list { display: flex; flex-wrap: wrap; gap: 6px; }
        .ai-docs-other { border-top: 1px dashed var(--doc-border); padding-top: 8px; margin-top: 4px; }
        .ai-docs-other-label { font-size: 10px; color: var(--doc-text); opacity: 0.7; margin-bottom: 4px; }
        .doc-chip { padding: 4px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 16px; font-size: 10px; cursor: pointer; display: flex; align-items: center; gap: 4px; transition: all 0.15s; }
        .doc-chip:hover { border-color: var(--warning); background: #fffbeb; }
        .doc-chip.selected { background: var(--warning); color: #fff; border-color: var(--warning); }
        .doc-chip.suggested { border-color: var(--warning); background: #fef3c7; }
        .doc-chip.suggested.selected { background: var(--warning); color: #fff; }
        
        .ai-conversation { flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 12px; }
        .ai-message { max-width: 95%; padding: 10px 14px; border-radius: 12px; font-size: 12px; line-height: 1.5; }
        .ai-message.user { align-self: flex-end; background: var(--accent); color: #fff; }
        .ai-message.assistant { align-self: flex-start; background: var(--bg3); color: var(--text); }
        .ai-message.system { align-self: center; background: #fef3c7; color: #92400e; font-size: 11px; text-align: center; }
        .ai-message.error { align-self: center; background: #fee2e2; color: #991b1b; font-size: 11px; }
        
        .ai-status { padding: 8px 16px; background: var(--bg2); border-top: 1px solid var(--border); font-size: 10px; color: var(--text2); display: flex; align-items: center; gap: 8px; }
        .ai-status-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--success); }
        .ai-status-dot.loading { background: var(--warning); animation: pulse 1s infinite; }
        
        .ai-input-area { padding: 12px; background: var(--bg); border-top: 1px solid var(--border); flex-shrink: 0; }
        .ai-context-info { font-size: 10px; color: var(--text2); margin-bottom: 8px; padding: 6px 10px; background: var(--bg2); border-radius: 6px; display: flex; flex-wrap: wrap; gap: 6px; }
        .ai-context-tag { padding: 2px 6px; background: var(--accent); color: #fff; border-radius: 4px; font-size: 9px; }
        .ai-context-tag.app { background: var(--success); }
        .ai-input-row { display: flex; gap: 8px; }
        .ai-textarea { flex: 1; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 12px; resize: none; min-height: 60px; font-family: inherit; }
        .ai-send { padding: 8px 16px; background: var(--ai-gradient); color: #fff; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; }
        .ai-screenshot { padding: 8px 12px; background: var(--bg2); border: 1px solid var(--border); border-radius: 8px; font-size: 12px; cursor: pointer; transition: all 0.15s; }
        .ai-screenshot:hover { background: var(--bg3); border-color: #cbd5e1; }
        .ai-screenshot.active { background: var(--success); color: #fff; border-color: var(--success); }
        .ai-screenshot.capturing { animation: pulse 0.5s infinite; }
        
        /* ============ GRAPH VIEW ============ */
        .graph-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 100; }
        .graph-overlay.visible { display: flex; }
        .graph-container { background: var(--bg); border-radius: 16px; width: 90%; max-width: 1000px; height: 80%; display: flex; flex-direction: column; overflow: hidden; }
        .graph-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .graph-title { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .graph-close { width: 32px; height: 32px; border: none; background: var(--bg2); border-radius: 8px; cursor: pointer; font-size: 16px; }
        .graph-content { flex: 1; position: relative; overflow: hidden; }
        .graph-canvas { width: 100%; height: 100%; }
        .graph-legend { position: absolute; bottom: 16px; left: 16px; background: rgba(255,255,255,0.95); padding: 12px; border-radius: 8px; font-size: 11px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .legend-dot { width: 12px; height: 12px; border-radius: 50%; }
        
        /* ============ MODALS ============ */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,.5); display: none; align-items: center; justify-content: center; z-index: 100; padding: 20px; }
        .modal-overlay.visible { display: flex; }
        .modal { background: var(--bg); border-radius: 12px; box-shadow: 0 20px 40px rgba(0,0,0,.2); width: 100%; max-width: 700px; max-height: 90vh; display: flex; flex-direction: column; overflow: hidden; }
        .modal-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .modal-title { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .modal-close { width: 32px; height: 32px; border: none; background: var(--bg2); border-radius: 8px; cursor: pointer; font-size: 16px; }
        .modal-body { flex: 1; padding: 20px; overflow-y: auto; }
        .modal-footer { padding: 16px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 8px; }
        
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 12px; font-weight: 500; margin-bottom: 6px; }
        .form-label span { color: var(--error); }
        .form-input { width: 100%; padding: 10px 14px; border: 1px solid var(--border); border-radius: 8px; font-size: 13px; }
        .form-input:focus { outline: none; border-color: var(--accent); }
        
        .type-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; }
        .type-card { padding: 12px 8px; border: 2px solid var(--border); border-radius: 10px; text-align: center; cursor: pointer; transition: all .15s; }
        .type-card:hover { border-color: var(--accent); background: var(--bg2); }
        .type-card.selected { border-color: var(--accent); background: #eff6ff; }
        .type-card-icon { font-size: 24px; margin-bottom: 4px; }
        .type-card-label { font-size: 11px; font-weight: 500; }
        
        /* Dependencies selector */
        .deps-selector { margin-top: 16px; padding: 16px; background: var(--bg2); border-radius: 8px; }
        .deps-selector-title { font-size: 12px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .deps-list { max-height: 200px; overflow-y: auto; }
        .deps-item { padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 6px; background: var(--bg); display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .deps-item:hover { border-color: var(--accent); }
        .deps-item.selected { border-color: var(--accent); background: #eff6ff; }
        .deps-item-check { width: 18px; height: 18px; border: 2px solid var(--border); border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .deps-item.selected .deps-item-check { background: var(--accent); border-color: var(--accent); color: #fff; }
        .deps-item-info { flex: 1; }
        .deps-item-name { font-size: 12px; font-weight: 500; }
        .deps-item-type { font-size: 10px; color: var(--text2); }
        
        /* Quick prompt */
        .quick-prompt-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: flex-start; justify-content: center; z-index: 1000; padding-top: 12vh; }
        .quick-prompt-overlay.visible { display: flex; }
        .quick-prompt { background: var(--bg); border-radius: 12px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 100%; max-width: 640px; overflow: hidden; }
        .quick-prompt-header { padding: 16px 20px; background: var(--ai-gradient); color: #fff; display: flex; align-items: center; gap: 12px; }
        .quick-prompt-header h3 { font-size: 15px; font-weight: 600; flex: 1; }
        .quick-prompt-body { padding: 20px; }
        .quick-prompt-input { width: 100%; padding: 14px 16px; border: 2px solid var(--border); border-radius: 10px; font-size: 14px; }
        .quick-prompt-input:focus { outline: none; border-color: var(--accent); }
        .quick-prompt-hints { margin-top: 12px; display: flex; flex-wrap: wrap; gap: 6px; }
        .quick-prompt-hint { padding: 6px 12px; background: var(--bg2); border-radius: 20px; font-size: 11px; color: var(--text2); cursor: pointer; }
        .quick-prompt-hint:hover { background: var(--accent); color: #fff; }
        .quick-prompt-footer { padding: 12px 20px; background: var(--bg2); border-top: 1px solid var(--border); display: flex; justify-content: space-between; }
        .quick-prompt-shortcut { font-size: 10px; color: var(--text2); }
        .quick-prompt-shortcut kbd { padding: 2px 6px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; }
        
        /* Status bar */
        .status-bar { background: var(--bg); border-top: 1px solid var(--border); padding: 4px 12px; display: flex; justify-content: space-between; font-size: 10px; color: #94a3b8; flex-shrink: 0; }
        
        /* States */
        .state-box { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 30px; text-align: center; }
        .state-icon { font-size: 48px; margin-bottom: 16px; }
        .state-title { font-size: 16px; font-weight: 600; margin-bottom: 6px; }
        .state-desc { font-size: 13px; color: var(--text2); max-width: 280px; }
        
        /* Init banner */
        .init-banner { background: var(--ai-gradient); color: #fff; padding: 6px 12px; display: flex; align-items: center; gap: 8px; font-size: 11px; flex-shrink: 0; }
        .init-banner.hidden { display: none; }
        .init-banner.ok { background: var(--success); }
        .init-banner.err { background: var(--error); }
        .init-spinner { width: 14px; height: 14px; border: 2px solid rgba(255,255,255,.3); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg2); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>
    <div class="init-banner" id="initBanner">
        <div class="init-spinner"></div>
        <span id="initMsg">Initialisation Artefactory AI v12...</span>
    </div>
    
    <!-- Mode Switch Bar -->
    <div class="mode-bar" id="modeBar">
        <div class="mode-switch">
            <button class="mode-btn edit-mode active" onclick="setMode('edit')">
                <span>üîß</span> √âdition
            </button>
            <button class="mode-btn run-mode" onclick="setMode('run')">
                <span>‚ñ∂Ô∏è</span> Ex√©cution
            </button>
        </div>
        
        <div class="app-selector">
            <label>üì¶ Application:</label>
            <select class="app-select" id="appSelect" onchange="onAppSelect()">
                <option value="">-- Aucune application --</option>
            </select>
            <span class="app-badge" id="appBadge" style="display:none">APP</span>
        </div>
        
        <div class="mode-info">
            <span class="mode-indicator edit" id="modeIndicator"></span>
            <span id="modeText">Mode √âdition</span>
            <button class="btn" onclick="showGraph()" title="Voir les d√©pendances">üîó Graph</button>
        </div>
    </div>
    
    <!-- ============ FACTORY MODE (Edit) ============ -->
    <div class="factory-container active" id="factoryContainer">
        <div class="header">
            <div class="header-icon">üè≠</div>
            <div class="header-info">
                <div class="header-title" id="artName">Artefactory AI</div>
                <div class="header-sub" id="artDesc">Applications Composables</div>
            </div>
            <button class="btn btn-add" onclick="openCreateModal()">‚ûï Nouveau</button>
            <select class="art-select" id="artSelect" onchange="onSelect()">
                <option value="">Chargement...</option>
            </select>
            <span class="art-count" id="artCount">0</span>
            <span id="typeBadge" class="type-badge" style="display:none"></span>
        </div>
        
        <div class="toolbar">
            <button class="btn active" id="btnRender" onclick="setView('render')">‚ñ∂Ô∏è Rendu</button>
            <button class="btn" id="btnCode" onclick="setView('code')">üìù Code</button>
            <button class="btn" id="btnSplit" onclick="setView('split')">‚óß Split</button>
            <div class="toolbar-sep"></div>
            <button class="btn" id="btnConsole" onclick="toggleConsole()">üñ•Ô∏è Console</button>
            <div class="toolbar-sep"></div>
            <button class="btn ai-btn" id="btnAI" onclick="toggleAIPanel()">ü§ñ Assistant</button>
            <button class="btn" onclick="openQuickPrompt()" title="Ctrl+K">‚ú®</button>
            <div class="toolbar-spacer"></div>
            <button class="btn" onclick="saveToGrist()" title="Ctrl+S">üíæ Save</button>
            <button class="btn" onclick="copyCode()">üìã</button>
            <button class="btn" onclick="refresh()">üîÑ</button>
        </div>
        
        <div class="main">
            <div class="main-left">
                <div class="panels" id="panels">
                    <div class="render-zone" id="renderZone">
                        <div class="render-bar" id="renderBar">
                            <span class="status-dot" id="statusDot"></span>
                            <span id="statusTxt">Pr√™t</span>
                            <div style="flex:1"></div>
                            <label style="display:flex;align-items:center;gap:4px;font-size:10px;cursor:pointer">
                                <input type="checkbox" id="bridgeToggle" checked onchange="toggleBridgeMode()">
                                <span>üåâ Bridge</span>
                            </label>
                        </div>
                        <div class="render-content" id="renderContent">
                            <div class="device-frame desktop" id="deviceFrame">
                                <div class="state-box">
                                    <div class="state-icon">üè≠</div>
                                    <div class="state-title">Artefactory AI v12</div>
                                    <div class="state-desc">Applications Composables - S√©lectionnez ou cr√©ez un artefact</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="splitter splitter-h" id="splitter" style="display:none"></div>
                    
                    <div class="code-zone" id="codeZone">
                        <div class="code-bar">
                            <div class="code-bar-left">
                                <span>üìù √âditeur</span>
                                <span id="codeInfo">0 lignes</span>
                                <span id="codeModified" style="color:#e5c07b;display:none">‚óè Modifi√©</span>
                            </div>
                            <div class="code-bar-right">
                                <label style="display:flex;align-items:center;gap:4px;font-size:10px;color:#636d83;cursor:pointer">
                                    <input type="checkbox" id="hotReload" checked>
                                    <span>Auto</span>
                                </label>
                                <button class="btn" onclick="applyCode()">‚ñ∂Ô∏è Run</button>
                            </div>
                        </div>
                        <div class="code-content">
                            <div id="aceEditor"></div>
                        </div>
                    </div>
                </div>
                
                <div class="console-zone" id="consoleZone">
                    <div class="console-bar">
                        <span>üñ•Ô∏è Console</span>
                        <button class="btn" onclick="clearConsole()">Effacer</button>
                    </div>
                    <div class="console-content" id="consoleContent"></div>
                </div>
            </div>
            
            <!-- AI Panel -->
            <div class="main-right" id="aiPanel">
                <div class="ai-panel">
                    <div class="ai-header">
                        <span style="font-size:20px">ü§ñ</span>
                        <h3>Assistant IA</h3>
                        <button class="ai-close" onclick="toggleAIPanel()">‚úï</button>
                    </div>
                    
                    <div class="ai-config">
                        <div class="ai-config-row">
                            <label>üîó Webhook</label>
                            <input type="text" id="webhookUrl" placeholder="https://n8n.example.com/webhook/...">
                        </div>
                        <div class="ai-config-row">
                            <label>üîë API Key</label>
                            <input type="password" id="apiKey" placeholder="Optionnel">
                        </div>
                    </div>
                    
                    <!-- Dependencies available for injection -->
                    <div class="ai-deps" id="aiDeps">
                        <div class="ai-deps-header">
                            <div class="ai-deps-title">
                                <span>üîó</span>
                                <span>D√©pendances disponibles</span>
                            </div>
                        </div>
                        <div class="ai-deps-list" id="aiDepsList">
                            <span style="font-size:11px;color:#065f46;opacity:0.8">Aucune d√©pendance</span>
                        </div>
                    </div>
                    
                    <!-- Documentation s√©lectionnable -->
                    <div class="ai-docs" id="aiDocs">
                        <div class="ai-docs-header" onclick="toggleDocsSection()">
                            <div class="ai-docs-title">
                                <span>üìö</span>
                                <span>Documentation</span>
                                <span class="ai-docs-count" id="docsCount">0</span>
                            </div>
                            <span class="ai-docs-toggle" id="docsToggle">‚ñº</span>
                        </div>
                        <div class="ai-docs-content" id="docsContent">
                            <div class="ai-docs-suggested" id="docsSuggested">
                                <div class="ai-docs-suggested-label">üí° Sugg√©r√©es pour ce mode:</div>
                                <div class="ai-docs-list" id="docsSuggestedList"></div>
                            </div>
                            <div class="ai-docs-other" id="docsOther">
                                <div class="ai-docs-other-label">üìÑ Autres disponibles:</div>
                                <div class="ai-docs-list" id="docsOtherList"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="ai-conversation" id="aiConversation">
                        <div class="ai-message system">
                            üëã Bienvenue dans Artefactory v12 !<br>
                            üîó Cr√©ez des applications compos√©es d'artefacts interconnect√©s.<br>
                            üì¶ Utilisez le type "App" pour d√©finir un manifest d'application.
                        </div>
                    </div>
                    
                    <div class="ai-status">
                        <span class="ai-status-dot" id="aiStatusDot"></span>
                        <span id="aiStatusText">En attente</span>
                    </div>
                    
                    <div class="ai-input-area">
                        <div class="ai-context-info" id="aiContextInfo">
                            <span>üìÑ Contexte:</span>
                            <span class="ai-context-tag" id="ctxMode">-</span>
                            <span class="ai-context-tag" id="ctxLines">0 lignes</span>
                            <span class="ai-context-tag app" id="ctxApp" style="display:none">üì¶ App</span>
                            <span class="ai-context-tag" id="ctxDocs" style="display:none;background:var(--warning)">üìö 0 doc(s)</span>
                            <span class="ai-context-tag" id="ctxSelection" style="display:none;background:#8b5cf6">‚úÇÔ∏è S√©lection</span>
                            <span class="ai-context-tag" id="ctxScreenshot" style="display:none;background:var(--success)">üì∏ Vision</span>
                        </div>
                        <div class="ai-input-row">
                            <textarea class="ai-textarea" id="aiInput" placeholder="D√©crivez ce que vous voulez... (s√©lectionnez du code pour une √©dition cibl√©e)" onkeydown="onAIInputKeydown(event)"></textarea>
                            <button class="ai-screenshot" id="screenshotBtn" onclick="toggleScreenshot()" title="Inclure capture d'√©cran (vision)">üì∏</button>
                            <button class="ai-send" id="aiSendBtn" onclick="sendAIRequest()">‚ú®</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ============ RUNTIME MODE ============ -->
    <div class="runtime-container" id="runtimeContainer">
        <div class="runtime-main">
            <div class="runtime-sidebar" id="runtimeSidebar">
                <div class="sidebar-header">
                    <div class="sidebar-logo" id="runtimeLogo">üì¶</div>
                    <div class="sidebar-title" id="runtimeTitle">Application</div>
                </div>
                <nav class="sidebar-nav" id="runtimeNav">
                    <!-- Navigation items generated dynamically -->
                </nav>
                <div class="sidebar-footer">
                    <button class="sidebar-toggle" onclick="toggleSidebar()">‚óÄ R√©duire</button>
                </div>
            </div>
            
            <div class="runtime-content">
                <div class="runtime-toolbar">
                    <div class="runtime-breadcrumb">
                        <span id="runtimeBreadcrumb">Accueil</span>
                    </div>
                    <div style="flex:1"></div>
                    <button class="btn" onclick="setMode('edit')">üîß √âditer</button>
                </div>
                <div class="runtime-frame" id="runtimeFrame">
                    <iframe class="runtime-iframe" id="runtimeIframe"></iframe>
                </div>
            </div>
        </div>
    </div>
    
    <div class="status-bar">
        <div style="display:flex;gap:12px">
            <span id="footerType">üìÑ -</span>
            <span id="footerLines">üìù -</span>
        </div>
        <span>Artefactory AI v12 - Apps Composables</span>
    </div>
    
    <!-- Graph Overlay -->
    <div class="graph-overlay" id="graphOverlay" onclick="closeGraphOnOverlay(event)">
        <div class="graph-container">
            <div class="graph-header">
                <div class="graph-title">üîó Graphe des d√©pendances</div>
                <button class="graph-close" onclick="closeGraph()">‚úï</button>
            </div>
            <div class="graph-content">
                <canvas class="graph-canvas" id="graphCanvas"></canvas>
                <div class="graph-legend">
                    <div class="legend-item"><div class="legend-dot" style="background:#10b981"></div> App (Manifest)</div>
                    <div class="legend-item"><div class="legend-dot" style="background:#3b82f6"></div> Widget Grist</div>
                    <div class="legend-item"><div class="legend-dot" style="background:#f59e0b"></div> Composant</div>
                    <div class="legend-item"><div class="legend-dot" style="background:#8b5cf6"></div> Documentation</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quick Prompt -->
    <div class="quick-prompt-overlay" id="quickPromptOverlay" onclick="closeQuickPromptOnOverlay(event)">
        <div class="quick-prompt">
            <div class="quick-prompt-header">
                <span style="font-size:18px">‚ú®</span>
                <h3>Assistant IA</h3>
            </div>
            <div class="quick-prompt-body">
                <input type="text" class="quick-prompt-input" id="quickPromptInput" 
                       placeholder="D√©crivez ce que vous voulez faire..." 
                       onkeydown="onQuickPromptKeydown(event)">
                <div class="quick-prompt-hints">
                    <span class="quick-prompt-hint" onclick="useHint('Cr√©e une nouvelle page pour cette app')">üìÑ Nouvelle page</span>
                    <span class="quick-prompt-hint" onclick="useHint('Ajoute la navigation vers')">üîó Ajouter navigation</span>
                    <span class="quick-prompt-hint" onclick="useHint('Connecte ce widget aux donn√©es')">üìä Connexion Grist</span>
                    <span class="quick-prompt-hint" onclick="useHint('Cr√©e un composant r√©utilisable pour')">‚öõÔ∏è Composant</span>
                    <span class="quick-prompt-hint" onclick="useHint('Corrige les erreurs')">üêõ Corriger</span>
                </div>
            </div>
            <div class="quick-prompt-footer">
                <span class="quick-prompt-shortcut"><kbd>Entr√©e</kbd> envoyer ¬∑ <kbd>√âchap</kbd> fermer</span>
                <button class="btn primary" onclick="submitQuickPrompt()">‚ú® G√©n√©rer</button>
            </div>
        </div>
    </div>
    
    <!-- Create Modal -->
    <div class="modal-overlay" id="createModal" onclick="closeModalOnOverlay(event)">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">‚ú® Nouvel artefact</div>
                <button class="modal-close" onclick="closeCreateModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Nom <span>*</span></label>
                    <input type="text" class="form-input" id="newName" placeholder="Mon artefact">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Type</label>
                    <div class="type-cards">
                        <div class="type-card" data-type="app" onclick="selectType('app')">
                            <div class="type-card-icon">üì¶</div>
                            <div class="type-card-label">App</div>
                        </div>
                        <div class="type-card selected" data-type="grist" onclick="selectType('grist')">
                            <div class="type-card-icon">üìä</div>
                            <div class="type-card-label">Widget Grist</div>
                        </div>
                        <div class="type-card" data-type="react" onclick="selectType('react')">
                            <div class="type-card-icon">‚öõÔ∏è</div>
                            <div class="type-card-label">React</div>
                        </div>
                        <div class="type-card" data-type="html" onclick="selectType('html')">
                            <div class="type-card-icon">üåê</div>
                            <div class="type-card-label">HTML</div>
                        </div>
                        <div class="type-card" data-type="component" onclick="selectType('component')">
                            <div class="type-card-icon">üß©</div>
                            <div class="type-card-label">Composant</div>
                        </div>
                        <div class="type-card" data-type="markdown" onclick="selectType('markdown')">
                            <div class="type-card-icon">üìù</div>
                            <div class="type-card-label">Doc</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <input type="text" class="form-input" id="newDesc" placeholder="Description optionnelle">
                </div>
                
                <!-- Dependencies selector -->
                <div class="deps-selector" id="depsSelector">
                    <div class="deps-selector-title">
                        <span>üîó</span>
                        <span>D√©pendances (artefacts li√©s)</span>
                    </div>
                    <div class="deps-list" id="depsList">
                        <!-- Generated dynamically -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">üí° Description pour l'IA</label>
                    <input type="text" class="form-input" id="newAIPrompt" placeholder="Ex: Dashboard avec 3 KPIs et un graphique...">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeCreateModal()">Annuler</button>
                <button class="btn primary" onclick="createArtefact()">‚ú® Cr√©er</button>
            </div>
        </div>
    </div>

<script>
// ============ CONFIGURATION ============
const TABLE_NAME = 'Artefacts';
const TABLE_COLS = [
    { id: 'Nom', type: 'Text' },
    { id: 'Type', type: 'Choice', widgetOptions: JSON.stringify({ choices: ['app', 'grist', 'react', 'html', 'component', 'svg', 'mermaid', 'markdown'] }) },
    { id: 'Code', type: 'Text' },
    { id: 'Description', type: 'Text' },
    { id: 'Dependencies', type: 'Text' }, // JSON array of artefact IDs
    { id: 'IsDoc', type: 'Bool' },
    { id: 'Icon', type: 'Text' },
    { id: 'CreatedAt', type: 'DateTime' }
];

const TYPES = {
    app: { label: 'Application', cls: 'type-app', icon: 'üì¶', mode: 'json',
        template: `{
  "name": "Mon Application",
  "icon": "üìä",
  "description": "Application compos√©e",
  "layout": "sidebar",
  "theme": {
    "primary": "#3b82f6",
    "accent": "#10b981"
  },
  "routes": [
    {
      "path": "/",
      "label": "Accueil",
      "icon": "üè†",
      "artefact": null,
      "description": "Page d'accueil"
    }
  ],
  "tables": [],
  "sharedState": {}
}` },
    grist: { label: 'Widget Grist', cls: 'type-grist', icon: 'üìä', mode: 'html',
        template: `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Widget Grist</title>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"><\/script>
    <script src="https://cdn.tailwindcss.com"><\/script>
</head>
<body class="bg-gray-50 p-4">
    <div id="app" class="max-w-2xl mx-auto">
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h1 class="text-2xl font-bold text-gray-800 mb-4">üìä Widget Grist</h1>
            <div id="status" class="text-gray-600 mb-4">Connexion...</div>
            <div id="data" class="space-y-2"></div>
        </div>
    </div>
    <script>
        // API App disponible via window.app
        const app = window.app || { navigate: ()=>{}, emit: ()=>{}, on: ()=>{}, state: {} };
        
        let records = [];
        grist.ready({ requiredAccess: 'read table' });
        
        grist.onRecords((data, mappings) => {
            records = data;
            document.getElementById('status').textContent = '‚úÖ ' + records.length + ' enregistrements';
            renderData();
        });
        
        function renderData() {
            const html = records.slice(0, 10).map(r => \`
                <div class="p-3 bg-gray-50 rounded-lg">
                    <span class="font-medium">\${JSON.stringify(r).substring(0, 100)}...</span>
                </div>
            \`).join('');
            document.getElementById('data').innerHTML = html || '<p class="text-gray-400">Aucune donn√©e</p>';
        }
    <\/script>
</body>
</html>` },
    react: { label: 'React', cls: 'type-react', icon: '‚öõÔ∏è', mode: 'jsx',
        template: `const App = () => {
  const [count, setCount] = React.useState(0);
  // API App disponible via window.app
  const app = window.app || { navigate: ()=>{}, emit: ()=>{}, state: {} };
  
  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-8">
      <div className="bg-white rounded-2xl shadow-xl p-8 text-center max-w-md">
        <h1 className="text-3xl font-bold text-gray-800 mb-4">Composant React</h1>
        <p className="text-gray-600 mb-6">Compteur: {count}</p>
        <button 
          onClick={() => setCount(c => c + 1)}
          className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
        >
          Incr√©menter
        </button>
      </div>
    </div>
  );
};` },
    html: { label: 'HTML', cls: 'type-html', icon: 'üåê', mode: 'html',
        template: `<div class="min-h-screen bg-gradient-to-br from-green-50 to-emerald-100 flex items-center justify-center p-8">
  <div class="bg-white rounded-2xl shadow-xl p-8 text-center max-w-md">
    <h1 class="text-3xl font-bold text-gray-800 mb-4">Page HTML</h1>
    <p class="text-gray-600 mb-6">Contenu de la page</p>
    <button onclick="app.navigate('/')" class="px-6 py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition">
      Retour accueil
    </button>
  </div>
</div>` },
    component: { label: 'Composant', cls: 'type-component', icon: 'üß©', mode: 'jsx',
        template: `// Composant r√©utilisable
// Peut √™tre import√© par d'autres artefacts via app.getComponent(id)

const Component = ({ title = "Titre", children }) => {
  return (
    <div className="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
      <h2 className="text-xl font-bold text-gray-800 mb-4">{title}</h2>
      <div className="text-gray-600">
        {children || "Contenu du composant"}
      </div>
    </div>
  );
};

// Export pour utilisation
window.ExportedComponent = Component;` },
    markdown: { label: 'Documentation', cls: 'type-markdown', icon: 'üìù', mode: 'markdown',
        template: `# Documentation

## Description

Cette documentation d√©crit le fonctionnement de l'artefact.

## Utilisation

\`\`\`javascript
// Exemple d'utilisation
app.navigate('/page');
app.emit('event', data);
\`\`\`

## API disponible

- \`app.navigate(path)\` - Navigation
- \`app.emit(event, data)\` - √âmettre un √©v√©nement
- \`app.on(event, callback)\` - √âcouter un √©v√©nement
- \`app.state\` - √âtat partag√©
- \`app.getData(table)\` - Acc√®s aux donn√©es Grist

---
*Artefactory AI v12*` },
    svg: { label: 'SVG', cls: 'type-svg', icon: 'üé®', mode: 'svg', template: `<svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg">
  <rect width="400" height="300" fill="#f8fafc"/>
  <circle cx="200" cy="150" r="80" fill="#3b82f6"/>
  <text x="200" y="160" text-anchor="middle" fill="white" font-size="24">SVG</text>
</svg>` },
    mermaid: { label: 'Mermaid', cls: 'type-mermaid', icon: 'üìà', mode: 'text', template: `flowchart TD
    A[Start] --> B{Decision}
    B -->|Yes| C[Action]
    B -->|No| D[End]` }
};

// ============ STATE ============
const state = {
    mode: 'edit', // 'edit' | 'run'
    artefacts: [],
    apps: [],
    current: null,
    currentApp: null,
    currentRoute: '/',
    view: 'split',
    showConsole: false,
    showAIPanel: true,
    code: '',
    originalCode: '',
    currentType: 'grist',
    isModified: false,
    splitRatio: 0.5,
    isDragging: false,
    selectedType: 'grist',
    selectedDeps: new Set(),
    gristBridgeMode: true,
    gristBridge: null,
    renderIframe: null,
    runtimeIframe: null,
    // AI
    aiConversation: [],
    aiProcessing: false,
    consoleErrors: [],
    // Documentation
    documentations: [],
    selectedDocs: new Set(),
    docsCollapsed: false,
    // Graph
    graphNodes: [],
    graphEdges: [],
    // Screenshot/Vision
    includeScreenshot: false
};

let aceEditor = null;

// ============ GRIST BRIDGE ============
class GristBridgeParent {
    constructor() {
        this.currentIframe = null;
        this.callbacks = new Map();
        this.nextId = 1;
        window.addEventListener('message', this._handleMessage.bind(this));
    }
    
    setCurrentIframe(iframe) {
        this.callbacks.clear();
        this.currentIframe = iframe;
    }
    
    async _handleMessage(event) {
        const data = event.data;
        if (!data || data.type !== 'grist-bridge') return;
        if (!this.currentIframe || event.source !== this.currentIframe.contentWindow) return;
        
        try {
            let result;
            switch (data.action) {
                case 'ready': result = { success: true }; break;
                case 'apiCall': result = await this._handleApiCall(data); break;
                case 'registerCallback': result = await this._handleRegisterCallback(data); break;
                default: throw new Error('Unknown action');
            }
            this._sendResponse(data.callId, result, null);
        } catch (error) {
            this._sendResponse(data.callId, null, error.message);
        }
    }
    
    _sendResponse(callId, result, error) {
        if (!this.currentIframe) return;
        this.currentIframe.contentWindow.postMessage({ type: 'grist-bridge-response', callId, result, error }, '*');
    }
    
    _sendCallback(callbackId, args) {
        if (!this.currentIframe) return;
        this.currentIframe.contentWindow.postMessage({ type: 'grist-bridge-callback', callbackId, args }, '*');
    }
    
    async _handleApiCall(data) {
        const { path, args } = data;
        const parts = path.split('.');
        let target = grist;
        for (let i = 0; i < parts.length - 1; i++) {
            target = target[parts[i]];
            if (!target) throw new Error(`Invalid path: ${path}`);
        }
        const method = target[parts[parts.length - 1]];
        if (typeof method !== 'function') throw new Error(`${path} is not a function`);
        return await method.apply(target, args || []);
    }
    
    async _handleRegisterCallback(data) {
        const { callbackType } = data;
        const callbackId = 'cb_' + (this.nextId++);
        const self = this;
        
        if (callbackType === 'onRecords') {
            grist.onRecords((records, mappings) => self._sendCallback(callbackId, [records, mappings]));
        } else if (callbackType === 'onRecord') {
            grist.onRecord((record, mappings) => self._sendCallback(callbackId, [record, mappings]));
        }
        
        return { callbackId };
    }
}

const GRIST_BRIDGE_SCRIPT = `
(function() {
    const pending = new Map();
    const callbacks = new Map();
    let nextId = 1;
    
    window.addEventListener('message', (event) => {
        const data = event.data;
        if (data?.type === 'grist-bridge-response') {
            const p = pending.get(data.callId);
            if (p) {
                pending.delete(data.callId);
                data.error ? p.reject(new Error(data.error)) : p.resolve(data.result);
            }
        }
        if (data?.type === 'grist-bridge-callback') {
            const cb = callbacks.get(data.callbackId);
            if (cb) cb.apply(null, data.args || []);
        }
    });
    
    function send(action, payload) {
        return new Promise((resolve, reject) => {
            const callId = 'call_' + (nextId++);
            pending.set(callId, { resolve, reject });
            window.parent.postMessage({ type: 'grist-bridge', action, callId, ...payload }, '*');
            setTimeout(() => { if (pending.has(callId)) { pending.delete(callId); reject(new Error('Timeout')); } }, 30000);
        });
    }
    
    async function registerCallback(type, fn) {
        const result = await send('registerCallback', { callbackType: type });
        callbacks.set(result.callbackId, fn);
    }
    
    window.grist = {
        ready: (options) => send('ready', { options }),
        docApi: {
            listTables: () => send('apiCall', { path: 'docApi.listTables', args: [] }),
            fetchTable: (t) => send('apiCall', { path: 'docApi.fetchTable', args: [t] }),
            applyUserActions: (a) => send('apiCall', { path: 'docApi.applyUserActions', args: [a] })
        },
        onRecords: (cb) => registerCallback('onRecords', cb),
        onRecord: (cb) => registerCallback('onRecord', cb)
    };
    
    console.log('üåâ Grist Bridge ready');
})();
`;

// App Runtime API injected into artefacts
const APP_RUNTIME_SCRIPT = `
(function() {
    const eventHandlers = new Map();
    
    window.app = {
        // Navigation
        navigate: (path) => {
            window.parent.postMessage({ type: 'app-navigate', path }, '*');
        },
        getCurrentRoute: () => window.__APP_ROUTE__ || '/',
        
        // Events
        emit: (event, data) => {
            window.parent.postMessage({ type: 'app-event', event, data }, '*');
        },
        on: (event, callback) => {
            if (!eventHandlers.has(event)) eventHandlers.set(event, []);
            eventHandlers.get(event).push(callback);
        },
        
        // State
        state: window.__APP_STATE__ || {},
        setState: (key, value) => {
            window.parent.postMessage({ type: 'app-setState', key, value }, '*');
        },
        
        // Get artefact
        getArtefact: (id) => {
            return new Promise((resolve) => {
                window.parent.postMessage({ type: 'app-getArtefact', id }, '*');
                // Simplified - in real impl would need proper async handling
            });
        },
        
        // Manifest
        manifest: window.__APP_MANIFEST__ || null,
        isEditMode: false
    };
    
    window.addEventListener('message', (event) => {
        const data = event.data;
        if (data?.type === 'app-event-broadcast') {
            const handlers = eventHandlers.get(data.event) || [];
            handlers.forEach(h => h(data.data));
        }
    });
    
    console.log('üì¶ App Runtime API ready');
})();
`;

function injectGristBridge(html) {
    return html.replace(
        /<script\s+src=["']https:\/\/docs\.getgrist\.com\/grist-plugin-api\.js["']\s*><\/script>/gi,
        '<script>' + GRIST_BRIDGE_SCRIPT + '<\/script>'
    );
}

function injectAppRuntime(html, manifest, route) {
    const runtimeInit = `
        <script>
            window.__APP_MANIFEST__ = ${JSON.stringify(manifest)};
            window.__APP_ROUTE__ = "${route}";
            window.__APP_STATE__ = {};
            ${APP_RUNTIME_SCRIPT}
        <\/script>
    `;
    
    if (html.includes('</head>')) {
        return html.replace('</head>', runtimeInit + '</head>');
    }
    return runtimeInit + html;
}

// ============ INITIALIZATION ============
async function init() {
    console.log('üöÄ Artefactory AI v12 - Apps Composables');
    
    state.gristBridge = new GristBridgeParent();
    initAceEditor();
    initSplitter();
    loadConfig();
    
    window.addEventListener('message', onMessage);
    window.addEventListener('keydown', onKeyDown);
    
    grist.ready({ requiredAccess: 'full' });
    
    try {
        await ensureTable();
        await loadArtefacts();
        showInit('‚úì Pr√™t', 'ok');
        setTimeout(hideInit, 800);
    } catch (e) {
        console.error(e);
        showInit('Erreur: ' + e.message, 'err');
    }
    
    setView('split');
    if (state.showAIPanel) {
        document.getElementById('aiPanel').classList.add('visible');
        document.getElementById('btnAI').classList.add('active');
    }
}

function initAceEditor() {
    aceEditor = ace.edit("aceEditor");
    aceEditor.setTheme("ace/theme/one_dark");
    aceEditor.session.setMode("ace/mode/html");
    aceEditor.setOptions({
        fontSize: "13px",
        showPrintMargin: false,
        tabSize: 2,
        useSoftTabs: true,
        wrap: true,
        enableBasicAutocompletion: true,
        enableLiveAutocompletion: true
    });
    
    aceEditor.session.on('change', onCodeChange);
    
    // Listener pour la s√©lection
    aceEditor.selection.on('changeSelection', onSelectionChange);
    
    aceEditor.commands.addCommand({
        name: 'save', bindKey: { win: 'Ctrl-S', mac: 'Cmd-S' },
        exec: () => saveToGrist()
    });
    aceEditor.commands.addCommand({
        name: 'aiPrompt', bindKey: { win: 'Ctrl-K', mac: 'Cmd-K' },
        exec: () => openQuickPrompt()
    });
}

function onSelectionChange() {
    const selection = aceEditor.getSelection();
    const range = selection.getRange();
    const hasSelection = !range.isEmpty();
    
    const ctxSelection = document.getElementById('ctxSelection');
    if (ctxSelection) {
        if (hasSelection) {
            const startLine = range.start.row + 1;
            const endLine = range.end.row + 1;
            ctxSelection.textContent = `‚úÇÔ∏è L${startLine}-${endLine}`;
            ctxSelection.style.display = 'inline';
        } else {
            ctxSelection.style.display = 'none';
        }
    }
}

function initSplitter() {
    const splitter = document.getElementById('splitter');
    splitter.addEventListener('mousedown', startDrag);
    document.addEventListener('mousemove', onDrag);
    document.addEventListener('mouseup', stopDrag);
}

function startDrag(e) {
    if (state.view !== 'split') return;
    state.isDragging = true;
    document.body.style.cursor = 'col-resize';
    e.preventDefault();
}

function onDrag(e) {
    if (!state.isDragging) return;
    const panels = document.getElementById('panels');
    const rect = panels.getBoundingClientRect();
    state.splitRatio = Math.max(0.2, Math.min(0.8, (e.clientX - rect.left) / rect.width));
    applySplitRatio();
}

function stopDrag() {
    if (!state.isDragging) return;
    state.isDragging = false;
    document.body.style.cursor = '';
    aceEditor.resize();
}

function applySplitRatio() {
    const renderZone = document.getElementById('renderZone');
    const codeZone = document.getElementById('codeZone');
    if (state.view === 'split') {
        renderZone.style.flex = '0 0 ' + (state.splitRatio * 100) + '%';
        codeZone.style.flex = '0 0 ' + ((1 - state.splitRatio) * 100 - 1) + '%';
    }
}

async function ensureTable() {
    showInit('V√©rification table...');
    const tables = await grist.docApi.listTables();
    if (!tables.includes(TABLE_NAME)) {
        showInit('Cr√©ation table...');
        await grist.docApi.applyUserActions([['AddTable', TABLE_NAME, TABLE_COLS]]);
    }
}

async function loadArtefacts() {
    const data = await grist.docApi.fetchTable(TABLE_NAME);
    const items = [];
    const apps = [];
    const docs = [];
    const n = data.id ? data.id.length : 0;
    
    for (let i = 0; i < n; i++) {
        const art = {
            id: data.id[i],
            Nom: data.Nom?.[i] || '',
            Type: data.Type?.[i] || '',
            Code: data.Code?.[i] || '',
            Description: data.Description?.[i] || '',
            Dependencies: data.Dependencies?.[i] || '[]',
            IsDoc: data.IsDoc?.[i] || false,
            Icon: data.Icon?.[i] || ''
        };
        
        // Parse dependencies
        try {
            art.deps = JSON.parse(art.Dependencies);
        } catch {
            art.deps = [];
        }
        
        items.push(art);
        
        if (art.Type === 'app') {
            apps.push(art);
        }
        
        // Collect documentation artefacts (IsDoc=true OR type=markdown)
        if (art.IsDoc || art.Type === 'markdown') {
            docs.push(art);
        }
    }
    
    state.artefacts = items;
    state.apps = apps;
    state.documentations = docs;
    
    updateSelect();
    updateAppSelect();
    updateDepsList();
    updateDocsList();
    buildGraph();
    
    if (items.length > 0 && !state.current) {
        selectArtefact(items[0].id);
    }
}

function loadConfig() {
    const saved = localStorage.getItem('artefactory_v12_config');
    if (saved) {
        try {
            const config = JSON.parse(saved);
            if (config.webhookUrl) document.getElementById('webhookUrl').value = config.webhookUrl;
            if (config.apiKey) document.getElementById('apiKey').value = config.apiKey;
            if (config.selectedDocs && Array.isArray(config.selectedDocs)) {
                state.selectedDocs = new Set(config.selectedDocs);
            }
        } catch (e) {}
    }
}

function saveConfig() {
    localStorage.setItem('artefactory_v12_config', JSON.stringify({
        webhookUrl: document.getElementById('webhookUrl').value,
        apiKey: document.getElementById('apiKey').value,
        selectedDocs: Array.from(state.selectedDocs)
    }));
}

// ============ DOCUMENTATION MANAGEMENT ============

// Mapping des docs sugg√©r√©es par mode
const DOC_SUGGESTIONS = {
    grist: ['api', 'grist', 'widget'],
    react: ['react', 'jsx', 'composant'],
    html: ['html', 'convention'],
    app: ['app', 'composable', 'navigation'],
    component: ['react', 'composant'],
    markdown: ['convention', 'format']
};

function getSuggestedDocs(mode) {
    const keywords = DOC_SUGGESTIONS[mode] || [];
    return state.documentations.filter(doc => {
        const name = (doc.Nom || '').toLowerCase();
        const desc = (doc.Description || '').toLowerCase();
        return keywords.some(kw => name.includes(kw) || desc.includes(kw));
    });
}

function updateDocsList() {
    const suggestedContainer = document.getElementById('docsSuggestedList');
    const otherContainer = document.getElementById('docsOtherList');
    const countBadge = document.getElementById('docsCount');
    const suggestedSection = document.getElementById('docsSuggested');
    const otherSection = document.getElementById('docsOther');
    
    if (state.documentations.length === 0) {
        suggestedContainer.innerHTML = '<span style="font-size:10px;opacity:0.7">Aucune documentation</span>';
        otherContainer.innerHTML = '';
        otherSection.style.display = 'none';
        suggestedSection.querySelector('.ai-docs-suggested-label').textContent = 'Aucune documentation disponible';
        countBadge.textContent = '0';
        return;
    }
    
    const currentMode = state.currentType || 'html';
    const suggested = getSuggestedDocs(currentMode);
    const suggestedIds = new Set(suggested.map(d => d.id));
    const others = state.documentations.filter(d => !suggestedIds.has(d.id));
    
    // Update count
    countBadge.textContent = state.selectedDocs.size;
    
    // Render suggested docs
    if (suggested.length > 0) {
        suggestedSection.style.display = 'block';
        suggestedSection.querySelector('.ai-docs-suggested-label').textContent = `üí° Sugg√©r√©es pour ${TYPES[currentMode]?.label || currentMode}:`;
        suggestedContainer.innerHTML = suggested.map(doc => `
            <div class="doc-chip suggested ${state.selectedDocs.has(doc.id) ? 'selected' : ''}" 
                 onclick="toggleDoc(${doc.id})" 
                 title="${doc.Description || doc.Nom}">
                üìö ${doc.Nom || 'Sans nom'}
            </div>
        `).join('');
    } else {
        suggestedSection.style.display = 'none';
    }
    
    // Render other docs
    if (others.length > 0) {
        otherSection.style.display = 'block';
        otherContainer.innerHTML = others.map(doc => `
            <div class="doc-chip ${state.selectedDocs.has(doc.id) ? 'selected' : ''}" 
                 onclick="toggleDoc(${doc.id})" 
                 title="${doc.Description || doc.Nom}">
                üìÑ ${doc.Nom || 'Sans nom'}
            </div>
        `).join('');
    } else {
        otherSection.style.display = 'none';
    }
}

function toggleDoc(docId) {
    if (state.selectedDocs.has(docId)) {
        state.selectedDocs.delete(docId);
    } else {
        state.selectedDocs.add(docId);
    }
    updateDocsList();
    updateAIContext(); // Met √† jour le compteur dans la barre de contexte
    saveConfig();
}

function toggleDocsSection() {
    state.docsCollapsed = !state.docsCollapsed;
    document.getElementById('docsContent').classList.toggle('collapsed', state.docsCollapsed);
    document.getElementById('docsToggle').textContent = state.docsCollapsed ? '‚ñ∂' : '‚ñº';
}

function getSelectedDocsContent() {
    return Array.from(state.selectedDocs)
        .map(id => state.documentations.find(d => d.id === id))
        .filter(Boolean)
        .map(doc => ({
            id: doc.id,
            name: doc.Nom,
            description: doc.Description,
            content: doc.Code
        }));
}

// ============ MODE SWITCH ============
function setMode(mode) {
    state.mode = mode;
    
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    document.querySelector(`.mode-btn.${mode}-mode`).classList.add('active');
    
    const indicator = document.getElementById('modeIndicator');
    indicator.className = 'mode-indicator ' + mode;
    document.getElementById('modeText').textContent = mode === 'edit' ? 'Mode √âdition' : 'Mode Ex√©cution';
    
    document.getElementById('factoryContainer').classList.toggle('active', mode === 'edit');
    document.getElementById('runtimeContainer').classList.toggle('active', mode === 'run');
    
    if (mode === 'run' && state.currentApp) {
        loadAppRuntime(state.currentApp);
    }
}

// ============ APP RUNTIME ============
function onAppSelect() {
    const id = parseInt(document.getElementById('appSelect').value);
    if (id) {
        const app = state.apps.find(a => a.id === id);
        if (app) {
            state.currentApp = app;
            document.getElementById('appBadge').style.display = 'inline';
            
            // Parse manifest
            try {
                app.manifest = JSON.parse(app.Code);
            } catch {
                app.manifest = { name: app.Nom, routes: [] };
            }
            
            if (state.mode === 'run') {
                loadAppRuntime(app);
            }
        }
    } else {
        state.currentApp = null;
        document.getElementById('appBadge').style.display = 'none';
    }
}

function loadAppRuntime(app) {
    if (!app.manifest) return;
    
    const manifest = app.manifest;
    const nav = document.getElementById('runtimeNav');
    const logo = document.getElementById('runtimeLogo');
    const title = document.getElementById('runtimeTitle');
    
    logo.textContent = manifest.icon || 'üì¶';
    title.textContent = manifest.name || 'Application';
    
    // Build navigation
    nav.innerHTML = '';
    (manifest.routes || []).forEach(route => {
        const item = document.createElement('div');
        item.className = 'nav-item' + (route.path === state.currentRoute ? ' active' : '');
        item.innerHTML = `
            <span class="nav-item-icon">${route.icon || 'üìÑ'}</span>
            <span class="nav-item-label">${route.label || route.path}</span>
        `;
        item.onclick = () => navigateToRoute(route.path);
        nav.appendChild(item);
    });
    
    // Load initial route
    navigateToRoute(state.currentRoute);
}

function navigateToRoute(path) {
    state.currentRoute = path;
    
    if (!state.currentApp?.manifest) return;
    
    const route = state.currentApp.manifest.routes?.find(r => r.path === path);
    
    // Update nav active state
    document.querySelectorAll('.nav-item').forEach((item, i) => {
        item.classList.toggle('active', state.currentApp.manifest.routes[i]?.path === path);
    });
    
    document.getElementById('runtimeBreadcrumb').textContent = route?.label || path;
    
    if (route?.artefact) {
        const artefact = state.artefacts.find(a => a.id === route.artefact);
        if (artefact) {
            renderInRuntime(artefact);
        } else {
            showRuntimeEmpty('Artefact non trouv√©: #' + route.artefact);
        }
    } else {
        showRuntimeEmpty('Aucun artefact assign√© √† cette route');
    }
}

function renderInRuntime(artefact) {
    const iframe = document.getElementById('runtimeIframe');
    state.runtimeIframe = iframe;
    
    let html = artefact.Code || '';
    const type = artefact.Type?.toLowerCase() || 'html';
    
    // Inject app runtime
    if (state.currentApp?.manifest) {
        html = injectAppRuntime(html, state.currentApp.manifest, state.currentRoute);
    }
    
    // Inject Grist bridge
    if (state.gristBridgeMode && html.includes('grist-plugin-api.js')) {
        html = injectGristBridge(html);
    }
    
    if (state.gristBridge) {
        state.gristBridge.setCurrentIframe(iframe);
    }
    
    if (type === 'react' || type === 'jsx') {
        html = buildReactHTML(artefact.Code);
    } else if (!html.includes('<!DOCTYPE') && !html.includes('<html')) {
        html = wrapHTML(html);
    }
    
    iframe.srcdoc = html;
}

function showRuntimeEmpty(msg) {
    const iframe = document.getElementById('runtimeIframe');
    iframe.srcdoc = `
        <!DOCTYPE html>
        <html>
        <head><script src="https://cdn.tailwindcss.com"><\/script></head>
        <body class="min-h-screen bg-gray-50 flex items-center justify-center">
            <div class="text-center p-8">
                <div class="text-6xl mb-4">üìÑ</div>
                <p class="text-gray-500">${msg}</p>
            </div>
        </body>
        </html>
    `;
}

function toggleSidebar() {
    const sidebar = document.getElementById('runtimeSidebar');
    sidebar.classList.toggle('collapsed');
    document.querySelector('.sidebar-toggle').textContent = 
        sidebar.classList.contains('collapsed') ? '‚ñ∂ √âtendre' : '‚óÄ R√©duire';
}

// ============ UI UPDATES ============
function showInit(msg, type) {
    const b = document.getElementById('initBanner');
    b.classList.remove('hidden', 'ok', 'err');
    if (type) {
        b.classList.add(type);
        b.querySelector('.init-spinner').style.display = 'none';
    }
    document.getElementById('initMsg').textContent = msg;
}

function hideInit() {
    document.getElementById('initBanner').classList.add('hidden');
}

function updateSelect() {
    const sel = document.getElementById('artSelect');
    sel.innerHTML = '<option value="">-- S√©lectionnez --</option>';
    
    // Group by type
    const groups = {};
    state.artefacts.forEach(a => {
        const type = a.Type || 'other';
        if (!groups[type]) groups[type] = [];
        groups[type].push(a);
    });
    
    Object.entries(groups).forEach(([type, items]) => {
        const grp = document.createElement('optgroup');
        grp.label = TYPES[type]?.icon + ' ' + (TYPES[type]?.label || type);
        items.forEach(a => {
            const opt = document.createElement('option');
            opt.value = a.id;
            opt.textContent = `${a.Nom || 'Sans nom'} (#${a.id})`;
            grp.appendChild(opt);
        });
        sel.appendChild(grp);
    });
    
    document.getElementById('artCount').textContent = state.artefacts.length;
    if (state.current) sel.value = state.current.id;
}

function updateAppSelect() {
    const sel = document.getElementById('appSelect');
    sel.innerHTML = '<option value="">-- Aucune application --</option>';
    
    state.apps.forEach(app => {
        const opt = document.createElement('option');
        opt.value = app.id;
        opt.textContent = `üì¶ ${app.Nom || 'App'} (#${app.id})`;
        sel.appendChild(opt);
    });
}

function updateDepsList() {
    const container = document.getElementById('depsList');
    const aiContainer = document.getElementById('aiDepsList');
    
    const otherArtefacts = state.artefacts.filter(a => a.id !== state.current?.id);
    
    if (otherArtefacts.length === 0) {
        container.innerHTML = '<p style="font-size:11px;color:var(--text2)">Aucun autre artefact disponible</p>';
        aiContainer.innerHTML = '<span style="font-size:11px;color:#065f46;opacity:0.8">Aucune d√©pendance</span>';
        return;
    }
    
    // For create modal
    container.innerHTML = otherArtefacts.map(a => `
        <div class="deps-item ${state.selectedDeps.has(a.id) ? 'selected' : ''}" onclick="toggleDep(${a.id})">
            <div class="deps-item-check">${state.selectedDeps.has(a.id) ? '‚úì' : ''}</div>
            <div class="deps-item-info">
                <div class="deps-item-name">${TYPES[a.Type]?.icon || 'üìÑ'} ${a.Nom || 'Sans nom'}</div>
                <div class="deps-item-type">${TYPES[a.Type]?.label || a.Type} ‚Ä¢ #${a.id}</div>
            </div>
        </div>
    `).join('');
    
    // For AI panel - show current artefact's dependencies
    if (state.current?.deps?.length > 0) {
        aiContainer.innerHTML = state.current.deps.map(depId => {
            const dep = state.artefacts.find(a => a.id === depId);
            if (!dep) return '';
            return `<div class="dep-chip selected">
                <span>${TYPES[dep.Type]?.icon || 'üìÑ'}</span>
                <span>${dep.Nom || 'Sans nom'}</span>
                <span class="dep-type">#${dep.id}</span>
            </div>`;
        }).join('');
    } else {
        aiContainer.innerHTML = '<span style="font-size:11px;color:#065f46;opacity:0.8">Aucune d√©pendance</span>';
    }
}

function toggleDep(id) {
    if (state.selectedDeps.has(id)) {
        state.selectedDeps.delete(id);
    } else {
        state.selectedDeps.add(id);
    }
    updateDepsList();
}

function onSelect() {
    const id = parseInt(document.getElementById('artSelect').value);
    if (id) selectArtefact(id);
}

function selectArtefact(id) {
    const art = state.artefacts.find(a => a.id === id);
    if (!art) return;
    
    state.current = art;
    document.getElementById('artSelect').value = id;
    
    const code = art.Code || '';
    const type = art.Type?.toLowerCase() || 'html';
    
    state.code = code;
    state.originalCode = code;
    state.currentType = type;
    state.isModified = false;
    state.consoleErrors = [];
    
    // Update UI
    document.getElementById('artName').textContent = art.Nom || 'Artefact';
    document.getElementById('artDesc').textContent = art.Description || 'Artefact';
    
    const badge = document.getElementById('typeBadge');
    const t = TYPES[type] || TYPES.html;
    badge.textContent = t.icon + ' ' + t.label;
    badge.className = 'type-badge ' + t.cls;
    badge.style.display = 'inline-block';
    
    // Update editor
    aceEditor.session.setMode('ace/mode/' + (t.mode || 'text'));
    aceEditor.setValue(code, -1);
    document.getElementById('codeInfo').textContent = code.split('\n').length + ' lignes';
    
    updateFooter(type, code);
    updateDepsList();
    updateDocsList(); // Met √† jour les suggestions de docs selon le mode
    updateAIContext();
    clearConsole();
    
    if (!code.trim()) {
        showEmpty();
        return;
    }
    
    setStatus('loading', 'Chargement...');
    render(type, code);
}

function updateFooter(type, code) {
    const t = TYPES[type] || TYPES.html;
    document.getElementById('footerType').textContent = t.icon + ' ' + t.label;
    document.getElementById('footerLines').textContent = 'üìù ' + code.split('\n').length + ' lignes';
}

function updateAIContext() {
    const type = state.currentType || 'html';
    const lines = state.code ? state.code.split('\n').length : 0;
    
    document.getElementById('ctxMode').textContent = TYPES[type]?.label || type;
    document.getElementById('ctxLines').textContent = lines + ' lignes';
    
    const appCtx = document.getElementById('ctxApp');
    if (state.currentApp) {
        appCtx.textContent = 'üì¶ ' + (state.currentApp.Nom || 'App');
        appCtx.style.display = 'inline';
    } else {
        appCtx.style.display = 'none';
    }
    
    // Update docs context tag
    const docsCtx = document.getElementById('ctxDocs');
    if (docsCtx) {
        if (state.selectedDocs.size > 0) {
            docsCtx.textContent = 'üìö ' + state.selectedDocs.size + ' doc(s)';
            docsCtx.style.display = 'inline';
        } else {
            docsCtx.style.display = 'none';
        }
    }
    
    // Update screenshot context tag
    const screenshotCtx = document.getElementById('ctxScreenshot');
    if (screenshotCtx) {
        screenshotCtx.style.display = state.includeScreenshot ? 'inline' : 'none';
    }
}

// ============ SCREENSHOT/VISION ============
function toggleScreenshot() {
    state.includeScreenshot = !state.includeScreenshot;
    const btn = document.getElementById('screenshotBtn');
    btn.classList.toggle('active', state.includeScreenshot);
    btn.title = state.includeScreenshot ? 
        'Capture d\'√©cran activ√©e (cliquer pour d√©sactiver)' : 
        'Inclure capture d\'√©cran (vision)';
    updateAIContext();
}

async function captureScreenshot(options = {}) {
    const {
        scale = 0.5,
        quality = 0.7
    } = options;
    
    const btn = document.getElementById('screenshotBtn');
    btn.classList.add('capturing');
    
    try {
        // Determine which iframe to capture based on mode
        let element = null;
        
        if (state.mode === 'run' && state.runtimeIframe) {
            // Runtime mode - capture runtime iframe
            try {
                element = state.runtimeIframe.contentDocument?.body;
            } catch (e) {
                console.warn('Cannot access runtime iframe:', e);
            }
        }
        
        if (!element && state.renderIframe) {
            // Edit mode or fallback - capture render preview
            try {
                element = state.renderIframe.contentDocument?.body;
            } catch (e) {
                console.warn('Cannot access render iframe:', e);
            }
        }
        
        // Fallback to device frame content
        if (!element) {
            const frame = document.getElementById('deviceFrame');
            const iframe = frame?.querySelector('iframe');
            if (iframe) {
                try {
                    element = iframe.contentDocument?.body;
                } catch (e) {
                    console.warn('Cannot access device frame iframe:', e);
                }
            }
        }
        
        if (!element) {
            console.warn('No capturable element found');
            return null;
        }
        
        const canvas = await html2canvas(element, {
            useCORS: true,
            allowTaint: true,
            scale,
            logging: false,
            backgroundColor: '#ffffff'
        });
        
        return canvas.toDataURL('image/jpeg', quality);
        
    } catch (e) {
        console.warn('Screenshot capture failed:', e);
        return null;
    } finally {
        btn.classList.remove('capturing');
    }
}

function setStatus(s, txt) {
    const dot = document.getElementById('statusDot');
    dot.className = 'status-dot';
    if (s === 'error') dot.classList.add('error');
    if (s === 'loading') dot.classList.add('loading');
    document.getElementById('statusTxt').textContent = txt;
}

function showEmpty() {
    document.getElementById('deviceFrame').innerHTML = `
        <div class="state-box">
            <div class="state-icon">üé®</div>
            <div class="state-title">√âditez l'artefact</div>
            <div class="state-desc">Utilisez l'√©diteur ou l'assistant IA (Ctrl+K)</div>
        </div>`;
    setStatus('ok', 'En attente');
}

// ============ RENDER ============
function render(type, code) {
    try {
        switch (type) {
            case 'app': renderAppManifest(code); break;
            case 'react': case 'jsx': case 'component': renderReact(code); break;
            case 'grist': renderGristWidget(code); break;
            case 'html': renderHTML(code); break;
            case 'svg': renderSVG(code); break;
            case 'markdown': renderMarkdown(code); break;
            default: renderHTML(code);
        }
    } catch (e) {
        setStatus('error', e.message);
    }
}

function renderAppManifest(code) {
    try {
        const manifest = JSON.parse(code);
        const frame = document.getElementById('deviceFrame');
        
        // Show manifest preview
        const routes = manifest.routes || [];
        frame.innerHTML = `
            <div style="padding:20px;font-family:system-ui;height:100%;overflow:auto;background:#f8fafc">
                <div style="max-width:600px;margin:0 auto">
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px">
                        <div style="width:48px;height:48px;background:linear-gradient(135deg,#059669,#10b981);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;color:#fff">${manifest.icon || 'üì¶'}</div>
                        <div>
                            <h1 style="font-size:20px;font-weight:bold;margin:0">${manifest.name || 'Application'}</h1>
                            <p style="font-size:12px;color:#64748b;margin:0">${manifest.description || ''}</p>
                        </div>
                    </div>
                    
                    <div style="background:#fff;border-radius:12px;border:1px solid #e2e8f0;overflow:hidden">
                        <div style="padding:12px 16px;background:#f1f5f9;border-bottom:1px solid #e2e8f0;font-size:12px;font-weight:600">
                            üìç Routes (${routes.length})
                        </div>
                        ${routes.map(r => `
                            <div style="padding:12px 16px;border-bottom:1px solid #f1f5f9;display:flex;align-items:center;gap:10px">
                                <span style="font-size:18px">${r.icon || 'üìÑ'}</span>
                                <div style="flex:1">
                                    <div style="font-weight:500">${r.label || r.path}</div>
                                    <div style="font-size:11px;color:#64748b">${r.path} ‚Üí Artefact #${r.artefact || 'Non assign√©'}</div>
                                </div>
                                ${r.artefact ? `<span style="padding:2px 8px;background:#dcfce7;color:#166534;border-radius:10px;font-size:10px">Li√©</span>` : `<span style="padding:2px 8px;background:#fef3c7;color:#92400e;border-radius:10px;font-size:10px">√Ä configurer</span>`}
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="margin-top:16px;padding:12px;background:#ecfdf5;border-radius:8px;font-size:11px;color:#065f46">
                        üí° Passez en mode <strong>Ex√©cution</strong> pour tester l'application
                    </div>
                </div>
            </div>
        `;
        setStatus('ok', 'Manifest valide');
    } catch (e) {
        setStatus('error', 'JSON invalide');
        document.getElementById('deviceFrame').innerHTML = `
            <div class="state-box" style="color:#ef4444">
                <div class="state-icon">‚ö†Ô∏è</div>
                <div class="state-title">Erreur JSON</div>
                <div class="state-desc">${e.message}</div>
            </div>`;
    }
}

function buildReactHTML(code) {
    return `<!DOCTYPE html><html><head><meta charset="UTF-8">
<script src="https://unpkg.com/react@18/umd/react.development.js"><\/script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"><\/script>
<script src="https://unpkg.com/@babel/standalone@7/babel.min.js"><\/script>
<script src="https://cdn.tailwindcss.com"><\/script>
<style>*{box-sizing:border-box}html,body,#root{margin:0;min-height:100%}</style>
</head><body><div id="root"></div>
<script>
${APP_RUNTIME_SCRIPT}
<\/script>
<script type="text/babel">
const{useState,useEffect,useRef,useMemo,useCallback}=React;
try{
${code.replace(/^import\s+.*$/gm, '').replace(/^export\s+default\s+/gm, '').replace(/^export\s+/gm, '')}
const C=typeof App!=="undefined"?App:typeof Component!=="undefined"?Component:null;
if(C)ReactDOM.createRoot(document.getElementById("root")).render(<C/>);
window.parent.postMessage({type:"ready"},"*");
}catch(e){
document.getElementById("root").innerHTML="<div style='padding:20px;background:#fee2e2;color:#991b1b'>"+e.message+"</div>";
window.parent.postMessage({type:"error",message:e.message},"*");
}
<\/script></body></html>`;
}

function renderReact(code) {
    renderFrame(buildReactHTML(code));
}

function wrapHTML(code) {
    return `<!DOCTYPE html><html><head><meta charset="UTF-8">
<script src="https://cdn.tailwindcss.com"><\/script>
<style>*{box-sizing:border-box}html,body{margin:0;min-height:100%}</style>
</head><body>
<script>${APP_RUNTIME_SCRIPT}<\/script>
${code}
<script>window.parent.postMessage({type:"ready"},"*")<\/script>
</body></html>`;
}

function renderHTML(code) {
    let html = code;
    if (!html.includes('<!DOCTYPE') && !html.includes('<html')) {
        html = wrapHTML(html);
    }
    renderFrame(html);
}

function renderGristWidget(code) {
    let html = code;
    if (state.gristBridgeMode && code.includes('grist-plugin-api.js')) {
        html = injectGristBridge(code);
    }
    // Inject app runtime
    html = injectAppRuntime(html, state.currentApp?.manifest || null, '/');
    renderFrame(html);
}

function renderFrame(html) {
    const frame = document.getElementById('deviceFrame');
    
    let iframe = state.renderIframe;
    if (!iframe || !iframe.parentNode) {
        iframe = document.createElement('iframe');
        iframe.className = 'render-iframe';
        iframe.sandbox = 'allow-scripts allow-same-origin';
        state.renderIframe = iframe;
        frame.innerHTML = '';
        frame.appendChild(iframe);
    }
    
    if (state.gristBridge) {
        state.gristBridge.setCurrentIframe(iframe);
    }
    
    iframe.srcdoc = html;
    iframe.onload = () => setStatus('ok', 'Pr√™t');
}

function renderSVG(code) {
    const frame = document.getElementById('deviceFrame');
    state.renderIframe = null;
    frame.innerHTML = `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:#f8fafc;padding:20px">${code}</div>`;
    setStatus('ok', 'SVG');
}

function renderMarkdown(code) {
    const frame = document.getElementById('deviceFrame');
    state.renderIframe = null;
    frame.innerHTML = `<div style="padding:20px;max-width:700px;margin:0 auto;line-height:1.6;height:100%;overflow:auto">${marked.parse(code)}</div>`;
    setStatus('ok', 'Markdown');
}

// ============ GRAPH ============
function buildGraph() {
    state.graphNodes = state.artefacts.map(a => ({
        id: a.id,
        label: a.Nom || 'Sans nom',
        type: a.Type,
        deps: a.deps || []
    }));
    
    state.graphEdges = [];
    state.artefacts.forEach(a => {
        (a.deps || []).forEach(depId => {
            state.graphEdges.push({ from: a.id, to: depId });
        });
    });
}

function showGraph() {
    document.getElementById('graphOverlay').classList.add('visible');
    drawGraph();
}

function closeGraph() {
    document.getElementById('graphOverlay').classList.remove('visible');
}

function closeGraphOnOverlay(e) {
    if (e.target.classList.contains('graph-overlay')) closeGraph();
}

function drawGraph() {
    const canvas = document.getElementById('graphCanvas');
    const ctx = canvas.getContext('2d');
    const rect = canvas.parentElement.getBoundingClientRect();
    canvas.width = rect.width;
    canvas.height = rect.height;
    
    const nodes = state.graphNodes;
    const edges = state.graphEdges;
    
    if (nodes.length === 0) {
        ctx.fillStyle = '#64748b';
        ctx.font = '14px system-ui';
        ctx.textAlign = 'center';
        ctx.fillText('Aucun artefact', canvas.width / 2, canvas.height / 2);
        return;
    }
    
    // Position nodes in a circle
    const cx = canvas.width / 2;
    const cy = canvas.height / 2;
    const radius = Math.min(canvas.width, canvas.height) * 0.35;
    
    const nodePositions = {};
    nodes.forEach((node, i) => {
        const angle = (i / nodes.length) * Math.PI * 2 - Math.PI / 2;
        nodePositions[node.id] = {
            x: cx + Math.cos(angle) * radius,
            y: cy + Math.sin(angle) * radius
        };
    });
    
    // Draw edges
    ctx.strokeStyle = '#cbd5e1';
    ctx.lineWidth = 2;
    edges.forEach(edge => {
        const from = nodePositions[edge.from];
        const to = nodePositions[edge.to];
        if (from && to) {
            ctx.beginPath();
            ctx.moveTo(from.x, from.y);
            ctx.lineTo(to.x, to.y);
            ctx.stroke();
            
            // Arrow
            const angle = Math.atan2(to.y - from.y, to.x - from.x);
            const arrowLen = 10;
            ctx.beginPath();
            ctx.moveTo(to.x - 20 * Math.cos(angle), to.y - 20 * Math.sin(angle));
            ctx.lineTo(
                to.x - 20 * Math.cos(angle) - arrowLen * Math.cos(angle - Math.PI / 6),
                to.y - 20 * Math.sin(angle) - arrowLen * Math.sin(angle - Math.PI / 6)
            );
            ctx.moveTo(to.x - 20 * Math.cos(angle), to.y - 20 * Math.sin(angle));
            ctx.lineTo(
                to.x - 20 * Math.cos(angle) - arrowLen * Math.cos(angle + Math.PI / 6),
                to.y - 20 * Math.sin(angle) - arrowLen * Math.sin(angle + Math.PI / 6)
            );
            ctx.stroke();
        }
    });
    
    // Draw nodes
    const colors = {
        app: '#10b981',
        grist: '#3b82f6',
        component: '#f59e0b',
        markdown: '#8b5cf6',
        react: '#06b6d4',
        html: '#f97316'
    };
    
    nodes.forEach(node => {
        const pos = nodePositions[node.id];
        const color = colors[node.type] || '#64748b';
        
        // Circle
        ctx.beginPath();
        ctx.arc(pos.x, pos.y, 20, 0, Math.PI * 2);
        ctx.fillStyle = color;
        ctx.fill();
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 3;
        ctx.stroke();
        
        // Label
        ctx.fillStyle = '#0f172a';
        ctx.font = '12px system-ui';
        ctx.textAlign = 'center';
        ctx.fillText(node.label, pos.x, pos.y + 35);
        
        // Type icon
        ctx.fillStyle = '#fff';
        ctx.font = '14px system-ui';
        ctx.fillText(TYPES[node.type]?.icon || 'üìÑ', pos.x, pos.y + 5);
    });
}

// ============ CODE EDITOR ============
function onCodeChange() {
    const code = aceEditor.getValue();
    state.code = code;
    state.isModified = code !== state.originalCode;
    
    document.getElementById('codeInfo').textContent = code.split('\n').length + ' lignes';
    document.getElementById('codeModified').style.display = state.isModified ? 'inline' : 'none';
    updateFooter(state.currentType, code);
    
    if (document.getElementById('hotReload').checked && state.view === 'split') {
        clearTimeout(state.hotReloadTimer);
        state.hotReloadTimer = setTimeout(() => {
            setStatus('loading', 'Compilation...');
            render(state.currentType, code);
        }, 800);
    }
}

function applyCode() {
    const code = aceEditor.getValue();
    state.code = code;
    clearConsole();
    setStatus('loading', 'Compilation...');
    render(state.currentType, code);
}

// ============ VIEW CONTROLS ============
function setView(v) {
    state.view = v;
    const panels = document.getElementById('panels');
    const renderZone = document.getElementById('renderZone');
    const codeZone = document.getElementById('codeZone');
    const splitter = document.getElementById('splitter');
    
    panels.classList.remove('split-h');
    codeZone.classList.remove('visible');
    renderZone.style.display = 'flex';
    splitter.style.display = 'none';
    renderZone.style.flex = '';
    codeZone.style.flex = '';
    
    document.querySelectorAll('#factoryContainer .toolbar .btn').forEach(b => b.classList.remove('active'));
    
    if (v === 'render') {
        document.getElementById('btnRender').classList.add('active');
    } else if (v === 'code') {
        document.getElementById('btnCode').classList.add('active');
        renderZone.style.display = 'none';
        codeZone.classList.add('visible');
        setTimeout(() => aceEditor.resize(), 10);
    } else if (v === 'split') {
        document.getElementById('btnSplit').classList.add('active');
        panels.classList.add('split-h');
        codeZone.classList.add('visible');
        splitter.style.display = 'block';
        applySplitRatio();
        setTimeout(() => aceEditor.resize(), 10);
    }
}

function toggleConsole() {
    state.showConsole = !state.showConsole;
    document.getElementById('consoleZone').classList.toggle('visible', state.showConsole);
    document.getElementById('btnConsole').classList.toggle('active', state.showConsole);
}

function toggleBridgeMode() {
    state.gristBridgeMode = document.getElementById('bridgeToggle').checked;
    if (state.current && state.code) render(state.currentType, state.code);
}

function toggleAIPanel() {
    state.showAIPanel = !state.showAIPanel;
    document.getElementById('aiPanel').classList.toggle('visible', state.showAIPanel);
    document.getElementById('btnAI').classList.toggle('active', state.showAIPanel);
}

// ============ CONSOLE ============
function onMessage(e) {
    const d = e.data;
    if (!d || !d.type) return;
    
    if (d.type === 'ready') setStatus('ok', 'Pr√™t');
    if (d.type === 'error') {
        setStatus('error', d.message);
        state.consoleErrors.push(d.message);
        addConsole('error', [d.message]);
    }
    if (d.type === 'console') {
        addConsole(d.method, d.args);
    }
    
    // App runtime messages
    if (d.type === 'app-navigate') {
        navigateToRoute(d.path);
    }
    if (d.type === 'app-event') {
        // Broadcast to all iframes
        console.log('üì¢ App event:', d.event, d.data);
    }
}

function addConsole(method, args) {
    const el = document.getElementById('consoleContent');
    const line = document.createElement('div');
    line.className = 'console-line ' + method;
    const p = { log: '‚Ä∫', warn: '‚ö†', error: '‚úï', info: '‚Ñπ' }[method] || '‚Ä∫';
    line.textContent = p + ' ' + args.join(' ');
    el.appendChild(line);
    el.scrollTop = el.scrollHeight;
}

function clearConsole() {
    document.getElementById('consoleContent').innerHTML = '';
    state.consoleErrors = [];
}

// ============ AI ============
function openQuickPrompt() {
    document.getElementById('quickPromptOverlay').classList.add('visible');
    document.getElementById('quickPromptInput').value = '';
    setTimeout(() => document.getElementById('quickPromptInput').focus(), 100);
}

function closeQuickPrompt() {
    document.getElementById('quickPromptOverlay').classList.remove('visible');
}

function closeQuickPromptOnOverlay(e) {
    if (e.target.classList.contains('quick-prompt-overlay')) closeQuickPrompt();
}

function useHint(hint) {
    document.getElementById('quickPromptInput').value = hint;
    document.getElementById('quickPromptInput').focus();
}

function onQuickPromptKeydown(e) {
    if (e.key === 'Enter') { e.preventDefault(); submitQuickPrompt(); }
    if (e.key === 'Escape') closeQuickPrompt();
}

function onAIInputKeydown(e) {
    if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
        e.preventDefault();
        sendAIRequest();
    }
}

async function submitQuickPrompt() {
    const prompt = document.getElementById('quickPromptInput').value.trim();
    if (!prompt) return;
    closeQuickPrompt();
    if (!state.showAIPanel) toggleAIPanel();
    document.getElementById('aiInput').value = prompt;
    await sendAIRequest();
}

async function sendAIRequest() {
    const prompt = document.getElementById('aiInput').value.trim();
    if (!prompt || state.aiProcessing) return;
    
    const webhookUrl = document.getElementById('webhookUrl').value.trim();
    if (!webhookUrl) {
        addAIMessage('error', '‚ö†Ô∏è Configurez l\'URL du webhook');
        return;
    }
    
    state.aiProcessing = true;
    setAIStatus('loading', 'G√©n√©ration...');
    document.getElementById('aiSendBtn').disabled = true;
    
    addAIMessage('user', prompt);
    document.getElementById('aiInput').value = '';
    
    // Capturer la s√©lection dans l'√©diteur
    const selection = aceEditor.getSelection();
    const selectionRange = selection.getRange();
    const hasSelection = !selectionRange.isEmpty();
    let selectionData = null;
    
    if (hasSelection) {
        selectionData = {
            startLine: selectionRange.start.row + 1,
            endLine: selectionRange.end.row + 1,
            startColumn: selectionRange.start.column,
            endColumn: selectionRange.end.column,
            text: aceEditor.getSelectedText()
        };
    }
    
    // Build context with documentation and selection
    const context = {
        prompt,
        code: state.code,
        mode: state.currentType,
        artefactId: state.current?.id,
        artefactName: state.current?.Nom,
        dependencies: state.current?.deps || [],
        
        // S√©lection de code
        selection: selectionData,
        hasSelection,
        
        // Documentation s√©lectionn√©e
        documentation: getSelectedDocsContent(),
        
        app: state.currentApp ? {
            id: state.currentApp.id,
            name: state.currentApp.Nom,
            manifest: state.currentApp.manifest
        } : null,
        allArtefacts: state.artefacts.map(a => ({
            id: a.id,
            name: a.Nom,
            type: a.Type,
            deps: a.deps
        })),
        console: state.consoleErrors.slice(-5),
        timestamp: new Date().toISOString(),
        
        // Vision/Screenshot
        useVision: state.includeScreenshot,
        visualContext: state.includeScreenshot ? {
            editorMode: state.mode,  // 'edit' | 'run'
            device: 'desktop'
        } : null
    };
    
    // Capture screenshot if vision is enabled
    if (state.includeScreenshot) {
        setAIStatus('loading', 'Capture √©cran...');
        const screenshot = await captureScreenshot({ scale: 0.5, quality: 0.7 });
        if (screenshot) {
            context.screenshot = screenshot;
            // Estimate size for logging
            const sizeKB = Math.round((screenshot.length * 3/4) / 1024);
            console.log('üì∏ Screenshot captured:', sizeKB + 'KB');
        } else {
            context.useVision = false;
            addAIMessage('system', '‚ö†Ô∏è Capture d\'√©cran √©chou√©e, envoi sans vision');
        }
        setAIStatus('loading', 'G√©n√©ration...');
    }
    
    // Log context for debug
    console.log('üì§ Contexte IA:', {
        mode: context.mode,
        docs: context.documentation.length,
        hasApp: !!context.app,
        deps: context.dependencies.length,
        hasSelection: context.hasSelection,
        selectionLines: selectionData ? `${selectionData.startLine}-${selectionData.endLine}` : null,
        useVision: context.useVision,
        screenshotSize: context.screenshot ? Math.round((context.screenshot.length * 3/4) / 1024) + 'KB' : null
    });
    
    try {
        const response = await fetch(webhookUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                ...(document.getElementById('apiKey').value && {
                    'Authorization': 'Bearer ' + document.getElementById('apiKey').value
                })
            },
            body: JSON.stringify(context)
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const result = await response.json();
        handleAIResponse(result);
        
    } catch (e) {
        addAIMessage('error', '‚ùå ' + e.message);
        setAIStatus('error', 'Erreur');
    } finally {
        state.aiProcessing = false;
        document.getElementById('aiSendBtn').disabled = false;
    }
    
    saveConfig();
}

// ============ GESTION R√âPONSES IA AVEC OP√âRATIONS ============

function handleAIResponse(result) {
    if (result.error || result.success === false) {
        addAIMessage('error', '‚ùå ' + (result.error || 'Erreur inconnue'));
        setAIStatus('error', 'Erreur');
        return;
    }
    
    // Nouveau format avec op√©rations
    if (result.operations && Array.isArray(result.operations)) {
        applyOperations(result.operations, result.strategy, result.message);
        return;
    }
    
    // Ancien format (fallback)
    const code = result.code || result.content;
    const message = result.message || result.explanation;
    
    if (code) {
        aceEditor.setValue(code, -1);
        state.code = code;
        state.isModified = true;
        document.getElementById('codeModified').style.display = 'inline';
        
        clearConsole();
        setStatus('loading', 'Compilation...');
        render(state.currentType, state.code);
        
        addAIMessage('assistant', message || '‚úÖ Code g√©n√©r√©');
        setAIStatus('ok', 'Termin√©');
    } else if (message) {
        addAIMessage('assistant', message);
        setAIStatus('ok', 'R√©ponse re√ßue');
    }
}

function applyOperations(operations, strategy, message) {
    const session = aceEditor.getSession();
    const doc = session.getDocument();
    
    // Tri des op√©rations par ligne d√©croissante pour √©viter les d√©calages
    const sortedOps = [...operations].sort((a, b) => {
        const lineA = a.startLine || a.afterLine || 0;
        const lineB = b.startLine || b.afterLine || 0;
        return lineB - lineA;
    });
    
    let appliedCount = 0;
    let details = [];
    
    for (const op of sortedOps) {
        try {
            switch (op.type) {
                case 'full':
                    // Remplacement complet
                    aceEditor.setValue(op.code, -1);
                    appliedCount++;
                    details.push('üîÑ R√©√©criture compl√®te');
                    break;
                    
                case 'replace':
                    if (op.startLine && op.endLine && op.code) {
                        // Convertir en 0-indexed pour Ace
                        const startRow = op.startLine - 1;
                        const endRow = op.endLine - 1;
                        
                        // Supprimer les lignes existantes
                        const range = new ace.Range(startRow, 0, endRow, session.getLine(endRow).length);
                        session.replace(range, op.code);
                        
                        appliedCount++;
                        details.push(`‚úèÔ∏è Lignes ${op.startLine}-${op.endLine} modifi√©es`);
                    }
                    break;
                    
                case 'insert':
                    if (op.afterLine && op.code) {
                        // Ins√©rer apr√®s la ligne sp√©cifi√©e
                        const insertRow = op.afterLine; // afterLine est d√©j√† la bonne position
                        const insertText = '\n' + op.code;
                        
                        const lineLength = session.getLine(op.afterLine - 1)?.length || 0;
                        session.insert({ row: op.afterLine - 1, column: lineLength }, insertText);
                        
                        appliedCount++;
                        details.push(`‚ûï Insertion apr√®s ligne ${op.afterLine}`);
                    }
                    break;
                    
                case 'delete':
                    if (op.startLine && op.endLine) {
                        const startRow = op.startLine - 1;
                        const endRow = op.endLine;
                        
                        // Supprimer les lignes (y compris le saut de ligne)
                        const range = new ace.Range(startRow, 0, endRow, 0);
                        session.remove(range);
                        
                        appliedCount++;
                        details.push(`üóëÔ∏è Lignes ${op.startLine}-${op.endLine} supprim√©es`);
                    }
                    break;
            }
        } catch (e) {
            console.error('Erreur op√©ration:', op, e);
            details.push(`‚ö†Ô∏è √âchec: ${op.type}`);
        }
    }
    
    // Mettre √† jour l'√©tat
    state.code = aceEditor.getValue();
    state.isModified = true;
    document.getElementById('codeModified').style.display = 'inline';
    
    // Actualiser le rendu
    clearConsole();
    setStatus('loading', 'Compilation...');
    render(state.currentType, state.code);
    
    // Message r√©capitulatif
    const strategyIcon = strategy === 'partial' ? 'üéØ' : 'üìù';
    const summaryMsg = `${strategyIcon} ${appliedCount} op√©ration(s) appliqu√©e(s)\n${details.join('\n')}\n\n${message || ''}`;
    
    addAIMessage('assistant', summaryMsg);
    setAIStatus('ok', strategy === 'partial' ? '√âdition cibl√©e' : 'Termin√©');
}

function addAIMessage(role, content) {
    const conv = document.getElementById('aiConversation');
    const msg = document.createElement('div');
    msg.className = 'ai-message ' + role;
    msg.innerHTML = content.replace(/\n/g, '<br>');
    conv.appendChild(msg);
    conv.scrollTop = conv.scrollHeight;
    state.aiConversation.push({ role, content });
}

function setAIStatus(status, text) {
    const dot = document.getElementById('aiStatusDot');
    dot.className = 'ai-status-dot';
    if (status === 'loading') dot.classList.add('loading');
    document.getElementById('aiStatusText').textContent = text;
}

// ============ KEYBOARD ============
function onKeyDown(e) {
    if (e.key === 'Escape') {
        if (document.getElementById('quickPromptOverlay').classList.contains('visible')) {
            closeQuickPrompt();
        } else if (document.getElementById('graphOverlay').classList.contains('visible')) {
            closeGraph();
        } else if (document.getElementById('createModal').classList.contains('visible')) {
            closeCreateModal();
        }
    }
    
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        openQuickPrompt();
    }
}

// ============ CREATE / SAVE ============
function openCreateModal() {
    document.getElementById('createModal').classList.add('visible');
    document.getElementById('newName').value = '';
    document.getElementById('newDesc').value = '';
    document.getElementById('newAIPrompt').value = '';
    state.selectedDeps = new Set();
    selectType('grist');
    updateDepsList();
    setTimeout(() => document.getElementById('newName').focus(), 100);
}

function closeCreateModal() {
    document.getElementById('createModal').classList.remove('visible');
}

function closeModalOnOverlay(e) {
    if (e.target.classList.contains('modal-overlay')) closeCreateModal();
}

function selectType(type) {
    state.selectedType = type;
    document.querySelectorAll('.type-card').forEach(c => c.classList.remove('selected'));
    document.querySelector(`.type-card[data-type="${type}"]`)?.classList.add('selected');
}

async function createArtefact() {
    const name = document.getElementById('newName').value.trim();
    const desc = document.getElementById('newDesc').value.trim();
    const type = state.selectedType;
    const aiPrompt = document.getElementById('newAIPrompt').value.trim();
    const deps = Array.from(state.selectedDeps);
    
    if (!name) {
        alert('Veuillez entrer un nom');
        return;
    }
    
    const code = TYPES[type]?.template || '';
    const isDoc = type === 'markdown';
    
    try {
        await grist.docApi.applyUserActions([
            ['AddRecord', TABLE_NAME, null, {
                Nom: name,
                Type: type,
                Code: code,
                Description: desc,
                Dependencies: JSON.stringify(deps),
                IsDoc: isDoc,
                Icon: TYPES[type]?.icon || 'üìÑ',
                CreatedAt: Date.now() / 1000
            }]
        ]);
        
        closeCreateModal();
        await loadArtefacts();
        
        const newArt = state.artefacts[state.artefacts.length - 1];
        if (newArt) {
            selectArtefact(newArt.id);
            
            if (aiPrompt) {
                setTimeout(() => {
                    if (!state.showAIPanel) toggleAIPanel();
                    document.getElementById('aiInput').value = aiPrompt;
                    sendAIRequest();
                }, 500);
            }
        }
        
    } catch (e) {
        console.error(e);
        alert('Erreur: ' + e.message);
    }
}

async function saveToGrist() {
    if (!state.current) {
        alert('Aucun artefact s√©lectionn√©');
        return;
    }
    
    const code = aceEditor.getValue();
    
    try {
        await grist.docApi.applyUserActions([
            ['UpdateRecord', TABLE_NAME, state.current.id, {
                Code: code,
                Type: state.currentType
            }]
        ]);
        
        state.originalCode = code;
        state.isModified = false;
        document.getElementById('codeModified').style.display = 'none';
        
        const art = state.artefacts.find(a => a.id === state.current.id);
        if (art) art.Code = code;
        
        // Update app manifest if needed
        if (state.currentType === 'app' && art) {
            try {
                art.manifest = JSON.parse(code);
            } catch {}
        }
        
        setStatus('ok', 'Sauvegard√© ‚úì');
        buildGraph();
        
    } catch (e) {
        console.error(e);
        alert('Erreur: ' + e.message);
    }
}

function copyCode() {
    navigator.clipboard.writeText(aceEditor.getValue()).then(() => {
        setStatus('ok', 'Copi√© ‚úì');
    });
}

function refresh() {
    if (state.current) {
        clearConsole();
        selectArtefact(state.current.id);
    } else {
        loadArtefacts();
    }
}

// ============ INIT ============
document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>