<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban - TaskFlow v9</title>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --primary: #4f46e5; --primary-dark: #4338ca; --primary-light: #e0e7ff;
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --info: #3b82f6;
            --bg: #f8fafc; --card-bg: #ffffff; --text: #1e293b; --text-muted: #64748b; --text-light: #94a3b8;
            --border: #e2e8f0; --border-dark: #cbd5e1;
            --shadow: 0 1px 3px rgba(0,0,0,0.1); --shadow-lg: 0 10px 40px rgba(0,0,0,0.15);
            --panel-width: 340px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; }

        /* Header */
        .header { background: var(--card-bg); border-bottom: 1px solid var(--border); padding: 12px 16px; display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-shrink: 0; }
        .header h1 { font-size: 1.25rem; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        .header-center { display: flex; align-items: center; gap: 8px; flex: 1; justify-content: center; }
        .header-right { display: flex; align-items: center; gap: 8px; }
        .btn { padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border); font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 0.8rem; transition: all 0.2s; background: var(--card-bg); color: var(--text); }
        .btn:hover { background: var(--bg); }
        .btn.primary { background: var(--primary); color: white; border-color: var(--primary); }
        .group-selector { display: flex; gap: 2px; background: var(--bg); padding: 3px; border-radius: 8px; }
        .group-selector .btn { border: none; background: transparent; padding: 5px 10px; border-radius: 5px; font-size: 0.75rem; }
        .group-selector .btn.active { background: var(--primary); color: white; }

        /* Filters */
        .filter-bar { background: var(--card-bg); border-bottom: 1px solid var(--border); padding: 8px 16px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .filter-dropdown { position: relative; }
        .filter-btn { padding: 6px 10px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 6px; font-size: 0.75rem; cursor: pointer; display: flex; align-items: center; gap: 4px; color: var(--text-muted); }
        .filter-btn:hover { border-color: var(--border-dark); color: var(--text); }
        .filter-btn.has-filter { background: var(--primary-light); border-color: var(--primary); color: var(--primary); }
        .filter-menu { position: absolute; top: 100%; left: 0; margin-top: 4px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; box-shadow: var(--shadow-lg); min-width: 160px; padding: 6px; z-index: 200; display: none; max-height: 280px; overflow-y: auto; }
        .filter-menu.open { display: block; }
        .filter-option { padding: 6px 8px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 0.8rem; }
        .filter-option:hover { background: var(--bg); }
        .filter-option input { margin: 0; }
        .search-box { position: relative; }
        .search-box input { padding: 6px 10px 6px 28px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.75rem; width: 160px; }
        .search-box::before { content: "üîç"; position: absolute; left: 8px; top: 50%; transform: translateY(-50%); font-size: 0.7rem; opacity: 0.5; }

        /* Main */
        .main-content { display: flex; flex: 1; overflow: hidden; position: relative; }
        .kanban-container { flex: 1; display: flex; gap: 16px; padding: 16px; overflow-x: auto; transition: margin-right 0.25s ease; }
        .kanban-container.panel-open { margin-right: var(--panel-width); }

        /* Columns */
        .kanban-column { min-width: 280px; max-width: 320px; flex: 1; background: var(--bg); border-radius: 12px; display: flex; flex-direction: column; max-height: 100%; }
        .column-header { padding: 12px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); }
        .column-title { font-weight: 600; font-size: 0.85rem; display: flex; align-items: center; gap: 8px; }
        .column-count { background: var(--border); color: var(--text-muted); padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: 600; }
        .column-add { width: 28px; height: 28px; border: none; background: var(--card-bg); border-radius: 6px; cursor: pointer; color: var(--text-muted); font-size: 1rem; }
        .column-add:hover { background: var(--primary-light); color: var(--primary); }
        .column-body { flex: 1; padding: 8px; overflow-y: auto; min-height: 100px; }

        /* Cards */
        .task-card { background: var(--card-bg); border-radius: 8px; padding: 12px; margin-bottom: 8px; cursor: pointer; border-left: 4px solid var(--info); box-shadow: var(--shadow); transition: all 0.15s; }
        .task-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .task-card.selected { outline: 2px solid var(--primary); outline-offset: 1px; }
        .task-card.p1 { border-left-color: var(--danger); }
        .task-card.p2 { border-left-color: var(--warning); }
        .task-card.p3 { border-left-color: var(--info); }
        .task-card.p4 { border-left-color: var(--text-muted); }
        .task-card.done { opacity: 0.6; }
        .task-card.sortable-ghost { opacity: 0.4; }
        .task-card.sortable-chosen { box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .card-header { display: flex; align-items: flex-start; justify-content: space-between; gap: 8px; margin-bottom: 6px; }
        .card-title { font-weight: 500; font-size: 0.85rem; flex: 1; }
        .card-type { font-size: 0.75rem; }
        .card-meta { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; font-size: 0.7rem; color: var(--text-muted); }
        .card-project { display: flex; align-items: center; gap: 3px; }
        .card-deps { display: flex; align-items: center; gap: 2px; }
        .card-progress { height: 3px; background: var(--border); border-radius: 2px; margin-top: 8px; overflow: hidden; }
        .card-progress-fill { height: 100%; border-radius: 2px; }
        .card-progress-fill.p1 { background: var(--danger); }
        .card-progress-fill.p2 { background: var(--warning); }
        .card-progress-fill.p3 { background: var(--info); }
        .card-progress-fill.p4 { background: var(--text-muted); }
        .card-assignees { display: flex; margin-top: 8px; }
        .card-avatar { width: 24px; height: 24px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 0.6rem; font-weight: 600; margin-left: -6px; border: 2px solid var(--card-bg); }
        .card-avatar:first-child { margin-left: 0; }
        .card-avatar.more { background: var(--text-muted); }

        /* Panel */
        .panel { position: absolute; top: 0; right: 0; width: var(--panel-width); height: 100%; background: var(--card-bg); border-left: 1px solid var(--border); display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.25s ease; z-index: 50; }
        .panel.open { transform: translateX(0); }
        .panel-header { padding: 12px 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; background: var(--bg); gap: 8px; }
        .panel-nav { display: flex; align-items: center; gap: 6px; flex: 1; min-width: 0; }
        .panel-nav-btn { width: 28px; height: 28px; border: 1px solid var(--border); background: var(--card-bg); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-muted); font-size: 0.75rem; flex-shrink: 0; }
        .panel-nav-btn:hover { background: var(--bg); color: var(--text); }
        .panel-nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .panel-title { font-weight: 600; font-size: 0.9rem; flex: 1; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .panel-close { width: 28px; height: 28px; border: none; background: transparent; border-radius: 6px; cursor: pointer; color: var(--text-muted); font-size: 1.1rem; }
        .panel-close:hover { background: var(--bg); color: var(--text); }
        .panel-content { flex: 1; overflow-y: auto; padding: 16px; }
        .panel-footer { padding: 12px 16px; border-top: 1px solid var(--border); }
        .panel-btn { padding: 10px 16px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 0.85rem; font-weight: 500; cursor: pointer; width: 100%; }
        .panel-btn:hover { background: var(--primary-dark); }
        .panel-btn:disabled { background: var(--border); cursor: not-allowed; }
        .panel-btn.success { background: var(--success); }
        .panel-btn.danger { background: transparent; color: var(--danger); border: 1px solid var(--danger); }
        .panel-btn.danger:hover { background: var(--danger); color: white; }
        .panel-section { margin-bottom: 16px; padding-bottom: 14px; border-bottom: 1px solid var(--border); }
        .panel-section:last-child { border-bottom: none; }

        /* Form */
        .type-selector { display: flex; gap: 6px; margin-bottom: 16px; background: var(--bg); padding: 4px; border-radius: 8px; }
        .type-option { flex: 1; padding: 8px 6px; border: none; background: transparent; border-radius: 6px; text-align: center; cursor: pointer; font-size: 0.75rem; font-weight: 500; color: var(--text-muted); }
        .type-option:hover { background: var(--card-bg); }
        .type-option.selected { background: var(--card-bg); color: var(--text); box-shadow: var(--shadow); }
        .type-option-icon { display: block; font-size: 1rem; margin-bottom: 2px; }
        .form-group { margin-bottom: 14px; }
        .form-label { display: block; font-size: 0.7rem; font-weight: 600; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.85rem; color: var(--text); background: var(--card-bg); }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
        .form-input.title-input { font-size: 1rem; font-weight: 600; border: none; padding: 8px 0; background: transparent; border-bottom: 2px solid var(--border); border-radius: 0; }
        .form-input.title-input:focus { border-bottom-color: var(--primary); box-shadow: none; }
        .form-textarea { min-height: 70px; resize: vertical; font-size: 0.8rem; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .priority-selector { display: flex; gap: 6px; }
        .priority-pill { flex: 1; padding: 8px 4px; border: 2px solid var(--border); border-radius: 8px; text-align: center; cursor: pointer; font-size: 0.7rem; font-weight: 600; background: var(--card-bg); }
        .priority-pill.p1 { border-color: var(--danger); color: var(--danger); }
        .priority-pill.p1.selected { background: var(--danger); color: white; }
        .priority-pill.p2 { border-color: var(--warning); color: var(--warning); }
        .priority-pill.p2.selected { background: var(--warning); color: white; }
        .priority-pill.p3 { border-color: var(--info); color: var(--info); }
        .priority-pill.p3.selected { background: var(--info); color: white; }
        .priority-pill.p4 { border-color: var(--text-muted); color: var(--text-muted); }
        .priority-pill.p4.selected { background: var(--text-muted); color: white; }
        .status-selector { display: flex; gap: 6px; flex-wrap: wrap; }
        .status-pill { padding: 6px 10px; border: 1px solid var(--border); border-radius: 20px; font-size: 0.72rem; cursor: pointer; background: var(--card-bg); }
        .status-pill:hover { border-color: var(--primary); }
        .status-pill.selected { background: var(--primary); color: white; border-color: var(--primary); }
        .progress-container { display: flex; align-items: center; gap: 10px; }
        .progress-slider { flex: 1; -webkit-appearance: none; height: 6px; border-radius: 3px; background: var(--border); }
        .progress-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: var(--primary); cursor: pointer; }
        .progress-value { font-size: 0.85rem; font-weight: 600; color: var(--primary); min-width: 40px; text-align: right; }

        /* Multi-select */
        .multi-select { position: relative; }
        .multi-select-trigger { min-height: 40px; padding: 6px 10px; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; gap: 8px; background: var(--card-bg); }
        .multi-select.open .multi-select-trigger { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
        .multi-select-values { display: flex; flex-wrap: wrap; gap: 4px; flex: 1; }
        .multi-select-chip { display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; background: var(--primary-light); color: var(--primary); border-radius: 4px; font-size: 0.72rem; font-weight: 500; }
        .multi-select-chip .remove { cursor: pointer; font-size: 0.85rem; opacity: 0.7; }
        .multi-select-chip .remove:hover { opacity: 1; }
        .multi-select-placeholder { color: var(--text-muted); font-size: 0.8rem; }
        .multi-select-arrow { color: var(--text-muted); font-size: 0.7rem; }
        .multi-select-dropdown { position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; box-shadow: var(--shadow-lg); z-index: 100; display: none; max-height: 180px; overflow-y: auto; }
        .multi-select.open .multi-select-dropdown { display: block; }
        .multi-select-option { padding: 8px 10px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.8rem; }
        .multi-select-option:hover { background: var(--bg); }
        .multi-select-option.selected { background: var(--primary-light); }
        .multi-select-option input { width: 14px; height: 14px; }
        .multi-select-empty { padding: 12px; text-align: center; color: var(--text-muted); font-size: 0.8rem; }

        /* Tags */
        .tags-input { display: flex; flex-wrap: wrap; gap: 5px; padding: 6px 10px; border: 1px solid var(--border); border-radius: 8px; min-height: 40px; align-items: center; cursor: text; background: var(--card-bg); }
        .tags-input:focus-within { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
        .tag-chip { display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; font-size: 0.72rem; font-weight: 500; }
        .tag-chip .remove { cursor: pointer; color: var(--text-muted); }
        .tag-chip .remove:hover { color: var(--danger); }
        .tags-input input { border: none; outline: none; flex: 1; min-width: 60px; font-size: 0.8rem; padding: 3px 0; background: transparent; }

        /* Time */
        .time-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .time-group label { font-size: 0.68rem; color: var(--text-muted); display: block; margin-bottom: 4px; }
        .time-input-wrap { display: flex; align-items: center; gap: 4px; }
        .time-input-wrap input { width: 60px; padding: 6px 8px; border: 1px solid var(--border); border-radius: 6px; text-align: center; font-size: 0.85rem; }
        .time-input-wrap input:focus { outline: none; border-color: var(--primary); }
        .time-input-wrap span { color: var(--text-muted); font-size: 0.75rem; }
        .time-bar { height: 6px; background: var(--border); border-radius: 3px; margin-top: 8px; overflow: hidden; }
        .time-bar-fill { height: 100%; background: var(--success); }
        .time-bar-fill.over { background: var(--danger); }

        /* Deps */
        .deps-display { margin-top: 10px; }
        .deps-group { margin-bottom: 10px; }
        .deps-group-label { font-size: 0.68rem; color: var(--text-muted); margin-bottom: 4px; }
        .deps-list { display: flex; flex-direction: column; gap: 4px; }
        .dep-item { display: flex; align-items: center; gap: 6px; padding: 6px 8px; background: var(--bg); border-radius: 5px; font-size: 0.75rem; cursor: pointer; }
        .dep-item:hover { background: var(--primary-light); }

        /* Delete */
        .delete-confirm { background: #fef2f2; border: 1px solid var(--danger); border-radius: 8px; padding: 12px; margin-top: 12px; display: none; }
        .delete-confirm.visible { display: block; }
        .delete-confirm-text { font-size: 0.8rem; color: var(--danger); margin-bottom: 10px; }
        .delete-confirm-actions { display: flex; gap: 8px; }
        .delete-confirm-btn { flex: 1; padding: 8px; border-radius: 6px; font-size: 0.8rem; font-weight: 500; cursor: pointer; border: none; }
        .delete-confirm-btn.cancel { background: var(--card-bg); border: 1px solid var(--border); }
        .delete-confirm-btn.confirm { background: var(--danger); color: white; }

        /* Utils */
        .save-indicator { position: fixed; bottom: 20px; right: 20px; background: var(--success); color: white; padding: 8px 14px; border-radius: 6px; font-size: 0.8rem; opacity: 0; transform: translateY(10px); transition: all 0.2s; z-index: 100; }
        .save-indicator.visible { opacity: 1; transform: translateY(0); }
        .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
        .toast { padding: 12px 18px; background: var(--text); color: white; border-radius: 8px; margin-top: 8px; font-size: 0.85rem; animation: slideIn 0.3s; }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .demo-badge { position: fixed; top: 8px; left: 50%; transform: translateX(-50%); background: var(--warning); color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; z-index: 1000; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--border-dark); border-radius: 3px; }
        @media (max-width: 900px) { :root { --panel-width: 320px; } .kanban-column { min-width: 250px; } }
        @media (max-width: 700px) { :root { --panel-width: 100%; } .kanban-container.panel-open { margin-right: 0; } .panel { left: 0; width: 100%; } }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìã Kanban</h1>
        <div class="header-center">
            <span style="font-size:0.8rem;color:var(--text-muted)">Grouper par :</span>
            <div class="group-selector">
                <button class="btn active" onclick="setGroupBy('statut')" id="groupStatut">Statut</button>
                <button class="btn" onclick="setGroupBy('priorite')" id="groupPriorite">Priorit√©</button>
                <button class="btn" onclick="setGroupBy('projet')" id="groupProjet">Projet</button>
            </div>
        </div>
        <div class="header-right">
            <button class="btn primary" onclick="openCreatePanel()">+ T√¢che</button>
        </div>
    </div>
    <div class="filter-bar">
        <div class="filter-dropdown">
            <div class="filter-btn" id="filterProjectBtn" onclick="toggleFilterMenu('project')">Projets ‚ñæ</div>
            <div class="filter-menu" id="filterProjectMenu"></div>
        </div>
        <div class="filter-dropdown">
            <div class="filter-btn" id="filterPriorityBtn" onclick="toggleFilterMenu('priority')">Priorit√©s ‚ñæ</div>
            <div class="filter-menu" id="filterPriorityMenu"></div>
        </div>
        <div class="filter-dropdown">
            <div class="filter-btn" id="filterAssigneeBtn" onclick="toggleFilterMenu('assignee')">Assign√©s ‚ñæ</div>
            <div class="filter-menu" id="filterAssigneeMenu"></div>
        </div>
        <div class="search-box"><input type="text" id="searchInput" placeholder="Rechercher..." oninput="handleSearch(this.value)"></div>
    </div>
    <div class="main-content">
        <div class="kanban-container" id="kanbanContainer"></div>
        <div class="panel" id="panel">
            <div class="panel-header" id="panelHeader"></div>
            <div class="panel-content" id="panelContent"></div>
            <div class="panel-footer" id="panelFooter"></div>
        </div>
    </div>
    <div class="save-indicator" id="saveIndicator">‚úì Enregistr√©</div>
    <div class="toast-container" id="toastContainer"></div>
    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SCHEMA & CONSTANTS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const TASKFLOW_SCHEMA = {
            Team: [{ id: 'nom', type: 'Text' }, { id: 'email', type: 'Text' }, { id: 'avatar', type: 'Text' }, { id: 'role', type: 'Choice' }, { id: 'actif', type: 'Bool' }],
            Projects: [{ id: 'nom', type: 'Text' }, { id: 'couleur', type: 'Text' }, { id: 'dateDebut', type: 'Date' }, { id: 'dateFin', type: 'Date' }, { id: 'responsable', type: 'Ref:Team' }, { id: 'actif', type: 'Bool' }],
            Tasks: [{ id: 'titre', type: 'Text' }, { id: 'description', type: 'Text' }, { id: 'dateDebut', type: 'Date' }, { id: 'dateEcheance', type: 'Date' }, { id: 'priorite', type: 'Choice' }, { id: 'statut', type: 'Choice' }, { id: 'progression', type: 'Numeric' }, { id: 'projet', type: 'Ref:Projects' }, { id: 'assignees', type: 'RefList:Team' }, { id: 'type', type: 'Choice' }, { id: 'dependDe', type: 'RefList:Tasks' }, { id: 'tags', type: 'ChoiceList' }, { id: 'estimationH', type: 'Numeric' }, { id: 'tempsPasse', type: 'Numeric' }, { id: 'couleur', type: 'Text' }]
        };
        const PRIORITY_LABELS = { 1: 'Critique', 2: 'Haute', 3: 'Moyenne', 4: 'Basse' };
        const PRIORITY_COLORS = { 1: '#ef4444', 2: '#f59e0b', 3: '#3b82f6', 4: '#64748b' };
        const STATUS_CONFIG = { todo: { label: '√Ä faire', icon: '‚≠ï' }, inprogress: { label: 'En cours', icon: 'üîÑ' }, review: { label: 'En revue', icon: 'üëÅÔ∏è' }, done: { label: 'Termin√©', icon: '‚úÖ' } };
        const TYPE_ICONS = { tache: 'üìã', jalon: '‚óÜ', reunion: 'üë•' };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // STATE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let tasks = [], team = [], projects = [], gristReady = false;
        let groupBy = 'statut', searchQuery = '', selectedTaskId = null;
        let filters = { project: [], priority: [], assignee: [] };
        let panelState = { open: false, isNew: false, taskId: null, taskIndex: -1, columnTasks: [], columnKey: null, editData: null };
        let sortableInstances = [];
        let saveTimeout = null;

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // UTILITIES
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const showToast = (m, t) => { const c = document.getElementById('toastContainer'); const e = document.createElement('div'); e.className = 'toast ' + (t||''); e.textContent = m; c.appendChild(e); setTimeout(() => e.remove(), 3000); };
        const showSaveIndicator = () => { const el = document.getElementById('saveIndicator'); el.classList.add('visible'); clearTimeout(saveTimeout); saveTimeout = setTimeout(() => el.classList.remove('visible'), 1500); };
        const escapeHtml = (t) => { if (!t) return ''; const d = document.createElement('div'); d.textContent = t; return d.innerHTML; };
        const gristToDate = (ts) => ts ? new Date(ts * 1000) : null;
        const dateToGrist = (d) => d ? Math.floor(d.getTime() / 1000) : null;
        const formatDateInput = (d) => d ? d.toISOString().split('T')[0] : '';
        const addDays = (d, n) => { const r = new Date(d); r.setDate(r.getDate() + n); return r; };
        const getProjectName = (id) => { const p = projects.find(x => x.id === id); return p?.nom || ''; };
        const getProjectColor = (id) => { const p = projects.find(x => x.id === id); return p?.couleur || '#64748b'; };
        const getTeamMemberName = (id) => { const m = team.find(x => x.id === id); return m?.nom || ''; };
        const getInitials = (n) => n ? n.split(' ').map(x => x[0]).join('').toUpperCase().slice(0, 2) : '?';
        const getRefListArray = (val) => { if (!val) return []; if (Array.isArray(val)) return val[0] === 'L' ? val.slice(1).map(Number).filter(n => !isNaN(n)) : val.map(Number).filter(n => !isNaN(n)); return []; };
        const toGristRefList = (arr) => arr && arr.length ? ['L', ...arr] : null;
        const getChoiceListArray = (val) => { if (!val) return []; if (Array.isArray(val)) return val[0] === 'L' ? val.slice(1) : val; return []; };
        const toGristChoiceList = (arr) => arr && arr.length ? ['L', ...arr] : null;
        const getAssignees = (t) => getRefListArray(t?.assignees);
        const getDependsOn = (t) => getRefListArray(t?.dependDe);
        const getTags = (t) => getChoiceListArray(t?.tags);
        const getPriority = (t) => (t?.priorite >= 1 && t?.priorite <= 4) ? parseInt(t.priorite) : 3;

        function wouldCreateCycle(taskId, depId, visited = new Set()) { if (taskId === depId) return true; if (visited.has(depId)) return false; visited.add(depId); const depTask = tasks.find(t => t.id === depId); if (!depTask) return false; return getDependsOn(depTask).some(d => wouldCreateCycle(taskId, d, visited)); }
        function getAvailableDependencies(taskId) { return tasks.filter(t => t.id !== taskId && !wouldCreateCycle(taskId, t.id)); }
        function getBlockedTasks(taskId) { return tasks.filter(t => getDependsOn(t).includes(taskId)); }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // GRIST
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function convertGristToRecords(data) { if (!data || Array.isArray(data)) return data || []; const cols = Object.keys(data); if (!cols.length) return []; const n = data[cols[0]]?.length || 0; const records = []; for (let i = 0; i < n; i++) { const rec = {}; cols.forEach(k => { rec[k] = data[k][i]; }); records.push(rec); } return records; }
        async function ensureSchema() { let created = 0; const tablesCreated = []; for (const [tableName, columns] of Object.entries(TASKFLOW_SCHEMA)) { let existingCols = [], tableExists = false; try { const data = await grist.docApi.fetchTable(tableName); existingCols = Object.keys(data).filter(c => c !== 'id' && c !== 'manualSort'); tableExists = true; } catch (e) { try { await grist.docApi.applyUserActions([['AddTable', tableName, columns.map(c => ({ id: c.id, type: c.type }))]]); tablesCreated.push(tableName); created++; continue; } catch (e2) { continue; } } if (tableExists) { const missing = columns.filter(c => !existingCols.includes(c.id)); for (const col of missing) { try { await grist.docApi.applyUserActions([['AddColumn', tableName, col.id, { type: col.type }]]); } catch (e) {} } } } if (tablesCreated.includes('Tasks')) await seedData(); }
        async function seedData() { const today = new Date(); const day = (d) => Math.floor(new Date(today.getFullYear(), today.getMonth(), today.getDate() + d).getTime() / 1000); try { await grist.docApi.applyUserActions([['AddRecord', 'Team', null, { nom: 'Alice Martin', actif: true }], ['AddRecord', 'Team', null, { nom: 'Bob Durant', actif: true }], ['AddRecord', 'Team', null, { nom: 'Claire Bernard', actif: true }]]); await grist.docApi.applyUserActions([['AddRecord', 'Projects', null, { nom: 'Refonte Portail', couleur: '#4f46e5', actif: true }], ['AddRecord', 'Projects', null, { nom: 'App Mobile', couleur: '#10b981', actif: true }]]); await grist.docApi.applyUserActions([['AddRecord', 'Tasks', null, { titre: 'Analyse', priorite: '1', statut: 'done', progression: 100, projet: 1, type: 'tache', dateDebut: day(-10), dateEcheance: day(-5), assignees: ['L', 1] }], ['AddRecord', 'Tasks', null, { titre: 'Dev Backend', priorite: '1', statut: 'inprogress', progression: 40, projet: 1, type: 'tache', dateDebut: day(-4), dateEcheance: day(10), assignees: ['L', 1, 2], dependDe: ['L', 1], estimationH: 32, tempsPasse: 12 }], ['AddRecord', 'Tasks', null, { titre: 'Design UI', priorite: '2', statut: 'review', progression: 80, projet: 2, type: 'tache', dateDebut: day(-5), dateEcheance: day(2), assignees: ['L', 3] }], ['AddRecord', 'Tasks', null, { titre: 'Livraison', priorite: '1', statut: 'todo', projet: 1, type: 'jalon', dateDebut: day(15), dateEcheance: day(15), dependDe: ['L', 2] }], ['AddRecord', 'Tasks', null, { titre: 'Tests QA', priorite: '3', statut: 'todo', projet: 2, type: 'tache', dateDebut: day(5), dateEcheance: day(12), tags: ['L', 'qa'] }]]); } catch (e) { console.log('Seed error:', e); } }
        async function loadAllData() { try { tasks = convertGristToRecords(await grist.docApi.fetchTable('Tasks')); } catch (e) { tasks = []; } try { team = convertGristToRecords(await grist.docApi.fetchTable('Team')); } catch (e) { team = []; } try { projects = convertGristToRecords(await grist.docApi.fetchTable('Projects')); } catch (e) { projects = []; } gristReady = true; updateFilterMenus(); render(); }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // FILTERS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function setGroupBy(g) { groupBy = g; document.querySelectorAll('.group-selector .btn').forEach(b => b.classList.remove('active')); document.getElementById('group' + g.charAt(0).toUpperCase() + g.slice(1)).classList.add('active'); render(); }
        function toggleFilterMenu(type) { document.querySelectorAll('.filter-menu').forEach(m => m.classList.remove('open')); document.getElementById(`filter${type.charAt(0).toUpperCase() + type.slice(1)}Menu`).classList.toggle('open'); }
        function updateFilterMenus() {
            document.getElementById('filterProjectMenu').innerHTML = projects.map(p => `<div class="filter-option" onclick="toggleFilterValue('project', ${p.id})"><input type="checkbox" ${filters.project.includes(p.id) ? 'checked' : ''}><span style="color:${p.couleur}">‚óè</span> ${escapeHtml(p.nom)}</div>`).join('') || '<div class="filter-option">Aucun</div>';
            document.getElementById('filterPriorityMenu').innerHTML = [1,2,3,4].map(p => `<div class="filter-option" onclick="toggleFilterValue('priority', ${p})"><input type="checkbox" ${filters.priority.includes(p) ? 'checked' : ''}><span style="color:${PRIORITY_COLORS[p]}">‚óè</span> ${PRIORITY_LABELS[p]}</div>`).join('');
            document.getElementById('filterAssigneeMenu').innerHTML = team.filter(m => m.actif !== false).map(m => `<div class="filter-option" onclick="toggleFilterValue('assignee', ${m.id})"><input type="checkbox" ${filters.assignee.includes(m.id) ? 'checked' : ''}>${escapeHtml(m.nom)}</div>`).join('') || '<div class="filter-option">Aucun</div>';
            document.getElementById('filterProjectBtn').classList.toggle('has-filter', filters.project.length > 0);
            document.getElementById('filterPriorityBtn').classList.toggle('has-filter', filters.priority.length > 0);
            document.getElementById('filterAssigneeBtn').classList.toggle('has-filter', filters.assignee.length > 0);
        }
        function toggleFilterValue(type, val) { const arr = filters[type]; const idx = arr.indexOf(val); if (idx === -1) arr.push(val); else arr.splice(idx, 1); updateFilterMenus(); render(); }
        function handleSearch(q) { searchQuery = q.toLowerCase(); render(); }
        function getFilteredTasks() {
            return tasks.filter(t => {
                if (filters.project.length && !filters.project.includes(t.projet)) return false;
                if (filters.priority.length && !filters.priority.includes(getPriority(t))) return false;
                if (filters.assignee.length && !getAssignees(t).some(a => filters.assignee.includes(a))) return false;
                if (searchQuery && !(t.titre||'').toLowerCase().includes(searchQuery)) return false;
                return true;
            });
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // RENDER
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function render() {
            sortableInstances.forEach(s => s.destroy());
            sortableInstances = [];
            const container = document.getElementById('kanbanContainer');
            const ft = getFilteredTasks();
            const columns = buildColumns(ft);
            
            container.innerHTML = columns.map(col => `
                <div class="kanban-column" data-key="${col.key}">
                    <div class="column-header">
                        <span class="column-title">${col.icon || ''} ${escapeHtml(col.label)} <span class="column-count">${col.tasks.length}</span></span>
                        <button class="column-add" onclick="openCreatePanelForColumn('${col.key}')" title="Ajouter">+</button>
                    </div>
                    <div class="column-body" id="col-${col.key}">${col.tasks.map(t => renderCard(t)).join('')}</div>
                </div>
            `).join('');
            
            // Initialize Sortable
            columns.forEach(col => {
                const el = document.getElementById(`col-${col.key}`);
                if (el) {
                    sortableInstances.push(new Sortable(el, {
                        group: 'tasks', animation: 150, ghostClass: 'sortable-ghost', chosenClass: 'sortable-chosen',
                        onEnd: (evt) => handleDrop(evt, col.key)
                    }));
                }
            });
        }

        function buildColumns(ft) {
            if (groupBy === 'statut') {
                return Object.entries(STATUS_CONFIG).map(([k, v]) => ({ key: k, label: v.label, icon: v.icon, tasks: ft.filter(t => t.statut === k) }));
            } else if (groupBy === 'priorite') {
                return [1,2,3,4].map(p => ({ key: String(p), label: PRIORITY_LABELS[p], icon: '', tasks: ft.filter(t => getPriority(t) === p) }));
            } else if (groupBy === 'projet') {
                const cols = projects.filter(p => p.actif !== false).map(p => ({ key: String(p.id), label: p.nom, icon: `<span style="color:${p.couleur}">‚óè</span>`, tasks: ft.filter(t => t.projet === p.id) }));
                cols.push({ key: 'none', label: 'Sans projet', icon: '', tasks: ft.filter(t => !t.projet) });
                return cols;
            }
            return [];
        }

        function renderCard(t) {
            const p = getPriority(t);
            const assignees = getAssignees(t);
            const deps = getDependsOn(t);
            const projectName = getProjectName(t.projet);
            const projectColor = getProjectColor(t.projet);
            const typeIcon = TYPE_ICONS[t.type] || 'üìã';
            
            return `<div class="task-card p${p} ${t.statut === 'done' ? 'done' : ''} ${t.id === selectedTaskId ? 'selected' : ''}" data-id="${t.id}" onclick="openTaskPanel(${t.id})">
                <div class="card-header">
                    <span class="card-title">${escapeHtml(t.titre) || 'Sans titre'}</span>
                    <span class="card-type">${typeIcon}</span>
                </div>
                <div class="card-meta">
                    ${projectName ? `<span class="card-project"><span style="color:${projectColor}">‚óè</span> ${escapeHtml(projectName)}</span>` : ''}
                    ${deps.length ? `<span class="card-deps">üîó ${deps.length}</span>` : ''}
                </div>
                ${t.type !== 'jalon' ? `<div class="card-progress"><div class="card-progress-fill p${p}" style="width:${t.progression || 0}%"></div></div>` : ''}
                ${assignees.length ? `<div class="card-assignees">${assignees.slice(0, 3).map(id => `<div class="card-avatar">${getInitials(getTeamMemberName(id))}</div>`).join('')}${assignees.length > 3 ? `<div class="card-avatar more">+${assignees.length - 3}</div>` : ''}</div>` : ''}
            </div>`;
        }

        async function handleDrop(evt, colKey) {
            const taskId = parseInt(evt.item.dataset.id);
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            let updates = {};
            if (groupBy === 'statut') { updates.statut = colKey; if (colKey === 'done') updates.progression = 100; }
            else if (groupBy === 'priorite') updates.priorite = colKey;
            else if (groupBy === 'projet') updates.projet = colKey === 'none' ? null : parseInt(colKey);
            
            Object.assign(task, updates);
            
            if (gristReady) {
                try { await grist.docApi.applyUserActions([['UpdateRecord', 'Tasks', taskId, updates]]); showSaveIndicator(); }
                catch (e) { showToast('Erreur d√©placement', 'error'); await loadAllData(); }
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PANEL
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function openPanel() { panelState.open = true; document.getElementById('panel').classList.add('open'); document.getElementById('kanbanContainer').classList.add('panel-open'); }
        function closePanel() { panelState.open = false; document.getElementById('panel').classList.remove('open'); document.getElementById('kanbanContainer').classList.remove('panel-open'); panelState = { open: false, isNew: false, taskId: null, taskIndex: -1, columnTasks: [], columnKey: null, editData: null }; selectedTaskId = null; render(); }

        function openTaskPanel(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            selectedTaskId = taskId;
            
            // Find column tasks for navigation
            const ft = getFilteredTasks();
            const columns = buildColumns(ft);
            let colKey = null, colTasks = [];
            for (const col of columns) {
                const idx = col.tasks.findIndex(t => t.id === taskId);
                if (idx !== -1) { colKey = col.key; colTasks = col.tasks; break; }
            }
            
            panelState.taskId = taskId;
            panelState.taskIndex = colTasks.findIndex(t => t.id === taskId);
            panelState.columnTasks = colTasks;
            panelState.columnKey = colKey;
            panelState.isNew = false;
            panelState.editData = cloneTaskData(task);
            renderPanelTask();
            openPanel();
            if (gristReady) grist.setSelectedRows([taskId]);
            render();
        }

        function openCreatePanel() { openCreatePanelForColumn(groupBy === 'statut' ? 'todo' : groupBy === 'priorite' ? '3' : projects.length ? String(projects[0].id) : 'none'); }

        function openCreatePanelForColumn(colKey) {
            const today = new Date();
            let preset = {};
            if (groupBy === 'statut') preset.statut = colKey;
            else if (groupBy === 'priorite') preset.priorite = colKey;
            else if (groupBy === 'projet') preset.projet = colKey === 'none' ? null : parseInt(colKey);
            
            panelState = {
                open: true, isNew: true, taskId: null, taskIndex: -1, columnTasks: [], columnKey: colKey,
                editData: { titre: '', description: '', type: 'tache', priorite: preset.priorite || '3', statut: preset.statut || 'todo', progression: 0, dateDebut: dateToGrist(today), dateEcheance: dateToGrist(addDays(today, 7)), projet: preset.projet !== undefined ? preset.projet : (projects.length > 0 ? projects[0].id : null), assignees: [], dependDe: [], tags: [], estimationH: null, tempsPasse: null }
            };
            renderPanelTask();
            openPanel();
            setTimeout(() => document.getElementById('taskTitle')?.focus(), 100);
        }

        function cloneTaskData(task) { return { titre: task.titre || '', description: task.description || '', type: task.type || 'tache', priorite: String(task.priorite || '3'), statut: task.statut || 'todo', progression: task.progression || 0, dateDebut: task.dateDebut, dateEcheance: task.dateEcheance, projet: task.projet || null, assignees: getAssignees(task), dependDe: getDependsOn(task), tags: getTags(task), estimationH: task.estimationH || null, tempsPasse: task.tempsPasse || null }; }

        function navigatePanelTask(dir) {
            if (panelState.isNew || panelState.columnTasks.length < 2) return;
            let newIdx = panelState.taskIndex + dir;
            if (newIdx < 0) newIdx = panelState.columnTasks.length - 1;
            if (newIdx >= panelState.columnTasks.length) newIdx = 0;
            const t = panelState.columnTasks[newIdx];
            if (t) openTaskPanel(t.id);
        }

        function renderPanelTask() {
            const header = document.getElementById('panelHeader');
            const content = document.getElementById('panelContent');
            const footer = document.getElementById('panelFooter');
            const data = panelState.editData;
            if (!data) { closePanel(); return; }

            const canNavigate = panelState.columnTasks.length > 1 && !panelState.isNew;
            const typeIcon = TYPE_ICONS[data.type] || 'üìã';
            const titleText = panelState.isNew ? 'Nouvelle t√¢che' : (data.titre || 'Sans titre');

            header.innerHTML = `<div class="panel-nav"><button class="panel-nav-btn" onclick="navigatePanelTask(-1)" ${!canNavigate ? 'disabled' : ''}>‚óÄ</button><span class="panel-title"><span style="margin-right:6px">${typeIcon}</span>${escapeHtml(titleText)}</span><button class="panel-nav-btn" onclick="navigatePanelTask(1)" ${!canNavigate ? 'disabled' : ''}>‚ñ∂</button></div><button class="panel-close" onclick="closePanel()">√ó</button>`;

            const s = gristToDate(data.dateDebut), e = gristToDate(data.dateEcheance);
            const projectOptions = projects.filter(p => p.actif !== false).map(p => `<option value="${p.id}" ${data.projet === p.id ? 'selected' : ''}>${escapeHtml(p.nom)}</option>`).join('');
            const assigneesChips = data.assignees.map(id => `<span class="multi-select-chip">${escapeHtml(getTeamMemberName(id))}<span class="remove" onclick="event.stopPropagation();removeAssignee(${id})">√ó</span></span>`).join('');
            const assigneesOptions = team.filter(m => m.actif !== false).map(m => `<div class="multi-select-option ${data.assignees.includes(m.id) ? 'selected' : ''}" onclick="toggleAssignee(${m.id})"><input type="checkbox" ${data.assignees.includes(m.id) ? 'checked' : ''} onclick="event.stopPropagation();toggleAssignee(${m.id})">${escapeHtml(m.nom)}</div>`).join('');
            const depsChips = data.dependDe.map(id => { const d = tasks.find(t => t.id === id); return d ? `<span class="multi-select-chip">${escapeHtml(d.titre)}<span class="remove" onclick="event.stopPropagation();removeDependency(${id})">√ó</span></span>` : ''; }).join('');
            const availableDeps = panelState.isNew ? tasks : getAvailableDependencies(panelState.taskId);
            const depsOptions = availableDeps.map(t => `<div class="multi-select-option ${data.dependDe.includes(t.id) ? 'selected' : ''}" onclick="toggleDependency(${t.id})"><input type="checkbox" ${data.dependDe.includes(t.id) ? 'checked' : ''} onclick="event.stopPropagation();toggleDependency(${t.id})">${escapeHtml(t.titre)}</div>`).join('');
            let blockedHtml = '';
            if (!panelState.isNew) { const blocked = getBlockedTasks(panelState.taskId); if (blocked.length) blockedHtml = `<div class="deps-display"><div class="deps-group"><div class="deps-group-label">‚Üí Bloque :</div><div class="deps-list">${blocked.map(t => `<div class="dep-item" onclick="openTaskPanel(${t.id})">‚Üí ${escapeHtml(t.titre)}</div>`).join('')}</div></div></div>`; }
            const tagsChips = data.tags.map(tag => `<span class="tag-chip">#${escapeHtml(tag)}<span class="remove" onclick="removeTag('${escapeHtml(tag)}')">√ó</span></span>`).join('');
            const estim = data.estimationH || 0, passe = data.tempsPasse || 0;
            const timePercent = estim > 0 ? Math.min((passe / estim) * 100, 100) : 0, timeOver = passe > estim && estim > 0;

            content.innerHTML = `
                <div class="type-selector"><div class="type-option ${data.type === 'tache' ? 'selected' : ''}" onclick="updateField('type','tache')"><span class="type-option-icon">üìã</span>T√¢che</div><div class="type-option ${data.type === 'jalon' ? 'selected' : ''}" onclick="updateField('type','jalon')"><span class="type-option-icon">‚óÜ</span>Jalon</div><div class="type-option ${data.type === 'reunion' ? 'selected' : ''}" onclick="updateField('type','reunion')"><span class="type-option-icon">üë•</span>R√©union</div></div>
                <div class="form-group"><input type="text" class="form-input title-input" id="taskTitle" placeholder="Titre..." value="${escapeHtml(data.titre)}" oninput="updateField('titre', this.value, true)"></div>
                <div class="panel-section">
                    ${data.type === 'jalon' ? `<div class="form-group"><label class="form-label">Date</label><input type="date" class="form-input" value="${formatDateInput(s)}" onchange="updateField('dateDebut', this.value); updateField('dateEcheance', this.value)"></div>` : `<div class="form-row"><div class="form-group"><label class="form-label">D√©but</label><input type="date" class="form-input" value="${formatDateInput(s)}" onchange="updateField('dateDebut', this.value)"></div><div class="form-group"><label class="form-label">Fin</label><input type="date" class="form-input" value="${formatDateInput(e)}" onchange="updateField('dateEcheance', this.value)"></div></div>`}
                    <div class="form-group"><label class="form-label">Projet</label><select class="form-select" onchange="updateField('projet', parseInt(this.value) || null)"><option value="">Aucun</option>${projectOptions}</select></div>
                </div>
                <div class="panel-section">
                    <div class="form-group"><label class="form-label">Priorit√©</label><div class="priority-selector"><div class="priority-pill p1 ${data.priorite == '1' ? 'selected' : ''}" onclick="updateField('priorite','1')">Critique</div><div class="priority-pill p2 ${data.priorite == '2' ? 'selected' : ''}" onclick="updateField('priorite','2')">Haute</div><div class="priority-pill p3 ${data.priorite == '3' ? 'selected' : ''}" onclick="updateField('priorite','3')">Moyenne</div><div class="priority-pill p4 ${data.priorite == '4' ? 'selected' : ''}" onclick="updateField('priorite','4')">Basse</div></div></div>
                    ${data.type !== 'jalon' ? `<div class="form-group"><label class="form-label">Statut</label><div class="status-selector"><div class="status-pill ${data.statut === 'todo' ? 'selected' : ''}" onclick="updateField('statut','todo')">√Ä faire</div><div class="status-pill ${data.statut === 'inprogress' ? 'selected' : ''}" onclick="updateField('statut','inprogress')">En cours</div><div class="status-pill ${data.statut === 'review' ? 'selected' : ''}" onclick="updateField('statut','review')">En revue</div><div class="status-pill ${data.statut === 'done' ? 'selected' : ''}" onclick="updateField('statut','done')">Termin√©</div></div></div><div class="form-group"><label class="form-label">Progression</label><div class="progress-container"><input type="range" class="progress-slider" min="0" max="100" value="${data.progression}" oninput="document.getElementById('progressValue').textContent=this.value+'%'" onchange="updateField('progression', parseInt(this.value))"><span class="progress-value" id="progressValue">${data.progression}%</span></div></div>` : ''}
                </div>
                <div class="panel-section">
                    <div class="form-group"><label class="form-label">Assign√©s</label><div class="multi-select" id="assigneesSelect"><div class="multi-select-trigger" onclick="toggleMultiSelect('assigneesSelect')"><div class="multi-select-values">${assigneesChips || '<span class="multi-select-placeholder">S√©lectionner...</span>'}</div><span class="multi-select-arrow">‚ñæ</span></div><div class="multi-select-dropdown">${assigneesOptions || '<div class="multi-select-empty">Aucun</div>'}</div></div></div>
                    <div class="form-group"><label class="form-label">D√©pend de</label><div class="multi-select" id="depsSelect"><div class="multi-select-trigger" onclick="toggleMultiSelect('depsSelect')"><div class="multi-select-values">${depsChips || '<span class="multi-select-placeholder">S√©lectionner...</span>'}</div><span class="multi-select-arrow">‚ñæ</span></div><div class="multi-select-dropdown">${depsOptions || '<div class="multi-select-empty">Aucune</div>'}</div></div>${blockedHtml}</div>
                </div>
                <div class="panel-section">
                    <div class="form-group"><label class="form-label">Temps</label><div class="time-row"><div class="time-group"><label>Estim√©</label><div class="time-input-wrap"><input type="number" min="0" step="0.5" value="${estim || ''}" placeholder="0" onchange="updateField('estimationH', parseFloat(this.value) || null)"><span>h</span></div></div><div class="time-group"><label>Pass√©</label><div class="time-input-wrap"><input type="number" min="0" step="0.5" value="${passe || ''}" placeholder="0" onchange="updateField('tempsPasse', parseFloat(this.value) || null)"><span>h</span></div></div></div>${estim > 0 ? `<div class="time-bar"><div class="time-bar-fill ${timeOver ? 'over' : ''}" style="width:${timePercent}%"></div></div>` : ''}</div>
                    <div class="form-group"><label class="form-label">Tags</label><div class="tags-input" onclick="document.getElementById('tagInput').focus()">${tagsChips}<input type="text" id="tagInput" placeholder="${data.tags.length ? '' : 'Ajouter...'}" onkeydown="handleTagKeydown(event)"></div></div>
                </div>
                <div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" placeholder="Notes..." oninput="updateField('description', this.value, true)">${escapeHtml(data.description)}</textarea></div>
                ${!panelState.isNew ? `<div id="deleteSection"><button class="panel-btn danger" onclick="showDeleteConfirm()">üóëÔ∏è Supprimer</button><div class="delete-confirm" id="deleteConfirm"><div class="delete-confirm-text">Supprimer ?</div><div class="delete-confirm-actions"><button class="delete-confirm-btn cancel" onclick="hideDeleteConfirm()">Annuler</button><button class="delete-confirm-btn confirm" onclick="confirmDelete()">Supprimer</button></div></div></div>` : ''}
            `;

            footer.innerHTML = panelState.isNew ? `<button class="panel-btn success" onclick="createTask()" ${!data.titre?.trim() ? 'disabled' : ''}>‚úì Cr√©er</button>` : '';
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // FIELD HANDLERS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function updateField(field, value, noSave = false) {
            const data = panelState.editData;
            if (!data) return;
            if (field === 'dateDebut' || field === 'dateEcheance') value = value ? dateToGrist(new Date(value)) : null;
            data[field] = value;
            if (field === 'type' && value === 'jalon' && data.dateDebut) data.dateEcheance = data.dateDebut;
            const visualFields = ['type', 'priorite', 'statut', 'projet'];
            if (visualFields.includes(field)) { renderPanelTask(); if (!panelState.isNew) render(); }
            if (field === 'titre' && panelState.isNew) { const btn = document.querySelector('.panel-footer .panel-btn'); if (btn) btn.disabled = !value || !value.trim(); }
            if (!panelState.isNew && !noSave && gristReady) saveTaskToGrist();
        }

        function toggleMultiSelect(id) { const el = document.getElementById(id); document.querySelectorAll('.multi-select').forEach(s => { if (s.id !== id) s.classList.remove('open'); }); el.classList.toggle('open'); }
        function toggleAssignee(id) { const data = panelState.editData; const idx = data.assignees.indexOf(id); if (idx === -1) data.assignees.push(id); else data.assignees.splice(idx, 1); if (!panelState.isNew && gristReady) saveTaskToGrist(); renderPanelTask(); render(); }
        function removeAssignee(id) { const data = panelState.editData; const idx = data.assignees.indexOf(id); if (idx !== -1) { data.assignees.splice(idx, 1); if (!panelState.isNew && gristReady) saveTaskToGrist(); renderPanelTask(); render(); } }
        function toggleDependency(id) { const data = panelState.editData; const idx = data.dependDe.indexOf(id); if (idx === -1) data.dependDe.push(id); else data.dependDe.splice(idx, 1); if (!panelState.isNew && gristReady) saveTaskToGrist(); renderPanelTask(); }
        function removeDependency(id) { const data = panelState.editData; const idx = data.dependDe.indexOf(id); if (idx !== -1) { data.dependDe.splice(idx, 1); if (!panelState.isNew && gristReady) saveTaskToGrist(); renderPanelTask(); } }
        function handleTagKeydown(e) { const data = panelState.editData; if (e.key === 'Enter' || e.key === ',') { e.preventDefault(); const tag = e.target.value.trim().replace(/^#/, ''); if (tag && !data.tags.includes(tag)) { data.tags.push(tag); e.target.value = ''; if (!panelState.isNew && gristReady) saveTaskToGrist(); renderPanelTask(); } } else if (e.key === 'Backspace' && !e.target.value && data.tags.length) { data.tags.pop(); if (!panelState.isNew && gristReady) saveTaskToGrist(); renderPanelTask(); } }
        function removeTag(tag) { const data = panelState.editData; const idx = data.tags.indexOf(tag); if (idx !== -1) { data.tags.splice(idx, 1); if (!panelState.isNew && gristReady) saveTaskToGrist(); renderPanelTask(); } }
        function showDeleteConfirm() { document.getElementById('deleteConfirm').classList.add('visible'); }
        function hideDeleteConfirm() { document.getElementById('deleteConfirm').classList.remove('visible'); }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CRUD
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function saveTaskToGrist() {
            const data = panelState.editData;
            if (!data || panelState.isNew || !gristReady) return;
            const record = { titre: data.titre, description: data.description, type: data.type, priorite: data.priorite, statut: data.statut, progression: data.progression, dateDebut: data.dateDebut, dateEcheance: data.dateEcheance, projet: data.projet, assignees: toGristRefList(data.assignees), dependDe: toGristRefList(data.dependDe), tags: toGristChoiceList(data.tags), estimationH: data.estimationH, tempsPasse: data.tempsPasse };
            try { await grist.docApi.applyUserActions([['UpdateRecord', 'Tasks', panelState.taskId, record]]); showSaveIndicator(); } catch (e) { showToast('Erreur sauvegarde', 'error'); }
        }

        async function createTask() {
            const data = panelState.editData;
            if (!data || !data.titre?.trim()) { showToast('Titre requis', 'error'); return; }
            const record = { titre: data.titre, description: data.description || '', type: data.type || 'tache', priorite: data.priorite || '3', statut: data.statut || 'todo', progression: data.progression || 0, dateDebut: data.dateDebut, dateEcheance: data.dateEcheance, projet: data.projet, assignees: toGristRefList(data.assignees), dependDe: toGristRefList(data.dependDe), tags: toGristChoiceList(data.tags), estimationH: data.estimationH, tempsPasse: data.tempsPasse };
            if (gristReady) {
                try { await grist.docApi.applyUserActions([['AddRecord', 'Tasks', null, record]]); showToast('Cr√©√©e', 'success'); await loadAllData(); closePanel(); } catch (e) { showToast('Erreur cr√©ation', 'error'); }
            } else { record.id = Date.now(); tasks.push(record); showToast('Cr√©√©e', 'success'); render(); closePanel(); }
        }

        async function confirmDelete() {
            if (panelState.isNew || !panelState.taskId) return;
            if (gristReady) {
                try { await grist.docApi.applyUserActions([['RemoveRecord', 'Tasks', panelState.taskId]]); showToast('Supprim√©e', 'success'); await loadAllData(); closePanel(); } catch (e) { showToast('Erreur suppression', 'error'); }
            } else { tasks = tasks.filter(t => t.id !== panelState.taskId); showToast('Supprim√©e', 'success'); render(); closePanel(); }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // INIT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function initGrist() {
            try {
                grist.ready({ requiredAccess: 'full' });
                await ensureSchema();
                await loadAllData();
                grist.onRecords(async () => await loadAllData());
                grist.onRecord((rec) => { if (rec?.id && rec.id !== selectedTaskId) { selectedTaskId = rec.id; render(); } });
            } catch (e) { console.log('Demo mode'); useDemoMode(); }
        }

        function useDemoMode() {
            document.body.insertAdjacentHTML('beforeend', '<div class="demo-badge">D√©mo</div>');
            team = [{ id: 1, nom: 'Alice Martin', actif: true }, { id: 2, nom: 'Bob Durant', actif: true }, { id: 3, nom: 'Claire Bernard', actif: true }];
            projects = [{ id: 1, nom: 'Refonte Portail', couleur: '#4f46e5', actif: true }, { id: 2, nom: 'App Mobile', couleur: '#10b981', actif: true }];
            const today = new Date();
            const day = (d) => dateToGrist(new Date(today.getFullYear(), today.getMonth(), today.getDate() + d));
            tasks = [
                { id: 1, titre: 'Analyse besoins', priorite: '1', projet: 1, dateDebut: day(-10), dateEcheance: day(-5), progression: 100, statut: 'done', type: 'tache', assignees: ['L', 1], tags: ['L', 'doc'] },
                { id: 2, titre: 'Dev Backend', priorite: '1', projet: 1, dateDebut: day(-4), dateEcheance: day(10), progression: 40, statut: 'inprogress', type: 'tache', dependDe: ['L', 1], assignees: ['L', 1, 2], estimationH: 32, tempsPasse: 12 },
                { id: 3, titre: 'Design UI', priorite: '2', projet: 2, dateDebut: day(-5), dateEcheance: day(2), progression: 80, statut: 'review', type: 'tache', assignees: ['L', 3] },
                { id: 4, titre: 'Livraison MVP', priorite: '1', projet: 1, dateDebut: day(15), dateEcheance: day(15), progression: 0, statut: 'todo', type: 'jalon', dependDe: ['L', 2] },
                { id: 5, titre: 'Tests QA', priorite: '3', projet: 2, dateDebut: day(5), dateEcheance: day(12), progression: 0, statut: 'todo', type: 'tache', tags: ['L', 'qa'] },
                { id: 6, titre: 'Documentation', priorite: '4', dateDebut: day(12), dateEcheance: day(20), progression: 0, statut: 'todo', type: 'tache' }
            ];
            updateFilterMenus();
            render();
        }

        // Events
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.filter-dropdown')) document.querySelectorAll('.filter-menu').forEach(m => m.classList.remove('open'));
            if (!e.target.closest('.multi-select')) document.querySelectorAll('.multi-select').forEach(s => s.classList.remove('open'));
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && panelState.open) closePanel();
            if (panelState.open && !panelState.isNew && !e.target.matches('input, textarea, select')) {
                if (e.key === 'ArrowLeft') navigatePanelTask(-1);
                if (e.key === 'ArrowRight') navigatePanelTask(1);
            }
        });

        initGrist();
    </script>
</body>
</html>