<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban Board - TaskFlow v6</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-light: #e0e7ff;
            --primary-dark: #4338ca;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
        }

        /* === HEADER === */
        .header {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
            flex-shrink: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header h1 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        /* === BUTTONS === */
        .btn {
            padding: 7px 14px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--card-bg);
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            transition: all 0.15s;
            color: var(--text);
        }

        .btn:hover { background: var(--bg); border-color: var(--text-muted); }
        .btn.primary { background: var(--primary); color: white; border-color: var(--primary); }
        .btn.primary:hover { background: var(--primary-dark); }
        .btn.sm { padding: 5px 10px; font-size: 0.75rem; }
        .btn.icon-only { padding: 7px; }

        /* === GROUP BY SELECTOR === */
        .group-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
        }

        .group-selector label { color: var(--text-muted); }

        .group-selector select {
            padding: 6px 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.8rem;
            background: var(--card-bg);
            cursor: pointer;
        }

        /* === SEARCH === */
        .search-box {
            position: relative;
        }

        .search-box input {
            padding: 7px 12px 7px 32px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.8rem;
            width: 180px;
            transition: all 0.2s;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
            width: 220px;
        }

        .search-box::before {
            content: "üîç";
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.75rem;
            opacity: 0.5;
        }

        /* === FILTER BAR === */
        .filter-bar {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            padding: 8px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            flex-shrink: 0;
        }

        .filter-dropdown { position: relative; }

        .filter-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 5px 10px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.75rem;
            color: var(--text);
            transition: all 0.15s;
        }

        .filter-btn:hover { background: var(--bg); }
        .filter-btn.active { background: var(--primary-light); border-color: var(--primary); color: var(--primary); }
        .filter-btn .arrow { font-size: 0.6rem; color: var(--text-muted); }

        .filter-menu {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 4px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            min-width: 160px;
            z-index: 200;
            display: none;
            max-height: 280px;
            overflow-y: auto;
        }

        .filter-menu.open { display: block; }

        .filter-menu-header {
            padding: 8px 12px;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            border-bottom: 1px solid var(--border);
        }

        .filter-option {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-option:hover { background: var(--bg); }
        .filter-option.active { background: var(--primary-light); color: var(--primary); }

        .filter-option .color-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .active-filters {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .filter-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            background: var(--primary-light);
            color: var(--primary);
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .filter-chip button {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 0.85rem;
            padding: 0 2px;
            line-height: 1;
        }

        /* === KANBAN CONTAINER === */
        .kanban-wrapper {
            flex: 1;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 16px 20px;
        }

        .kanban-container {
            display: flex;
            gap: 16px;
            height: 100%;
            min-width: max-content;
        }

        /* === COLUMN === */
        .kanban-column {
            width: 300px;
            min-width: 300px;
            background: var(--bg);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            max-height: 100%;
        }

        .column-header {
            padding: 14px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px solid var(--border);
        }

        .column-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .column-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .column-count {
            background: var(--card-bg);
            color: var(--text-muted);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .column-actions {
            display: flex;
            gap: 4px;
        }

        .column-action-btn {
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            border: none;
            background: transparent;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 0.9rem;
            transition: all 0.15s;
        }

        .column-action-btn:hover {
            background: var(--card-bg);
            color: var(--text);
        }

        .column-body {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .column-footer {
            padding: 10px 12px;
            border-top: 1px solid var(--border);
        }

        .add-task-btn {
            width: 100%;
            padding: 10px;
            border: 2px dashed var(--border);
            border-radius: 8px;
            background: transparent;
            color: var(--text-muted);
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.15s;
        }

        .add-task-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--primary-light);
        }

        /* === ADD COLUMN === */
        .add-column {
            width: 300px;
            min-width: 300px;
            background: transparent;
            border: 2px dashed var(--border);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 0.85rem;
            transition: all 0.15s;
        }

        .add-column:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--primary-light);
        }

        /* === TASK CARD === */
        .task-card {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 14px;
            cursor: pointer;
            transition: all 0.15s;
            box-shadow: var(--shadow);
            border-left: 4px solid transparent;
            position: relative;
        }

        .task-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .task-card.selected {
            outline: 2px solid var(--primary);
            outline-offset: 1px;
        }

        .task-card.p1 { border-left-color: var(--danger); }
        .task-card.p2 { border-left-color: var(--warning); }
        .task-card.p3 { border-left-color: var(--info); }
        .task-card.p4 { border-left-color: var(--text-muted); }

        .task-card.sortable-ghost { opacity: 0.4; }
        .task-card.sortable-chosen { box-shadow: 0 8px 25px rgba(0,0,0,0.15); }

        .task-card-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .task-card-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
        }

        .badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge.priority { color: white; }
        .badge.p1 { background: var(--danger); }
        .badge.p2 { background: var(--warning); }
        .badge.p3 { background: var(--info); }
        .badge.p4 { background: var(--text-muted); }

        .badge.project {
            background: var(--bg);
            color: var(--text-muted);
            border: 1px solid var(--border);
        }

        .badge.milestone {
            background: #fef3c7;
            color: #92400e;
        }

        .badge.tag {
            background: var(--primary-light);
            color: var(--primary);
        }

        .task-card-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .task-card-date {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .task-card-progress {
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
            margin: 0 12px;
        }

        .progress-bar {
            flex: 1;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 2px;
            transition: width 0.3s;
        }

        .task-card-assignees {
            display: flex;
            margin-left: auto;
        }

        .assignee-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            font-weight: 600;
            margin-left: -6px;
            border: 2px solid var(--card-bg);
        }

        .assignee-avatar:first-child { margin-left: 0; }

        /* === EMPTY STATE === */
        .empty-column {
            text-align: center;
            padding: 24px;
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        /* === MODAL SYSTEM === */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }

        .modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--card-bg);
            border-radius: 16px;
            width: 90%;
            max-width: 520px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transform: scale(0.95);
            transition: transform 0.2s;
        }

        .modal-overlay.open .modal {
            transform: scale(1);
        }

        .modal-header {
            padding: 18px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: var(--bg);
            cursor: pointer;
            font-size: 1.2rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover { background: var(--border); }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* === FORM ELEMENTS === */
        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--text);
        }

        .form-group label .required {
            color: var(--danger);
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.15s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
        }

        /* Priority selector */
        .priority-selector {
            display: flex;
            gap: 8px;
        }

        .priority-option {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--card-bg);
            cursor: pointer;
            text-align: center;
            font-size: 0.75rem;
            font-weight: 500;
            transition: all 0.15s;
        }

        .priority-option:hover { border-color: var(--text-muted); }

        .priority-option.active {
            border-width: 2px;
        }

        .priority-option.p1.active { border-color: var(--danger); background: #fef2f2; color: var(--danger); }
        .priority-option.p2.active { border-color: var(--warning); background: #fefce8; color: #a16207; }
        .priority-option.p3.active { border-color: var(--info); background: #eff6ff; color: var(--info); }
        .priority-option.p4.active { border-color: var(--text-muted); background: var(--bg); }

        .priority-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }

        .priority-dot.p1 { background: var(--danger); }
        .priority-dot.p2 { background: var(--warning); }
        .priority-dot.p3 { background: var(--info); }
        .priority-dot.p4 { background: var(--text-muted); }

        /* Type selector */
        .type-selector {
            display: flex;
            gap: 8px;
        }

        .type-option {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--card-bg);
            cursor: pointer;
            text-align: center;
            font-size: 0.8rem;
            transition: all 0.15s;
        }

        .type-option:hover { border-color: var(--text-muted); }
        .type-option.active { border-color: var(--primary); background: var(--primary-light); color: var(--primary); }

        /* Slider */
        .slider-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .slider {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            background: var(--border);
            border-radius: 3px;
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
        }

        .slider-value {
            min-width: 40px;
            text-align: right;
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* Multi-select */
        .multi-select {
            position: relative;
        }

        .multi-select-trigger {
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--card-bg);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 42px;
        }

        .multi-select-trigger:hover { border-color: var(--text-muted); }

        .multi-select-values {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 4px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            z-index: 100;
            display: none;
            max-height: 200px;
            overflow-y: auto;
        }

        .multi-select.open .multi-select-dropdown { display: block; }

        .multi-select-option {
            padding: 10px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
        }

        .multi-select-option:hover { background: var(--bg); }
        .multi-select-option.selected { background: var(--primary-light); }

        .multi-select-option input {
            margin: 0;
        }

        /* === LEGEND === */
        .legend {
            display: flex;
            gap: 16px;
            padding: 10px 20px;
            background: var(--card-bg);
            border-top: 1px solid var(--border);
            font-size: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
            flex-shrink: 0;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        /* === TOAST === */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2000;
        }

        .toast {
            padding: 12px 20px;
            background: var(--text);
            color: white;
            border-radius: 8px;
            margin-top: 8px;
            font-size: 0.85rem;
            animation: slideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .toast.warning { background: var(--warning); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* === DEMO BADGE === */
        .demo-badge {
            position: fixed;
            top: 10px;
            right: 10px;
            background: var(--warning);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.7rem;
            font-weight: 600;
            z-index: 100;
        }

        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .header { padding: 10px 16px; }
            .filter-bar { padding: 8px 16px; }
            .kanban-wrapper { padding: 12px 16px; }
            .kanban-column { width: 280px; min-width: 280px; }
            .search-box input { width: 140px; }
            .search-box input:focus { width: 160px; }
            .form-row { grid-template-columns: 1fr; }
        }

        @media (max-width: 480px) {
            .kanban-column { width: calc(100vw - 48px); min-width: calc(100vw - 48px); }
            .kanban-wrapper { scroll-snap-type: x mandatory; }
            .kanban-column { scroll-snap-align: start; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <h1>
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7" rx="1"></rect>
                    <rect x="14" y="3" width="7" height="7" rx="1"></rect>
                    <rect x="3" y="14" width="7" height="7" rx="1"></rect>
                    <rect x="14" y="14" width="7" height="7" rx="1"></rect>
                </svg>
                Kanban
            </h1>
            <div class="group-selector">
                <label>Grouper par:</label>
                <select id="groupBySelect" onchange="changeGroupBy(this.value)">
                    <option value="statut">Statut</option>
                    <option value="priorite">Priorit√©</option>
                    <option value="projet">Projet</option>
                    <option value="assignee">Assign√©</option>
                </select>
            </div>
        </div>
        <div class="header-actions">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Rechercher..." oninput="handleSearch()">
            </div>
            <button class="btn primary" onclick="openCreateModal()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Nouvelle t√¢che
            </button>
        </div>
    </div>

    <div class="filter-bar">
        <div class="filter-dropdown" id="filterProject">
            <button class="filter-btn" onclick="toggleFilterMenu('filterProject')">
                <span id="filterProjectLabel">Projet ‚ñæ</span>
            </button>
            <div class="filter-menu" id="filterProjectMenu"></div>
        </div>
        <div class="filter-dropdown" id="filterPriority">
            <button class="filter-btn" onclick="toggleFilterMenu('filterPriority')">
                <span id="filterPriorityLabel">Priorit√© ‚ñæ</span>
            </button>
            <div class="filter-menu" id="filterPriorityMenu"></div>
        </div>
        <div class="active-filters" id="activeFilters"></div>
    </div>

    <div class="kanban-wrapper">
        <div class="kanban-container" id="kanbanContainer"></div>
    </div>

    <div class="legend">
        <div class="legend-item">
            <div class="legend-color" style="background: var(--danger)"></div>
            <span>Critique</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: var(--warning)"></div>
            <span>Haute</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: var(--info)"></div>
            <span>Moyenne</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: var(--text-muted)"></div>
            <span>Basse</span>
        </div>
    </div>

    <!-- Task Modal -->
    <div class="modal-overlay" id="taskModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">
                    <span>‚úèÔ∏è</span> Nouvelle t√¢che
                </div>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="taskId">
                
                <div class="form-group">
                    <label>Titre <span class="required">*</span></label>
                    <input type="text" class="form-control" id="taskTitle" placeholder="Nom de la t√¢che">
                </div>

                <div class="form-group">
                    <label>Description</label>
                    <textarea class="form-control" id="taskDescription" placeholder="Description d√©taill√©e..."></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Date de d√©but</label>
                        <input type="date" class="form-control" id="taskStart">
                    </div>
                    <div class="form-group">
                        <label>Date d'√©ch√©ance</label>
                        <input type="date" class="form-control" id="taskEnd">
                    </div>
                </div>

                <div class="form-group">
                    <label>Priorit√©</label>
                    <div class="priority-selector" id="prioritySelector">
                        <div class="priority-option p1" data-value="1" onclick="selectPriority(1)">
                            <span class="priority-dot p1"></span>Critique
                        </div>
                        <div class="priority-option p2" data-value="2" onclick="selectPriority(2)">
                            <span class="priority-dot p2"></span>Haute
                        </div>
                        <div class="priority-option p3 active" data-value="3" onclick="selectPriority(3)">
                            <span class="priority-dot p3"></span>Moyenne
                        </div>
                        <div class="priority-option p4" data-value="4" onclick="selectPriority(4)">
                            <span class="priority-dot p4"></span>Basse
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Statut</label>
                        <select class="form-control" id="taskStatus">
                            <option value="todo">√Ä faire</option>
                            <option value="inprogress">En cours</option>
                            <option value="review">En revue</option>
                            <option value="done">Termin√©</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Projet</label>
                        <select class="form-control" id="taskProject">
                            <option value="">Aucun projet</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Type</label>
                    <div class="type-selector" id="typeSelector">
                        <div class="type-option active" data-value="tache" onclick="selectType('tache')">üìã T√¢che</div>
                        <div class="type-option" data-value="jalon" onclick="selectType('jalon')">‚óÜ Jalon</div>
                        <div class="type-option" data-value="reunion" onclick="selectType('reunion')">üë• R√©union</div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Progression</label>
                    <div class="slider-container">
                        <input type="range" class="slider" id="taskProgress" min="0" max="100" value="0" oninput="updateProgressLabel()">
                        <span class="slider-value" id="progressValue">0%</span>
                    </div>
                </div>

                <div class="form-group">
                    <label>Assign√©s</label>
                    <div class="multi-select" id="assigneeSelect">
                        <div class="multi-select-trigger" onclick="toggleMultiSelect('assigneeSelect')">
                            <div class="multi-select-values" id="assigneeValues">
                                <span style="color: var(--text-muted)">S√©lectionner...</span>
                            </div>
                            <span>‚ñæ</span>
                        </div>
                        <div class="multi-select-dropdown" id="assigneeDropdown"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal()">Annuler</button>
                <button class="btn primary" onclick="saveTask()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                        <polyline points="7 3 7 8 15 8"></polyline>
                    </svg>
                    Enregistrer
                </button>
            </div>
        </div>
    </div>

    <!-- Add Column Modal -->
    <div class="modal-overlay" id="addColumnModal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header">
                <div class="modal-title">‚ûï Nouvelle colonne</div>
                <button class="modal-close" onclick="closeAddColumnModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Nom de la colonne <span class="required">*</span></label>
                    <input type="text" class="form-control" id="newColumnName" placeholder="Ex: En test">
                </div>
                <div class="form-group">
                    <label>Couleur</label>
                    <input type="color" class="form-control" id="newColumnColor" value="#6366f1" style="height: 42px; padding: 4px;">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeAddColumnModal()">Annuler</button>
                <button class="btn primary" onclick="addColumn()">Cr√©er</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CONFIGURATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const PRIORITY_LABELS = { 1: 'Critique', 2: 'Haute', 3: 'Moyenne', 4: 'Basse' };
        const PRIORITY_COLORS = { 1: '#ef4444', 2: '#f59e0b', 3: '#3b82f6', 4: '#64748b' };
        
        const STATUS_CONFIG = {
            'todo': { label: '√Ä faire', color: '#64748b', order: 1 },
            'inprogress': { label: 'En cours', color: '#3b82f6', order: 2 },
            'review': { label: 'En revue', color: '#f59e0b', order: 3 },
            'done': { label: 'Termin√©', color: '#10b981', order: 4 }
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // STATE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let gristReady = false;
        let tasks = [];
        let team = [];
        let projects = [];
        let columns = [];
        let selectedTaskId = null;
        let sortableInstances = [];
        let groupBy = 'statut';
        let searchQuery = '';
        let filters = { project: null, priority: null };
        let selectedPriority = 3;
        let selectedType = 'tache';
        let selectedAssignees = [];

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // UTILITIES
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function gristToDate(ts) {
            if (ts === null || ts === undefined || ts === '') return null;
            const num = Number(ts);
            if (isNaN(num)) return null;
            return new Date(num * 1000);
        }

        function dateToGrist(date) {
            if (!date) return null;
            return Math.floor(date.getTime() / 1000);
        }

        function formatDateShort(date) {
            if (!date) return '-';
            return new Intl.DateTimeFormat('fr-FR', { day: '2-digit', month: 'short' }).format(date);
        }

        function formatDateInput(date) {
            if (!date) return '';
            return date.toISOString().split('T')[0];
        }

        function getTaskPriority(task) {
            if (!task) return 3;
            const p = task.priorite;
            return (p >= 1 && p <= 4) ? p : 3;
        }

        function isJalon(task) {
            if (task.type === 'jalon') return true;
            const debut = gristToDate(task.dateDebut);
            const echeance = gristToDate(task.dateEcheance);
            if (debut && echeance) {
                return debut.toDateString() === echeance.toDateString();
            }
            return false;
        }

        function getAssigneesArray(task) {
            if (!task?.assignees) return [];
            if (Array.isArray(task.assignees)) {
                return task.assignees[0] === 'L' ? task.assignees.slice(1).map(Number) : task.assignees.map(Number);
            }
            return [];
        }

        function getInitials(name) {
            if (!name) return '?';
            return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3500);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // GROUP BY LOGIC
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function changeGroupBy(value) {
            groupBy = value;
            localStorage.setItem('taskflow_kanban_groupby', value);
            buildColumns();
            render();
        }

        function buildColumns() {
            columns = [];
            
            if (groupBy === 'statut') {
                Object.entries(STATUS_CONFIG).forEach(([id, config]) => {
                    columns.push({ id, label: config.label, color: config.color, order: config.order });
                });
                columns.sort((a, b) => a.order - b.order);
            } else if (groupBy === 'priorite') {
                [1, 2, 3, 4].forEach(p => {
                    columns.push({ id: p, label: PRIORITY_LABELS[p], color: PRIORITY_COLORS[p], order: p });
                });
            } else if (groupBy === 'projet') {
                columns.push({ id: '', label: 'Sans projet', color: '#64748b', order: 0 });
                const projectNames = [...new Set(tasks.map(t => t.projet).filter(Boolean))].sort();
                projectNames.forEach((name, i) => {
                    const proj = projects.find(p => p.nom === name);
                    columns.push({ id: name, label: name, color: proj?.couleur || '#6366f1', order: i + 1 });
                });
            } else if (groupBy === 'assignee') {
                columns.push({ id: 0, label: 'Non assign√©', color: '#64748b', order: 0 });
                team.forEach((member, i) => {
                    columns.push({ id: member.id, label: member.nom, color: '#6366f1', order: i + 1 });
                });
            }
        }

        function getTaskColumnValue(task) {
            if (groupBy === 'statut') return task.statut || 'todo';
            if (groupBy === 'priorite') return getTaskPriority(task);
            if (groupBy === 'projet') return task.projet || '';
            if (groupBy === 'assignee') {
                const assignees = getAssigneesArray(task);
                return assignees.length > 0 ? assignees[0] : 0;
            }
            return task.statut || 'todo';
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // FILTERS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function loadFilters() {
            try {
                const stored = localStorage.getItem('taskflow_kanban_filters');
                if (stored) filters = { ...filters, ...JSON.parse(stored) };
                const storedGroup = localStorage.getItem('taskflow_kanban_groupby');
                if (storedGroup) {
                    groupBy = storedGroup;
                    document.getElementById('groupBySelect').value = groupBy;
                }
            } catch (e) {}
        }

        function saveFilters() {
            localStorage.setItem('taskflow_kanban_filters', JSON.stringify(filters));
        }

        function toggleFilterMenu(id) {
            const menu = document.querySelector(`#${id} .filter-menu`);
            const wasOpen = menu.classList.contains('open');
            document.querySelectorAll('.filter-menu').forEach(m => m.classList.remove('open'));
            if (!wasOpen) menu.classList.add('open');
        }

        function setFilter(key, value) {
            filters[key] = value || null;
            saveFilters();
            updateFilterUI();
            render();
        }

        function updateFilterMenus() {
            // Projects filter
            const projectsSet = [...new Set(tasks.map(t => t.projet).filter(Boolean))].sort();
            document.getElementById('filterProjectMenu').innerHTML = `
                <div class="filter-menu-header">Projets</div>
                <div class="filter-option ${!filters.project ? 'active' : ''}" onclick="setFilter('project', null)">Tous les projets</div>
                ${projectsSet.map(p => `
                    <div class="filter-option ${filters.project === p ? 'active' : ''}" onclick="setFilter('project', '${escapeHtml(p)}')">
                        ${escapeHtml(p)}
                    </div>
                `).join('')}
            `;

            // Priority filter
            document.getElementById('filterPriorityMenu').innerHTML = `
                <div class="filter-menu-header">Priorit√©</div>
                <div class="filter-option ${!filters.priority ? 'active' : ''}" onclick="setFilter('priority', null)">Toutes</div>
                ${[1, 2, 3, 4].map(p => `
                    <div class="filter-option ${filters.priority === p ? 'active' : ''}" onclick="setFilter('priority', ${p})">
                        <span class="color-dot" style="background: ${PRIORITY_COLORS[p]}"></span>
                        ${PRIORITY_LABELS[p]}
                    </div>
                `).join('')}
            `;

            // Update project dropdown in modal
            document.getElementById('taskProject').innerHTML = `
                <option value="">Aucun projet</option>
                ${projectsSet.map(p => `<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join('')}
            `;

            updateFilterUI();
        }

        function updateFilterUI() {
            const projectBtn = document.querySelector('#filterProject .filter-btn');
            const priorityBtn = document.querySelector('#filterPriority .filter-btn');
            
            projectBtn.className = 'filter-btn' + (filters.project ? ' active' : '');
            priorityBtn.className = 'filter-btn' + (filters.priority ? ' active' : '');
            
            document.getElementById('filterProjectLabel').textContent = filters.project ? `Projet: ${filters.project}` : 'Projet ‚ñæ';
            document.getElementById('filterPriorityLabel').textContent = filters.priority ? `${PRIORITY_LABELS[filters.priority]}` : 'Priorit√© ‚ñæ';

            const chips = [];
            if (filters.project) chips.push(`<span class="filter-chip">${escapeHtml(filters.project)} <button onclick="setFilter('project', null)">√ó</button></span>`);
            if (filters.priority) chips.push(`<span class="filter-chip">${PRIORITY_LABELS[filters.priority]} <button onclick="setFilter('priority', null)">√ó</button></span>`);
            document.getElementById('activeFilters').innerHTML = chips.join('');
        }

        function handleSearch() {
            searchQuery = document.getElementById('searchInput').value.toLowerCase().trim();
            render();
        }

        function getFilteredTasks() {
            return tasks.filter(task => {
                if (filters.project && task.projet !== filters.project) return false;
                if (filters.priority && getTaskPriority(task) !== filters.priority) return false;
                if (searchQuery) {
                    const title = (task.titre || '').toLowerCase();
                    const desc = (task.description || '').toLowerCase();
                    if (!title.includes(searchQuery) && !desc.includes(searchQuery)) return false;
                }
                return true;
            });
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // RENDER
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function render() {
            const container = document.getElementById('kanbanContainer');
            const filteredTasks = getFilteredTasks();

            // Destroy existing sortables
            sortableInstances.forEach(s => s.destroy());
            sortableInstances = [];

            let html = '';

            columns.forEach(col => {
                const columnTasks = filteredTasks.filter(t => {
                    const val = getTaskColumnValue(t);
                    return val === col.id || String(val) === String(col.id);
                });

                html += `
                    <div class="kanban-column" data-column-id="${col.id}">
                        <div class="column-header">
                            <span class="column-title">
                                <span class="column-dot" style="background: ${col.color}"></span>
                                ${escapeHtml(col.label)}
                            </span>
                            <span class="column-count">${columnTasks.length}</span>
                        </div>
                        <div class="column-body" data-column="${col.id}">
                            ${columnTasks.length === 0 ? '<div class="empty-column">Aucune t√¢che</div>' : ''}
                            ${columnTasks.map(task => renderTaskCard(task)).join('')}
                        </div>
                        <div class="column-footer">
                            <button class="add-task-btn" onclick="openCreateModal('${col.id}')">
                                + Ajouter une t√¢che
                            </button>
                        </div>
                    </div>
                `;
            });

            // Add column button (only for statut grouping for now)
            if (groupBy === 'statut') {
                html += `
                    <div class="add-column" onclick="openAddColumnModal()">
                        + Ajouter une colonne
                    </div>
                `;
            }

            container.innerHTML = html;

            // Init sortables
            document.querySelectorAll('.column-body').forEach(body => {
                const sortable = Sortable.create(body, {
                    group: 'kanban',
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    onEnd: handleDragEnd
                });
                sortableInstances.push(sortable);
            });

            // Click handlers
            document.querySelectorAll('.task-card').forEach(card => {
                card.addEventListener('click', () => selectTask(parseInt(card.dataset.id)));
                card.addEventListener('dblclick', () => openEditModal(parseInt(card.dataset.id)));
            });
        }

        function renderTaskCard(task) {
            const p = getTaskPriority(task);
            const echeance = gristToDate(task.dateEcheance);
            const selected = task.id === selectedTaskId ? ' selected' : '';
            const jalon = isJalon(task);
            const assignees = getAssigneesArray(task);
            const progress = task.progression || 0;

            let badgesHtml = `<span class="badge priority p${p}">${PRIORITY_LABELS[p]}</span>`;
            if (task.projet) badgesHtml += `<span class="badge project">${escapeHtml(task.projet)}</span>`;
            if (jalon) badgesHtml += `<span class="badge milestone">‚óÜ Jalon</span>`;

            let assigneesHtml = '';
            if (assignees.length > 0) {
                assigneesHtml = '<div class="task-card-assignees">';
                assignees.slice(0, 3).forEach(id => {
                    const member = team.find(m => m.id === id);
                    if (member) {
                        assigneesHtml += `<div class="assignee-avatar" title="${escapeHtml(member.nom)}">${getInitials(member.nom)}</div>`;
                    }
                });
                if (assignees.length > 3) {
                    assigneesHtml += `<div class="assignee-avatar" title="${assignees.length - 3} autres">+${assignees.length - 3}</div>`;
                }
                assigneesHtml += '</div>';
            }

            return `
                <div class="task-card p${p}${selected}" data-id="${task.id}">
                    <div class="task-card-title">${escapeHtml(task.titre)}</div>
                    <div class="task-card-badges">${badgesHtml}</div>
                    <div class="task-card-meta">
                        <span class="task-card-date">üìÖ ${formatDateShort(echeance)}</span>
                        <div class="task-card-progress">
                            <div class="progress-bar">
                                <div class="progress-bar-fill" style="width: ${progress}%"></div>
                            </div>
                            <span>${progress}%</span>
                        </div>
                        ${assigneesHtml}
                    </div>
                </div>
            `;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // DRAG & DROP
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function handleDragEnd(evt) {
            const taskId = parseInt(evt.item.dataset.id);
            const newColumn = evt.to.dataset.column;
            const task = tasks.find(t => t.id === taskId);

            if (!task) return;

            // Update local state
            if (groupBy === 'statut') {
                task.statut = newColumn;
            } else if (groupBy === 'priorite') {
                task.priorite = parseInt(newColumn);
            } else if (groupBy === 'projet') {
                task.projet = newColumn || null;
            }

            // Persist to Grist
            if (gristReady) {
                try {
                    const update = {};
                    if (groupBy === 'statut') update.statut = newColumn;
                    else if (groupBy === 'priorite') update.priorite = parseInt(newColumn);
                    else if (groupBy === 'projet') update.projet = newColumn || null;

                    await grist.docApi.applyUserActions([
                        ['UpdateRecord', 'Tasks', taskId, update]
                    ]);
                    showToast('‚úì T√¢che mise √† jour', 'success');
                } catch (e) {
                    console.error('Error updating task:', e);
                    showToast('Erreur de mise √† jour', 'error');
                }
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SELECTION (Grist sync)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function selectTask(taskId) {
            selectedTaskId = taskId;

            document.querySelectorAll('.task-card').forEach(card => {
                card.classList.toggle('selected', parseInt(card.dataset.id) === taskId);
            });

            if (gristReady && taskId) {
                grist.setSelectedRows([taskId]);
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // MODAL SYSTEM
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function openCreateModal(columnId = null) {
            document.getElementById('taskId').value = '';
            document.getElementById('modalTitle').innerHTML = '<span>‚úèÔ∏è</span> Nouvelle t√¢che';
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskDescription').value = '';
            document.getElementById('taskStart').value = formatDateInput(new Date());
            document.getElementById('taskEnd').value = '';
            document.getElementById('taskProgress').value = 0;
            document.getElementById('progressValue').textContent = '0%';

            // Set defaults based on column
            if (columnId !== null) {
                if (groupBy === 'statut') {
                    document.getElementById('taskStatus').value = columnId;
                } else if (groupBy === 'priorite') {
                    selectPriority(parseInt(columnId));
                } else if (groupBy === 'projet') {
                    document.getElementById('taskProject').value = columnId;
                }
            } else {
                document.getElementById('taskStatus').value = 'todo';
            }

            selectPriority(selectedPriority);
            selectType('tache');
            selectedAssignees = [];
            updateAssigneeDisplay();
            updateAssigneeDropdown();

            document.getElementById('taskModal').classList.add('open');
            document.getElementById('taskTitle').focus();
        }

        function openEditModal(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            document.getElementById('taskId').value = task.id;
            document.getElementById('modalTitle').innerHTML = '<span>üìù</span> Modifier la t√¢che';
            document.getElementById('taskTitle').value = task.titre || '';
            document.getElementById('taskDescription').value = task.description || '';
            document.getElementById('taskStatus').value = task.statut || 'todo';
            document.getElementById('taskProject').value = task.projet || '';
            document.getElementById('taskProgress').value = task.progression || 0;
            document.getElementById('progressValue').textContent = (task.progression || 0) + '%';

            const start = gristToDate(task.dateDebut);
            const end = gristToDate(task.dateEcheance);
            document.getElementById('taskStart').value = start ? formatDateInput(start) : '';
            document.getElementById('taskEnd').value = end ? formatDateInput(end) : '';

            selectPriority(getTaskPriority(task));
            selectType(task.type || 'tache');
            selectedAssignees = getAssigneesArray(task);
            updateAssigneeDisplay();
            updateAssigneeDropdown();

            document.getElementById('taskModal').classList.add('open');
        }

        function closeModal() {
            document.getElementById('taskModal').classList.remove('open');
        }

        function selectPriority(p) {
            selectedPriority = p;
            document.querySelectorAll('.priority-option').forEach(opt => {
                opt.classList.toggle('active', parseInt(opt.dataset.value) === p);
            });
        }

        function selectType(type) {
            selectedType = type;
            document.querySelectorAll('.type-option').forEach(opt => {
                opt.classList.toggle('active', opt.dataset.value === type);
            });
        }

        function updateProgressLabel() {
            const val = document.getElementById('taskProgress').value;
            document.getElementById('progressValue').textContent = val + '%';
        }

        // Multi-select for assignees
        function toggleMultiSelect(id) {
            document.getElementById(id).classList.toggle('open');
        }

        function updateAssigneeDropdown() {
            const dropdown = document.getElementById('assigneeDropdown');
            dropdown.innerHTML = team.map(member => `
                <div class="multi-select-option ${selectedAssignees.includes(member.id) ? 'selected' : ''}" 
                     onclick="toggleAssignee(${member.id})">
                    <input type="checkbox" ${selectedAssignees.includes(member.id) ? 'checked' : ''}>
                    ${escapeHtml(member.nom)}
                </div>
            `).join('');
        }

        function toggleAssignee(id) {
            if (selectedAssignees.includes(id)) {
                selectedAssignees = selectedAssignees.filter(a => a !== id);
            } else {
                selectedAssignees.push(id);
            }
            updateAssigneeDisplay();
            updateAssigneeDropdown();
        }

        function updateAssigneeDisplay() {
            const container = document.getElementById('assigneeValues');
            if (selectedAssignees.length === 0) {
                container.innerHTML = '<span style="color: var(--text-muted)">S√©lectionner...</span>';
            } else {
                container.innerHTML = selectedAssignees.map(id => {
                    const member = team.find(m => m.id === id);
                    return member ? `<span class="filter-chip">${escapeHtml(member.nom)}</span>` : '';
                }).join('');
            }
        }

        async function saveTask() {
            const taskId = document.getElementById('taskId').value;
            const title = document.getElementById('taskTitle').value.trim();

            if (!title) {
                showToast('‚ö†Ô∏è Le titre est requis', 'warning');
                document.getElementById('taskTitle').focus();
                return;
            }

            const startVal = document.getElementById('taskStart').value;
            const endVal = document.getElementById('taskEnd').value;

            const taskData = {
                titre: title,
                description: document.getElementById('taskDescription').value,
                statut: document.getElementById('taskStatus').value,
                projet: document.getElementById('taskProject').value || null,
                priorite: selectedPriority,
                type: selectedType,
                progression: parseInt(document.getElementById('taskProgress').value),
                dateDebut: startVal ? dateToGrist(new Date(startVal)) : null,
                dateEcheance: endVal ? dateToGrist(new Date(endVal)) : null,
                assignees: selectedAssignees.length > 0 ? ['L', ...selectedAssignees] : null
            };

            if (gristReady) {
                try {
                    if (taskId) {
                        // Update
                        await grist.docApi.applyUserActions([
                            ['UpdateRecord', 'Tasks', parseInt(taskId), taskData]
                        ]);
                        showToast('‚úì T√¢che modifi√©e', 'success');
                    } else {
                        // Create
                        await grist.docApi.applyUserActions([
                            ['AddRecord', 'Tasks', null, taskData]
                        ]);
                        showToast('‚úì T√¢che cr√©√©e', 'success');
                    }
                    closeModal();
                } catch (e) {
                    console.error('Error saving task:', e);
                    showToast('Erreur lors de la sauvegarde', 'error');
                }
            } else {
                // Demo mode
                if (taskId) {
                    const task = tasks.find(t => t.id === parseInt(taskId));
                    if (task) Object.assign(task, taskData);
                } else {
                    taskData.id = Date.now();
                    tasks.push(taskData);
                }
                render();
                closeModal();
                showToast('‚úì T√¢che enregistr√©e (mode d√©mo)', 'success');
            }
        }

        // Add Column Modal
        function openAddColumnModal() {
            document.getElementById('newColumnName').value = '';
            document.getElementById('newColumnColor').value = '#6366f1';
            document.getElementById('addColumnModal').classList.add('open');
            document.getElementById('newColumnName').focus();
        }

        function closeAddColumnModal() {
            document.getElementById('addColumnModal').classList.remove('open');
        }

        async function addColumn() {
            const name = document.getElementById('newColumnName').value.trim();
            if (!name) {
                showToast('‚ö†Ô∏è Nom requis', 'warning');
                return;
            }

            const color = document.getElementById('newColumnColor').value;
            const id = name.toLowerCase().replace(/\s+/g, '_');

            // Add to local config
            STATUS_CONFIG[id] = {
                label: name,
                color: color,
                order: Object.keys(STATUS_CONFIG).length + 1
            };

            buildColumns();
            render();
            closeAddColumnModal();
            showToast('‚úì Colonne cr√©√©e', 'success');
        }

        // Close modals on click outside
        document.addEventListener('click', (e) => {
            // Close filter menus
            if (!e.target.closest('.filter-dropdown')) {
                document.querySelectorAll('.filter-menu').forEach(m => m.classList.remove('open'));
            }
            // Close multi-select
            if (!e.target.closest('.multi-select')) {
                document.querySelectorAll('.multi-select').forEach(m => m.classList.remove('open'));
            }
        });

        // Close modal on escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
                closeAddColumnModal();
            }
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // GRIST INTEGRATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function convertGristToRecords(data) {
            if (!data || Array.isArray(data)) return data || [];
            const cols = Object.keys(data);
            if (!cols.length) return [];
            const count = data[cols[0]]?.length || 0;
            const records = [];
            for (let i = 0; i < count; i++) {
                const record = {};
                cols.forEach(c => record[c] = data[c][i]);
                records.push(record);
            }
            return records;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SCHEMA AUTO-INITIALISATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        const TASKFLOW_SCHEMA = {
            // Ordre important : tables r√©f√©renc√©es en premier
            Team: [
                { id: 'nom', type: 'Text' },
                { id: 'email', type: 'Text' },
                { id: 'avatar', type: 'Text' },
                { id: 'role', type: 'Choice' },
                { id: 'actif', type: 'Bool' }
            ],
            Projects: [
                { id: 'nom', type: 'Text' },
                { id: 'couleur', type: 'Text' },
                { id: 'dateDebut', type: 'Date' },
                { id: 'dateFin', type: 'Date' },
                { id: 'responsable', type: 'Ref:Team' },
                { id: 'actif', type: 'Bool' }
            ],
            Tasks: [
                { id: 'titre', type: 'Text' },
                { id: 'description', type: 'Text' },
                { id: 'dateDebut', type: 'Date' },
                { id: 'dateEcheance', type: 'Date' },
                { id: 'priorite', type: 'Choice' },
                { id: 'statut', type: 'Choice' },
                { id: 'progression', type: 'Numeric' },
                { id: 'projet', type: 'Ref:Projects' },
                { id: 'assignees', type: 'RefList:Team' },
                { id: 'type', type: 'Choice' },
                { id: 'dependDe', type: 'RefList:Tasks' },
                { id: 'tags', type: 'ChoiceList' },
                { id: 'estimationH', type: 'Numeric' },
                { id: 'tempsPasse', type: 'Numeric' },
                { id: 'couleur', type: 'Text' }
            ]
        };

        async function ensureSchema() {
            const log = (msg) => console.log(`[TaskFlow Schema] ${msg}`);
            let created = 0, added = 0;
            const tablesCreated = [];

            for (const [tableName, columns] of Object.entries(TASKFLOW_SCHEMA)) {
                let existingCols = [];
                let tableExists = false;

                try {
                    const data = await grist.docApi.fetchTable(tableName);
                    existingCols = Object.keys(data).filter(c => c !== 'id' && c !== 'manualSort');
                    tableExists = true;
                    log(`‚úì Table ${tableName} existe (${existingCols.length} colonnes)`);
                } catch (e) {
                    try {
                        await grist.docApi.applyUserActions([
                            ['AddTable', tableName, columns.map(c => ({ id: c.id, type: c.type }))]
                        ]);
                        log(`‚úÖ Table ${tableName} cr√©√©e avec ${columns.length} colonnes`);
                        tablesCreated.push(tableName);
                        created++;
                        continue;
                    } catch (e2) {
                        log(`‚ö†Ô∏è Impossible de cr√©er ${tableName}: ${e2.message || e2}`);
                        continue;
                    }
                }

                if (tableExists) {
                    const missing = columns.filter(c => !existingCols.includes(c.id));
                    for (const col of missing) {
                        try {
                            await grist.docApi.applyUserActions([
                                ['AddColumn', tableName, col.id, { type: col.type }]
                            ]);
                            log(`  + Colonne ${tableName}.${col.id} (${col.type}) ajout√©e`);
                            added++;
                        } catch (e) {
                            log(`  ~ Colonne ${tableName}.${col.id} ignor√©e: ${e.message || e}`);
                        }
                    }
                }
            }

            // Ins√©rer des donn√©es initiales si les tables viennent d'√™tre cr√©√©es
            if (tablesCreated.includes('Tasks')) {
                await seedData();
            }

            if (created > 0 || added > 0) {
                log(`Schema OK ‚Äî ${created} table(s) cr√©√©e(s), ${added} colonne(s) ajout√©e(s)`);
                showToast(`Schema initialis√© (${created} tables, ${added} colonnes)`, 'success');
            } else {
                log('Schema complet ‚Äî rien √† modifier');
            }
        }

        async function seedData() {
            const log = (msg) => console.log(`[TaskFlow Seed] ${msg}`);
            const today = new Date();
            const day = (d) => {
                const dt = new Date(today.getFullYear(), today.getMonth(), today.getDate() + d);
                return dt.getTime() / 1000;
            };

            try {
                // ‚îÄ‚îÄ Team ‚îÄ‚îÄ
                await grist.docApi.applyUserActions([
                    ['AddRecord', 'Team', null, { nom: 'Alice Martin', email: 'alice.martin@cerema.fr', role: 'Chef de projet', actif: true }],
                    ['AddRecord', 'Team', null, { nom: 'Bob Durant', email: 'bob.durant@cerema.fr', role: 'D√©veloppeur', actif: true }],
                    ['AddRecord', 'Team', null, { nom: 'Claire Bernard', email: 'claire.bernard@cerema.fr', role: 'Designer', actif: true }],
                    ['AddRecord', 'Team', null, { nom: 'David Petit', email: 'david.petit@cerema.fr', role: 'Data analyst', actif: true }]
                ]);
                log('‚úÖ 4 membres ajout√©s √† Team');

                // ‚îÄ‚îÄ Projects ‚îÄ‚îÄ
                await grist.docApi.applyUserActions([
                    ['AddRecord', 'Projects', null, { nom: 'Refonte Portail', couleur: '#4f46e5', dateDebut: day(-15), dateFin: day(45), responsable: 1, actif: true }],
                    ['AddRecord', 'Projects', null, { nom: 'App Mobile Terrain', couleur: '#10b981', dateDebut: day(-5), dateFin: day(60), responsable: 2, actif: true }],
                    ['AddRecord', 'Projects', null, { nom: 'Dashboard IA', couleur: '#f59e0b', dateDebut: day(0), dateFin: day(30), responsable: 4, actif: true }]
                ]);
                log('‚úÖ 3 projets ajout√©s √† Projects');

                // ‚îÄ‚îÄ Tasks ‚îÄ‚îÄ
                await grist.docApi.applyUserActions([
                    // Projet 1 ‚Äî Refonte Portail
                    ['AddRecord', 'Tasks', null, {
                        titre: 'Cahier des charges', description: 'R√©diger le CDC complet avec specs fonctionnelles',
                        dateDebut: day(-15), dateEcheance: day(-8), priorite: '1', statut: 'done',
                        progression: 100, projet: 1, type: 'tache', assignees: ['L', 1], estimationH: 16
                    }],
                    ['AddRecord', 'Tasks', null, {
                        titre: 'Maquettes UI/UX', description: 'Wireframes et prototypes Figma',
                        dateDebut: day(-10), dateEcheance: day(-2), priorite: '2', statut: 'done',
                        progression: 100, projet: 1, type: 'tache', assignees: ['L', 3], estimationH: 24
                    }],
                    ['AddRecord', 'Tasks', null, {
                        titre: 'D√©veloppement frontend', description: 'Int√©gration HTML/CSS/JS du nouveau portail',
                        dateDebut: day(-3), dateEcheance: day(12), priorite: '1', statut: 'inprogress',
                        progression: 35, projet: 1, type: 'tache', assignees: ['L', 2, 3], dependDe: ['L', 2], estimationH: 40
                    }],
                    ['AddRecord', 'Tasks', null, {
                        titre: 'Validation design', description: 'Point de validation des maquettes avec le comit√©',
                        dateDebut: day(-2), dateEcheance: day(-2), priorite: '2', statut: 'done',
                        progression: 100, projet: 1, type: 'jalon'
                    }],
                    ['AddRecord', 'Tasks', null, {
                        titre: 'API backend', description: 'D√©veloppement des endpoints REST',
                        dateDebut: day(-5), dateEcheance: day(10), priorite: '1', statut: 'inprogress',
                        progression: 55, projet: 1, type: 'tache', assignees: ['L', 2], estimationH: 32, tempsPasse: 18
                    }],

                    // Projet 2 ‚Äî App Mobile
                    ['AddRecord', 'Tasks', null, {
                        titre: '√âtude terrain', description: 'Analyse des besoins agents terrain',
                        dateDebut: day(-5), dateEcheance: day(0), priorite: '2', statut: 'review',
                        progression: 90, projet: 2, type: 'tache', assignees: ['L', 1, 4], estimationH: 12
                    }],
                    ['AddRecord', 'Tasks', null, {
                        titre: 'Proto mobile v1', description: 'Premier prototype fonctionnel React Native',
                        dateDebut: day(1), dateEcheance: day(20), priorite: '2', statut: 'todo',
                        progression: 0, projet: 2, type: 'tache', assignees: ['L', 2], dependDe: ['L', 6], estimationH: 48
                    }],
                    ['AddRecord', 'Tasks', null, {
                        titre: 'R√©union lancement mobile', description: 'Kick-off avec les parties prenantes',
                        dateDebut: day(2), dateEcheance: day(2), priorite: '3', statut: 'todo',
                        progression: 0, projet: 2, type: 'reunion', assignees: ['L', 1, 2, 3, 4]
                    }],

                    // Projet 3 ‚Äî Dashboard IA
                    ['AddRecord', 'Tasks', null, {
                        titre: 'Collecte des sources de donn√©es', description: 'Identifier et connecter les flux de donn√©es',
                        dateDebut: day(0), dateEcheance: day(7), priorite: '2', statut: 'inprogress',
                        progression: 20, projet: 3, type: 'tache', assignees: ['L', 4], estimationH: 16
                    }],
                    ['AddRecord', 'Tasks', null, {
                        titre: 'Mod√®le de scoring IA', description: 'Entra√Æner le mod√®le de classification Albert API',
                        dateDebut: day(5), dateEcheance: day(18), priorite: '1', statut: 'todo',
                        progression: 0, projet: 3, type: 'tache', assignees: ['L', 4], dependDe: ['L', 9], estimationH: 30
                    }],
                    ['AddRecord', 'Tasks', null, {
                        titre: 'Widget dashboard Grist', description: 'Interface de visualisation des indicateurs',
                        dateDebut: day(10), dateEcheance: day(25), priorite: '3', statut: 'todo',
                        progression: 0, projet: 3, type: 'tache', assignees: ['L', 2, 3], estimationH: 24
                    }],
                    ['AddRecord', 'Tasks', null, {
                        titre: 'Livraison MVP Dashboard', description: 'Version minimale fonctionnelle',
                        dateDebut: day(28), dateEcheance: day(28), priorite: '1', statut: 'todo',
                        progression: 0, projet: 3, type: 'jalon', dependDe: ['L', 10, 11]
                    }]
                ]);
                log('‚úÖ 12 t√¢ches ajout√©es √† Tasks');

            } catch (e) {
                log(`‚ö†Ô∏è Erreur seed: ${e.message || e}`);
            }
        }

        async function loadAllData() {
            try {
                const taskData = await grist.docApi.fetchTable('Tasks');
                tasks = convertGristToRecords(taskData);
            } catch (e) {
                console.log('Tasks table not available:', e);
                tasks = [];
            }

            try {
                const teamData = await grist.docApi.fetchTable('Team');
                team = convertGristToRecords(teamData);
            } catch (e) {
                console.log('Team table not available');
            }

            try {
                const projData = await grist.docApi.fetchTable('Projects');
                projects = convertGristToRecords(projData);
            } catch (e) {
                console.log('Projects table not available');
            }

            gristReady = true;
            buildColumns();
            updateFilterMenus();
            render();
        }

        async function initGrist() {
            try {
                grist.ready({ requiredAccess: 'full' });

                // Auto-init du sch√©ma complet
                await ensureSchema();

                // Chargement initial direct
                await loadAllData();

                // Live updates quand les donn√©es changent
                grist.onRecords(async () => {
                    await loadAllData();
                });

                grist.onRecord((record) => {
                    if (record?.id && record.id !== selectedTaskId) {
                        selectedTaskId = record.id;
                        document.querySelectorAll('.task-card').forEach(card => {
                            card.classList.toggle('selected', parseInt(card.dataset.id) === selectedTaskId);
                        });
                    }
                });

            } catch (e) {
                console.log('Grist not available, using demo mode');
                useDemoMode();
            }
        }

        function useDemoMode() {
            document.body.insertAdjacentHTML('beforeend', '<div class="demo-badge">D√©mo</div>');

            team = [
                { id: 1, nom: 'Alice Martin' },
                { id: 2, nom: 'Bob Durant' },
                { id: 3, nom: 'Claire Bernard' }
            ];

            const today = new Date();
            const day = (d) => dateToGrist(new Date(today.getFullYear(), today.getMonth(), today.getDate() + d));

            tasks = [
                { id: 1, titre: 'Tests unitaires', statut: 'todo', priorite: 3, projet: 'QA', dateDebut: day(0), dateEcheance: day(2), progression: 0, assignees: ['L', 3] },
                { id: 2, titre: 'Documentation', statut: 'todo', priorite: 4, projet: 'Docs', dateDebut: day(2), dateEcheance: day(4), progression: 0, assignees: ['L', 3] },
                { id: 3, titre: 'Livraison v1.0', statut: 'todo', type: 'jalon', priorite: 1, projet: 'Release', dateDebut: day(5), dateEcheance: day(5), progression: 0 },
                { id: 4, titre: 'API REST', statut: 'inprogress', priorite: 1, projet: 'Backend', dateDebut: day(-5), dateEcheance: day(2), progression: 60, assignees: ['L', 1, 3] },
                { id: 5, titre: 'Int√©gration', statut: 'inprogress', priorite: 2, projet: 'Frontend', dateDebut: day(-3), dateEcheance: day(1), progression: 40, assignees: ['L', 2] },
                { id: 6, titre: 'Maquettes UI', statut: 'review', priorite: 2, projet: 'Design', dateDebut: day(-10), dateEcheance: day(-3), progression: 90, assignees: ['L', 2] },
                { id: 7, titre: 'Review backend', statut: 'review', priorite: 2, projet: 'Backend', dateDebut: day(-7), dateEcheance: day(-1), progression: 80, assignees: ['L', 1] },
                { id: 8, titre: 'Architecture syst√®me', statut: 'done', priorite: 1, projet: 'Backend', dateDebut: day(-15), dateEcheance: day(-10), progression: 100, assignees: ['L', 1] }
            ];

            buildColumns();
            updateFilterMenus();
            render();
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // INIT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        loadFilters();
        initGrist();
    </script>
</body>
</html>