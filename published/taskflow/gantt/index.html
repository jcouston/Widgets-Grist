<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gantt - TaskFlow v9</title>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --primary: #4f46e5; --primary-light: #e0e7ff; --primary-dark: #4338ca;
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --info: #3b82f6;
            --bg: #f8fafc; --card-bg: #ffffff; --text: #1e293b; --text-muted: #64748b; --text-light: #94a3b8;
            --border: #e2e8f0; --border-dark: #cbd5e1;
            --shadow: 0 1px 3px rgba(0,0,0,0.1); --shadow-lg: 0 10px 40px rgba(0,0,0,0.15);
            --row-height: 44px; --task-list-width: 260px; --cell-width: 34px; --panel-width: 340px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; }

        /* Header */
        .header { background: var(--card-bg); border-bottom: 1px solid var(--border); padding: 10px 16px; display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap; flex-shrink: 0; }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .header h1 { font-size: 1.15rem; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        .header-center { display: flex; align-items: center; gap: 8px; }
        .header-right { display: flex; align-items: center; gap: 8px; }
        .btn { padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--card-bg); font-weight: 500; cursor: pointer; display: inline-flex; align-items: center; gap: 5px; font-size: 0.75rem; transition: all 0.15s; color: var(--text); }
        .btn:hover { background: var(--bg); }
        .btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .btn.primary { background: var(--primary); color: white; border-color: var(--primary); }
        .btn.primary:hover { background: var(--primary-dark); }
        .btn-nav { padding: 6px 10px; font-size: 0.9rem; }
        .view-controls { display: flex; background: var(--bg); padding: 3px; border-radius: 6px; gap: 2px; }
        .view-controls .btn { border: none; background: transparent; padding: 5px 10px; border-radius: 4px; }
        .view-controls .btn.active { background: var(--primary); color: white; }
        .current-period { font-weight: 600; font-size: 0.85rem; min-width: 140px; text-align: center; }
        .sort-selector select { padding: 5px 8px; border: 1px solid var(--border); border-radius: 5px; font-size: 0.72rem; background: var(--card-bg); }

        /* Filters */
        .filter-bar { background: var(--card-bg); border-bottom: 1px solid var(--border); padding: 6px 16px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; flex-shrink: 0; }
        .filter-dropdown { position: relative; }
        .filter-btn { display: flex; align-items: center; gap: 6px; padding: 4px 10px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 5px; cursor: pointer; font-size: 0.72rem; }
        .filter-btn:hover { background: var(--bg); }
        .filter-btn.active { background: var(--primary-light); border-color: var(--primary); color: var(--primary); }
        .filter-menu { position: absolute; top: 100%; left: 0; margin-top: 4px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 6px; box-shadow: var(--shadow-lg); min-width: 150px; z-index: 200; display: none; max-height: 250px; overflow-y: auto; }
        .filter-menu.open { display: block; }
        .filter-option { padding: 7px 10px; cursor: pointer; font-size: 0.75rem; display: flex; align-items: center; gap: 6px; }
        .filter-option:hover { background: var(--bg); }
        .filter-option.active { background: var(--primary-light); color: var(--primary); }
        .filter-option .dot { width: 8px; height: 8px; border-radius: 50%; }
        .active-filters { display: flex; gap: 6px; }
        .filter-chip { display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; background: var(--primary-light); color: var(--primary); border-radius: 10px; font-size: 0.68rem; font-weight: 500; }
        .filter-chip button { background: none; border: none; color: var(--primary); cursor: pointer; font-size: 0.8rem; padding: 0; margin-left: 2px; }

        /* Gantt Container */
        .main-content { display: flex; flex: 1; min-height: 0; overflow: hidden; position: relative; }
        .gantt-wrapper { flex: 1; display: flex; flex-direction: column; min-height: 0; overflow: hidden; transition: margin-right 0.25s ease; }
        .gantt-wrapper.panel-open { margin-right: var(--panel-width); }

        .gantt-header { display: flex; background: var(--card-bg); border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .task-list-header { width: var(--task-list-width); min-width: var(--task-list-width); padding: 10px 12px; font-weight: 600; border-right: 1px solid var(--border); background: var(--bg); display: flex; align-items: center; justify-content: space-between; font-size: 0.8rem; }
        .timeline-header { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .timeline-header-months { display: flex; background: var(--bg); border-bottom: 1px solid var(--border); }
        .month-cell { padding: 4px 0; text-align: center; font-size: 0.7rem; font-weight: 600; color: var(--text-muted); border-right: 1px solid var(--border); }
        .timeline-header-days { display: flex; }
        .day-cell { width: var(--cell-width); min-width: var(--cell-width); padding: 6px 2px; text-align: center; font-size: 0.68rem; color: var(--text-muted); border-right: 1px solid var(--border); background: var(--bg); }
        .day-cell.weekend { background: #fef2f2; color: #ef4444; }
        .day-cell.today { background: var(--primary); color: white; font-weight: 700; }
        .day-cell.month-start { border-left: 2px solid var(--border); }

        .gantt-body { display: flex; flex: 1; min-height: 0; overflow: hidden; }
        .task-list { width: var(--task-list-width); min-width: var(--task-list-width); overflow-y: auto; border-right: 1px solid var(--border); background: var(--card-bg); }
        .task-row { display: flex; align-items: center; padding: 0 12px; border-bottom: 1px solid var(--border); height: var(--row-height); gap: 8px; cursor: pointer; transition: background 0.1s; }
        .task-row:hover { background: var(--bg); }
        .task-row.selected { background: var(--primary-light); }
        .task-row.sortable-ghost { opacity: 0.4; }
        .task-row.sortable-chosen { background: var(--primary-light); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .drag-handle { color: var(--text-muted); cursor: grab; opacity: 0.3; font-size: 0.75rem; }
        .task-row:hover .drag-handle { opacity: 1; }
        .task-priority-bar { width: 3px; height: 22px; border-radius: 2px; }
        .task-priority-bar.p1 { background: var(--danger); }
        .task-priority-bar.p2 { background: var(--warning); }
        .task-priority-bar.p3 { background: var(--info); }
        .task-priority-bar.p4 { background: var(--text-muted); }
        .task-info { flex: 1; min-width: 0; }
        .task-name { font-size: 0.78rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .task-meta { display: flex; align-items: center; gap: 6px; margin-top: 2px; }
        .task-dates { font-size: 0.65rem; color: var(--text-muted); }
        .task-progress-badge { font-size: 0.6rem; color: var(--text-muted); background: var(--bg); padding: 1px 4px; border-radius: 3px; }

        .timeline-scroll { flex: 1; overflow: auto; }
        .timeline-grid { position: relative; min-height: 100%; }
        .grid-row { height: var(--row-height); border-bottom: 1px solid var(--border); display: flex; }
        .grid-cell { width: var(--cell-width); min-width: var(--cell-width); border-right: 1px solid #f1f5f9; height: 100%; }
        .grid-cell.weekend { background: #fef2f2; }
        .grid-cell.today { background: rgba(79, 70, 229, 0.08); }
        .grid-cell.month-start { border-left: 1px solid var(--border); }

        /* Gantt Bars */
        .gantt-bar { position: absolute; height: 24px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; padding: 0 8px; font-size: 0.7rem; font-weight: 500; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; z-index: 10; transition: box-shadow 0.15s; }
        .gantt-bar:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.25); z-index: 20; }
        .gantt-bar.selected { outline: 2px solid var(--text); outline-offset: 2px; z-index: 25; }
        .gantt-bar.p1 { background: linear-gradient(135deg, var(--danger), #f87171); }
        .gantt-bar.p2 { background: linear-gradient(135deg, var(--warning), #fbbf24); }
        .gantt-bar.p3 { background: linear-gradient(135deg, var(--info), #60a5fa); }
        .gantt-bar.p4 { background: linear-gradient(135deg, var(--text-muted), #94a3b8); }
        .gantt-bar .resize-handle { position: absolute; top: 0; bottom: 0; width: 8px; cursor: ew-resize; }
        .gantt-bar .resize-handle.left { left: 0; }
        .gantt-bar .resize-handle.right { right: 0; }
        .gantt-bar-progress { position: absolute; left: 0; top: 0; height: 100%; background: rgba(255,255,255,0.25); border-radius: 4px 0 0 4px; pointer-events: none; }

        /* Milestones */
        .gantt-milestone { position: absolute; cursor: pointer; z-index: 15; display: flex; align-items: center; gap: 4px; }
        .milestone-diamond { width: 14px; height: 14px; transform: rotate(45deg); border-radius: 2px; box-shadow: 0 1px 3px rgba(0,0,0,0.25); }
        .gantt-milestone.p1 .milestone-diamond { background: var(--danger); }
        .gantt-milestone.p2 .milestone-diamond { background: var(--warning); }
        .gantt-milestone.p3 .milestone-diamond { background: var(--info); }
        .gantt-milestone.p4 .milestone-diamond { background: var(--text-muted); }
        .gantt-milestone.selected .milestone-diamond { outline: 2px solid var(--text); outline-offset: 2px; }
        .gantt-milestone:hover .milestone-diamond { transform: rotate(45deg) scale(1.15); }
        .milestone-label { font-size: 0.68rem; color: var(--text); white-space: nowrap; font-weight: 500; }

        /* Dependencies */
        .dependencies-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; }
        .dependency-line { fill: none; stroke: var(--text-muted); stroke-width: 1.5; stroke-dasharray: 4 2; }
        .dependency-line.highlight { stroke: var(--primary); stroke-width: 2; stroke-dasharray: none; }
        .dependency-arrow { fill: var(--text-muted); }
        .dependency-arrow.highlight { fill: var(--primary); }

        /* Today Line */
        .today-line { position: absolute; top: 0; bottom: 0; width: 2px; background: var(--danger); z-index: 25; }
        .today-line::before { content: "‚ñº"; position: absolute; top: -8px; left: 50%; transform: translateX(-50%); font-size: 0.6rem; color: var(--danger); }

        /* Tooltip */
        .tooltip { position: fixed; background: var(--text); color: white; padding: 10px 14px; border-radius: 8px; font-size: 0.78rem; z-index: 1000; max-width: 280px; box-shadow: var(--shadow-lg); pointer-events: none; opacity: 0; transition: opacity 0.15s; }
        .tooltip.visible { opacity: 1; }
        .tooltip-title { font-weight: 600; margin-bottom: 6px; }
        .tooltip-row { display: flex; justify-content: space-between; gap: 12px; font-size: 0.72rem; opacity: 0.9; }

        /* Legend */
        .legend { display: flex; gap: 14px; padding: 8px 16px; background: var(--card-bg); border-top: 1px solid var(--border); font-size: 0.7rem; align-items: center; flex-wrap: wrap; flex-shrink: 0; }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .legend-color { width: 10px; height: 10px; border-radius: 2px; }
        .legend-milestone { width: 8px; height: 8px; background: var(--text-muted); transform: rotate(45deg); }
        .legend-separator { width: 1px; height: 16px; background: var(--border); }

        /* Panel Slide-in */
        .panel { position: absolute; top: 0; right: 0; width: var(--panel-width); height: 100%; background: var(--card-bg); border-left: 1px solid var(--border); display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.25s ease; z-index: 50; }
        .panel.open { transform: translateX(0); }
        .panel-header { padding: 12px 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; background: var(--bg); gap: 8px; }
        .panel-nav { display: flex; align-items: center; gap: 6px; flex: 1; min-width: 0; }
        .panel-nav-btn { width: 28px; height: 28px; border: 1px solid var(--border); background: var(--card-bg); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-muted); font-size: 0.75rem; flex-shrink: 0; }
        .panel-nav-btn:hover { background: var(--bg); color: var(--text); }
        .panel-nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .panel-title { font-weight: 600; font-size: 0.9rem; flex: 1; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .panel-close { width: 28px; height: 28px; border: none; background: transparent; border-radius: 6px; cursor: pointer; color: var(--text-muted); font-size: 1.1rem; }
        .panel-close:hover { background: var(--bg); color: var(--text); }
        .panel-content { flex: 1; overflow-y: auto; padding: 16px; }
        .panel-footer { padding: 12px 16px; border-top: 1px solid var(--border); }
        .panel-btn { padding: 10px 16px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 0.85rem; font-weight: 500; cursor: pointer; width: 100%; }
        .panel-btn:hover { background: var(--primary-dark); }
        .panel-btn:disabled { background: var(--border); cursor: not-allowed; }
        .panel-btn.success { background: var(--success); }
        .panel-btn.danger { background: transparent; color: var(--danger); border: 1px solid var(--danger); }
        .panel-btn.danger:hover { background: var(--danger); color: white; }
        .panel-section { margin-bottom: 16px; padding-bottom: 14px; border-bottom: 1px solid var(--border); }
        .panel-section:last-child { border-bottom: none; }

        /* Form Elements */
        .type-selector { display: flex; gap: 6px; margin-bottom: 16px; background: var(--bg); padding: 4px; border-radius: 8px; }
        .type-option { flex: 1; padding: 8px 6px; border: none; background: transparent; border-radius: 6px; text-align: center; cursor: pointer; font-size: 0.75rem; font-weight: 500; color: var(--text-muted); }
        .type-option:hover { background: var(--card-bg); }
        .type-option.selected { background: var(--card-bg); color: var(--text); box-shadow: var(--shadow); }
        .type-option-icon { display: block; font-size: 1rem; margin-bottom: 2px; }
        .form-group { margin-bottom: 14px; }
        .form-label { display: block; font-size: 0.7rem; font-weight: 600; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.85rem; color: var(--text); background: var(--card-bg); }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
        .form-input.title-input { font-size: 1rem; font-weight: 600; border: none; padding: 8px 0; background: transparent; border-bottom: 2px solid var(--border); border-radius: 0; }
        .form-input.title-input:focus { border-bottom-color: var(--primary); box-shadow: none; }
        .form-textarea { min-height: 70px; resize: vertical; font-size: 0.8rem; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .priority-selector { display: flex; gap: 6px; }
        .priority-pill { flex: 1; padding: 8px 4px; border: 2px solid var(--border); border-radius: 8px; text-align: center; cursor: pointer; font-size: 0.7rem; font-weight: 600; background: var(--card-bg); }
        .priority-pill.p1 { border-color: var(--danger); color: var(--danger); }
        .priority-pill.p1.selected { background: var(--danger); color: white; }
        .priority-pill.p2 { border-color: var(--warning); color: var(--warning); }
        .priority-pill.p2.selected { background: var(--warning); color: white; }
        .priority-pill.p3 { border-color: var(--info); color: var(--info); }
        .priority-pill.p3.selected { background: var(--info); color: white; }
        .priority-pill.p4 { border-color: var(--text-muted); color: var(--text-muted); }
        .priority-pill.p4.selected { background: var(--text-muted); color: white; }
        .status-selector { display: flex; gap: 6px; flex-wrap: wrap; }
        .status-pill { padding: 6px 10px; border: 1px solid var(--border); border-radius: 20px; font-size: 0.72rem; cursor: pointer; background: var(--card-bg); }
        .status-pill:hover { border-color: var(--primary); }
        .status-pill.selected { background: var(--primary); color: white; border-color: var(--primary); }
        .progress-container { display: flex; align-items: center; gap: 10px; }
        .progress-slider { flex: 1; -webkit-appearance: none; height: 6px; border-radius: 3px; background: var(--border); }
        .progress-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: var(--primary); cursor: pointer; }
        .progress-value { font-size: 0.85rem; font-weight: 600; color: var(--primary); min-width: 40px; text-align: right; }

        /* Multi-select */
        .multi-select { position: relative; }
        .multi-select-trigger { min-height: 40px; padding: 6px 10px; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; gap: 8px; background: var(--card-bg); }
        .multi-select.open .multi-select-trigger { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
        .multi-select-values { display: flex; flex-wrap: wrap; gap: 4px; flex: 1; }
        .multi-select-chip { display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; background: var(--primary-light); color: var(--primary); border-radius: 4px; font-size: 0.72rem; font-weight: 500; }
        .multi-select-chip .remove { cursor: pointer; font-size: 0.85rem; opacity: 0.7; }
        .multi-select-chip .remove:hover { opacity: 1; }
        .multi-select-placeholder { color: var(--text-muted); font-size: 0.8rem; }
        .multi-select-arrow { color: var(--text-muted); font-size: 0.7rem; }
        .multi-select-dropdown { position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; box-shadow: var(--shadow-lg); z-index: 100; display: none; max-height: 180px; overflow-y: auto; }
        .multi-select.open .multi-select-dropdown { display: block; }
        .multi-select-option { padding: 8px 10px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.8rem; }
        .multi-select-option:hover { background: var(--bg); }
        .multi-select-option.selected { background: var(--primary-light); }
        .multi-select-option input { width: 14px; height: 14px; }
        .multi-select-empty { padding: 12px; text-align: center; color: var(--text-muted); font-size: 0.8rem; }

        /* Tags */
        .tags-input { display: flex; flex-wrap: wrap; gap: 5px; padding: 6px 10px; border: 1px solid var(--border); border-radius: 8px; min-height: 40px; align-items: center; cursor: text; background: var(--card-bg); }
        .tags-input:focus-within { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
        .tag-chip { display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; font-size: 0.72rem; font-weight: 500; }
        .tag-chip .remove { cursor: pointer; color: var(--text-muted); }
        .tag-chip .remove:hover { color: var(--danger); }
        .tags-input input { border: none; outline: none; flex: 1; min-width: 60px; font-size: 0.8rem; padding: 3px 0; background: transparent; }

        /* Time */
        .time-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .time-group label { font-size: 0.68rem; color: var(--text-muted); display: block; margin-bottom: 4px; }
        .time-input-wrap { display: flex; align-items: center; gap: 4px; }
        .time-input-wrap input { width: 60px; padding: 6px 8px; border: 1px solid var(--border); border-radius: 6px; text-align: center; font-size: 0.85rem; }
        .time-input-wrap input:focus { outline: none; border-color: var(--primary); }
        .time-input-wrap span { color: var(--text-muted); font-size: 0.75rem; }
        .time-bar { height: 6px; background: var(--border); border-radius: 3px; margin-top: 8px; overflow: hidden; }
        .time-bar-fill { height: 100%; background: var(--success); }
        .time-bar-fill.over { background: var(--danger); }

        /* Deps display */
        .deps-display { margin-top: 10px; }
        .deps-group { margin-bottom: 10px; }
        .deps-group-label { font-size: 0.68rem; color: var(--text-muted); margin-bottom: 4px; }
        .deps-list { display: flex; flex-direction: column; gap: 4px; }
        .dep-item { display: flex; align-items: center; gap: 6px; padding: 6px 8px; background: var(--bg); border-radius: 5px; font-size: 0.75rem; cursor: pointer; }
        .dep-item:hover { background: var(--primary-light); }

        /* Delete confirm */
        .delete-confirm { background: #fef2f2; border: 1px solid var(--danger); border-radius: 8px; padding: 12px; margin-top: 12px; display: none; }
        .delete-confirm.visible { display: block; }
        .delete-confirm-text { font-size: 0.8rem; color: var(--danger); margin-bottom: 10px; }
        .delete-confirm-actions { display: flex; gap: 8px; }
        .delete-confirm-btn { flex: 1; padding: 8px; border-radius: 6px; font-size: 0.8rem; font-weight: 500; cursor: pointer; border: none; }
        .delete-confirm-btn.cancel { background: var(--card-bg); border: 1px solid var(--border); }
        .delete-confirm-btn.confirm { background: var(--danger); color: white; }

        /* Utils */
        .save-indicator { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--success); color: white; padding: 8px 16px; border-radius: 20px; font-size: 0.8rem; opacity: 0; transition: opacity 0.3s; z-index: 2000; }
        .save-indicator.visible { opacity: 1; }
        .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; }
        .toast { padding: 10px 16px; background: var(--text); color: white; border-radius: 6px; margin-top: 6px; font-size: 0.8rem; }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .demo-badge { position: fixed; top: 8px; right: 8px; background: var(--warning); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.65rem; font-weight: 600; z-index: 100; }

        @media (max-width: 900px) { :root { --task-list-width: 200px; --cell-width: 28px; --panel-width: 320px; } }
        @media (max-width: 700px) { :root { --task-list-width: 140px; --cell-width: 24px; --panel-width: 100%; } .gantt-wrapper.panel-open { margin-right: 0; } .panel { left: 0; width: 100%; } .task-dates, .task-progress-badge { display: none; } .form-row { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <h1>üìä Gantt</h1>
            <div class="sort-selector">
                <select id="sortSelect" onchange="changeSortMode(this.value)">
                    <option value="priority">Tri: Priorit√©</option>
                    <option value="date">Tri: Date</option>
                    <option value="manual">Tri: Manuel</option>
                </select>
            </div>
        </div>
        <div class="header-center">
            <button class="btn btn-nav" onclick="navigate(-1)">‚óÄ</button>
            <button class="btn" onclick="goToToday()">Aujourd'hui</button>
            <button class="btn btn-nav" onclick="navigate(1)">‚ñ∂</button>
            <span class="current-period" id="currentPeriod"></span>
            <div class="view-controls">
                <button class="btn" data-view="week" onclick="setView('week')">Sem</button>
                <button class="btn active" data-view="month" onclick="setView('month')">Mois</button>
                <button class="btn" data-view="quarter" onclick="setView('quarter')">Trim</button>
            </div>
        </div>
        <div class="header-right">
            <button class="btn primary" onclick="openCreatePanel()">+ T√¢che</button>
        </div>
    </div>

    <div class="filter-bar">
        <div class="filter-dropdown" id="filterProject">
            <div class="filter-btn" onclick="toggleFilterMenu('filterProject')"><span id="filterProjectLabel">Projet ‚ñæ</span></div>
            <div class="filter-menu" id="filterProjectMenu"></div>
        </div>
        <div class="filter-dropdown" id="filterAssignee">
            <div class="filter-btn" onclick="toggleFilterMenu('filterAssignee')"><span id="filterAssigneeLabel">Assign√© ‚ñæ</span></div>
            <div class="filter-menu" id="filterAssigneeMenu"></div>
        </div>
        <div class="active-filters" id="activeFilters"></div>
    </div>

    <div class="main-content">
        <div class="gantt-wrapper" id="ganttWrapper">
            <div class="gantt-header">
                <div class="task-list-header"><span>T√¢ches</span><span id="taskCount" style="font-size:0.7rem;color:var(--text-muted);">0</span></div>
                <div class="timeline-header">
                    <div class="timeline-header-months" id="monthsHeader"></div>
                    <div class="timeline-header-days" id="daysHeader"></div>
                </div>
            </div>
            <div class="gantt-body">
                <div class="task-list" id="taskList"></div>
                <div class="timeline-scroll" id="timelineScroll">
                    <div class="timeline-grid" id="timelineGrid"></div>
                </div>
            </div>
            <div class="legend">
                <div class="legend-item"><div class="legend-color" style="background:var(--danger)"></div>Critique</div>
                <div class="legend-item"><div class="legend-color" style="background:var(--warning)"></div>Haute</div>
                <div class="legend-item"><div class="legend-color" style="background:var(--info)"></div>Moyenne</div>
                <div class="legend-item"><div class="legend-color" style="background:var(--text-muted)"></div>Basse</div>
                <div class="legend-separator"></div>
                <div class="legend-item"><div class="legend-milestone"></div>Jalon</div>
            </div>
        </div>

        <div class="panel" id="panel">
            <div class="panel-header" id="panelHeader"></div>
            <div class="panel-content" id="panelContent"></div>
            <div class="panel-footer" id="panelFooter"></div>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>
    <div class="save-indicator" id="saveIndicator">‚úì Enregistr√©</div>
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CONFIGURATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const VIEW_CONFIG = {
            week: { label: 'Semaine', unit: 'day', days: 7, cellWidth: 70, navStep: 7 },
            month: { label: 'Mois', unit: 'day', days: 42, cellWidth: 34, navStep: 'month' },
            quarter: { label: 'Trimestre', unit: 'week', weeks: 13, cellWidth: 45, navStep: 'quarter' }
        };
        const PRIORITY_LABELS = { 1: 'Critique', 2: 'Haute', 3: 'Moyenne', 4: 'Basse' };
        const PRIORITY_COLORS = { 1: '#ef4444', 2: '#f59e0b', 3: '#3b82f6', 4: '#64748b' };
        const STATUS_LABELS = { todo: '√Ä faire', inprogress: 'En cours', review: 'En revue', done: 'Termin√©' };
        const TYPE_ICONS = { tache: 'üìã', jalon: '‚óÜ', reunion: 'üë•' };
        const MONTHS = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
        const MONTHS_SHORT = ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Ao√ªt', 'Sep', 'Oct', 'Nov', 'D√©c'];

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // STATE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let gristReady = false;
        let tasks = [], team = [], projects = [];
        let currentView = 'month';
        let viewStartDate = new Date();
        let selectedTaskId = null;
        let sortMode = 'priority';
        let sortableInstance = null;
        let filters = { project: null, assignee: null };
        let dragState = { active: false, type: null, taskId: null, startX: 0, originalLeft: 0, originalWidth: 0, originalStart: null, originalEnd: null };
        let panelState = { open: false, isNew: false, taskId: null, taskIndex: -1, taskList: [], editData: null };
        let saveTimeout = null;

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // UTILITIES
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const escapeHtml = (t) => { if (!t) return ''; const d = document.createElement('div'); d.textContent = t; return d.innerHTML; };
        const gristToDate = (ts) => { if (ts == null || ts === '') return null; const n = Number(ts); return isNaN(n) ? null : new Date(n * 1000); };
        const dateToGrist = (d) => d ? Math.floor(d.getTime() / 1000) : null;
        const formatDate = (d) => d ? new Intl.DateTimeFormat('fr-FR', { day: '2-digit', month: 'short', year: 'numeric' }).format(d) : '-';
        const formatDateShort = (d) => d ? new Intl.DateTimeFormat('fr-FR', { day: '2-digit', month: 'short' }).format(d) : '-';
        const formatDateISO = (d) => d ? d.toISOString().split('T')[0] : '';
        const isWeekend = (d) => d.getDay() === 0 || d.getDay() === 6;
        const isSameDay = (a, b) => a && b && a.toDateString() === b.toDateString();
        const getDaysDiff = (a, b) => Math.round((b - a) / 86400000);
        const addDays = (d, n) => { const r = new Date(d); r.setDate(r.getDate() + n); return r; };
        const getTaskPriority = (t) => (t?.priorite >= 1 && t?.priorite <= 4) ? parseInt(t.priorite) : 3;
        const isJalon = (t) => t?.type === 'jalon' || (gristToDate(t?.dateDebut)?.toDateString() === gristToDate(t?.dateEcheance)?.toDateString());

        function showToast(msg, type = 'info') { const c = document.getElementById('toastContainer'); const t = document.createElement('div'); t.className = 'toast ' + type; t.textContent = msg; c.appendChild(t); setTimeout(() => t.remove(), 3000); }
        function showSaveIndicator() { const el = document.getElementById('saveIndicator'); el.classList.add('visible'); clearTimeout(saveTimeout); saveTimeout = setTimeout(() => el.classList.remove('visible'), 1500); }

        // RefList/ChoiceList helpers
        function getRefListArray(val) { if (!val) return []; if (Array.isArray(val)) return val[0] === 'L' ? val.slice(1).map(Number).filter(n => !isNaN(n)) : val.map(Number).filter(n => !isNaN(n)); return []; }
        function toGristRefList(arr) { return arr && arr.length ? ['L', ...arr] : null; }
        function getChoiceListArray(val) { if (!val) return []; if (Array.isArray(val)) return val[0] === 'L' ? val.slice(1) : val; return []; }
        function toGristChoiceList(arr) { return arr && arr.length ? ['L', ...arr] : null; }
        const getAssigneesArray = (t) => getRefListArray(t?.assignees);
        const getDependsOnArray = (t) => getRefListArray(t?.dependDe);
        const getTagsArray = (t) => getChoiceListArray(t?.tags);

        // Project/Team helpers
        const getProjectName = (id) => { const p = projects.find(x => x.id === id); return p?.nom || ''; };
        const getProjectColor = (id) => { const p = projects.find(x => x.id === id); return p?.couleur || '#64748b'; };
        const getTeamMemberName = (id) => { const m = team.find(x => x.id === id); return m?.nom || ''; };
        const getInitials = (n) => n ? n.split(' ').map(x => x[0]).join('').toUpperCase().slice(0, 2) : '?';

        // Dependency cycle detection
        function wouldCreateCycle(taskId, depId, visited = new Set()) {
            if (taskId === depId) return true;
            if (visited.has(depId)) return false;
            visited.add(depId);
            const depTask = tasks.find(t => t.id === depId);
            if (!depTask) return false;
            return getDependsOnArray(depTask).some(d => wouldCreateCycle(taskId, d, visited));
        }
        function getAvailableDependencies(taskId) { return tasks.filter(t => t.id !== taskId && !wouldCreateCycle(taskId, t.id)); }
        function getBlockedTasks(taskId) { return tasks.filter(t => getDependsOnArray(t).includes(taskId)); }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // DATE CALCULATIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function getStartOfWeek(d) { const r = new Date(d); const day = r.getDay(); r.setDate(r.getDate() - day + (day === 0 ? -6 : 1)); r.setHours(0, 0, 0, 0); return r; }
        function getStartOfMonth(d) { return new Date(d.getFullYear(), d.getMonth(), 1); }
        function getStartOfQuarter(d) { return new Date(d.getFullYear(), Math.floor(d.getMonth() / 3) * 3, 1); }
        function getWeekNumber(d) { const t = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); const day = t.getUTCDay() || 7; t.setUTCDate(t.getUTCDate() + 4 - day); const year = new Date(Date.UTC(t.getUTCFullYear(), 0, 1)); return Math.ceil((((t - year) / 86400000) + 1) / 7); }
        function getViewStartDate() {
            switch (currentView) {
                case 'week': return getStartOfWeek(viewStartDate);
                case 'month': return getStartOfMonth(viewStartDate);
                case 'quarter': return getStartOfQuarter(viewStartDate);
                default: return getStartOfMonth(viewStartDate);
            }
        }
        function getTotalDays() { const cfg = VIEW_CONFIG[currentView]; if (cfg.unit === 'day') return cfg.days; if (cfg.unit === 'week') return cfg.weeks * 7; return cfg.days; }
        function getPixelsPerDay() { const cfg = VIEW_CONFIG[currentView]; if (cfg.unit === 'day') return cfg.cellWidth; if (cfg.unit === 'week') return cfg.cellWidth / 7; return cfg.cellWidth; }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // VIEW & NAVIGATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function setView(view) {
            currentView = view;
            document.querySelectorAll('.view-controls .btn').forEach(b => b.classList.toggle('active', b.dataset.view === view));
            document.documentElement.style.setProperty('--cell-width', VIEW_CONFIG[view].cellWidth + 'px');
            render();
        }
        function navigate(dir) {
            const cfg = VIEW_CONFIG[currentView];
            if (typeof cfg.navStep === 'number') viewStartDate = addDays(viewStartDate, dir * cfg.navStep);
            else if (cfg.navStep === 'month') viewStartDate = new Date(viewStartDate.getFullYear(), viewStartDate.getMonth() + dir, 1);
            else if (cfg.navStep === 'quarter') viewStartDate = new Date(viewStartDate.getFullYear(), viewStartDate.getMonth() + dir * 3, 1);
            render();
        }
        function goToToday() { viewStartDate = new Date(); render(); }
        function updatePeriodLabel() {
            const start = getViewStartDate();
            let text = '';
            switch (currentView) {
                case 'week': text = 'S' + getWeekNumber(start) + ' ¬∑ ' + formatDateShort(start) + ' - ' + formatDateShort(addDays(start, 6)); break;
                case 'month': text = MONTHS[start.getMonth()] + ' ' + start.getFullYear(); break;
                case 'quarter': text = 'T' + (Math.floor(start.getMonth() / 3) + 1) + ' ' + start.getFullYear(); break;
            }
            document.getElementById('currentPeriod').textContent = text;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SORTING & FILTERING
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function changeSortMode(mode) { sortMode = mode; sortTasks(); render(); }
        function sortTasks() {
            if (sortMode === 'priority') tasks.sort((a, b) => { const pa = getTaskPriority(a), pb = getTaskPriority(b); return pa !== pb ? pa - pb : (a.dateDebut || 0) - (b.dateDebut || 0); });
            else if (sortMode === 'date') tasks.sort((a, b) => (a.dateDebut || 0) - (b.dateDebut || 0));
        }
        function toggleFilterMenu(id) { const m = document.querySelector('#' + id + ' .filter-menu'); const open = m.classList.contains('open'); document.querySelectorAll('.filter-menu').forEach(x => x.classList.remove('open')); if (!open) m.classList.add('open'); }
        function setFilter(key, val) { filters[key] = val || null; updateFilterUI(); render(); }
        function updateFilterMenus() {
            document.getElementById('filterProjectMenu').innerHTML = '<div class="filter-option ' + (!filters.project ? 'active' : '') + '" onclick="setFilter(\'project\', null)">Tous</div>' + projects.map(p => '<div class="filter-option ' + (filters.project === p.id ? 'active' : '') + '" onclick="setFilter(\'project\', ' + p.id + ')"><span class="dot" style="background:' + (p.couleur || '#6366f1') + '"></span>' + escapeHtml(p.nom) + '</div>').join('');
            document.getElementById('filterAssigneeMenu').innerHTML = '<div class="filter-option ' + (!filters.assignee ? 'active' : '') + '" onclick="setFilter(\'assignee\', null)">Tous</div>' + team.map(m => '<div class="filter-option ' + (filters.assignee == m.id ? 'active' : '') + '" onclick="setFilter(\'assignee\', ' + m.id + ')">' + escapeHtml(m.nom) + '</div>').join('');
            updateFilterUI();
        }
        function updateFilterUI() {
            const projBtn = document.querySelector('#filterProject .filter-btn');
            const assBtn = document.querySelector('#filterAssignee .filter-btn');
            projBtn.className = 'filter-btn' + (filters.project ? ' active' : '');
            assBtn.className = 'filter-btn' + (filters.assignee ? ' active' : '');
            const projName = filters.project ? getProjectName(filters.project) : null;
            document.getElementById('filterProjectLabel').textContent = projName || 'Projet ‚ñæ';
            const mem = team.find(m => m.id == filters.assignee);
            document.getElementById('filterAssigneeLabel').textContent = mem ? mem.nom : 'Assign√© ‚ñæ';
            const chips = [];
            if (projName) chips.push('<span class="filter-chip">' + escapeHtml(projName) + '<button onclick="setFilter(\'project\',null)">√ó</button></span>');
            if (mem) chips.push('<span class="filter-chip">' + escapeHtml(mem.nom) + '<button onclick="setFilter(\'assignee\',null)">√ó</button></span>');
            document.getElementById('activeFilters').innerHTML = chips.join('');
        }
        function taskMatchesFilters(t) {
            if (filters.project && t.projet !== filters.project) return false;
            if (filters.assignee && !getAssigneesArray(t).includes(Number(filters.assignee))) return false;
            return true;
        }
        function getFilteredTasks() { return tasks.filter(taskMatchesFilters); }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // RENDER FUNCTIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function render() {
            updatePeriodLabel();
            renderTimelineHeader();
            renderTaskList();
            renderTimeline();
            syncScroll();
        }

        function renderTimelineHeader() {
            const start = getViewStartDate();
            const totalDays = getTotalDays();
            const cfg = VIEW_CONFIG[currentView];
            let monthsHtml = '', daysHtml = '';
            let currentMonth = -1, monthStart = 0;

            for (let i = 0; i < totalDays; i++) {
                const d = addDays(start, i);
                const m = d.getMonth();
                if (m !== currentMonth) {
                    if (currentMonth !== -1) {
                        const width = (i - monthStart) * cfg.cellWidth;
                        monthsHtml += '<div class="month-cell" style="width:' + width + 'px">' + MONTHS_SHORT[currentMonth] + '</div>';
                    }
                    currentMonth = m;
                    monthStart = i;
                }
                const isWe = isWeekend(d);
                const isT = isSameDay(d, new Date());
                const isMonthStart = d.getDate() === 1;
                daysHtml += '<div class="day-cell ' + (isWe ? 'weekend ' : '') + (isT ? 'today ' : '') + (isMonthStart ? 'month-start' : '') + '">' + d.getDate() + '</div>';
            }
            const finalWidth = (totalDays - monthStart) * cfg.cellWidth;
            monthsHtml += '<div class="month-cell" style="width:' + finalWidth + 'px">' + MONTHS_SHORT[currentMonth] + '</div>';

            document.getElementById('monthsHeader').innerHTML = monthsHtml;
            document.getElementById('daysHeader').innerHTML = daysHtml;
        }

        function renderTaskList() {
            const ft = getFilteredTasks();
            panelState.taskList = ft;
            document.getElementById('taskCount').textContent = ft.length;

            let html = '';
            ft.forEach((t, idx) => {
                const p = getTaskPriority(t);
                const start = gristToDate(t.dateDebut);
                const end = gristToDate(t.dateEcheance);
                const jalon = isJalon(t);
                const progress = t.progression || 0;
                const selected = t.id === selectedTaskId;

                html += '<div class="task-row ' + (selected ? 'selected' : '') + '" data-id="' + t.id + '" onclick="openTaskPanel(' + t.id + ')">' +
                    '<span class="drag-handle">‚ò∞</span>' +
                    '<div class="task-priority-bar p' + p + '"></div>' +
                    '<div class="task-info">' +
                        '<div class="task-name">' + (jalon ? '‚óÜ ' : '') + (escapeHtml(t.titre) || 'Sans titre') + '</div>' +
                        '<div class="task-meta">' +
                            '<span class="task-dates">' + formatDateShort(start) + ' ‚Üí ' + formatDateShort(end) + '</span>' +
                            (!jalon ? '<span class="task-progress-badge">' + progress + '%</span>' : '') +
                        '</div>' +
                    '</div>' +
                '</div>';
            });
            document.getElementById('taskList').innerHTML = html;

            if (sortMode === 'manual') {
                if (sortableInstance) sortableInstance.destroy();
                sortableInstance = new Sortable(document.getElementById('taskList'), {
                    animation: 150, handle: '.drag-handle', ghostClass: 'sortable-ghost', chosenClass: 'sortable-chosen',
                    onEnd: (evt) => {
                        const id = parseInt(evt.item.dataset.id);
                        const newIndex = evt.newIndex, oldIndex = evt.oldIndex;
                        if (newIndex !== oldIndex) {
                            const [moved] = tasks.splice(tasks.findIndex(t => t.id === id), 1);
                            tasks.splice(newIndex, 0, moved);
                            render();
                        }
                    }
                });
            }
        }

        function renderTimeline() {
            const ft = getFilteredTasks();
            const start = getViewStartDate();
            const totalDays = getTotalDays();
            const cfg = VIEW_CONFIG[currentView];
            const pxPerDay = getPixelsPerDay();
            const totalWidth = totalDays * cfg.cellWidth;

            let gridHtml = '';
            ft.forEach(() => {
                gridHtml += '<div class="grid-row">';
                for (let i = 0; i < totalDays; i++) {
                    const d = addDays(start, i);
                    const isWe = isWeekend(d);
                    const isT = isSameDay(d, new Date());
                    const isMonthStart = d.getDate() === 1;
                    gridHtml += '<div class="grid-cell ' + (isWe ? 'weekend ' : '') + (isT ? 'today ' : '') + (isMonthStart ? 'month-start' : '') + '"></div>';
                }
                gridHtml += '</div>';
            });

            const grid = document.getElementById('timelineGrid');
            grid.innerHTML = gridHtml;
            grid.style.width = totalWidth + 'px';
            grid.style.height = (ft.length * 44) + 'px';

            // Today line
            const today = new Date();
            const todayOffset = getDaysDiff(start, today);
            if (todayOffset >= 0 && todayOffset < totalDays) {
                const todayLine = document.createElement('div');
                todayLine.className = 'today-line';
                todayLine.style.left = (todayOffset * pxPerDay + pxPerDay / 2) + 'px';
                grid.appendChild(todayLine);
            }

            // Bars & milestones
            ft.forEach((t, idx) => {
                const tStart = gristToDate(t.dateDebut);
                const tEnd = gristToDate(t.dateEcheance);
                if (!tStart || !tEnd) return;

                const p = getTaskPriority(t);
                const jalon = isJalon(t);
                const top = idx * 44 + 10;
                const startOffset = getDaysDiff(start, tStart);
                const duration = getDaysDiff(tStart, tEnd) + 1;
                const left = startOffset * pxPerDay;
                const width = duration * pxPerDay;
                const selected = t.id === selectedTaskId;

                if (jalon) {
                    const m = document.createElement('div');
                    m.className = 'gantt-milestone p' + p + (selected ? ' selected' : '');
                    m.dataset.id = t.id;
                    m.style.left = (left + pxPerDay / 2 - 7) + 'px';
                    m.style.top = top + 'px';
                    m.innerHTML = '<div class="milestone-diamond"></div><span class="milestone-label">' + escapeHtml(t.titre) + '</span>';
                    m.onclick = () => openTaskPanel(t.id);
                    setupTooltip(m, t);
                    grid.appendChild(m);
                } else {
                    const bar = document.createElement('div');
                    bar.className = 'gantt-bar p' + p + (selected ? ' selected' : '');
                    bar.dataset.id = t.id;
                    bar.style.left = left + 'px';
                    bar.style.top = top + 'px';
                    bar.style.width = Math.max(width, 20) + 'px';
                    bar.innerHTML = '<div class="gantt-bar-progress" style="width:' + (t.progression || 0) + '%"></div>' +
                        '<div class="resize-handle left" onmousedown="startDrag(event, this.parentElement, \'resize-left\')"></div>' +
                        '<span style="position:relative;z-index:1;">' + escapeHtml(t.titre) + '</span>' +
                        '<div class="resize-handle right" onmousedown="startDrag(event, this.parentElement, \'resize-right\')"></div>';
                    bar.onclick = (e) => { if (!e.target.classList.contains('resize-handle')) openTaskPanel(t.id); };
                    bar.onmousedown = (e) => { if (!e.target.classList.contains('resize-handle')) startDrag(e, bar, 'move'); };
                    setupTooltip(bar, t);
                    grid.appendChild(bar);
                }
            });

            renderDependencies(ft, start);
        }

        function renderDependencies(ft, start) {
            const existing = document.querySelector('.dependencies-layer');
            if (existing) existing.remove();

            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.classList.add('dependencies-layer');
            svg.style.width = '100%';
            svg.style.height = '100%';

            const pxPerDay = getPixelsPerDay();
            const taskIndexMap = {};
            ft.forEach((t, i) => taskIndexMap[t.id] = i);

            ft.forEach(t => {
                const deps = getDependsOnArray(t);
                deps.forEach(depId => {
                    const depTask = tasks.find(x => x.id === depId);
                    if (!depTask || taskIndexMap[depId] === undefined) return;

                    const depEnd = gristToDate(depTask.dateEcheance);
                    const tStart = gristToDate(t.dateDebut);
                    if (!depEnd || !tStart) return;

                    const depIdx = taskIndexMap[depId];
                    const tIdx = taskIndexMap[t.id];

                    const x1 = getDaysDiff(start, depEnd) * pxPerDay + pxPerDay;
                    const y1 = depIdx * 44 + 22;
                    const x2 = getDaysDiff(start, tStart) * pxPerDay;
                    const y2 = tIdx * 44 + 22;

                    const highlight = selectedTaskId === t.id || selectedTaskId === depId;
                    const midX = (x1 + x2) / 2;

                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    path.setAttribute('d', 'M' + x1 + ',' + y1 + ' C' + midX + ',' + y1 + ' ' + midX + ',' + y2 + ' ' + x2 + ',' + y2);
                    path.classList.add('dependency-line');
                    if (highlight) path.classList.add('highlight');
                    svg.appendChild(path);

                    const arrow = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
                    arrow.setAttribute('points', x2 + ',' + y2 + ' ' + (x2 - 6) + ',' + (y2 - 4) + ' ' + (x2 - 6) + ',' + (y2 + 4));
                    arrow.classList.add('dependency-arrow');
                    if (highlight) arrow.classList.add('highlight');
                    svg.appendChild(arrow);
                });
            });

            document.getElementById('timelineGrid').appendChild(svg);
        }

        function setupTooltip(el, task) {
            const tooltip = document.getElementById('tooltip');
            el.addEventListener('mouseenter', () => {
                const start = gristToDate(task.dateDebut);
                const end = gristToDate(task.dateEcheance);
                const p = getTaskPriority(task);
                const projName = task.projet ? getProjectName(task.projet) : '';
                tooltip.innerHTML = '<div class="tooltip-title">' + escapeHtml(task.titre) + '</div>' +
                    '<div class="tooltip-row"><span>Priorit√©</span><span>' + PRIORITY_LABELS[p] + '</span></div>' +
                    '<div class="tooltip-row"><span>Dates</span><span>' + formatDateShort(start) + ' ‚Üí ' + formatDateShort(end) + '</span></div>' +
                    (projName ? '<div class="tooltip-row"><span>Projet</span><span>' + escapeHtml(projName) + '</span></div>' : '') +
                    '<div class="tooltip-row"><span>Progression</span><span>' + (task.progression || 0) + '%</span></div>';
                tooltip.classList.add('visible');
            });
            el.addEventListener('mousemove', (e) => { tooltip.style.left = (e.clientX + 15) + 'px'; tooltip.style.top = (e.clientY + 15) + 'px'; });
            el.addEventListener('mouseleave', () => tooltip.classList.remove('visible'));
        }

        function syncScroll() {
            const taskList = document.getElementById('taskList');
            const timeline = document.getElementById('timelineScroll');
            taskList.onscroll = () => timeline.scrollTop = taskList.scrollTop;
            timeline.onscroll = () => taskList.scrollTop = timeline.scrollTop;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PANEL SLIDE-IN
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function openPanel() {
            panelState.open = true;
            document.getElementById('panel').classList.add('open');
            document.getElementById('ganttWrapper').classList.add('panel-open');
        }

        function closePanel() {
            panelState.open = false;
            document.getElementById('panel').classList.remove('open');
            document.getElementById('ganttWrapper').classList.remove('panel-open');
            panelState = { open: false, isNew: false, taskId: null, taskIndex: -1, taskList: panelState.taskList, editData: null };
            selectedTaskId = null;
            render();
        }

        function openTaskPanel(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            selectedTaskId = taskId;
            const idx = panelState.taskList.findIndex(t => t.id === taskId);

            panelState.isNew = false;
            panelState.taskId = taskId;
            panelState.taskIndex = idx >= 0 ? idx : 0;
            panelState.editData = cloneTaskData(task);

            renderPanel();
            openPanel();
            if (gristReady) grist.setSelectedRows([taskId]);
            render();
        }

        function openCreatePanel() {
            const today = new Date();
            panelState = {
                open: true, isNew: true, taskId: null, taskIndex: -1, taskList: panelState.taskList,
                editData: {
                    titre: '', description: '', type: 'tache', priorite: '3', statut: 'todo', progression: 0,
                    dateDebut: dateToGrist(today), dateEcheance: dateToGrist(addDays(today, 7)),
                    projet: projects.length > 0 ? projects[0].id : null,
                    assignees: [], dependDe: [], tags: [], estimationH: null, tempsPasse: null
                }
            };
            renderPanel();
            openPanel();
            setTimeout(() => { const el = document.getElementById('taskTitle'); if (el) el.focus(); }, 100);
        }

        function cloneTaskData(task) {
            return {
                titre: task.titre || '', description: task.description || '', type: task.type || 'tache',
                priorite: String(task.priorite || '3'), statut: task.statut || 'todo', progression: task.progression || 0,
                dateDebut: task.dateDebut, dateEcheance: task.dateEcheance, projet: task.projet || null,
                assignees: getAssigneesArray(task), dependDe: getDependsOnArray(task), tags: getTagsArray(task),
                estimationH: task.estimationH || null, tempsPasse: task.tempsPasse || null
            };
        }

        function navigatePanelTask(dir) {
            if (panelState.isNew || panelState.taskList.length < 2) return;
            let newIdx = panelState.taskIndex + dir;
            if (newIdx < 0) newIdx = panelState.taskList.length - 1;
            if (newIdx >= panelState.taskList.length) newIdx = 0;
            const t = panelState.taskList[newIdx];
            if (t) openTaskPanel(t.id);
        }

        function renderPanel() {
            const header = document.getElementById('panelHeader');
            const content = document.getElementById('panelContent');
            const footer = document.getElementById('panelFooter');
            const data = panelState.editData;
            if (!data) { closePanel(); return; }

            const canNavigate = panelState.taskList.length > 1 && !panelState.isNew;
            const typeIcon = TYPE_ICONS[data.type] || 'üìã';
            const titleText = panelState.isNew ? 'Nouvelle t√¢che' : (data.titre || 'Sans titre');

            header.innerHTML = '<div class="panel-nav">' +
                '<button class="panel-nav-btn" onclick="navigatePanelTask(-1)" ' + (!canNavigate ? 'disabled' : '') + '>‚óÄ</button>' +
                '<span class="panel-title"><span style="margin-right:6px">' + typeIcon + '</span>' + escapeHtml(titleText) + '</span>' +
                '<button class="panel-nav-btn" onclick="navigatePanelTask(1)" ' + (!canNavigate ? 'disabled' : '') + '>‚ñ∂</button>' +
            '</div><button class="panel-close" onclick="closePanel()">√ó</button>';

            const s = gristToDate(data.dateDebut);
            const e = gristToDate(data.dateEcheance);
            const projectOptions = projects.filter(p => p.actif !== false).map(p => 
                '<option value="' + p.id + '" ' + (data.projet === p.id ? 'selected' : '') + '>' + escapeHtml(p.nom) + '</option>'
            ).join('');

            const assigneesChips = data.assignees.map(id => 
                '<span class="multi-select-chip">' + escapeHtml(getTeamMemberName(id)) + '<span class="remove" onclick="event.stopPropagation();removeAssignee(' + id + ')">√ó</span></span>'
            ).join('');
            const assigneesOptions = team.filter(m => m.actif !== false).map(m => 
                '<div class="multi-select-option ' + (data.assignees.includes(m.id) ? 'selected' : '') + '" onclick="toggleAssignee(' + m.id + ')"><input type="checkbox" ' + (data.assignees.includes(m.id) ? 'checked' : '') + ' onclick="event.stopPropagation();toggleAssignee(' + m.id + ')">' + escapeHtml(m.nom) + '</div>'
            ).join('');

            const depsChips = data.dependDe.map(id => {
                const d = tasks.find(t => t.id === id);
                return d ? '<span class="multi-select-chip">' + escapeHtml(d.titre) + '<span class="remove" onclick="event.stopPropagation();removeDependency(' + id + ')">√ó</span></span>' : '';
            }).join('');
            const availableDeps = panelState.isNew ? tasks : getAvailableDependencies(panelState.taskId);
            const depsOptions = availableDeps.map(t => 
                '<div class="multi-select-option ' + (data.dependDe.includes(t.id) ? 'selected' : '') + '" onclick="toggleDependency(' + t.id + ')"><input type="checkbox" ' + (data.dependDe.includes(t.id) ? 'checked' : '') + ' onclick="event.stopPropagation();toggleDependency(' + t.id + ')">' + escapeHtml(t.titre) + '</div>'
            ).join('');

            let blockedHtml = '';
            if (!panelState.isNew) {
                const blocked = getBlockedTasks(panelState.taskId);
                if (blocked.length) {
                    blockedHtml = '<div class="deps-display"><div class="deps-group"><div class="deps-group-label">‚Üí Bloque :</div><div class="deps-list">' +
                        blocked.map(t => '<div class="dep-item" onclick="openTaskPanel(' + t.id + ')">‚Üí ' + escapeHtml(t.titre) + '</div>').join('') +
                    '</div></div></div>';
                }
            }

            const tagsChips = data.tags.map(tag => 
                '<span class="tag-chip">#' + escapeHtml(tag) + '<span class="remove" onclick="removeTag(\'' + escapeHtml(tag) + '\')">√ó</span></span>'
            ).join('');

            const estim = data.estimationH || 0;
            const passe = data.tempsPasse || 0;
            const timePercent = estim > 0 ? Math.min((passe / estim) * 100, 100) : 0;
            const timeOver = passe > estim && estim > 0;

            content.innerHTML = 
                '<div class="type-selector">' +
                    '<div class="type-option ' + (data.type === 'tache' ? 'selected' : '') + '" onclick="updateField(\'type\',\'tache\')"><span class="type-option-icon">üìã</span>T√¢che</div>' +
                    '<div class="type-option ' + (data.type === 'jalon' ? 'selected' : '') + '" onclick="updateField(\'type\',\'jalon\')"><span class="type-option-icon">‚óÜ</span>Jalon</div>' +
                    '<div class="type-option ' + (data.type === 'reunion' ? 'selected' : '') + '" onclick="updateField(\'type\',\'reunion\')"><span class="type-option-icon">üë•</span>R√©union</div>' +
                '</div>' +
                '<div class="form-group"><input type="text" class="form-input title-input" id="taskTitle" placeholder="Titre..." value="' + escapeHtml(data.titre) + '" oninput="updateField(\'titre\', this.value, true)"></div>' +
                '<div class="panel-section">' +
                    (data.type === 'jalon' ? 
                        '<div class="form-group"><label class="form-label">Date</label><input type="date" class="form-input" value="' + formatDateISO(s) + '" onchange="updateField(\'dateDebut\', this.value); updateField(\'dateEcheance\', this.value)"></div>' : 
                        '<div class="form-row"><div class="form-group"><label class="form-label">D√©but</label><input type="date" class="form-input" value="' + formatDateISO(s) + '" onchange="updateField(\'dateDebut\', this.value)"></div><div class="form-group"><label class="form-label">Fin</label><input type="date" class="form-input" value="' + formatDateISO(e) + '" onchange="updateField(\'dateEcheance\', this.value)"></div></div>') +
                    '<div class="form-group"><label class="form-label">Projet</label><select class="form-select" onchange="updateField(\'projet\', parseInt(this.value) || null)"><option value="">Aucun</option>' + projectOptions + '</select></div>' +
                '</div>' +
                '<div class="panel-section">' +
                    '<div class="form-group"><label class="form-label">Priorit√©</label><div class="priority-selector">' +
                        '<div class="priority-pill p1 ' + (data.priorite == '1' ? 'selected' : '') + '" onclick="updateField(\'priorite\',\'1\')">Critique</div>' +
                        '<div class="priority-pill p2 ' + (data.priorite == '2' ? 'selected' : '') + '" onclick="updateField(\'priorite\',\'2\')">Haute</div>' +
                        '<div class="priority-pill p3 ' + (data.priorite == '3' ? 'selected' : '') + '" onclick="updateField(\'priorite\',\'3\')">Moyenne</div>' +
                        '<div class="priority-pill p4 ' + (data.priorite == '4' ? 'selected' : '') + '" onclick="updateField(\'priorite\',\'4\')">Basse</div>' +
                    '</div></div>' +
                    (data.type !== 'jalon' ? 
                        '<div class="form-group"><label class="form-label">Statut</label><div class="status-selector">' +
                            '<div class="status-pill ' + (data.statut === 'todo' ? 'selected' : '') + '" onclick="updateField(\'statut\',\'todo\')">√Ä faire</div>' +
                            '<div class="status-pill ' + (data.statut === 'inprogress' ? 'selected' : '') + '" onclick="updateField(\'statut\',\'inprogress\')">En cours</div>' +
                            '<div class="status-pill ' + (data.statut === 'review' ? 'selected' : '') + '" onclick="updateField(\'statut\',\'review\')">En revue</div>' +
                            '<div class="status-pill ' + (data.statut === 'done' ? 'selected' : '') + '" onclick="updateField(\'statut\',\'done\')">Termin√©</div>' +
                        '</div></div>' +
                        '<div class="form-group"><label class="form-label">Progression</label><div class="progress-container"><input type="range" class="progress-slider" min="0" max="100" value="' + data.progression + '" oninput="document.getElementById(\'progressValue\').textContent=this.value+\'%\'" onchange="updateField(\'progression\', parseInt(this.value))"><span class="progress-value" id="progressValue">' + data.progression + '%</span></div></div>' : '') +
                '</div>' +
                '<div class="panel-section">' +
                    '<div class="form-group"><label class="form-label">Assign√©s</label><div class="multi-select" id="assigneesSelect"><div class="multi-select-trigger" onclick="toggleMultiSelect(\'assigneesSelect\')"><div class="multi-select-values">' + (assigneesChips || '<span class="multi-select-placeholder">S√©lectionner...</span>') + '</div><span class="multi-select-arrow">‚ñæ</span></div><div class="multi-select-dropdown">' + (assigneesOptions || '<div class="multi-select-empty">Aucun</div>') + '</div></div></div>' +
                    '<div class="form-group"><label class="form-label">D√©pend de</label><div class="multi-select" id="depsSelect"><div class="multi-select-trigger" onclick="toggleMultiSelect(\'depsSelect\')"><div class="multi-select-values">' + (depsChips || '<span class="multi-select-placeholder">S√©lectionner...</span>') + '</div><span class="multi-select-arrow">‚ñæ</span></div><div class="multi-select-dropdown">' + (depsOptions || '<div class="multi-select-empty">Aucune</div>') + '</div></div>' + blockedHtml + '</div>' +
                '</div>' +
                '<div class="panel-section">' +
                    '<div class="form-group"><label class="form-label">Temps</label><div class="time-row"><div class="time-group"><label>Estim√©</label><div class="time-input-wrap"><input type="number" min="0" step="0.5" value="' + (estim || '') + '" placeholder="0" onchange="updateField(\'estimationH\', parseFloat(this.value) || null)"><span>h</span></div></div><div class="time-group"><label>Pass√©</label><div class="time-input-wrap"><input type="number" min="0" step="0.5" value="' + (passe || '') + '" placeholder="0" onchange="updateField(\'tempsPasse\', parseFloat(this.value) || null)"><span>h</span></div></div></div>' + (estim > 0 ? '<div class="time-bar"><div class="time-bar-fill ' + (timeOver ? 'over' : '') + '" style="width:' + timePercent + '%"></div></div>' : '') + '</div>' +
                    '<div class="form-group"><label class="form-label">Tags</label><div class="tags-input" onclick="document.getElementById(\'tagInput\').focus()">' + tagsChips + '<input type="text" id="tagInput" placeholder="' + (data.tags.length ? '' : 'Ajouter...') + '" onkeydown="handleTagKeydown(event)"></div></div>' +
                '</div>' +
                '<div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" placeholder="Notes..." oninput="updateField(\'description\', this.value, true)">' + escapeHtml(data.description) + '</textarea></div>' +
                (!panelState.isNew ? '<div id="deleteSection"><button class="panel-btn danger" onclick="showDeleteConfirm()">üóëÔ∏è Supprimer</button><div class="delete-confirm" id="deleteConfirm"><div class="delete-confirm-text">Supprimer ?</div><div class="delete-confirm-actions"><button class="delete-confirm-btn cancel" onclick="hideDeleteConfirm()">Annuler</button><button class="delete-confirm-btn confirm" onclick="confirmDelete()">Supprimer</button></div></div></div>' : '');

            if (panelState.isNew) {
                const canCreate = data.titre && data.titre.trim().length > 0;
                footer.innerHTML = '<button class="panel-btn success" onclick="createTask()" ' + (!canCreate ? 'disabled' : '') + '>‚úì Cr√©er</button>';
            } else {
                footer.innerHTML = '';
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // FIELD HANDLERS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function updateField(field, value, noSave) {
            const data = panelState.editData;
            if (!data) return;

            if (field === 'dateDebut' || field === 'dateEcheance') {
                value = value ? dateToGrist(new Date(value)) : null;
            }

            data[field] = value;

            if (field === 'type' && value === 'jalon' && data.dateDebut) {
                data.dateEcheance = data.dateDebut;
            }

            const visualFields = ['type', 'priorite', 'statut', 'projet'];
            if (visualFields.includes(field)) {
                renderPanel();
                if (!panelState.isNew) render();
            }

            if (field === 'titre' && panelState.isNew) {
                const btn = document.querySelector('.panel-footer .panel-btn');
                if (btn) btn.disabled = !value || !value.trim();
            }

            if (!panelState.isNew && !noSave && gristReady) saveTaskToGrist();
        }

        function toggleMultiSelect(id) {
            const el = document.getElementById(id);
            document.querySelectorAll('.multi-select').forEach(s => { if (s.id !== id) s.classList.remove('open'); });
            el.classList.toggle('open');
        }

        function toggleAssignee(id) {
            const data = panelState.editData;
            const idx = data.assignees.indexOf(id);
            if (idx === -1) data.assignees.push(id);
            else data.assignees.splice(idx, 1);
            if (!panelState.isNew && gristReady) saveTaskToGrist();
            renderPanel();
        }

        function removeAssignee(id) {
            const data = panelState.editData;
            const idx = data.assignees.indexOf(id);
            if (idx !== -1) {
                data.assignees.splice(idx, 1);
                if (!panelState.isNew && gristReady) saveTaskToGrist();
                renderPanel();
            }
        }

        function toggleDependency(id) {
            const data = panelState.editData;
            const idx = data.dependDe.indexOf(id);
            if (idx === -1) data.dependDe.push(id);
            else data.dependDe.splice(idx, 1);
            if (!panelState.isNew && gristReady) saveTaskToGrist();
            renderPanel();
            render();
        }

        function removeDependency(id) {
            const data = panelState.editData;
            const idx = data.dependDe.indexOf(id);
            if (idx !== -1) {
                data.dependDe.splice(idx, 1);
                if (!panelState.isNew && gristReady) saveTaskToGrist();
                renderPanel();
                render();
            }
        }

        function handleTagKeydown(e) {
            const data = panelState.editData;
            if (e.key === 'Enter' || e.key === ',') {
                e.preventDefault();
                const tag = e.target.value.trim().replace(/^#/, '');
                if (tag && !data.tags.includes(tag)) {
                    data.tags.push(tag);
                    e.target.value = '';
                    if (!panelState.isNew && gristReady) saveTaskToGrist();
                    renderPanel();
                }
            } else if (e.key === 'Backspace' && !e.target.value && data.tags.length) {
                data.tags.pop();
                if (!panelState.isNew && gristReady) saveTaskToGrist();
                renderPanel();
            }
        }

        function removeTag(tag) {
            const data = panelState.editData;
            const idx = data.tags.indexOf(tag);
            if (idx !== -1) {
                data.tags.splice(idx, 1);
                if (!panelState.isNew && gristReady) saveTaskToGrist();
                renderPanel();
            }
        }

        function showDeleteConfirm() { document.getElementById('deleteConfirm').classList.add('visible'); }
        function hideDeleteConfirm() { document.getElementById('deleteConfirm').classList.remove('visible'); }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SAVE OPERATIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function saveTaskToGrist() {
            const data = panelState.editData;
            if (!data || panelState.isNew || !gristReady) return;

            const record = {
                titre: data.titre, description: data.description, type: data.type, priorite: data.priorite,
                statut: data.statut, progression: data.progression, dateDebut: data.dateDebut, dateEcheance: data.dateEcheance,
                projet: data.projet, assignees: toGristRefList(data.assignees), dependDe: toGristRefList(data.dependDe),
                tags: toGristChoiceList(data.tags), estimationH: data.estimationH, tempsPasse: data.tempsPasse
            };

            try {
                await grist.docApi.applyUserActions([['UpdateRecord', 'Tasks', panelState.taskId, record]]);
                showSaveIndicator();
                const idx = tasks.findIndex(t => t.id === panelState.taskId);
                if (idx !== -1) tasks[idx] = { ...tasks[idx], ...record };
            } catch (e) {
                console.error(e);
                showToast('Erreur sauvegarde', 'error');
            }
        }

        async function createTask() {
            const data = panelState.editData;
            if (!data || !data.titre || !data.titre.trim()) {
                showToast('Titre requis', 'error');
                return;
            }

            const record = {
                titre: data.titre, description: data.description || '', type: data.type || 'tache',
                priorite: data.priorite || '3', statut: data.statut || 'todo', progression: data.progression || 0,
                dateDebut: data.dateDebut, dateEcheance: data.dateEcheance, projet: data.projet,
                assignees: toGristRefList(data.assignees), dependDe: toGristRefList(data.dependDe),
                tags: toGristChoiceList(data.tags), estimationH: data.estimationH, tempsPasse: data.tempsPasse
            };

            if (gristReady) {
                try {
                    await grist.docApi.applyUserActions([['AddRecord', 'Tasks', null, record]]);
                    showToast('T√¢che cr√©√©e', 'success');
                    closePanel();
                    await loadAllData();
                } catch (e) {
                    console.error(e);
                    showToast('Erreur cr√©ation', 'error');
                }
            } else {
                record.id = Date.now();
                tasks.push(record);
                sortTasks();
                showToast('T√¢che cr√©√©e', 'success');
                closePanel();
                render();
            }
        }

        async function confirmDelete() {
            if (panelState.isNew || !panelState.taskId) return;

            if (gristReady) {
                try {
                    await grist.docApi.applyUserActions([['RemoveRecord', 'Tasks', panelState.taskId]]);
                    showToast('Supprim√©e', 'success');
                    closePanel();
                    await loadAllData();
                } catch (e) {
                    console.error(e);
                    showToast('Erreur suppression', 'error');
                }
            } else {
                tasks = tasks.filter(t => t.id !== panelState.taskId);
                showToast('Supprim√©e', 'success');
                closePanel();
                render();
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // DRAG & DROP
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function startDrag(e, bar, type) {
            const id = parseInt(bar.dataset.id);
            const task = tasks.find(t => t.id === id);
            if (!task || isJalon(task)) return;

            e.preventDefault();
            e.stopPropagation();

            dragState = {
                active: true, type: type, taskId: id, startX: e.clientX,
                originalLeft: parseFloat(bar.style.left), originalWidth: parseFloat(bar.style.width),
                originalStart: gristToDate(task.dateDebut), originalEnd: gristToDate(task.dateEcheance)
            };

            bar.style.zIndex = '100';
            bar.style.opacity = '0.8';

            document.addEventListener('mousemove', onDrag);
            document.addEventListener('mouseup', endDrag);
        }

        function onDrag(e) {
            if (!dragState.active) return;

            const pxPerDay = getPixelsPerDay();
            const dx = e.clientX - dragState.startX;
            const daysDelta = Math.round(dx / pxPerDay);
            const bar = document.querySelector('.gantt-bar[data-id="' + dragState.taskId + '"]');
            if (!bar) return;

            if (dragState.type === 'move') {
                bar.style.left = (dragState.originalLeft + daysDelta * pxPerDay) + 'px';
            } else if (dragState.type === 'resize-right') {
                const newWidth = Math.max(dragState.originalWidth + daysDelta * pxPerDay, pxPerDay);
                bar.style.width = newWidth + 'px';
            } else if (dragState.type === 'resize-left') {
                const newLeft = dragState.originalLeft + daysDelta * pxPerDay;
                const newWidth = dragState.originalWidth - daysDelta * pxPerDay;
                if (newWidth >= pxPerDay) {
                    bar.style.left = newLeft + 'px';
                    bar.style.width = newWidth + 'px';
                }
            }
        }

        async function endDrag(e) {
            document.removeEventListener('mousemove', onDrag);
            document.removeEventListener('mouseup', endDrag);

            if (!dragState.active) return;

            const bar = document.querySelector('.gantt-bar[data-id="' + dragState.taskId + '"]');
            if (bar) { bar.style.zIndex = ''; bar.style.opacity = ''; }

            const task = tasks.find(t => t.id === dragState.taskId);
            if (!task) { dragState.active = false; return; }

            const pxPerDay = getPixelsPerDay();
            const dx = e.clientX - dragState.startX;
            const daysDelta = Math.round(dx / pxPerDay);

            let newStart = dragState.originalStart, newEnd = dragState.originalEnd;
            if (dragState.type === 'move') { newStart = addDays(dragState.originalStart, daysDelta); newEnd = addDays(dragState.originalEnd, daysDelta); }
            else if (dragState.type === 'resize-right') newEnd = addDays(dragState.originalEnd, daysDelta);
            else if (dragState.type === 'resize-left') newStart = addDays(dragState.originalStart, daysDelta);

            task.dateDebut = dateToGrist(newStart);
            task.dateEcheance = dateToGrist(newEnd);

            if (gristReady) {
                try {
                    await grist.docApi.applyUserActions([['UpdateRecord', 'Tasks', task.id, { dateDebut: task.dateDebut, dateEcheance: task.dateEcheance }]]);
                    showToast('Dates mises √† jour', 'success');
                } catch (err) { showToast('Erreur de mise √† jour', 'error'); }
            }

            dragState.active = false;
            render();
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // GRIST INTEGRATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function convert(data) {
            if (!data || Array.isArray(data)) return data || [];
            const cols = Object.keys(data);
            if (!cols.length) return [];
            const n = data[cols[0]]?.length || 0;
            const r = [];
            for (let i = 0; i < n; i++) { const rec = {}; cols.forEach(c => rec[c] = data[c][i]); r.push(rec); }
            return r;
        }

        const TASKFLOW_SCHEMA = {
            Team: [{ id: 'nom', type: 'Text' }, { id: 'email', type: 'Text' }, { id: 'avatar', type: 'Text' }, { id: 'role', type: 'Choice' }, { id: 'actif', type: 'Bool' }],
            Projects: [{ id: 'nom', type: 'Text' }, { id: 'couleur', type: 'Text' }, { id: 'dateDebut', type: 'Date' }, { id: 'dateFin', type: 'Date' }, { id: 'responsable', type: 'Ref:Team' }, { id: 'actif', type: 'Bool' }],
            Tasks: [{ id: 'titre', type: 'Text' }, { id: 'description', type: 'Text' }, { id: 'dateDebut', type: 'Date' }, { id: 'dateEcheance', type: 'Date' }, { id: 'priorite', type: 'Choice' }, { id: 'statut', type: 'Choice' }, { id: 'progression', type: 'Numeric' }, { id: 'projet', type: 'Ref:Projects' }, { id: 'assignees', type: 'RefList:Team' }, { id: 'type', type: 'Choice' }, { id: 'dependDe', type: 'RefList:Tasks' }, { id: 'tags', type: 'ChoiceList' }, { id: 'estimationH', type: 'Numeric' }, { id: 'tempsPasse', type: 'Numeric' }, { id: 'couleur', type: 'Text' }]
        };

        async function ensureSchema() {
            let created = 0, added = 0;
            const tablesCreated = [];

            for (const [tableName, columns] of Object.entries(TASKFLOW_SCHEMA)) {
                let existingCols = [], tableExists = false;
                try { existingCols = Object.keys(await grist.docApi.fetchTable(tableName)).filter(c => c !== 'id' && c !== 'manualSort'); tableExists = true; }
                catch (e) { try { await grist.docApi.applyUserActions([['AddTable', tableName, columns.map(c => ({ id: c.id, type: c.type }))]]); tablesCreated.push(tableName); created++; continue; } catch (e2) { continue; } }
                if (tableExists) { const missing = columns.filter(c => !existingCols.includes(c.id)); for (const col of missing) { try { await grist.docApi.applyUserActions([['AddColumn', tableName, col.id, { type: col.type }]]); added++; } catch (e) {} } }
            }
            if (tablesCreated.includes('Tasks')) await seedData();
            if (created > 0 || added > 0) showToast('Schema initialis√© (' + created + ' tables, ' + added + ' colonnes)', 'success');
        }

        async function seedData() {
            const today = new Date();
            const day = (d) => new Date(today.getFullYear(), today.getMonth(), today.getDate() + d).getTime() / 1000;
            try {
                await grist.docApi.applyUserActions([
                    ['AddRecord', 'Team', null, { nom: 'Alice Martin', email: 'alice@cerema.fr', role: 'Chef de projet', actif: true }],
                    ['AddRecord', 'Team', null, { nom: 'Bob Durant', email: 'bob@cerema.fr', role: 'D√©veloppeur', actif: true }],
                    ['AddRecord', 'Team', null, { nom: 'Claire Bernard', email: 'claire@cerema.fr', role: 'Designer', actif: true }]
                ]);
                await grist.docApi.applyUserActions([
                    ['AddRecord', 'Projects', null, { nom: 'Refonte Portail', couleur: '#4f46e5', dateDebut: day(-15), dateFin: day(45), responsable: 1, actif: true }],
                    ['AddRecord', 'Projects', null, { nom: 'App Mobile', couleur: '#10b981', dateDebut: day(-5), dateFin: day(60), responsable: 2, actif: true }]
                ]);
                await grist.docApi.applyUserActions([
                    ['AddRecord', 'Tasks', null, { titre: 'Cahier des charges', dateDebut: day(-15), dateEcheance: day(-8), priorite: '1', statut: 'done', progression: 100, projet: 1, type: 'tache', assignees: ['L', 1] }],
                    ['AddRecord', 'Tasks', null, { titre: 'Maquettes UI/UX', dateDebut: day(-10), dateEcheance: day(-2), priorite: '2', statut: 'done', progression: 100, projet: 1, type: 'tache', assignees: ['L', 3] }],
                    ['AddRecord', 'Tasks', null, { titre: 'D√©veloppement frontend', dateDebut: day(-3), dateEcheance: day(12), priorite: '1', statut: 'inprogress', progression: 35, projet: 1, type: 'tache', assignees: ['L', 2, 3], dependDe: ['L', 2] }],
                    ['AddRecord', 'Tasks', null, { titre: 'Validation design', dateDebut: day(-2), dateEcheance: day(-2), priorite: '2', statut: 'done', progression: 100, projet: 1, type: 'jalon' }],
                    ['AddRecord', 'Tasks', null, { titre: 'API backend', dateDebut: day(-5), dateEcheance: day(10), priorite: '1', statut: 'inprogress', progression: 55, projet: 1, type: 'tache', assignees: ['L', 2] }],
                    ['AddRecord', 'Tasks', null, { titre: 'Proto mobile v1', dateDebut: day(1), dateEcheance: day(20), priorite: '2', statut: 'todo', progression: 0, projet: 2, type: 'tache', assignees: ['L', 2] }],
                    ['AddRecord', 'Tasks', null, { titre: 'Livraison MVP', dateDebut: day(28), dateEcheance: day(28), priorite: '1', statut: 'todo', progression: 0, projet: 1, type: 'jalon', dependDe: ['L', 3, 5] }]
                ]);
            } catch (e) { console.log('Seed error:', e); }
        }

        async function loadAllData() {
            try { tasks = convert(await grist.docApi.fetchTable('Tasks')); } catch (e) { tasks = []; }
            try { team = convert(await grist.docApi.fetchTable('Team')); } catch (e) { team = []; }
            try { projects = convert(await grist.docApi.fetchTable('Projects')); } catch (e) { projects = []; }
            gristReady = true;
            sortTasks();
            updateFilterMenus();
            render();
        }

        async function initGrist() {
            try {
                grist.ready({ requiredAccess: 'full' });
                await ensureSchema();
                await loadAllData();
                grist.onRecords(async () => await loadAllData());
                grist.onRecord((rec) => {
                    if (rec?.id && rec.id !== selectedTaskId) {
                        selectedTaskId = rec.id;
                        render();
                    }
                });
            } catch (e) {
                console.log('Grist unavailable, using demo');
                useDemoMode();
            }
        }

        function useDemoMode() {
            document.body.insertAdjacentHTML('beforeend', '<div class="demo-badge">D√©mo</div>');

            team = [
                { id: 1, nom: 'Alice Martin', actif: true },
                { id: 2, nom: 'Bob Durant', actif: true },
                { id: 3, nom: 'Claire Bernard', actif: true }
            ];
            projects = [
                { id: 1, nom: 'Refonte Portail', couleur: '#4f46e5', actif: true },
                { id: 2, nom: 'App Mobile', couleur: '#10b981', actif: true }
            ];

            const today = new Date();
            const day = (d) => dateToGrist(new Date(today.getFullYear(), today.getMonth(), today.getDate() + d));

            tasks = [
                { id: 1, titre: 'Analyse besoins', priorite: '1', projet: 1, dateDebut: day(-10), dateEcheance: day(-5), progression: 100, statut: 'done', type: 'tache', assignees: ['L', 1], tags: ['L', 'documentation'] },
                { id: 2, titre: 'Dev Backend', priorite: '1', projet: 1, dateDebut: day(-4), dateEcheance: day(10), progression: 40, statut: 'inprogress', type: 'tache', dependDe: ['L', 1], assignees: ['L', 1, 2], estimationH: 32, tempsPasse: 12 },
                { id: 3, titre: 'Mise en prod', type: 'jalon', priorite: '1', projet: 1, dateDebut: day(20), dateEcheance: day(20), progression: 0, statut: 'todo' },
                { id: 4, titre: 'Design UI', priorite: '2', projet: 2, dateDebut: day(-5), dateEcheance: day(2), progression: 80, statut: 'review', type: 'tache', assignees: ['L', 3] },
                { id: 5, titre: 'Dev Frontend', priorite: '2', projet: 2, dateDebut: day(0), dateEcheance: day(15), progression: 20, statut: 'inprogress', type: 'tache', dependDe: ['L', 4], assignees: ['L', 2] },
                { id: 6, titre: 'Review finale', type: 'jalon', priorite: '2', projet: 2, dateDebut: day(18), dateEcheance: day(18), progression: 0, statut: 'todo', dependDe: ['L', 5] },
                { id: 7, titre: 'Tests QA', priorite: '3', projet: 1, dateDebut: day(5), dateEcheance: day(12), progression: 0, statut: 'todo', type: 'tache', tags: ['L', 'qa', 'tests'] },
                { id: 8, titre: 'Documentation', priorite: '4', projet: null, dateDebut: day(12), dateEcheance: day(20), progression: 0, statut: 'todo', type: 'tache', assignees: ['L', 3] }
            ];

            sortTasks();
            updateFilterMenus();
            render();
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // EVENT LISTENERS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.filter-dropdown')) {
                document.querySelectorAll('.filter-menu').forEach(m => m.classList.remove('open'));
            }
            if (!e.target.closest('.multi-select')) {
                document.querySelectorAll('.multi-select').forEach(s => s.classList.remove('open'));
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && panelState.open) closePanel();
            if (panelState.open && !panelState.isNew && !e.target.matches('input, textarea, select')) {
                if (e.key === 'ArrowLeft') navigatePanelTask(-1);
                if (e.key === 'ArrowRight') navigatePanelTask(1);
            }
        });

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // INIT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        document.documentElement.style.setProperty('--cell-width', VIEW_CONFIG[currentView].cellWidth + 'px');
        initGrist();
    </script>
</body>
</html>