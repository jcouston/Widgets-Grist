<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar - TaskFlow v16</title>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --primary-light: #e0e7ff;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text: #1e293b;
            --text-muted: #64748b;
            --text-light: #94a3b8;
            --border: #e2e8f0;
            --border-dark: #cbd5e1;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.15);
            --panel-width: 340px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; }

        /* Header */
        .header { background: var(--card-bg); border-bottom: 1px solid var(--border); padding: 12px 16px; display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-shrink: 0; }
        .header h1 { font-size: 1.25rem; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 8px; white-space: nowrap; }
        .header-center { display: flex; align-items: center; gap: 8px; flex: 1; justify-content: center; min-width: 0; }
        .nav-group { display: flex; align-items: center; gap: 4px; }
        .current-period { font-weight: 600; font-size: 0.9rem; min-width: 120px; text-align: center; white-space: nowrap; }
        .header-right { display: flex; align-items: center; gap: 8px; }

        .btn { padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border); font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 0.8rem; transition: all 0.2s; background: var(--card-bg); color: var(--text); white-space: nowrap; }
        .btn:hover { background: var(--bg); }
        .btn.primary { background: var(--primary); color: white; border-color: var(--primary); }
        .btn.primary:hover { background: var(--primary-dark); }
        .btn-icon { padding: 8px 10px; min-width: 36px; }

        .view-controls { display: flex; gap: 2px; background: var(--bg); padding: 3px; border-radius: 8px; }
        .view-controls .btn { border: none; background: transparent; padding: 5px 10px; border-radius: 5px; font-size: 0.75rem; }
        .view-controls .btn.active { background: var(--primary); color: white; }

        /* Filters */
        .filters { display: flex; align-items: center; gap: 4px; }
        .filter-dropdown { position: relative; }
        .filter-btn { padding: 6px 10px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 6px; font-size: 0.75rem; cursor: pointer; display: flex; align-items: center; gap: 4px; color: var(--text-muted); transition: all 0.15s; white-space: nowrap; }
        .filter-btn:hover { border-color: var(--border-dark); color: var(--text); }
        .filter-btn.has-filter { background: var(--primary-light); border-color: var(--primary); color: var(--primary); }
        .filter-menu { position: absolute; top: 100%; right: 0; margin-top: 4px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; box-shadow: var(--shadow-lg); min-width: 180px; padding: 6px; z-index: 100; display: none; max-height: 300px; overflow-y: auto; }
        .filter-menu.open { display: block; }
        .filter-option { padding: 6px 8px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 0.8rem; }
        .filter-option:hover { background: var(--bg); }
        .filter-option input { margin: 0; }

        /* Main Layout */
        .main-content { display: flex; flex: 1; overflow: hidden; position: relative; }
        .grid-container { flex: 1; overflow: hidden; transition: margin-right 0.25s ease; display: flex; flex-direction: column; }
        .grid-container.panel-open { margin-right: var(--panel-width); }

        /* Month Grid */
        .month-grid { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: var(--card-bg); }
        .month-header { display: grid; grid-template-columns: 32px repeat(7, 1fr); background: var(--bg); border-bottom: 1px solid var(--border); }
        .month-header-cell { padding: 10px 4px; text-align: center; font-size: 0.7rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .month-header-cell.weekend { color: var(--text-light); }
        .month-body { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .month-week { flex: 1; display: grid; grid-template-columns: 32px repeat(7, 1fr); min-height: 0; border-bottom: 1px solid var(--border); position: relative; }
        .month-week:last-child { border-bottom: none; }
        .week-number { display: flex; align-items: flex-start; justify-content: center; padding-top: 8px; font-size: 0.65rem; font-weight: 600; color: var(--text-light); cursor: pointer; background: var(--bg); border-right: 1px solid var(--border); transition: all 0.15s; }
        .week-number:hover { color: var(--primary); background: var(--primary-light); }
        .month-day { border-right: 1px solid var(--border); display: flex; flex-direction: column; min-height: 0; overflow: hidden; cursor: pointer; position: relative; transition: background 0.15s; }
        .month-day:last-child { border-right: none; }
        .month-day:hover { background: rgba(79, 70, 229, 0.03); }
        .month-day.weekend { background: #fef2f2; }
        .month-day.other-month { opacity: 0.4; }
        .month-day.today .day-number { background: var(--primary); color: white; }
        .month-day.selected { background: var(--primary-light) !important; }
        .day-header { padding: 4px 6px; flex-shrink: 0; }
        .day-number { font-size: 0.8rem; font-weight: 500; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .day-events-area { flex: 1; position: relative; overflow: hidden; }
        .week-lanes-container { position: absolute; left: 32px; right: 0; top: 0; bottom: 0; pointer-events: none; overflow: hidden; }

        .event-bar { position: absolute; height: 16px; border-radius: 3px; padding: 0 5px; font-size: 0.6rem; font-weight: 500; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: flex; align-items: center; cursor: pointer; pointer-events: auto; box-shadow: 0 1px 2px rgba(0,0,0,0.15); z-index: 1; transition: transform 0.1s, box-shadow 0.1s; }
        .event-bar:hover { transform: translateY(-1px); box-shadow: 0 3px 8px rgba(0,0,0,0.2); z-index: 10; }
        .event-bar.selected { outline: 2px solid var(--primary); outline-offset: 1px; }
        .event-bar.p1 { background: linear-gradient(135deg, var(--danger), #f87171); }
        .event-bar.p2 { background: linear-gradient(135deg, var(--warning), #fbbf24); }
        .event-bar.p3 { background: linear-gradient(135deg, var(--info), #60a5fa); }
        .event-bar.p4 { background: linear-gradient(135deg, var(--text-muted), #94a3b8); }
        .event-bar.milestone { background: transparent !important; box-shadow: none; color: var(--text); }
        .event-bar.milestone::before { content: '‚óÜ'; margin-right: 3px; font-size: 0.7rem; }
        .event-bar.milestone.p1::before { color: var(--danger); }
        .event-bar.milestone.p2::before { color: var(--warning); }
        .event-bar.milestone.p3::before { color: var(--info); }
        .event-bar.milestone.p4::before { color: var(--text-muted); }
        .event-bar.done { opacity: 0.5; }
        .more-events { position: absolute; bottom: 2px; right: 4px; font-size: 0.6rem; color: var(--primary); cursor: pointer; padding: 1px 5px; border-radius: 3px; background: var(--primary-light); pointer-events: auto; font-weight: 600; }
        .more-events:hover { background: var(--primary); color: white; }

        /* Week View */
        .week-grid { flex: 1; display: none; flex-direction: column; overflow: hidden; background: var(--card-bg); }
        .week-grid.active { display: flex; }
        .week-header { display: grid; grid-template-columns: 50px repeat(7, 1fr); background: var(--bg); border-bottom: 1px solid var(--border); }
        .week-header-cell { padding: 8px 4px; text-align: center; border-right: 1px solid var(--border); }
        .week-header-cell:last-child { border-right: none; }
        .week-header-cell.weekend { background: #fef2f2; }
        .week-header-day { font-size: 0.65rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; }
        .week-header-date { font-size: 1.1rem; font-weight: 600; color: var(--text); cursor: pointer; }
        .week-header-date:hover { color: var(--primary); }
        .week-header-cell.today .week-header-date { background: var(--primary); color: white; width: 28px; height: 28px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; }
        .week-allday { display: grid; grid-template-columns: 50px repeat(7, 1fr); background: var(--card-bg); border-bottom: 1px solid var(--border); min-height: 40px; }
        .week-allday-label { font-size: 0.6rem; color: var(--text-light); padding: 4px; text-align: center; border-right: 1px solid var(--border); background: var(--bg); display: flex; align-items: center; justify-content: center; }
        .week-allday-cell { border-right: 1px solid var(--border); padding: 4px; cursor: pointer; min-height: 36px; }
        .week-allday-cell:last-child { border-right: none; }
        .week-allday-cell:hover { background: rgba(79, 70, 229, 0.03); }
        .week-allday-cell.weekend { background: #fef2f2; }
        .week-allday-event { color: white; font-size: 0.65rem; padding: 2px 6px; border-radius: 3px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; font-weight: 500; }
        .week-allday-event.p1 { background: var(--danger); }
        .week-allday-event.p2 { background: var(--warning); }
        .week-allday-event.p3 { background: var(--info); }
        .week-allday-event.p4 { background: var(--text-muted); }
        .week-timeline { flex: 1; display: grid; grid-template-columns: 50px repeat(7, 1fr); overflow-y: auto; }
        .week-hours { border-right: 1px solid var(--border); background: var(--bg); }
        .week-hour-label { height: 48px; padding: 0 6px; font-size: 0.65rem; color: var(--text-muted); text-align: right; display: flex; align-items: flex-start; justify-content: flex-end; padding-top: 2px; }
        .week-day-column { border-right: 1px solid var(--border); position: relative; }
        .week-day-column:last-child { border-right: none; }
        .week-day-column.weekend { background: #fef2f2; }
        .week-hour-slot { height: 48px; border-bottom: 1px solid var(--border); cursor: crosshair; position: relative; transition: background 0.1s; }
        .week-hour-slot:hover { background: rgba(79, 70, 229, 0.05); }

        /* Year View */
        .year-grid { flex: 1; display: none; grid-template-columns: repeat(4, 1fr); gap: 16px; padding: 20px; overflow-y: auto; background: var(--bg); }
        .year-grid.active { display: grid; }
        .mini-month { background: var(--card-bg); border-radius: 10px; padding: 12px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; box-shadow: var(--shadow); }
        .mini-month:hover { border-color: var(--primary); transform: translateY(-2px); }
        .mini-month-title { font-weight: 600; font-size: 0.85rem; margin-bottom: 8px; text-align: center; }
        .mini-month-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; font-size: 0.6rem; text-align: center; }
        .mini-day-header { font-weight: 600; color: var(--text-muted); padding: 2px; }
        .mini-day { padding: 3px 2px; border-radius: 3px; }
        .mini-day.other-month { color: var(--text-light); }
        .mini-day.today { background: var(--primary); color: white; font-weight: 600; }
        .mini-day.has-events { background: var(--primary-light); font-weight: 500; }

        /* Panel - Slide-in */
        .panel { position: absolute; top: 0; right: 0; width: var(--panel-width); height: 100%; background: var(--card-bg); border-left: 1px solid var(--border); display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.25s ease; z-index: 10; }
        .panel.open { transform: translateX(0); }
        .panel-header { padding: 12px 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; background: var(--bg); gap: 8px; }
        .panel-nav { display: flex; align-items: center; gap: 6px; flex: 1; min-width: 0; }
        .panel-nav-btn { width: 28px; height: 28px; border: 1px solid var(--border); background: var(--card-bg); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-muted); font-size: 0.75rem; transition: all 0.15s; flex-shrink: 0; }
        .panel-nav-btn:hover { background: var(--bg); color: var(--text); }
        .panel-nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .panel-title { font-weight: 600; font-size: 0.9rem; flex: 1; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; min-width: 0; }
        .panel-title-icon { margin-right: 6px; }
        .panel-close { width: 28px; height: 28px; border: none; background: transparent; border-radius: 6px; cursor: pointer; color: var(--text-muted); font-size: 1.1rem; flex-shrink: 0; }
        .panel-close:hover { background: var(--bg); color: var(--text); }
        .panel-content { flex: 1; overflow-y: auto; padding: 16px; }
        .panel-footer { padding: 12px 16px; border-top: 1px solid var(--border); display: flex; gap: 8px; }
        .panel-footer-left { flex: 1; }
        .panel-footer-right { display: flex; gap: 8px; }

        .panel-btn { padding: 10px 16px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 0.85rem; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: background 0.15s; }
        .panel-btn:hover { background: var(--primary-dark); }
        .panel-btn:disabled { background: var(--border); cursor: not-allowed; }
        .panel-btn.success { background: var(--success); }
        .panel-btn.success:hover { background: #059669; }
        .panel-btn.danger { background: transparent; color: var(--danger); border: 1px solid var(--danger); padding: 8px 12px; }
        .panel-btn.danger:hover { background: var(--danger); color: white; }

        .panel-section { margin-bottom: 16px; padding-bottom: 14px; border-bottom: 1px solid var(--border); }
        .panel-section:last-child { border-bottom: none; margin-bottom: 0; }
        .panel-section-title { font-size: 0.7rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }
        .panel-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 16px; }
        .panel-stat { background: var(--bg); padding: 12px; border-radius: 8px; text-align: center; }
        .panel-stat-value { font-size: 1.4rem; font-weight: 700; color: var(--primary); }
        .panel-stat-label { font-size: 0.7rem; color: var(--text-muted); }
        .panel-task-card { background: var(--bg); border-radius: 8px; padding: 12px; margin-bottom: 8px; cursor: pointer; border-left: 4px solid var(--info); transition: all 0.15s; }
        .panel-task-card:hover { background: var(--primary-light); transform: translateX(2px); }
        .panel-task-card.selected { background: var(--primary-light); border-left-color: var(--primary) !important; }
        .panel-task-card.p1 { border-left-color: var(--danger); }
        .panel-task-card.p2 { border-left-color: var(--warning); }
        .panel-task-card.p3 { border-left-color: var(--info); }
        .panel-task-card.p4 { border-left-color: var(--text-muted); }
        .panel-task-title { font-weight: 500; font-size: 0.85rem; margin-bottom: 4px; }
        .panel-task-meta { font-size: 0.7rem; color: var(--text-muted); display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 6px; }
        .panel-task-progress { height: 3px; background: var(--border); border-radius: 2px; margin-top: 8px; overflow: hidden; }
        .panel-task-progress-bar { height: 100%; border-radius: 2px; }
        .panel-task-progress-bar.p1 { background: var(--danger); }
        .panel-task-progress-bar.p2 { background: var(--warning); }
        .panel-task-progress-bar.p3 { background: var(--info); }
        .panel-task-progress-bar.p4 { background: var(--text-muted); }
        .panel-empty { text-align: center; color: var(--text-muted); padding: 32px 0; font-size: 0.85rem; }

        /* Form Elements */
        .type-selector { display: flex; gap: 6px; margin-bottom: 16px; background: var(--bg); padding: 4px; border-radius: 8px; }
        .type-option { flex: 1; padding: 8px 6px; border: none; background: transparent; border-radius: 6px; text-align: center; cursor: pointer; transition: all 0.15s; font-size: 0.75rem; font-weight: 500; color: var(--text-muted); }
        .type-option:hover { background: var(--card-bg); }
        .type-option.selected { background: var(--card-bg); color: var(--text); box-shadow: var(--shadow); }
        .type-option-icon { display: block; font-size: 1rem; margin-bottom: 2px; }
        
        .form-group { margin-bottom: 14px; position: relative; }
        .form-label { display: block; font-size: 0.7rem; font-weight: 600; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.3px; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.85rem; color: var(--text); background: var(--card-bg); transition: border-color 0.15s, box-shadow 0.15s; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
        .form-input.title-input { font-size: 1rem; font-weight: 600; border: none; padding: 8px 0; background: transparent; border-bottom: 2px solid var(--border); border-radius: 0; }
        .form-input.title-input:focus { border-bottom-color: var(--primary); box-shadow: none; }
        .form-textarea { min-height: 70px; resize: vertical; font-size: 0.8rem; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        .priority-selector { display: flex; gap: 6px; }
        .priority-pill { flex: 1; padding: 8px 4px; border: 2px solid var(--border); border-radius: 8px; text-align: center; cursor: pointer; font-size: 0.7rem; font-weight: 600; transition: all 0.15s; background: var(--card-bg); }
        .priority-pill:hover { transform: scale(1.02); }
        .priority-pill.p1 { border-color: var(--danger); color: var(--danger); }
        .priority-pill.p1.selected { background: var(--danger); color: white; }
        .priority-pill.p2 { border-color: var(--warning); color: var(--warning); }
        .priority-pill.p2.selected { background: var(--warning); color: white; }
        .priority-pill.p3 { border-color: var(--info); color: var(--info); }
        .priority-pill.p3.selected { background: var(--info); color: white; }
        .priority-pill.p4 { border-color: var(--text-muted); color: var(--text-muted); }
        .priority-pill.p4.selected { background: var(--text-muted); color: white; }
        
        .status-selector { display: flex; gap: 6px; flex-wrap: wrap; }
        .status-pill { padding: 6px 10px; border: 1px solid var(--border); border-radius: 20px; font-size: 0.72rem; cursor: pointer; transition: all 0.15s; background: var(--card-bg); }
        .status-pill:hover { border-color: var(--primary); }
        .status-pill.selected { background: var(--primary); color: white; border-color: var(--primary); }
        
        .progress-container { display: flex; align-items: center; gap: 10px; }
        .progress-slider { flex: 1; -webkit-appearance: none; height: 6px; border-radius: 3px; background: var(--border); outline: none; }
        .progress-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: var(--primary); cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
        .progress-value { font-size: 0.85rem; font-weight: 600; color: var(--primary); min-width: 40px; text-align: right; }

        /* Multi-select (Assign√©s, D√©pendances) */
        .multi-select { position: relative; }
        .multi-select-trigger { min-height: 40px; padding: 6px 10px; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; gap: 8px; background: var(--card-bg); }
        .multi-select-trigger:hover { border-color: var(--border-dark); }
        .multi-select.open .multi-select-trigger { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
        .multi-select-values { display: flex; flex-wrap: wrap; gap: 4px; flex: 1; }
        .multi-select-chip { display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; background: var(--primary-light); color: var(--primary); border-radius: 4px; font-size: 0.72rem; font-weight: 500; }
        .multi-select-chip .remove { cursor: pointer; font-size: 0.85rem; opacity: 0.7; margin-left: 2px; }
        .multi-select-chip .remove:hover { opacity: 1; }
        .multi-select-placeholder { color: var(--text-muted); font-size: 0.8rem; }
        .multi-select-arrow { color: var(--text-muted); font-size: 0.7rem; flex-shrink: 0; }
        .multi-select-dropdown { position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; box-shadow: var(--shadow-lg); z-index: 100; display: none; max-height: 180px; overflow-y: auto; }
        .multi-select.open .multi-select-dropdown { display: block; }
        .multi-select-option { padding: 8px 10px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.8rem; }
        .multi-select-option:hover { background: var(--bg); }
        .multi-select-option.selected { background: var(--primary-light); }
        .multi-select-option input[type="checkbox"] { width: 14px; height: 14px; accent-color: var(--primary); flex-shrink: 0; }
        .multi-select-empty { padding: 12px; text-align: center; color: var(--text-muted); font-size: 0.8rem; }

        /* Tags Input */
        .tags-input { display: flex; flex-wrap: wrap; gap: 5px; padding: 6px 10px; border: 1px solid var(--border); border-radius: 8px; min-height: 40px; align-items: center; cursor: text; background: var(--card-bg); }
        .tags-input:focus-within { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
        .tag-chip { display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 4px; font-size: 0.72rem; font-weight: 500; }
        .tag-chip .remove { cursor: pointer; color: var(--text-muted); font-size: 0.85rem; }
        .tag-chip .remove:hover { color: var(--danger); }
        .tags-input input { border: none; outline: none; flex: 1; min-width: 60px; font-size: 0.8rem; padding: 3px 0; background: transparent; }

        /* Time Tracking */
        .time-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .time-group { display: flex; flex-direction: column; gap: 4px; }
        .time-group label { font-size: 0.68rem; color: var(--text-muted); }
        .time-input-wrap { display: flex; align-items: center; gap: 4px; }
        .time-input-wrap input { width: 60px; padding: 6px 8px; border: 1px solid var(--border); border-radius: 6px; text-align: center; font-size: 0.85rem; }
        .time-input-wrap input:focus { outline: none; border-color: var(--primary); }
        .time-input-wrap span { color: var(--text-muted); font-size: 0.75rem; }
        .time-bar { height: 6px; background: var(--border); border-radius: 3px; margin-top: 8px; overflow: hidden; }
        .time-bar-fill { height: 100%; background: var(--success); transition: width 0.3s; }
        .time-bar-fill.over { background: var(--danger); }

        /* Dependencies Section */
        .deps-display { margin-top: 10px; }
        .deps-group { margin-bottom: 10px; }
        .deps-group-label { font-size: 0.68rem; color: var(--text-muted); margin-bottom: 4px; display: flex; align-items: center; gap: 4px; }
        .deps-list { display: flex; flex-direction: column; gap: 4px; }
        .dep-item { display: flex; align-items: center; gap: 6px; padding: 6px 8px; background: var(--bg); border-radius: 5px; font-size: 0.75rem; cursor: pointer; transition: background 0.15s; }
        .dep-item:hover { background: var(--primary-light); }
        .dep-item .icon { font-size: 0.7rem; color: var(--text-muted); }

        /* Delete Confirm */
        .delete-confirm { background: #fef2f2; border: 1px solid var(--danger); border-radius: 8px; padding: 12px; margin-top: 12px; display: none; }
        .delete-confirm.visible { display: block; }
        .delete-confirm-text { font-size: 0.8rem; color: var(--danger); margin-bottom: 10px; }
        .delete-confirm-actions { display: flex; gap: 8px; }
        .delete-confirm-btn { flex: 1; padding: 8px; border-radius: 6px; font-size: 0.8rem; font-weight: 500; cursor: pointer; border: none; }
        .delete-confirm-btn.cancel { background: var(--card-bg); border: 1px solid var(--border); }
        .delete-confirm-btn.confirm { background: var(--danger); color: white; }

        /* Legend */
        .legend { display: flex; gap: 16px; padding: 10px 20px; background: var(--card-bg); border-top: 1px solid var(--border); font-size: 0.75rem; align-items: center; flex-wrap: wrap; flex-shrink: 0; }
        .legend-item { display: flex; align-items: center; gap: 6px; color: var(--text-muted); }
        .legend-color { width: 12px; height: 12px; border-radius: 3px; }

        /* Utils */
        .save-indicator { position: fixed; bottom: 70px; right: 20px; background: var(--success); color: white; padding: 8px 14px; border-radius: 6px; font-size: 0.8rem; font-weight: 500; opacity: 0; transform: translateY(10px); transition: all 0.2s; z-index: 100; }
        .save-indicator.visible { opacity: 1; transform: translateY(0); }
        .toast-container { position: fixed; bottom: 60px; right: 20px; z-index: 1000; }
        .toast { padding: 12px 18px; background: var(--text); color: white; border-radius: 8px; margin-top: 8px; font-size: 0.85rem; font-weight: 500; animation: slideIn 0.3s ease; }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .demo-badge { position: fixed; top: 8px; left: 50%; transform: translateX(-50%); background: var(--warning); color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; z-index: 1000; }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--border-dark); border-radius: 3px; }

        @media (max-width: 900px) { :root { --panel-width: 320px; } .year-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 700px) { :root { --panel-width: 100%; } .grid-container.panel-open { margin-right: 0; } .panel { left: 0; width: 100%; } .year-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 12px; } .legend { display: none; } }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìÖ Calendrier</h1>
        <div class="header-center">
            <div class="nav-group">
                <button class="btn btn-icon" onclick="navigate(-1)">‚óÄ</button>
                <span class="current-period" id="currentPeriod">F√©vrier 2026</span>
                <button class="btn btn-icon" onclick="navigate(1)">‚ñ∂</button>
            </div>
            <button class="btn" onclick="goToday()">Aujourd'hui</button>
            <div class="view-controls">
                <button class="btn active" onclick="setView('month')" id="btnMonth">Mois</button>
                <button class="btn" onclick="setView('week')" id="btnWeek">Semaine</button>
                <button class="btn" onclick="setView('year')" id="btnYear">Ann√©e</button>
            </div>
        </div>
        <div class="header-right">
            <div class="filters">
                <div class="filter-dropdown">
                    <div class="filter-btn" id="filterProjectBtn" onclick="toggleFilter('project')">Projets ‚ñæ</div>
                    <div class="filter-menu" id="filterProjectMenu"></div>
                </div>
                <div class="filter-dropdown">
                    <div class="filter-btn" id="filterPriorityBtn" onclick="toggleFilter('priority')">Priorit√©s ‚ñæ</div>
                    <div class="filter-menu" id="filterPriorityMenu"></div>
                </div>
            </div>
            <button class="btn primary" onclick="openCreatePanel()">+ T√¢che</button>
        </div>
    </div>

    <div class="main-content">
        <div class="grid-container" id="gridContainer">
            <div class="month-grid" id="monthGrid"></div>
            <div class="week-grid" id="weekGrid"></div>
            <div class="year-grid" id="yearGrid"></div>
        </div>
        <div class="panel" id="panel">
            <div class="panel-header" id="panelHeader"></div>
            <div class="panel-content" id="panelContent"></div>
            <div class="panel-footer" id="panelFooter"></div>
        </div>
    </div>

    <div class="legend">
        <div class="legend-item"><div class="legend-color" style="background:var(--danger)"></div>Critique</div>
        <div class="legend-item"><div class="legend-color" style="background:var(--warning)"></div>Haute</div>
        <div class="legend-item"><div class="legend-color" style="background:var(--info)"></div>Moyenne</div>
        <div class="legend-item"><div class="legend-color" style="background:var(--text-muted)"></div>Basse</div>
        <div class="legend-item"><span style="color:var(--text)">‚óÜ</span>Jalon</div>
    </div>

    <div class="save-indicator" id="saveIndicator">‚úì Enregistr√©</div>
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // SCHEMA & CONSTANTS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const TASKFLOW_SCHEMA = {
            Team: [{ id: 'nom', type: 'Text' }, { id: 'email', type: 'Text' }, { id: 'avatar', type: 'Text' }, { id: 'role', type: 'Choice' }, { id: 'actif', type: 'Bool' }],
            Projects: [{ id: 'nom', type: 'Text' }, { id: 'couleur', type: 'Text' }, { id: 'dateDebut', type: 'Date' }, { id: 'dateFin', type: 'Date' }, { id: 'responsable', type: 'Ref:Team' }, { id: 'actif', type: 'Bool' }],
            Tasks: [{ id: 'titre', type: 'Text' }, { id: 'description', type: 'Text' }, { id: 'dateDebut', type: 'Date' }, { id: 'dateEcheance', type: 'Date' }, { id: 'priorite', type: 'Choice' }, { id: 'statut', type: 'Choice' }, { id: 'progression', type: 'Numeric' }, { id: 'projet', type: 'Ref:Projects' }, { id: 'assignees', type: 'RefList:Team' }, { id: 'type', type: 'Choice' }, { id: 'dependDe', type: 'RefList:Tasks' }, { id: 'tags', type: 'ChoiceList' }, { id: 'estimationH', type: 'Numeric' }, { id: 'tempsPasse', type: 'Numeric' }, { id: 'couleur', type: 'Text' }]
        };

        const PRIORITY_LABELS = { 1: 'Critique', 2: 'Haute', 3: 'Moyenne', 4: 'Basse' };
        const PRIORITY_COLORS = { 1: '#ef4444', 2: '#f59e0b', 3: '#3b82f6', 4: '#64748b' };
        const STATUS_CONFIG = { todo: '√Ä faire', inprogress: 'En cours', review: 'En revue', done: 'Termin√©' };
        const TYPE_ICONS = { tache: 'üìã', jalon: '‚óÜ', reunion: 'üë•' };
        const MONTHS = ['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'];
        const DAYS = ['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'];
        const DAYS_FULL = ['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'];

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // STATE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let tasks = [], team = [], projects = [], gristReady = false;
        let currentView = 'month', currentDate = new Date(), selectedDate = null, selectedTaskId = null;
        let panelState = { open: false, mode: null, periodType: null, periodDate: null, periodTasks: [], taskId: null, taskIndex: -1, isNew: false, editData: null };
        let filters = { project: [], priority: [] };
        let saveTimeout = null;

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // UTILITIES
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const showToast = (m, t) => { const c = document.getElementById('toastContainer'); const e = document.createElement('div'); e.className = 'toast ' + (t || ''); e.textContent = m; c.appendChild(e); setTimeout(() => e.remove(), 3000); };
        const showSaveIndicator = () => { const el = document.getElementById('saveIndicator'); el.classList.add('visible'); clearTimeout(saveTimeout); saveTimeout = setTimeout(() => el.classList.remove('visible'), 1500); };
        const escapeHtml = (t) => { if (!t) return ''; const d = document.createElement('div'); d.textContent = t; return d.innerHTML; };

        const gristToDate = (ts) => ts ? new Date(ts * 1000) : null;
        const dateToGrist = (d) => d ? Math.floor(d.getTime() / 1000) : null;
        const formatDate = (d, f='short') => { if (!d) return ''; if (f === 'short') return d.getDate() + ' ' + MONTHS[d.getMonth()].substring(0,3).toLowerCase(); if (f === 'full') return DAYS_FULL[d.getDay()] + ' ' + d.getDate() + ' ' + MONTHS[d.getMonth()].toLowerCase(); if (f === 'iso') return d.toISOString().split('T')[0]; return d.toLocaleDateString('fr-FR'); };
        const isSameDay = (a, b) => a && b && a.getFullYear() === b.getFullYear() && a.getMonth() === b.getMonth() && a.getDate() === b.getDate();
        const isToday = (d) => isSameDay(d, new Date());
        const isWeekend = (d) => { const w = d.getDay(); return w === 0 || w === 6; };
        const getWeekNumber = (d) => { const t = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); const n = t.getUTCDay() || 7; t.setUTCDate(t.getUTCDate() + 4 - n); const y = new Date(Date.UTC(t.getUTCFullYear(), 0, 1)); return Math.ceil((((t - y) / 86400000) + 1) / 7); };
        const getMonthStart = (d) => new Date(d.getFullYear(), d.getMonth(), 1);
        const getMonthEnd = (d) => new Date(d.getFullYear(), d.getMonth() + 1, 0);
        const getWeekStart = (d) => { const t = new Date(d); const w = t.getDay(); return new Date(t.setDate(t.getDate() - w + (w === 0 ? -6 : 1))); };
        const addDays = (d, n) => { const r = new Date(d); r.setDate(r.getDate() + n); return r; };
        const startOfDay = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate());
        const endOfDay = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23, 59, 59, 999);

        // Project/Team helpers
        const getProjectName = (id) => { const p = projects.find(x => x.id === id); return p?.nom || ''; };
        const getProjectColor = (id) => { const p = projects.find(x => x.id === id); return p?.couleur || '#64748b'; };
        const getTeamMemberName = (id) => { const m = team.find(x => x.id === id); return m?.nom || ''; };
        const getInitials = (n) => n ? n.split(' ').map(x => x[0]).join('').toUpperCase().slice(0, 2) : '?';

        // RefList / ChoiceList helpers - STANDARDIZED
        const getRefListArray = (val) => {
            if (!val) return [];
            if (Array.isArray(val)) return val[0] === 'L' ? val.slice(1).map(Number).filter(n => !isNaN(n)) : val.map(Number).filter(n => !isNaN(n));
            return [];
        };
        const toGristRefList = (arr) => arr && arr.length ? ['L', ...arr] : null;
        
        const getChoiceListArray = (val) => {
            if (!val) return [];
            if (Array.isArray(val)) return val[0] === 'L' ? val.slice(1) : val;
            return [];
        };
        const toGristChoiceList = (arr) => arr && arr.length ? ['L', ...arr] : null;

        // Task field accessors
        const getAssignees = (t) => getRefListArray(t?.assignees);
        const getDependsOn = (t) => getRefListArray(t?.dependDe);
        const getTags = (t) => getChoiceListArray(t?.tags);
        const getPriority = (t) => (t?.priorite >= 1 && t?.priorite <= 4) ? parseInt(t.priorite) : 3;

        // Dependency helpers - detect cycles
        function wouldCreateCycle(taskId, depId, visited = new Set()) {
            if (taskId === depId) return true;
            if (visited.has(depId)) return false;
            visited.add(depId);
            const depTask = tasks.find(t => t.id === depId);
            if (!depTask) return false;
            const depDeps = getDependsOn(depTask);
            return depDeps.some(d => wouldCreateCycle(taskId, d, visited));
        }
        
        function getAvailableDependencies(taskId) {
            return tasks.filter(t => t.id !== taskId && !wouldCreateCycle(taskId, t.id));
        }
        
        function getBlockedTasks(taskId) {
            return tasks.filter(t => getDependsOn(t).includes(taskId));
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // GRIST DATA
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function convertGristToRecords(data) {
            if (!data || Array.isArray(data)) return data || [];
            const cols = Object.keys(data);
            if (!cols.length) return [];
            const n = data[cols[0]]?.length || 0;
            const records = [];
            for (let i = 0; i < n; i++) { const rec = {}; cols.forEach(k => { rec[k] = data[k][i]; }); records.push(rec); }
            return records;
        }

        async function ensureSchema() {
            let created = 0, added = 0;
            const tablesCreated = [];
            for (const [tableName, columns] of Object.entries(TASKFLOW_SCHEMA)) {
                let existingCols = [], tableExists = false;
                try { const data = await grist.docApi.fetchTable(tableName); existingCols = Object.keys(data).filter(c => c !== 'id' && c !== 'manualSort'); tableExists = true; }
                catch (e) { try { await grist.docApi.applyUserActions([['AddTable', tableName, columns.map(c => ({ id: c.id, type: c.type }))]]); tablesCreated.push(tableName); created++; continue; } catch (e2) { continue; } }
                if (tableExists) { const missing = columns.filter(c => !existingCols.includes(c.id)); for (const col of missing) { try { await grist.docApi.applyUserActions([['AddColumn', tableName, col.id, { type: col.type }]]); added++; } catch (e) {} } }
            }
            if (tablesCreated.includes('Tasks')) await seedData();
            if (created > 0 || added > 0) showToast(`Schema OK`, 'success');
        }

        async function seedData() {
            const today = new Date();
            const day = (d) => Math.floor(new Date(today.getFullYear(), today.getMonth(), today.getDate() + d).getTime() / 1000);
            try {
                await grist.docApi.applyUserActions([
                    ['AddRecord', 'Team', null, { nom: 'Alice Martin', email: 'alice@cerema.fr', role: 'Chef de projet', actif: true }],
                    ['AddRecord', 'Team', null, { nom: 'Bob Durant', email: 'bob@cerema.fr', role: 'D√©veloppeur', actif: true }],
                    ['AddRecord', 'Team', null, { nom: 'Claire Bernard', email: 'claire@cerema.fr', role: 'Designer', actif: true }]
                ]);
                await grist.docApi.applyUserActions([
                    ['AddRecord', 'Projects', null, { nom: 'Refonte Portail', couleur: '#4f46e5', actif: true }],
                    ['AddRecord', 'Projects', null, { nom: 'App Mobile', couleur: '#10b981', actif: true }],
                    ['AddRecord', 'Projects', null, { nom: 'Dashboard IA', couleur: '#f59e0b', actif: true }]
                ]);
                await grist.docApi.applyUserActions([
                    ['AddRecord', 'Tasks', null, { titre: 'Analyse besoins', priorite: '1', statut: 'done', progression: 100, projet: 1, type: 'tache', dateDebut: day(-10), dateEcheance: day(-5), assignees: ['L', 1], tags: ['L', 'documentation'] }],
                    ['AddRecord', 'Tasks', null, { titre: 'Dev Backend', priorite: '1', statut: 'inprogress', progression: 40, projet: 1, type: 'tache', dateDebut: day(-4), dateEcheance: day(10), assignees: ['L', 1, 2], dependDe: ['L', 1], estimationH: 32, tempsPasse: 12 }],
                    ['AddRecord', 'Tasks', null, { titre: 'Design UI', priorite: '2', statut: 'review', progression: 80, projet: 2, type: 'tache', dateDebut: day(-5), dateEcheance: day(2), assignees: ['L', 3] }],
                    ['AddRecord', 'Tasks', null, { titre: 'Livraison MVP', priorite: '1', statut: 'todo', progression: 0, projet: 1, type: 'jalon', dateDebut: day(15), dateEcheance: day(15), dependDe: ['L', 2] }],
                    ['AddRecord', 'Tasks', null, { titre: 'Tests QA', priorite: '3', statut: 'todo', progression: 0, projet: 3, type: 'tache', dateDebut: day(5), dateEcheance: day(12), tags: ['L', 'qa', 'tests'] }]
                ]);
            } catch (e) { console.log('Seed error:', e); }
        }

        async function loadAllData() {
            try { tasks = convertGristToRecords(await grist.docApi.fetchTable('Tasks')); } catch (e) { tasks = []; }
            try { team = convertGristToRecords(await grist.docApi.fetchTable('Team')); } catch (e) { team = []; }
            try { projects = convertGristToRecords(await grist.docApi.fetchTable('Projects')); } catch (e) { projects = []; }
            gristReady = true;
            updateFilterMenus();
            render();
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // FILTERS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function toggleFilter(type) {
            document.querySelectorAll('.filter-menu').forEach(m => m.classList.remove('open'));
            document.getElementById(`filter${type.charAt(0).toUpperCase() + type.slice(1)}Menu`).classList.toggle('open');
        }
        
        function updateFilterMenus() {
            document.getElementById('filterProjectMenu').innerHTML = projects.map(p => 
                `<div class="filter-option" onclick="toggleFilterValue('project', ${p.id})"><input type="checkbox" ${filters.project.includes(p.id) ? 'checked' : ''}><span style="color:${p.couleur||'#6366f1'}">‚óè</span> ${escapeHtml(p.nom)}</div>`
            ).join('') || '<div class="filter-option">Aucun projet</div>';
            
            document.getElementById('filterPriorityMenu').innerHTML = [1,2,3,4].map(p => 
                `<div class="filter-option" onclick="toggleFilterValue('priority', ${p})"><input type="checkbox" ${filters.priority.includes(p) ? 'checked' : ''}><span style="color:${PRIORITY_COLORS[p]}">‚óè</span> ${PRIORITY_LABELS[p]}</div>`
            ).join('');
            
            document.getElementById('filterProjectBtn').classList.toggle('has-filter', filters.project.length > 0);
            document.getElementById('filterPriorityBtn').classList.toggle('has-filter', filters.priority.length > 0);
        }
        
        function toggleFilterValue(type, val) {
            const arr = filters[type];
            const idx = arr.indexOf(val);
            if (idx === -1) arr.push(val); else arr.splice(idx, 1);
            updateFilterMenus();
            render();
        }
        
        function getFilteredTasks() {
            return tasks.filter(t => {
                if (filters.project.length && !filters.project.includes(t.projet)) return false;
                if (filters.priority.length && !filters.priority.includes(getPriority(t))) return false;
                return true;
            });
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // NAVIGATION & VIEWS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function setView(v) {
            currentView = v;
            document.querySelectorAll('.view-controls .btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn' + v.charAt(0).toUpperCase() + v.slice(1)).classList.add('active');
            document.getElementById('monthGrid').style.display = v === 'month' ? 'flex' : 'none';
            document.getElementById('weekGrid').style.display = v === 'week' ? 'flex' : 'none';
            document.getElementById('yearGrid').style.display = v === 'year' ? 'grid' : 'none';
            render();
        }
        
        function navigate(dir) {
            if (currentView === 'month') currentDate.setMonth(currentDate.getMonth() + dir);
            else if (currentView === 'week') currentDate.setDate(currentDate.getDate() + dir * 7);
            else if (currentView === 'year') currentDate.setFullYear(currentDate.getFullYear() + dir);
            render();
        }
        
        function goToday() { currentDate = new Date(); render(); }
        
        function updatePeriodLabel() {
            let label = '';
            if (currentView === 'month') label = MONTHS[currentDate.getMonth()] + ' ' + currentDate.getFullYear();
            else if (currentView === 'week') { const ws = getWeekStart(currentDate); label = 'Sem. ' + getWeekNumber(ws) + ' - ' + MONTHS[ws.getMonth()].substring(0,3) + ' ' + ws.getFullYear(); }
            else if (currentView === 'year') label = currentDate.getFullYear();
            document.getElementById('currentPeriod').textContent = label;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // RENDER
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function render() {
            updatePeriodLabel();
            if (currentView === 'month') renderMonth();
            else if (currentView === 'week') renderWeek();
            else if (currentView === 'year') renderYear();
        }
        
        function renderMonth() {
            const grid = document.getElementById('monthGrid');
            const ft = getFilteredTasks();
            const start = getMonthStart(currentDate);
            const end = getMonthEnd(currentDate);
            const startWeekday = start.getDay() || 7;
            const firstDate = addDays(start, -(startWeekday - 1));
            
            let html = '<div class="month-header"><div class="month-header-cell"></div>';
            for (let i = 1; i <= 7; i++) html += `<div class="month-header-cell ${i >= 6 ? 'weekend' : ''}">${DAYS[i % 7]}</div>`;
            html += '</div><div class="month-body">';
            
            let date = new Date(firstDate);
            for (let w = 0; w < 6; w++) {
                const weekStart = new Date(date);
                html += `<div class="month-week"><div class="week-number" onclick="openWeekPanel(new Date(${date.getTime()}))">${getWeekNumber(date)}</div>`;
                for (let d = 0; d < 7; d++) {
                    const thisDate = new Date(date);
                    const isOther = thisDate.getMonth() !== currentDate.getMonth();
                    const classes = ['month-day', isOther ? 'other-month' : '', isToday(thisDate) ? 'today' : '', isWeekend(thisDate) ? 'weekend' : '', isSameDay(thisDate, selectedDate) ? 'selected' : ''].filter(Boolean).join(' ');
                    html += `<div class="${classes}" onclick="openDayPanel(new Date(${thisDate.getTime()}))" data-date="${thisDate.getTime()}"><div class="day-header"><span class="day-number">${thisDate.getDate()}</span></div><div class="day-events-area"></div></div>`;
                    date = addDays(date, 1);
                }
                html += '</div>';
                if (date > end && date.getMonth() !== currentDate.getMonth()) break;
            }
            html += '</div>';
            grid.innerHTML = html;
            
            // Render event bars
            renderEventBars(ft, firstDate, 6);
        }
        
        function renderEventBars(ft, firstDate, weeks) {
            const container = document.createElement('div');
            container.className = 'week-lanes-container';
            
            const tasksByWeek = [];
            for (let w = 0; w < weeks; w++) tasksByWeek.push([]);
            
            ft.forEach(t => {
                const s = gristToDate(t.dateDebut) || gristToDate(t.dateEcheance);
                const e = gristToDate(t.dateEcheance) || s;
                if (!s) return;
                
                const taskStart = startOfDay(s);
                const taskEnd = endOfDay(e);
                
                for (let w = 0; w < weeks; w++) {
                    const weekStart = addDays(firstDate, w * 7);
                    const weekEnd = endOfDay(addDays(weekStart, 6));
                    
                    if (taskEnd >= weekStart && taskStart <= weekEnd) {
                        tasksByWeek[w].push({ task: t, start: taskStart, end: taskEnd });
                    }
                }
            });
            
            const monthBody = document.querySelector('.month-body');
            if (!monthBody) return;
            
            const weekRows = monthBody.querySelectorAll('.month-week');
            weekRows.forEach((row, w) => {
                const lanesContainer = document.createElement('div');
                lanesContainer.className = 'week-lanes-container';
                
                const weekStart = addDays(firstDate, w * 7);
                const lanes = [];
                
                tasksByWeek[w].sort((a, b) => a.start - b.start || (b.end - b.start) - (a.end - a.start));
                
                tasksByWeek[w].forEach(({ task, start, end }) => {
                    const barStart = Math.max(start.getTime(), weekStart.getTime());
                    const barEnd = Math.min(end.getTime(), addDays(weekStart, 7).getTime() - 1);
                    const startDay = Math.floor((barStart - weekStart.getTime()) / 86400000);
                    const endDay = Math.floor((barEnd - weekStart.getTime()) / 86400000);
                    
                    let lane = lanes.findIndex(l => l <= startDay);
                    if (lane === -1) { lane = lanes.length; lanes.push(0); }
                    lanes[lane] = endDay + 1;
                    
                    if (lane < 3) {
                        const p = getPriority(task);
                        const left = (startDay / 7 * 100) + '%';
                        const width = ((endDay - startDay + 1) / 7 * 100) + '%';
                        const top = (28 + lane * 18) + 'px';
                        const isMilestone = task.type === 'jalon';
                        const isDone = task.statut === 'done';
                        
                        const bar = document.createElement('div');
                        bar.className = `event-bar p${p} ${isMilestone ? 'milestone' : ''} ${isDone ? 'done' : ''} ${task.id === selectedTaskId ? 'selected' : ''}`;
                        bar.style.cssText = `left:${left}; width:${width}; top:${top};`;
                        bar.textContent = task.titre || 'Sans titre';
                        bar.onclick = (e) => { e.stopPropagation(); openTaskPanel(task.id); };
                        lanesContainer.appendChild(bar);
                    }
                });
                
                const overflowCount = tasksByWeek[w].length - 3;
                if (overflowCount > 0) {
                    const more = document.createElement('div');
                    more.className = 'more-events';
                    more.textContent = `+${overflowCount}`;
                    more.onclick = (e) => { e.stopPropagation(); openWeekPanel(weekStart); };
                    row.querySelector('.month-day:last-child').appendChild(more);
                }
                
                row.appendChild(lanesContainer);
            });
        }
        
        function renderWeek() {
            const grid = document.getElementById('weekGrid');
            const ft = getFilteredTasks();
            const weekStart = getWeekStart(currentDate);
            
            let headerHtml = '<div class="week-header"><div class="week-header-cell"></div>';
            for (let d = 0; d < 7; d++) {
                const date = addDays(weekStart, d);
                const classes = ['week-header-cell', isWeekend(date) ? 'weekend' : '', isToday(date) ? 'today' : ''].filter(Boolean).join(' ');
                headerHtml += `<div class="${classes}"><div class="week-header-day">${DAYS[(d + 1) % 7]}</div><div class="week-header-date" onclick="openDayPanel(new Date(${date.getTime()}))">${date.getDate()}</div></div>`;
            }
            headerHtml += '</div>';
            
            let alldayHtml = '<div class="week-allday"><div class="week-allday-label">Journ√©e</div>';
            for (let d = 0; d < 7; d++) {
                const date = addDays(weekStart, d);
                const dayTasks = ft.filter(t => {
                    const s = gristToDate(t.dateDebut), e = gristToDate(t.dateEcheance) || s;
                    return s && startOfDay(s) <= date && endOfDay(e || s) >= date;
                });
                alldayHtml += `<div class="week-allday-cell ${isWeekend(date) ? 'weekend' : ''}" onclick="openDayPanel(new Date(${date.getTime()}))">${dayTasks.slice(0, 3).map(t => `<div class="week-allday-event p${getPriority(t)}" onclick="event.stopPropagation();openTaskPanel(${t.id})">${escapeHtml(t.titre)}</div>`).join('')}</div>`;
            }
            alldayHtml += '</div>';
            
            let timelineHtml = '<div class="week-timeline"><div class="week-hours">';
            for (let h = 0; h < 24; h++) timelineHtml += `<div class="week-hour-label">${String(h).padStart(2,'0')}:00</div>`;
            timelineHtml += '</div>';
            for (let d = 0; d < 7; d++) {
                const date = addDays(weekStart, d);
                timelineHtml += `<div class="week-day-column ${isWeekend(date) ? 'weekend' : ''}">`;
                for (let h = 0; h < 24; h++) timelineHtml += `<div class="week-hour-slot" onclick="openDayPanel(new Date(${date.getTime()}))"></div>`;
                timelineHtml += '</div>';
            }
            timelineHtml += '</div>';
            
            grid.innerHTML = headerHtml + alldayHtml + timelineHtml;
        }
        
        function renderYear() {
            const grid = document.getElementById('yearGrid');
            const ft = getFilteredTasks();
            const year = currentDate.getFullYear();
            
            let html = '';
            for (let m = 0; m < 12; m++) {
                const monthStart = new Date(year, m, 1);
                const monthEnd = new Date(year, m + 1, 0);
                const startWeekday = monthStart.getDay() || 7;
                const firstDate = addDays(monthStart, -(startWeekday - 1));
                
                html += `<div class="mini-month" onclick="currentDate=new Date(${year},${m},1);setView('month')"><div class="mini-month-title">${MONTHS[m]}</div><div class="mini-month-grid">`;
                for (let d = 1; d <= 7; d++) html += `<div class="mini-day-header">${DAYS[d % 7].charAt(0)}</div>`;
                
                let date = new Date(firstDate);
                for (let w = 0; w < 6; w++) {
                    for (let d = 0; d < 7; d++) {
                        const isOther = date.getMonth() !== m;
                        const hasEvents = ft.some(t => {
                            const s = gristToDate(t.dateDebut), e = gristToDate(t.dateEcheance) || s;
                            return s && isSameDay(date, s) || (e && isSameDay(date, e));
                        });
                        html += `<div class="mini-day ${isOther ? 'other-month' : ''} ${isToday(date) ? 'today' : ''} ${hasEvents && !isOther ? 'has-events' : ''}">${date.getDate()}</div>`;
                        date = addDays(date, 1);
                    }
                }
                html += '</div></div>';
            }
            grid.innerHTML = html;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PANEL
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function openPanel() {
            panelState.open = true;
            document.getElementById('panel').classList.add('open');
            document.getElementById('gridContainer').classList.add('panel-open');
        }
        
        function closePanel() {
            panelState.open = false;
            document.getElementById('panel').classList.remove('open');
            document.getElementById('gridContainer').classList.remove('panel-open');
            panelState = { open: false, mode: null, periodType: null, periodDate: null, periodTasks: [], taskId: null, taskIndex: -1, isNew: false, editData: null };
        }
        
        function openDayPanel(date) {
            selectedDate = date;
            const ft = getFilteredTasks().filter(t => {
                const s = gristToDate(t.dateDebut), e = gristToDate(t.dateEcheance) || s;
                return s && startOfDay(s) <= date && endOfDay(e || s) >= date;
            });
            panelState = { open: true, mode: 'period', periodType: 'day', periodDate: date, periodTasks: ft, taskId: null, taskIndex: -1, isNew: false, editData: null };
            renderPanelPeriod();
            openPanel();
            render();
        }
        
        function openWeekPanel(date) {
            const weekStart = getWeekStart(date);
            const weekEnd = addDays(weekStart, 6);
            const ft = getFilteredTasks().filter(t => {
                const s = gristToDate(t.dateDebut), e = gristToDate(t.dateEcheance) || s;
                return s && startOfDay(s) <= weekEnd && endOfDay(e || s) >= weekStart;
            });
            panelState = { open: true, mode: 'period', periodType: 'week', periodDate: weekStart, periodTasks: ft, taskId: null, taskIndex: -1, isNew: false, editData: null };
            renderPanelPeriod();
            openPanel();
        }
        
        function openTaskPanel(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            selectedTaskId = taskId;
            const idx = panelState.periodTasks.findIndex(t => t.id === taskId);
            panelState.mode = 'task';
            panelState.taskId = taskId;
            panelState.taskIndex = idx >= 0 ? idx : 0;
            panelState.isNew = false;
            panelState.editData = cloneTaskData(task);
            renderPanelTask();
            openPanel();
            if (gristReady) grist.setSelectedRows([taskId]);
            render();
        }
        
        function openCreatePanel(date = null) {
            const today = new Date();
            const targetDate = date || selectedDate || today;
            panelState = {
                open: true, mode: 'task', periodType: panelState.periodType, periodDate: panelState.periodDate,
                periodTasks: panelState.periodTasks, taskId: null, taskIndex: -1, isNew: true,
                editData: {
                    titre: '', description: '', type: 'tache', priorite: '3', statut: 'todo', progression: 0,
                    dateDebut: dateToGrist(targetDate), dateEcheance: dateToGrist(addDays(targetDate, 7)),
                    projet: projects.length > 0 ? projects[0].id : null,
                    assignees: [], dependDe: [], tags: [], estimationH: null, tempsPasse: null
                }
            };
            renderPanelTask();
            openPanel();
            setTimeout(() => document.getElementById('taskTitle')?.focus(), 100);
        }
        
        function cloneTaskData(task) {
            return {
                titre: task.titre || '',
                description: task.description || '',
                type: task.type || 'tache',
                priorite: String(task.priorite || '3'),
                statut: task.statut || 'todo',
                progression: task.progression || 0,
                dateDebut: task.dateDebut,
                dateEcheance: task.dateEcheance,
                projet: task.projet || null,
                assignees: getAssignees(task),
                dependDe: getDependsOn(task),
                tags: getTags(task),
                estimationH: task.estimationH || null,
                tempsPasse: task.tempsPasse || null
            };
        }
        
        function backToPeriod() {
            if (panelState.periodType) {
                panelState.mode = 'period';
                panelState.taskId = null;
                panelState.isNew = false;
                panelState.editData = null;
                renderPanelPeriod();
            } else {
                closePanel();
            }
        }
        
        function navigatePanelTask(dir) {
            if (panelState.isNew || panelState.periodTasks.length < 2) return;
            let newIdx = panelState.taskIndex + dir;
            if (newIdx < 0) newIdx = panelState.periodTasks.length - 1;
            if (newIdx >= panelState.periodTasks.length) newIdx = 0;
            const t = panelState.periodTasks[newIdx];
            if (t) openTaskPanel(t.id);
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PANEL PERIOD VIEW
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function renderPanelPeriod() {
            const header = document.getElementById('panelHeader');
            const content = document.getElementById('panelContent');
            const footer = document.getElementById('panelFooter');
            
            const { periodType, periodDate, periodTasks } = panelState;
            let title = '';
            if (periodType === 'day') title = formatDate(periodDate, 'full');
            else if (periodType === 'week') title = `Semaine ${getWeekNumber(periodDate)}`;
            
            header.innerHTML = `<div class="panel-nav"><span class="panel-title">üìÖ ${escapeHtml(title)}</span></div><button class="panel-close" onclick="closePanel()">√ó</button>`;
            
            const done = periodTasks.filter(t => t.statut === 'done').length;
            const total = periodTasks.length;
            
            content.innerHTML = `
                <div class="panel-stats">
                    <div class="panel-stat"><div class="panel-stat-value">${total}</div><div class="panel-stat-label">T√¢ches</div></div>
                    <div class="panel-stat"><div class="panel-stat-value">${done}/${total}</div><div class="panel-stat-label">Termin√©es</div></div>
                </div>
                <div class="panel-section"><div class="panel-section-title">T√¢ches</div>
                    ${periodTasks.length ? periodTasks.map(t => renderTaskCard(t)).join('') : '<div class="panel-empty">Aucune t√¢che</div>'}
                </div>
            `;
            
            footer.innerHTML = `<button class="panel-btn primary" onclick="openCreatePanel()" style="width:100%">+ Nouvelle t√¢che</button>`;
        }
        
        function renderTaskCard(t) {
            const p = getPriority(t);
            const projectName = getProjectName(t.projet);
            const projectColor = getProjectColor(t.projet);
            const s = gristToDate(t.dateDebut), e = gristToDate(t.dateEcheance);
            const ds = s ? formatDate(s, 'short') : '';
            
            return `<div class="panel-task-card p${p} ${t.id === selectedTaskId ? 'selected' : ''}" onclick="openTaskPanel(${t.id})">
                <div class="panel-task-title">${t.type === 'jalon' ? '‚óÜ ' : ''}${escapeHtml(t.titre) || 'Sans titre'}</div>
                <div class="panel-task-meta"><span>${ds}</span>${projectName ? `<span style="color:${projectColor}">‚óè ${escapeHtml(projectName)}</span>` : ''}</div>
                ${t.type !== 'jalon' ? `<div class="panel-task-progress"><div class="panel-task-progress-bar p${p}" style="width:${t.progression || 0}%"></div></div>` : ''}
            </div>`;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PANEL TASK FORM (COMPLETE)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function renderPanelTask() {
            const header = document.getElementById('panelHeader');
            const content = document.getElementById('panelContent');
            const footer = document.getElementById('panelFooter');
            
            const data = panelState.editData;
            if (!data) { backToPeriod(); return; }
            
            const canNavigate = panelState.periodTasks.length > 1 && !panelState.isNew;
            const typeIcon = TYPE_ICONS[data.type] || 'üìã';
            const titleText = panelState.isNew ? 'Nouvelle t√¢che' : (data.titre || 'Sans titre');
            
            header.innerHTML = `
                <div class="panel-nav">
                    <button class="panel-nav-btn" onclick="backToPeriod()" title="Retour">‚Üê</button>
                    <button class="panel-nav-btn" onclick="navigatePanelTask(-1)" ${!canNavigate ? 'disabled' : ''}>‚óÄ</button>
                    <span class="panel-title"><span class="panel-title-icon">${typeIcon}</span>${escapeHtml(titleText)}</span>
                    <button class="panel-nav-btn" onclick="navigatePanelTask(1)" ${!canNavigate ? 'disabled' : ''}>‚ñ∂</button>
                </div>
                <button class="panel-close" onclick="closePanel()">√ó</button>
            `;
            
            const s = gristToDate(data.dateDebut);
            const e = gristToDate(data.dateEcheance);
            
            // Project options
            const projectOptions = projects.filter(p => p.actif !== false).map(p => 
                `<option value="${p.id}" ${data.projet === p.id ? 'selected' : ''}>${escapeHtml(p.nom)}</option>`
            ).join('');
            
            // Assignees chips & options
            const assigneesChips = data.assignees.map(id => `<span class="multi-select-chip">${escapeHtml(getTeamMemberName(id))}<span class="remove" onclick="event.stopPropagation();removeAssignee(${id})">√ó</span></span>`).join('');
            const assigneesOptions = team.filter(m => m.actif !== false).map(m => 
                `<div class="multi-select-option ${data.assignees.includes(m.id) ? 'selected' : ''}" onclick="toggleAssignee(${m.id})"><input type="checkbox" ${data.assignees.includes(m.id) ? 'checked' : ''} onclick="event.stopPropagation();toggleAssignee(${m.id})">${escapeHtml(m.nom)}</div>`
            ).join('');
            
            // Dependencies chips & options
            const depsChips = data.dependDe.map(id => {
                const d = tasks.find(t => t.id === id);
                return d ? `<span class="multi-select-chip">${escapeHtml(d.titre)}<span class="remove" onclick="event.stopPropagation();removeDependency(${id})">√ó</span></span>` : '';
            }).join('');
            const availableDeps = panelState.isNew ? tasks : getAvailableDependencies(panelState.taskId);
            const depsOptions = availableDeps.map(t => 
                `<div class="multi-select-option ${data.dependDe.includes(t.id) ? 'selected' : ''}" onclick="toggleDependency(${t.id})"><input type="checkbox" ${data.dependDe.includes(t.id) ? 'checked' : ''} onclick="event.stopPropagation();toggleDependency(${t.id})">${escapeHtml(t.titre)}</div>`
            ).join('');
            
            // Blocked tasks (read-only)
            let blockedHtml = '';
            if (!panelState.isNew) {
                const blocked = getBlockedTasks(panelState.taskId);
                if (blocked.length) {
                    blockedHtml = `<div class="deps-display"><div class="deps-group"><div class="deps-group-label">‚Üí Bloque :</div><div class="deps-list">${blocked.map(t => `<div class="dep-item" onclick="openTaskPanel(${t.id})"><span class="icon">‚Üí</span>${escapeHtml(t.titre)}</div>`).join('')}</div></div></div>`;
                }
            }
            
            // Tags chips
            const tagsChips = data.tags.map(tag => `<span class="tag-chip">#${escapeHtml(tag)}<span class="remove" onclick="removeTag('${escapeHtml(tag)}')">√ó</span></span>`).join('');
            
            // Time tracking
            const estim = data.estimationH || 0;
            const passe = data.tempsPasse || 0;
            const timePercent = estim > 0 ? Math.min((passe / estim) * 100, 100) : 0;
            const timeOver = passe > estim && estim > 0;
            
            content.innerHTML = `
                <div class="type-selector">
                    <div class="type-option ${data.type === 'tache' ? 'selected' : ''}" onclick="updateField('type','tache')"><span class="type-option-icon">üìã</span>T√¢che</div>
                    <div class="type-option ${data.type === 'jalon' ? 'selected' : ''}" onclick="updateField('type','jalon')"><span class="type-option-icon">‚óÜ</span>Jalon</div>
                    <div class="type-option ${data.type === 'reunion' ? 'selected' : ''}" onclick="updateField('type','reunion')"><span class="type-option-icon">üë•</span>R√©union</div>
                </div>
                
                <div class="form-group">
                    <input type="text" class="form-input title-input" id="taskTitle" placeholder="Titre de la t√¢che..." value="${escapeHtml(data.titre)}" oninput="updateField('titre', this.value, true)">
                </div>
                
                <div class="panel-section">
                    ${data.type === 'jalon' ? `
                        <div class="form-group"><label class="form-label">Date</label><input type="date" class="form-input" value="${s ? formatDate(s, 'iso') : ''}" onchange="updateField('dateDebut', this.value); updateField('dateEcheance', this.value)"></div>
                    ` : `
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">D√©but</label><input type="date" class="form-input" value="${s ? formatDate(s, 'iso') : ''}" onchange="updateField('dateDebut', this.value)"></div>
                            <div class="form-group"><label class="form-label">Fin</label><input type="date" class="form-input" value="${e ? formatDate(e, 'iso') : ''}" onchange="updateField('dateEcheance', this.value)"></div>
                        </div>
                    `}
                    <div class="form-group">
                        <label class="form-label">Projet</label>
                        <select class="form-select" onchange="updateField('projet', parseInt(this.value) || null)">
                            <option value="">Aucun projet</option>
                            ${projectOptions}
                        </select>
                    </div>
                </div>
                
                <div class="panel-section">
                    <div class="form-group">
                        <label class="form-label">Priorit√©</label>
                        <div class="priority-selector">
                            <div class="priority-pill p1 ${data.priorite == '1' ? 'selected' : ''}" onclick="updateField('priorite','1')">Critique</div>
                            <div class="priority-pill p2 ${data.priorite == '2' ? 'selected' : ''}" onclick="updateField('priorite','2')">Haute</div>
                            <div class="priority-pill p3 ${data.priorite == '3' ? 'selected' : ''}" onclick="updateField('priorite','3')">Moyenne</div>
                            <div class="priority-pill p4 ${data.priorite == '4' ? 'selected' : ''}" onclick="updateField('priorite','4')">Basse</div>
                        </div>
                    </div>
                    ${data.type !== 'jalon' ? `
                        <div class="form-group">
                            <label class="form-label">Statut</label>
                            <div class="status-selector">
                                <div class="status-pill ${data.statut === 'todo' ? 'selected' : ''}" onclick="updateField('statut','todo')">√Ä faire</div>
                                <div class="status-pill ${data.statut === 'inprogress' ? 'selected' : ''}" onclick="updateField('statut','inprogress')">En cours</div>
                                <div class="status-pill ${data.statut === 'review' ? 'selected' : ''}" onclick="updateField('statut','review')">En revue</div>
                                <div class="status-pill ${data.statut === 'done' ? 'selected' : ''}" onclick="updateField('statut','done')">Termin√©</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Progression</label>
                            <div class="progress-container">
                                <input type="range" class="progress-slider" min="0" max="100" value="${data.progression}" oninput="document.getElementById('progressValue').textContent=this.value+'%'" onchange="updateField('progression', parseInt(this.value))">
                                <span class="progress-value" id="progressValue">${data.progression}%</span>
                            </div>
                        </div>
                    ` : ''}
                </div>
                
                <div class="panel-section">
                    <div class="form-group">
                        <label class="form-label">Assign√©s</label>
                        <div class="multi-select" id="assigneesSelect">
                            <div class="multi-select-trigger" onclick="toggleMultiSelect('assigneesSelect')">
                                <div class="multi-select-values">${assigneesChips || '<span class="multi-select-placeholder">S√©lectionner...</span>'}</div>
                                <span class="multi-select-arrow">‚ñæ</span>
                            </div>
                            <div class="multi-select-dropdown">${assigneesOptions || '<div class="multi-select-empty">Aucun membre</div>'}</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">D√©pend de</label>
                        <div class="multi-select" id="depsSelect">
                            <div class="multi-select-trigger" onclick="toggleMultiSelect('depsSelect')">
                                <div class="multi-select-values">${depsChips || '<span class="multi-select-placeholder">S√©lectionner...</span>'}</div>
                                <span class="multi-select-arrow">‚ñæ</span>
                            </div>
                            <div class="multi-select-dropdown">${depsOptions || '<div class="multi-select-empty">Aucune t√¢che</div>'}</div>
                        </div>
                        ${blockedHtml}
                    </div>
                </div>
                
                <div class="panel-section">
                    <div class="form-group">
                        <label class="form-label">Temps</label>
                        <div class="time-row">
                            <div class="time-group">
                                <label>Estim√©</label>
                                <div class="time-input-wrap">
                                    <input type="number" min="0" step="0.5" value="${estim || ''}" placeholder="0" onchange="updateField('estimationH', parseFloat(this.value) || null)">
                                    <span>h</span>
                                </div>
                            </div>
                            <div class="time-group">
                                <label>Pass√©</label>
                                <div class="time-input-wrap">
                                    <input type="number" min="0" step="0.5" value="${passe || ''}" placeholder="0" onchange="updateField('tempsPasse', parseFloat(this.value) || null)">
                                    <span>h</span>
                                </div>
                            </div>
                        </div>
                        ${estim > 0 ? `<div class="time-bar"><div class="time-bar-fill ${timeOver ? 'over' : ''}" style="width:${timePercent}%"></div></div>` : ''}
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tags</label>
                        <div class="tags-input" onclick="document.getElementById('tagInput').focus()">
                            ${tagsChips}
                            <input type="text" id="tagInput" placeholder="${data.tags.length ? '' : 'Ajouter...'}" onkeydown="handleTagKeydown(event)">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" placeholder="Notes, d√©tails..." oninput="updateField('description', this.value, true)">${escapeHtml(data.description)}</textarea>
                </div>
                
                ${!panelState.isNew ? `
                    <div id="deleteSection">
                        <button class="panel-btn danger" onclick="showDeleteConfirm()">üóëÔ∏è Supprimer</button>
                        <div class="delete-confirm" id="deleteConfirm">
                            <div class="delete-confirm-text">Supprimer cette t√¢che ?</div>
                            <div class="delete-confirm-actions">
                                <button class="delete-confirm-btn cancel" onclick="hideDeleteConfirm()">Annuler</button>
                                <button class="delete-confirm-btn confirm" onclick="confirmDelete()">Supprimer</button>
                            </div>
                        </div>
                    </div>
                ` : ''}
            `;
            
            // Footer
            if (panelState.isNew) {
                const canCreate = data.titre && data.titre.trim().length > 0;
                footer.innerHTML = `<div class="panel-footer-right" style="width:100%"><button class="panel-btn success" onclick="createTask()" ${!canCreate ? 'disabled' : ''} style="width:100%">‚úì Cr√©er la t√¢che</button></div>`;
            } else {
                footer.innerHTML = '';
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // FIELD UPDATES & HANDLERS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        function updateField(field, value, noSave = false) {
            const data = panelState.editData;
            if (!data) return;
            
            // Convert date strings to Grist timestamps
            if (field === 'dateDebut' || field === 'dateEcheance') {
                value = value ? dateToGrist(new Date(value)) : null;
            }
            
            data[field] = value;
            
            // Jalon: sync dates
            if (field === 'type' && value === 'jalon' && data.dateDebut) {
                data.dateEcheance = data.dateDebut;
            }
            
            // Visual fields requiring re-render
            const visualFields = ['type', 'priorite', 'statut', 'projet'];
            if (visualFields.includes(field)) {
                renderPanelTask();
                if (!panelState.isNew) render();
            }
            
            // Enable/disable create button
            if (field === 'titre' && panelState.isNew) {
                const btn = document.querySelector('.panel-footer .panel-btn');
                if (btn) btn.disabled = !value || !value.trim();
            }
            
            // Auto-save for existing tasks
            if (!panelState.isNew && !noSave && gristReady) {
                saveTaskToGrist();
            }
        }
        
        function toggleMultiSelect(id) {
            const el = document.getElementById(id);
            document.querySelectorAll('.multi-select').forEach(s => { if (s.id !== id) s.classList.remove('open'); });
            el.classList.toggle('open');
        }
        
        function toggleAssignee(id) {
            const data = panelState.editData;
            const idx = data.assignees.indexOf(id);
            if (idx === -1) data.assignees.push(id);
            else data.assignees.splice(idx, 1);
            if (!panelState.isNew && gristReady) saveTaskToGrist();
            renderPanelTask();
        }
        
        function removeAssignee(id) {
            const data = panelState.editData;
            const idx = data.assignees.indexOf(id);
            if (idx !== -1) {
                data.assignees.splice(idx, 1);
                if (!panelState.isNew && gristReady) saveTaskToGrist();
                renderPanelTask();
            }
        }
        
        function toggleDependency(id) {
            const data = panelState.editData;
            const idx = data.dependDe.indexOf(id);
            if (idx === -1) data.dependDe.push(id);
            else data.dependDe.splice(idx, 1);
            if (!panelState.isNew && gristReady) saveTaskToGrist();
            renderPanelTask();
        }
        
        function removeDependency(id) {
            const data = panelState.editData;
            const idx = data.dependDe.indexOf(id);
            if (idx !== -1) {
                data.dependDe.splice(idx, 1);
                if (!panelState.isNew && gristReady) saveTaskToGrist();
                renderPanelTask();
            }
        }
        
        function handleTagKeydown(e) {
            const data = panelState.editData;
            if (e.key === 'Enter' || e.key === ',') {
                e.preventDefault();
                const tag = e.target.value.trim().replace(/^#/, '');
                if (tag && !data.tags.includes(tag)) {
                    data.tags.push(tag);
                    e.target.value = '';
                    if (!panelState.isNew && gristReady) saveTaskToGrist();
                    renderPanelTask();
                }
            } else if (e.key === 'Backspace' && !e.target.value && data.tags.length) {
                data.tags.pop();
                if (!panelState.isNew && gristReady) saveTaskToGrist();
                renderPanelTask();
            }
        }
        
        function removeTag(tag) {
            const data = panelState.editData;
            const idx = data.tags.indexOf(tag);
            if (idx !== -1) {
                data.tags.splice(idx, 1);
                if (!panelState.isNew && gristReady) saveTaskToGrist();
                renderPanelTask();
            }
        }
        
        function showDeleteConfirm() { document.getElementById('deleteConfirm').classList.add('visible'); }
        function hideDeleteConfirm() { document.getElementById('deleteConfirm').classList.remove('visible'); }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // CRUD OPERATIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function saveTaskToGrist() {
            const data = panelState.editData;
            if (!data || panelState.isNew || !gristReady) return;
            
            const record = {
                titre: data.titre,
                description: data.description,
                type: data.type,
                priorite: data.priorite,
                statut: data.statut,
                progression: data.progression,
                dateDebut: data.dateDebut,
                dateEcheance: data.dateEcheance,
                projet: data.projet,
                assignees: toGristRefList(data.assignees),
                dependDe: toGristRefList(data.dependDe),
                tags: toGristChoiceList(data.tags),
                estimationH: data.estimationH,
                tempsPasse: data.tempsPasse
            };
            
            try {
                await grist.docApi.applyUserActions([['UpdateRecord', 'Tasks', panelState.taskId, record]]);
                showSaveIndicator();
            } catch (e) {
                showToast('Erreur de sauvegarde', 'error');
            }
        }
        
        async function createTask() {
            const data = panelState.editData;
            if (!data || !data.titre || !data.titre.trim()) {
                showToast('Le titre est requis', 'error');
                return;
            }
            
            const record = {
                titre: data.titre,
                description: data.description || '',
                type: data.type || 'tache',
                priorite: data.priorite || '3',
                statut: data.statut || 'todo',
                progression: data.progression || 0,
                dateDebut: data.dateDebut,
                dateEcheance: data.dateEcheance,
                projet: data.projet,
                assignees: toGristRefList(data.assignees),
                dependDe: toGristRefList(data.dependDe),
                tags: toGristChoiceList(data.tags),
                estimationH: data.estimationH,
                tempsPasse: data.tempsPasse
            };
            
            if (gristReady) {
                try {
                    await grist.docApi.applyUserActions([['AddRecord', 'Tasks', null, record]]);
                    showToast('T√¢che cr√©√©e', 'success');
                    await loadAllData();
                    backToPeriod();
                } catch (e) {
                    showToast('Erreur de cr√©ation', 'error');
                }
            } else {
                record.id = Date.now();
                tasks.push(record);
                showToast('T√¢che cr√©√©e', 'success');
                render();
                backToPeriod();
            }
        }
        
        async function confirmDelete() {
            if (panelState.isNew || !panelState.taskId) return;
            
            if (gristReady) {
                try {
                    await grist.docApi.applyUserActions([['RemoveRecord', 'Tasks', panelState.taskId]]);
                    showToast('T√¢che supprim√©e', 'success');
                    await loadAllData();
                    backToPeriod();
                } catch (e) {
                    showToast('Erreur de suppression', 'error');
                }
            } else {
                tasks = tasks.filter(t => t.id !== panelState.taskId);
                showToast('T√¢che supprim√©e', 'success');
                render();
                backToPeriod();
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // INIT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        async function initGrist() {
            try {
                grist.ready({ requiredAccess: 'full' });
                await ensureSchema();
                await loadAllData();
                grist.onRecords(async () => await loadAllData());
                grist.onRecord((rec) => {
                    if (rec?.id && rec.id !== selectedTaskId) {
                        selectedTaskId = rec.id;
                        render();
                    }
                });
            } catch (e) {
                console.log('Grist unavailable, using demo');
                useDemoMode();
            }
        }
        
        function useDemoMode() {
            document.body.insertAdjacentHTML('beforeend', '<div class="demo-badge">D√©mo</div>');
            
            team = [
                { id: 1, nom: 'Alice Martin', actif: true },
                { id: 2, nom: 'Bob Durant', actif: true },
                { id: 3, nom: 'Claire Bernard', actif: true }
            ];
            projects = [
                { id: 1, nom: 'Refonte Portail', couleur: '#4f46e5', actif: true },
                { id: 2, nom: 'App Mobile', couleur: '#10b981', actif: true },
                { id: 3, nom: 'Dashboard IA', couleur: '#f59e0b', actif: true }
            ];
            
            const today = new Date();
            const day = (d) => dateToGrist(new Date(today.getFullYear(), today.getMonth(), today.getDate() + d));
            
            tasks = [
                { id: 1, titre: 'Analyse besoins', priorite: '1', projet: 1, dateDebut: day(-10), dateEcheance: day(-5), progression: 100, statut: 'done', type: 'tache', assignees: ['L', 1], tags: ['L', 'documentation'] },
                { id: 2, titre: 'Dev Backend', priorite: '1', projet: 1, dateDebut: day(-4), dateEcheance: day(10), progression: 40, statut: 'inprogress', type: 'tache', dependDe: ['L', 1], assignees: ['L', 1, 2], estimationH: 32, tempsPasse: 12 },
                { id: 3, titre: 'Design UI', priorite: '2', projet: 2, dateDebut: day(-5), dateEcheance: day(2), progression: 80, statut: 'review', type: 'tache', assignees: ['L', 3] },
                { id: 4, titre: 'Livraison MVP', priorite: '1', projet: 1, dateDebut: day(15), dateEcheance: day(15), progression: 0, statut: 'todo', type: 'jalon', dependDe: ['L', 2] },
                { id: 5, titre: 'Tests QA', priorite: '3', projet: 3, dateDebut: day(5), dateEcheance: day(12), progression: 0, statut: 'todo', type: 'tache', tags: ['L', 'qa', 'tests'] },
                { id: 6, titre: 'Documentation', priorite: '4', projet: null, dateDebut: day(12), dateEcheance: day(20), progression: 0, statut: 'todo', type: 'tache', assignees: ['L', 3] },
                { id: 7, titre: 'Formation √©quipe', priorite: '3', projet: 2, dateDebut: day(18), dateEcheance: day(22), progression: 0, statut: 'todo', type: 'reunion' }
            ];
            
            updateFilterMenus();
            render();
        }

        // Event listeners
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.filter-dropdown')) {
                document.querySelectorAll('.filter-menu').forEach(m => m.classList.remove('open'));
            }
            if (!e.target.closest('.multi-select')) {
                document.querySelectorAll('.multi-select').forEach(s => s.classList.remove('open'));
            }
        });
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (panelState.open) closePanel();
            }
            if (panelState.open && panelState.mode === 'task' && !e.target.matches('input, textarea, select')) {
                if (e.key === 'ArrowLeft') navigatePanelTask(-1);
                if (e.key === 'ArrowRight') navigatePanelTask(1);
            }
        });

        // Start
        initGrist();
    </script>
</body>
</html>